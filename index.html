<!DOCTYPE html><html><head>
      <title>Android Demo &#x7B80;&#x5355;&#x5206;&#x6790;</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/liuwenchang/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.5.21/node_modules/@shd101wyy/mume/dependencies/katex/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header" id="android-demo-%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90">Android Demo &#x7B80;&#x5355;&#x5206;&#x6790;</h1>

<hr>
<ul>
<li><a href="#android-demo-%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90">Android Demo &#x7B80;&#x5355;&#x5206;&#x6790;</a>
<ul>
<li><a href="#1-peerconnection-%E5%88%9B%E5%BB%BA">1 PeerConnection &#x521B;&#x5EFA;</a>
<ul>
<li><a href="#11-%E5%88%9B%E5%BB%BA-peerconnectionfactory">1.1 &#x521B;&#x5EFA; PeerConnectionFactory</a></li>
<li><a href="#12-%E5%88%9B%E5%BB%BA-peerconnection">1.2 &#x521B;&#x5EFA; PeerConnection</a></li>
<li><a href="#13-%E5%88%9B%E5%BB%BA-videotrack">1.3 &#x521B;&#x5EFA; VideoTrack</a></li>
<li><a href="#14-%E6%B7%BB%E5%8A%A0-videotrack">1.4 &#x6DFB;&#x52A0; VideoTrack</a></li>
</ul>
</li>
<li><a href="#2-%E9%9F%B3%E9%A2%91%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9D%97audiodevicemodule">2 &#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757;(AudioDeviceModule)</a>
<ul>
<li><a href="#21-%E5%88%9B%E5%BB%BA-javaaudiodevicemodule">2.1 &#x521B;&#x5EFA; JavaAudioDeviceModule</a></li>
<li><a href="#22-%E5%88%9B%E5%BB%BA-native-%E5%B1%82-audiodevicemodule">2.2 &#x521B;&#x5EFA; Native &#x5C42; AudioDeviceModule</a></li>
<li><a href="#23-native-%E8%8E%B7%E5%8F%96%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86%E6%92%AD%E6%94%BE%E5%8F%82%E6%95%B0">2.3 Native &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x64AD;&#x653E;&#x53C2;&#x6570;</a></li>
<li><a href="#24-%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86-audiorecordjni">2.4 &#x97F3;&#x9891;&#x91C7;&#x96C6; AudioRecordJni</a></li>
<li><a href="#25-%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE-audiotrackjni">2.5 &#x97F3;&#x9891;&#x64AD;&#x653E; AudioTrackJni</a></li>
</ul>
</li>
<li><a href="#3-%E8%A7%86%E9%A2%91%E5%9B%BE%E5%83%8F%E9%87%87%E9%9B%86%E6%A8%A1%E5%9D%97videocapturer">3 &#x89C6;&#x9891;&#x56FE;&#x50CF;&#x91C7;&#x96C6;&#x6A21;&#x5757;(VideoCapturer)</a>
<ul>
<li><a href="#31-%E5%88%9B%E5%BB%BA%E6%91%84%E5%83%8F%E5%A4%B4%E9%87%87%E9%9B%86%E6%BA%90cameravideocapturer">3.1 &#x521B;&#x5EFA;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#x6E90;(CameraVideoCapturer)</a>
<ul>
<li><a href="#311-%E6%91%84%E5%83%8F%E5%A4%B4-camera1-%E9%87%87%E9%9B%86camera1capturer">3.1.1 &#x6444;&#x50CF;&#x5934; Camera1 &#x91C7;&#x96C6;(Camera1Capturer)</a></li>
<li><a href="#312-%E6%91%84%E5%83%8F%E5%A4%B4-camera2-%E9%87%87%E9%9B%86camera2capturer">3.1.2 &#x6444;&#x50CF;&#x5934; Camera2 &#x91C7;&#x96C6;(Camera2Capturer)</a></li>
</ul>
</li>
<li><a href="#32-%E5%88%9B%E5%BB%BA-videosource">3.2 &#x521B;&#x5EFA; VideoSource</a></li>
<li><a href="#33-%E6%91%84%E5%83%8F%E5%A4%B4%E9%87%87%E9%9B%86%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8F%8A%E5%90%AF%E5%8A%A8">3.3 &#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#x521D;&#x59CB;&#x5316;&#x53CA;&#x542F;&#x52A8;</a>
<ul>
<li><a href="#331-%E5%90%AF%E5%8A%A8-camera1-%E9%87%87%E9%9B%86">3.3.1 &#x542F;&#x52A8; Camera1 &#x91C7;&#x96C6;</a></li>
<li><a href="#332-%E5%90%AF%E5%8A%A8-camera2-%E9%87%87%E9%9B%86">3.3.2 &#x542F;&#x52A8; Camera2 &#x91C7;&#x96C6;</a></li>
</ul>
</li>
<li><a href="#34-%E5%88%9B%E5%BB%BA-videotrack">3.4 &#x521B;&#x5EFA; VideoTrack</a>
<ul>
<li><a href="#341-%E5%88%9B%E5%BB%BA-videotrack">3.4.1 &#x521B;&#x5EFA; VideoTrack</a></li>
<li><a href="#342-%E4%BD%BF%E8%83%BD-videotrack">3.4.2 &#x4F7F;&#x80FD; VideoTrack</a></li>
<li><a href="#343-%E6%B7%BB%E5%8A%A0%E6%B8%B2%E6%9F%93-sink">3.4.3 &#x6DFB;&#x52A0;&#x6E32;&#x67D3; Sink</a></li>
<li><a href="#344-%E6%B7%BB%E5%8A%A0%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81-sink">3.4.4 &#x6DFB;&#x52A0;&#x89C6;&#x9891;&#x7F16;&#x7801; Sink</a></li>
</ul>
</li>
<li><a href="#35-%E6%91%84%E5%83%8F%E5%A4%B4%E8%A7%86%E9%A2%91%E6%95%B0%E6%8D%AE%E6%B5%81">3.5 &#x6444;&#x50CF;&#x5934;&#x89C6;&#x9891;&#x6570;&#x636E;&#x6D41;</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="mume-header" id="1-peerconnection-%E5%88%9B%E5%BB%BA">1 PeerConnection &#x521B;&#x5EFA;</h2>

<p>&#x97F3;&#x89C6;&#x9891;&#x4E92;&#x901A;&#x9700;&#x8981;&#x5148;&#x521B;&#x5EFA; PeerConnection&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x521B;&#x5EFA;&#x53CA;&#x4EA4;&#x6362; Sdp&#xFF0C;&#x4EE5;&#x5B8C;&#x6210;&#x901A;&#x8BDD;&#x5EFA;&#x7ACB;&#x3002;</p>
<h3 class="mume-header" id="11-%E5%88%9B%E5%BB%BA-peerconnectionfactory">1.1 &#x521B;&#x5EFA; PeerConnectionFactory</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// CallActivity.java</span>
<span class="token class-name">CallActivity</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create peer connection client.</span>
    <span class="token comment">// &#x521B;&#x5EFA; peer connection client, &#x5E76;&#x8C03;&#x7528; PeerConnectionFactory.initialize() &#x52A0;&#x8F7D;&#x52A8;&#x6001;&#x5E93;&#x53CA;&#x4E0A;&#x4E0B;&#x6587;&#x73AF;&#x5883;&#x7B49;.</span>
    peerConnectionClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnectionClient</span><span class="token punctuation">(</span>
        <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> eglBase<span class="token punctuation">,</span> peerConnectionParameters<span class="token punctuation">,</span> <span class="token class-name">CallActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnectionFactory */</span>
    <span class="token class-name">PeerConnectionFactory<span class="token punctuation">.</span>Options</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnectionFactory<span class="token punctuation">.</span>Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PeerConnectionClient</span><span class="token punctuation">.</span><span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    
    <span class="token comment">/* &#x5F00;&#x59CB;&#x901A;&#x8BDD;&#x5EFA;&#x7ACB; */</span>
    <span class="token function">startCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span><span class="token class-name">PeerConnectionFactory<span class="token punctuation">.</span>Options</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;PeerConnectionFactory has already been constructed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">createPeerConnectionFactoryInternal</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">createPeerConnectionFactoryInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757; */</span>
    <span class="token keyword">final</span> <span class="token class-name">AudioDeviceModule</span> adm <span class="token operator">=</span> <span class="token function">createJavaAudioDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x89C6;&#x9891;&#x7F16;&#x7801;&#x662F;&#x5426;&#x4F7F;&#x80FD; H264 high level profile */</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> enableH264HighProfile <span class="token operator">=</span>
        VIDEO_CODEC_H264_HIGH<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCodec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">VideoEncoderFactory</span> encoderFactory<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">VideoDecoderFactory</span> decoderFactory<span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA;&#x89C6;&#x9891;&#x7F16;&#x89E3;&#x7801;&#x5DE5;&#x5382;, &#x8F6F;&#x7F16;&#x6216;&#x786C;&#x7F16; */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCodecHwAcceleration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      encoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultVideoEncoderFactory</span><span class="token punctuation">(</span>
          rootEglBase<span class="token punctuation">.</span><span class="token function">getEglBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* enableIntelVp8Encoder */</span><span class="token punctuation">,</span> enableH264HighProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      decoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultVideoDecoderFactory</span><span class="token punctuation">(</span>rootEglBase<span class="token punctuation">.</span><span class="token function">getEglBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      encoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftwareVideoEncoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      decoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftwareVideoDecoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* &#x6784;&#x5EFA; PeerConnectionFactory */</span>
    factory <span class="token operator">=</span> <span class="token class-name">PeerConnectionFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setAudioDeviceModule</span><span class="token punctuation">(</span>adm<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setVideoEncoderFactory</span><span class="token punctuation">(</span>encoderFactory<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setVideoDecoderFactory</span><span class="token punctuation">(</span>decoderFactory<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    adm<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/PeerConnectionFactory.java</span>
<span class="token comment">// PeerConnectionFactory.Builder</span>
<span class="token keyword">public</span> <span class="token class-name">PeerConnectionFactory</span> <span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x901A;&#x8FC7; Jni &#x521B;&#x5EFA; Native &#x5C42; PeerConnectionFactory &#x5BF9;&#x8C61;</span>
    <span class="token keyword">return</span> <span class="token function">nativeCreatePeerConnectionFactory</span><span class="token punctuation">(</span><span class="token class-name">ContextUtils</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span>
        <span class="token comment">/* &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x8BBE;&#x5907; Native C++&#x6307;&#x9488; */</span>
        audioDeviceModule<span class="token punctuation">.</span><span class="token function">getNativeAudioDeviceModulePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x7F16;&#x7801;&#x5DE5;&#x5382;&#x7C7B; Native C++ &#x6307;&#x9488; */</span>
        audioEncoderFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeAudioEncoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x89E3;&#x7801;&#x5DE5;&#x5382;&#x7C7B; Native C++ &#x6307;&#x9488; */</span>
        audioDecoderFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeAudioDecoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token comment">/* &#x89C6;&#x9891;&#x7F16;&#x7801;&#x5668;&#x5DE5;&#x5382;&#x7C7B;&#x5BF9;&#x8C61; */</span>
        videoEncoderFactory<span class="token punctuation">,</span>
        <span class="token comment">/* &#x89C6;&#x9891;&#x89E3;&#x7801;&#x5668;&#x5DE5;&#x5382;&#x7C7B;&#x5BF9;&#x8C61; */</span>
        videoDecoderFactory<span class="token punctuation">,</span>
        <span class="token comment">/* &#x97F3;&#x9891;&#x589E;&#x5F3A;&#x5904;&#x7406;&#xFF0C;&#x6B64;&#x5904;&#x4E3A; null */</span>
        audioProcessingFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> audioProcessingFactory<span class="token punctuation">.</span><span class="token function">createNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* fec &#x63A7;&#x5236;&#x5668;&#xFF0C;&#x6B64;&#x5904;&#x4E3A; null */</span>
        fecControllerFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> fecControllerFactoryFactory<span class="token punctuation">.</span><span class="token function">createNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        networkControllerFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token number">0</span>
            <span class="token operator">:</span> networkControllerFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeNetworkControllerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        networkStatePredictorFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token number">0</span>
            <span class="token operator">:</span> networkStatePredictorFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeNetworkStatePredictorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        mediaTransportFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token number">0</span>
            <span class="token operator">:</span> mediaTransportFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeMediaTransportFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        neteqFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> neteqFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeNetEqFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnection_factory_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; sdk/android/api/org/webrtc/PeerConnectionFactory.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x52A8;&#x6001;&#x751F;&#x6210;</span>
<span class="token comment">/* &#x521B;&#x5EFA; Native &#x5C42; PeerConnectionFactory &#x5BF9;&#x8C61; */</span>
JNI_GENERATOR_EXPORT jobject
    <span class="token function">Java_org_webrtc_PeerConnectionFactory_nativeCreatePeerConnectionFactory</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jobject context<span class="token punctuation">,</span>
    jobject options<span class="token punctuation">,</span>
    jlong nativeAudioDeviceModule<span class="token punctuation">,</span>
    jlong audioEncoderFactory<span class="token punctuation">,</span>
    jlong audioDecoderFactory<span class="token punctuation">,</span>
    jobject encoderFactory<span class="token punctuation">,</span>
    jobject decoderFactory<span class="token punctuation">,</span>
    jlong nativeAudioProcessor<span class="token punctuation">,</span>
    jlong nativeFecControllerFactory<span class="token punctuation">,</span>
    jlong nativeNetworkControllerFactory<span class="token punctuation">,</span>
    jlong nativeNetworkStatePredictorFactory<span class="token punctuation">,</span>
    jlong mediaTransportFactory<span class="token punctuation">,</span>
    jlong neteqFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">JNI_PeerConnectionFactory_CreatePeerConnectionFactory</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        nativeAudioDeviceModule<span class="token punctuation">,</span> 
        audioEncoderFactory<span class="token punctuation">,</span> audioDecoderFactory<span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> encoderFactory<span class="token punctuation">)</span><span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> decoderFactory<span class="token punctuation">)</span><span class="token punctuation">,</span>
        nativeAudioProcessor<span class="token punctuation">,</span>
        nativeFecControllerFactory<span class="token punctuation">,</span> nativeNetworkControllerFactory<span class="token punctuation">,</span>
        nativeNetworkStatePredictorFactory<span class="token punctuation">,</span> mediaTransportFactory<span class="token punctuation">,</span> neteqFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection_factory.cc</span>
<span class="token keyword">static</span> ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span>
<span class="token function">JNI_PeerConnectionFactory_CreatePeerConnectionFactory</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jcontext<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> joptions<span class="token punctuation">,</span>
    jlong native_audio_device_module<span class="token punctuation">,</span>
    jlong native_audio_encoder_factory<span class="token punctuation">,</span>
    jlong native_audio_decoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jencoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jdecoder_factory<span class="token punctuation">,</span>
    jlong native_audio_processor<span class="token punctuation">,</span>
    jlong native_fec_controller_factory<span class="token punctuation">,</span>
    jlong native_network_controller_factory<span class="token punctuation">,</span>
    jlong native_network_state_predictor_factory<span class="token punctuation">,</span>
    jlong native_media_transport_factory<span class="token punctuation">,</span>
    jlong native_neteq_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioProcessing<span class="token operator">&gt;</span> audio_processor <span class="token operator">=</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>AudioProcessing<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">CreatePeerConnectionFactoryForJava</span><span class="token punctuation">(</span>
      jni<span class="token punctuation">,</span> jcontext<span class="token punctuation">,</span> joptions<span class="token punctuation">,</span>
      <span class="token comment">// Native &#x97F3;&#x9891;&#x8BBE;&#x5907;&#x5BF9;&#x8C61;</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>AudioDeviceModule<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_device_module<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfRefPtr<span class="token operator">&lt;</span>AudioEncoderFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_encoder_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfRefPtr<span class="token operator">&lt;</span>AudioDecoderFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_decoder_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jencoder_factory<span class="token punctuation">,</span> jdecoder_factory<span class="token punctuation">,</span>
      <span class="token comment">// &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x589E;&#x5F3A;&#x5904;&#x7406;&#x5BF9;&#x8C61;</span>
      audio_processor <span class="token operator">?</span> audio_processor <span class="token operator">:</span> <span class="token function">CreateAudioProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>FecControllerFactoryInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_fec_controller_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>NetworkControllerFactoryInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_network_controller_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>NetworkStatePredictorFactoryInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_network_state_predictor_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>MediaTransportFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_media_transport_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>NetEqFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>native_neteq_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Following parameters are optional:</span>
<span class="token comment">// |audio_device_module|, |jencoder_factory|, |jdecoder_factory|,</span>
<span class="token comment">// |audio_processor|, |media_transport_factory|, |fec_controller_factory|,</span>
<span class="token comment">// |network_state_predictor_factory|, |neteq_factory|.</span>
ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">CreatePeerConnectionFactoryForJava</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jcontext<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> joptions<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioDeviceModule<span class="token operator">&gt;</span> audio_device_module<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioEncoderFactory<span class="token operator">&gt;</span> audio_encoder_factory<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioDecoderFactory<span class="token operator">&gt;</span> audio_decoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jencoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jdecoder_factory<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioProcessing<span class="token operator">&gt;</span> audio_processor<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>FecControllerFactoryInterface<span class="token operator">&gt;</span> fec_controller_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NetworkControllerFactoryInterface<span class="token operator">&gt;</span>
        network_controller_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NetworkStatePredictorFactoryInterface<span class="token operator">&gt;</span>
        network_state_predictor_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>MediaTransportFactory<span class="token operator">&gt;</span> media_transport_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NetEqFactory<span class="token operator">&gt;</span> neteq_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// talk/ assumes pretty widely that the current Thread is ThreadManager&apos;d, but</span>
    <span class="token comment">// ThreadManager only WrapCurrentThread()s the thread where it is first</span>
    <span class="token comment">// created.  Since the semantics around when auto-wrapping happens in</span>
    <span class="token comment">// webrtc/rtc_base/ are convoluted, we simply wrap here to avoid having to</span>
    <span class="token comment">// think about ramifications of auto-wrapping there.</span>
    rtc<span class="token operator">::</span><span class="token class-name">ThreadManager</span><span class="token operator">::</span><span class="token function">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">WrapCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; network &#x7EBF;&#x7A0B;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> network_thread <span class="token operator">=</span>
        rtc<span class="token operator">::</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">CreateWithSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    network_thread<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span><span class="token string">&quot;network_thread&quot;</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>network_thread<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to start thread&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; worker &#x7EBF;&#x7A0B;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> worker_thread <span class="token operator">=</span> rtc<span class="token operator">::</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker_thread<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span><span class="token string">&quot;worker_thread&quot;</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>worker_thread<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to start thread&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; signaling &#x7EBF;&#x7A0B;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> signaling_thread <span class="token operator">=</span> rtc<span class="token operator">::</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    signaling_thread<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span><span class="token string">&quot;signaling_thread&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>signaling_thread<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to start thread&quot;</span><span class="token punctuation">;</span>

    rtc<span class="token operator">::</span>NetworkMonitorFactory<span class="token operator">*</span> network_monitor_factory <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> absl<span class="token operator">::</span>optional<span class="token operator">&lt;</span>PeerConnectionFactoryInterface<span class="token operator">::</span>Options<span class="token operator">&gt;</span> options <span class="token operator">=</span>
        <span class="token function">JavaToNativePeerConnectionFactoryOptions</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> joptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Do not create network_monitor_factory only if the options are</span>
    <span class="token comment">// provided and disable_network_monitor therein is set to true.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token operator">-&gt;</span>disable_network_monitor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        network_monitor_factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">AndroidNetworkMonitorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rtc<span class="token operator">::</span><span class="token class-name">NetworkMonitorFactory</span><span class="token operator">::</span><span class="token function">SetFactory</span><span class="token punctuation">(</span>network_monitor_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    PeerConnectionFactoryDependencies dependencies<span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>network_thread <span class="token operator">=</span> network_thread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>worker_thread <span class="token operator">=</span> worker_thread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>signaling_thread <span class="token operator">=</span> signaling_thread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>task_queue_factory <span class="token operator">=</span> <span class="token function">CreateDefaultTaskQueueFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>call_factory <span class="token operator">=</span> <span class="token function">CreateCallFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>event_log_factory <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>RtcEventLogFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>
        dependencies<span class="token punctuation">.</span>task_queue_factory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>fec_controller_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>fec_controller_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>network_controller_factory <span class="token operator">=</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_controller_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>network_state_predictor_factory <span class="token operator">=</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_state_predictor_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>media_transport_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>media_transport_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>neteq_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>neteq_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cricket<span class="token operator">::</span>MediaEngineDependencies media_dependencies<span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>task_queue_factory <span class="token operator">=</span> dependencies<span class="token punctuation">.</span>task_queue_factory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x5916;&#x90E8;&#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;</span>
    media_dependencies<span class="token punctuation">.</span>adm <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_device_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>audio_encoder_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_encoder_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>audio_decoder_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_decoder_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>audio_processing <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>video_encoder_factory <span class="token operator">=</span>
        absl<span class="token operator">::</span><span class="token function">WrapUnique</span><span class="token punctuation">(</span><span class="token function">CreateVideoEncoderFactory</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> jencoder_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>video_decoder_factory <span class="token operator">=</span>
        absl<span class="token operator">::</span><span class="token function">WrapUnique</span><span class="token punctuation">(</span><span class="token function">CreateVideoDecoderFactory</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> jdecoder_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x521B;&#x5EFA; MediaEngine</span>
    dependencies<span class="token punctuation">.</span>media_engine <span class="token operator">=</span>
        cricket<span class="token operator">::</span><span class="token function">CreateMediaEngine</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>media_dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; PeerConnectionFactory&#xFF0C;&#x6B64;&#x8C03;&#x7528;&#x4E0E;&#x5176;&#x4ED6;&#x5E73;&#x53F0;&#x76F8;&#x540C;</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>PeerConnectionFactoryInterface<span class="token operator">&gt;</span> factory <span class="token operator">=</span>
        <span class="token function">CreateModularPeerConnectionFactory</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to create the peer connection factory; &quot;</span>
                            <span class="token string">&quot;WebRTC/libjingle init likely failed on this device&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO(honghaiz): Maybe put the options as the argument of</span>
    <span class="token comment">// CreatePeerConnectionFactory.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        factory<span class="token operator">-&gt;</span><span class="token function">SetOptions</span><span class="token punctuation">(</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">NativeToScopedJavaPeerConnectionFactory</span><span class="token punctuation">(</span>
        jni<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>worker_thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>signaling_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> network_monitor_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">NativeToScopedJavaPeerConnectionFactory</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>webrtc<span class="token operator">::</span>PeerConnectionFactoryInterface<span class="token operator">&gt;</span> pcf<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> network_thread<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> worker_thread<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> signaling_thread<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>NetworkMonitorFactory<span class="token operator">*</span> network_monitor_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// OwnedFactoryAndThreads &#x4FDD;&#x5B58;&#x7EF4;&#x62A4; Native Factory &#x5BF9;&#x8C61;</span>
    OwnedFactoryAndThreads<span class="token operator">*</span> owned_factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">OwnedFactoryAndThreads</span><span class="token punctuation">(</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>worker_thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>signaling_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> network_monitor_factory<span class="token punctuation">,</span> pcf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; Java &#x5C42;&#x7684; PeerConnectionFactory &#x5B9E;&#x4F8B;</span>
    ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> j_pcf <span class="token operator">=</span> <span class="token function">Java_PeerConnectionFactory_Constructor</span><span class="token punctuation">(</span>
        env<span class="token punctuation">,</span> <span class="token function">NativeToJavaPointer</span><span class="token punctuation">(</span>owned_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x56DE;&#x8C03; PeerConnectionFactory.onNetworkThreadReady()</span>
    <span class="token function">PostJavaCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> owned_factory<span class="token operator">-&gt;</span><span class="token function">network_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTC_FROM_HERE<span class="token punctuation">,</span> j_pcf<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>Java_PeerConnectionFactory_onNetworkThreadReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x56DE;&#x8C03; PeerConnectionFactory.onWorkerThreadReady()</span>
    <span class="token function">PostJavaCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> owned_factory<span class="token operator">-&gt;</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTC_FROM_HERE<span class="token punctuation">,</span> j_pcf<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>Java_PeerConnectionFactory_onWorkerThreadReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x56DE;&#x8C03; PeerConnectionFactory.onSignalingThreadReady()</span>
    <span class="token function">PostJavaCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> owned_factory<span class="token operator">-&gt;</span><span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTC_FROM_HERE<span class="token punctuation">,</span> j_pcf<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>Java_PeerConnectionFactory_onSignalingThreadReady<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> j_pcf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> base<span class="token operator">::</span>android<span class="token operator">::</span>ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">Java_PeerConnectionFactory_Constructor</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span>
    env<span class="token punctuation">,</span> jlong nativeFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_PeerConnectionFactory_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_PeerConnectionFactory_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_PeerConnectionFactory_Constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x6784;&#x9020; Java &#x5C42; PeerConnectionFactory &#x5B9E;&#x4F8B;</span>
    jobject ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">NewObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> base<span class="token operator">::</span>android<span class="token operator">::</span>ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="12-%E5%88%9B%E5%BB%BA-peerconnection">1.2 &#x521B;&#x5EFA; PeerConnection</h3>

<ol>
<li>&#x8FDE;&#x63A5;&#x4E0A;&#x623F;&#x95F4;&#x670D;&#x52A1;&#x5668;&#xFF1B;</li>
<li>&#x82E5;&#x4F7F;&#x80FD;&#x89C6;&#x9891;&#xFF0C;&#x5219;&#x5148;&#x521B;&#x5EFA;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90;&#xFF1B;</li>
<li>&#x521B;&#x5EFA; PeerConnection&#xFF1B;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// CallActivity.java</span>
<span class="token comment">/* &#x4FE1;&#x4EE4;&#x5C42;&#x8FDE;&#x63A5;&#x623F;&#x95F4;&#x670D;&#x52A1;&#x5668;&#x6210;&#x529F;, &#x521B;&#x5EFA; PeerConnection, &#x82E5;&#x662F;&#x4E3B;&#x53EB;&#x7AEF;&#x5219;&#x521B;&#x5EFA; offer sdp&#xFF0C;&#x82E5;&#x662F;&#x88AB;&#x53EB;&#x7AEF;&#x5219;&#x9700;&#x8BBE;&#x7F6E;&#x8FDC;&#x7AEF; Sdp &#x53CA;&#x521B;&#x5EFA;&#x672C;&#x7AEF; Sdp */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onConnectedToRoomInternal</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SignalingParameters</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> delta <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> callStartedTimeMs<span class="token punctuation">;</span>

    signalingParameters <span class="token operator">=</span> params<span class="token punctuation">;</span>
    <span class="token function">logAndToast</span><span class="token punctuation">(</span><span class="token string">&quot;Creating peer connection, delay=&quot;</span> <span class="token operator">+</span> delta <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x5B9E;&#x4F8B;&#xFF0C;&#x53EF;&#x4E3A;&#xFF1A;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x3001;&#x5C4F;&#x5E55;&#x5171;&#x4EAB;&#x3001;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6; */</span>
    <span class="token class-name">VideoCapturer</span> videoCapturer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCallEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        videoCapturer <span class="token operator">=</span> <span class="token function">createVideoCapturer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnection */</span>
    peerConnectionClient<span class="token punctuation">.</span><span class="token function">createPeerConnection</span><span class="token punctuation">(</span>
        localProxyVideoSink<span class="token punctuation">,</span> remoteSinks<span class="token punctuation">,</span> videoCapturer<span class="token punctuation">,</span> signalingParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>signalingParameters<span class="token punctuation">.</span>initiator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logAndToast</span><span class="token punctuation">(</span><span class="token string">&quot;Creating OFFER...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Create offer. Offer SDP will be sent to answering client in</span>
        <span class="token comment">// PeerConnectionEvents.onLocalDescription event.</span>
        peerConnectionClient<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>offerSdp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            peerConnectionClient<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>offerSdp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">logAndToast</span><span class="token punctuation">(</span><span class="token string">&quot;Creating ANSWER...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Create answer. Answer SDP will be sent to offering client in</span>
            <span class="token comment">// PeerConnectionEvents.onLocalDescription event.</span>
            peerConnectionClient<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>iceCandidates <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Add remote ICE candidates from room.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IceCandidate</span> iceCandidate <span class="token operator">:</span> params<span class="token punctuation">.</span>iceCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                peerConnectionClient<span class="token punctuation">.</span><span class="token function">addRemoteIceCandidate</span><span class="token punctuation">(</span>iceCandidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">VideoSink</span> localRender<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">VideoSink</span> remoteSink<span class="token punctuation">,</span>
      <span class="token keyword">final</span> <span class="token class-name">VideoCapturer</span> videoCapturer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SignalingParameters</span> signalingParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCallEnabled <span class="token operator">&amp;&amp;</span> videoCapturer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Video call enabled but no video capturer provided.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">createPeerConnection</span><span class="token punctuation">(</span>
        localRender<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>remoteSink<span class="token punctuation">)</span><span class="token punctuation">,</span> videoCapturer<span class="token punctuation">,</span> signalingParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">VideoSink</span> localRender<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VideoSink</span><span class="token punctuation">&gt;</span></span> remoteSinks<span class="token punctuation">,</span>
      <span class="token keyword">final</span> <span class="token class-name">VideoCapturer</span> videoCapturer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SignalingParameters</span> signalingParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating peer connection without initializing factory.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x672C;&#x5730;&#x9884;&#x89C8;&#x7684; sink</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>localRender <span class="token operator">=</span> localRender<span class="token punctuation">;</span>
    <span class="token comment">// &#x8FDC;&#x7AEF;&#x6E32;&#x67D3;&#x7684; sink</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>remoteSinks <span class="token operator">=</span> remoteSinks<span class="token punctuation">;</span>
    <span class="token comment">// &#x89C6;&#x9891;&#x6E90;&#x5B9E;&#x4F8B;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>videoCapturer <span class="token operator">=</span> videoCapturer<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>signalingParameters <span class="token operator">=</span> signalingParameters<span class="token punctuation">;</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">createMediaConstraintsInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">createPeerConnectionInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">maybeCreateAndStartRtcEventLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create peer connection: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createPeerConnectionInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> isError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Peerconnection factory is not created&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Create peer connection.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    queuedRemoteCandidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">PeerConnection<span class="token punctuation">.</span>RTCConfiguration</span> rtcConfig <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>RTCConfiguration</span><span class="token punctuation">(</span>signalingParameters<span class="token punctuation">.</span>iceServers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TCP candidates are only useful when connecting to a server that supports</span>
    <span class="token comment">// ICE-TCP.</span>
    rtcConfig<span class="token punctuation">.</span>tcpCandidatePolicy <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>TcpCandidatePolicy</span><span class="token punctuation">.</span>DISABLED<span class="token punctuation">;</span>
    rtcConfig<span class="token punctuation">.</span>bundlePolicy <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>BundlePolicy</span><span class="token punctuation">.</span>MAXBUNDLE<span class="token punctuation">;</span>
    rtcConfig<span class="token punctuation">.</span>rtcpMuxPolicy <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>RtcpMuxPolicy</span><span class="token punctuation">.</span>REQUIRE<span class="token punctuation">;</span>
    rtcConfig<span class="token punctuation">.</span>continualGatheringPolicy <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>ContinualGatheringPolicy</span><span class="token punctuation">.</span>GATHER_CONTINUALLY<span class="token punctuation">;</span>
    <span class="token comment">// Use ECDSA encryption.</span>
    rtcConfig<span class="token punctuation">.</span>keyType <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>KeyType</span><span class="token punctuation">.</span>ECDSA<span class="token punctuation">;</span>
    <span class="token comment">// Enable DTLS for normal calls and disable for loopback calls.</span>
    rtcConfig<span class="token punctuation">.</span>enableDtlsSrtp <span class="token operator">=</span> <span class="token operator">!</span>peerConnectionParameters<span class="token punctuation">.</span>loopback<span class="token punctuation">;</span>
    <span class="token comment">/* Sdp &#x8BED;&#x6CD5;&#x4F7F;&#x7528; Unified Plan &#x6A21;&#x5F0F; */</span>
    rtcConfig<span class="token punctuation">.</span>sdpSemantics <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>SdpSemantics</span><span class="token punctuation">.</span>UNIFIED_PLAN<span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnection */</span>
    peerConnection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createPeerConnection</span><span class="token punctuation">(</span>rtcConfig<span class="token punctuation">,</span> pcObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataChannelEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* create data channel */</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    isInitiator <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// Set INFO libjingle logging.</span>
    <span class="token comment">// NOTE: this _must_ happen while |factory| is alive!</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">enableLogToDebugOutput</span><span class="token punctuation">(</span><span class="token class-name">Logging<span class="token punctuation">.</span>Severity</span><span class="token punctuation">.</span>LS_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mediaStreamLabels <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">&quot;ARDAMS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVideoCallEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x5E76;&#x6DFB;&#x52A0;&#x89C6;&#x9891;&#x6E90;&#x5230; PeerConnection, &#x521B;&#x5EFA; VideoTrack &#x65F6;&#x5C06;&#x542F;&#x52A8;&#x89C6;&#x9891;&#x6E90;&#x91C7;&#x96C6; */</span>
        peerConnection<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span><span class="token function">createVideoTrack</span><span class="token punctuation">(</span>videoCapturer<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaStreamLabels<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// We can add the renderers right away because we don&apos;t need to wait for an</span>
        <span class="token comment">// answer to get the remote track.</span>
        remoteVideoTrack <span class="token operator">=</span> <span class="token function">getRemoteVideoTrack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        remoteVideoTrack<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span>renderVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">VideoSink</span> remoteSink <span class="token operator">:</span> remoteSinks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            remoteVideoTrack<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>remoteSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x521B;&#x5EFA;&#x5E76;&#x6DFB;&#x52A0;&#x97F3;&#x9891;&#x6E90; AudioTrack &#x5230; PeerConnection</span>
    peerConnection<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span><span class="token function">createAudioTrack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mediaStreamLabels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVideoCallEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">findVideoSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Peer connection created.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/PeerConnectionFactory.java</span>
<span class="token keyword">public</span> <span class="token class-name">PeerConnection</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span>
      <span class="token class-name">PeerConnection<span class="token punctuation">.</span>RTCConfiguration</span> rtcConfig<span class="token punctuation">,</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>Observer</span> observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span>rtcConfig<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* constraints */</span><span class="token punctuation">,</span> observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">PeerConnection</span> <span class="token function">createPeerConnectionInternal</span><span class="token punctuation">(</span><span class="token class-name">PeerConnection<span class="token punctuation">.</span>RTCConfiguration</span> rtcConfig<span class="token punctuation">,</span>
      <span class="token class-name">MediaConstraints</span> constraints<span class="token comment">/* null */</span><span class="token punctuation">,</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>Observer</span> observer<span class="token punctuation">,</span>
      <span class="token class-name">SSLCertificateVerifier</span> sslCertificateVerifier<span class="token comment">/* null */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkPeerConnectionFactoryExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x521B;&#x5EFA; PeerConnection.Observer &#x7684; Native &#x5C42;&#x5173;&#x8054;&#x5BF9;&#x8C61;</span>
    <span class="token keyword">long</span> nativeObserver <span class="token operator">=</span> <span class="token class-name">PeerConnection</span><span class="token punctuation">.</span><span class="token function">createNativePeerConnectionObserver</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeObserver <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> nativePeerConnection <span class="token operator">=</span> <span class="token function">nativeCreatePeerConnection</span><span class="token punctuation">(</span>
        nativeFactory<span class="token punctuation">,</span> rtcConfig<span class="token punctuation">,</span> constraints<span class="token punctuation">,</span> nativeObserver<span class="token punctuation">,</span> sslCertificateVerifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nativePeerConnection <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnection</span><span class="token punctuation">(</span>nativePeerConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/PeerConnection.java</span>
<span class="token class-name">PeerConnection</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativePeerConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativePeerConnection <span class="token operator">=</span> nativePeerConnection<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>&#x7ED1;&#x5B9A; Java &#x5C42; PeerConnection Observer &#x5BF9;&#x8C61;&#xFF0C;&#x540E;&#x7EED;&#x901A;&#x8FC7;&#x8BE5; Observer &#x5C06; Native &#x5C42;&#x4E8B;&#x4EF6;&#x56DE;&#x8C03;&#x5230; Java &#x5C42;&#x3002;<br>
&#x5176;&#x4E2D;&#xFF0C;PeerConnectionObserverJni &#x4E3A;Android&#x7AEF; PeerConnectionObserver &#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x3002;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnection_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; PeerConnection.java &#x751F;&#x6210;</span>
JNI_GENERATOR_EXPORT jlong <span class="token function">Java_org_webrtc_PeerConnection_nativeCreatePeerConnectionObserver</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jobject observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_PeerConnection_CreatePeerConnectionObserver</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> observer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_PeerConnection_CreatePeerConnectionObserver</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">PeerConnectionObserverJni</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_observer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">PeerConnectionObserverJni</span><span class="token operator">::</span><span class="token function">PeerConnectionObserverJni</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_observer<span class="token punctuation">)</span>
    <span class="token comment">// &#x521B;&#x5EFA; Observer Object &#x7684; global &#x5F15;&#x7528;</span>
    <span class="token operator">:</span> <span class="token function">j_observer_global_</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_observer<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre><p>&#x521B;&#x5EFA; Native &#x5C42; PeerConnection &#x5BF9;&#x8C61;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnection_factory_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; sdk/android/api/org/webrtc/PeerConnectionFactory.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x52A8;&#x6001;&#x751F;&#x6210;</span>
<span class="token comment">/* &#x521B;&#x5EFA; Native &#x5C42; PeerConnection &#x5BF9;&#x8C61; */</span>
JNI_GENERATOR_EXPORT jlong <span class="token function">Java_org_webrtc_PeerConnectionFactory_nativeCreatePeerConnection</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jlong factory<span class="token punctuation">,</span>
    jobject rtcConfig<span class="token punctuation">,</span>
    jobject constraints<span class="token punctuation">,</span> <span class="token comment">// null</span>
    jlong nativeObserver<span class="token punctuation">,</span>
    jobject sslCertificateVerifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_PeerConnectionFactory_CreatePeerConnection</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> factory<span class="token punctuation">,</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> rtcConfig<span class="token punctuation">)</span><span class="token punctuation">,</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> constraints<span class="token punctuation">)</span><span class="token punctuation">,</span> nativeObserver<span class="token punctuation">,</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> sslCertificateVerifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection_factory.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_PeerConnectionFactory_CreatePeerConnection</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    jlong factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_rtc_config<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_constraints<span class="token punctuation">,</span> <span class="token comment">/* null */</span>
    jlong observer_p<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_sslCertificateVerifier <span class="token comment">/* null */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* PeerConnectionObserver */</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>PeerConnectionObserver<span class="token operator">&gt;</span> <span class="token function">observer</span><span class="token punctuation">(</span>
        <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>PeerConnectionObserver<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>observer_p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// RTCConfiguration &#x62F7;&#x8D1D;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// rtc::RTCCertificate &#x751F;&#x6210;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// MediaConstraints &#x62F7;&#x8D1D;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    PeerConnectionDependencies <span class="token function">peer_connection_dependencies</span><span class="token punctuation">(</span>observer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// SSLCertificateVerifierWrapper &#x521B;&#x5EFA;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnection&#xFF0C;&#x8BE5;&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x4E0E;&#x5404;&#x5E73;&#x53F0;&#x4E00;&#x81F4; */</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>PeerConnectionInterface<span class="token operator">&gt;</span> pc <span class="token operator">=</span>
        <span class="token function">PeerConnectionFactoryFromJava</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">CreatePeerConnection</span><span class="token punctuation">(</span>
            rtc_config<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>peer_connection_dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pc<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8FD4;&#x56DE; PeerConnection &#x5C01;&#x88C5;&#x5BF9;&#x8C61; */</span>
    <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token function">OwnedPeerConnection</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>constraints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/peer_connection_factory.cc</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>PeerConnectionInterface<span class="token operator">&gt;</span>
<span class="token class-name">PeerConnectionFactory</span><span class="token operator">::</span><span class="token function">CreatePeerConnection</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> PeerConnectionInterface<span class="token operator">::</span>RTCConfiguration<span class="token operator">&amp;</span> configuration<span class="token punctuation">,</span>
    PeerConnectionDependencies dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// &#x521B;&#x5EFA; PeerConnection</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>PeerConnection<span class="token operator">&gt;</span> <span class="token function">pc</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>PeerConnection<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>event_log<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ActionsBeforeInitializeForTesting</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// PeerConnection &#x521D;&#x59CB;&#x5316;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pc<span class="token operator">-&gt;</span><span class="token function">Initialize</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">PeerConnectionProxy</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="13-%E5%88%9B%E5%BB%BA-videotrack">1.3 &#x521B;&#x5EFA; VideoTrack</h3>

<ol>
<li>&#x521B;&#x5EFA;&#x89C6;&#x9891;&#x6E32;&#x67D3;&#x5904;&#x7406; SurfaceTextureHelper&#xFF1B;</li>
<li>&#x521B;&#x5EFA; VideoSource;</li>
<li>&#x521D;&#x59CB;&#x5316;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90;&#x5E76;&#x542F;&#x52A8;&#xFF0C;&#x8BBE;&#x7F6E;&#x89C6;&#x9891;&#x6570;&#x636E;&#x56DE;&#x8C03;&#x76D1;&#x542C;&#x4E3A; VideoSource &#x5185;&#x5B9E;&#x73B0;&#x7684; CapturerObserver&#xFF1B;</li>
<li>&#x521B;&#x5EFA; VideoTrack&#xFF0C;&#x5E76;&#x4F5C;&#x4E3A; VideoSink &#x6CE8;&#x518C;&#x5230; VideoSource &#x5185;&#xFF1B;</li>
<li>VideoTrack &#x4F7F;&#x80FD;&#x89C6;&#x9891;&#x6E32;&#x67D3;&#xFF1B;</li>
<li>VideoTrack &#x6DFB;&#x52A0;&#x672C;&#x5730;&#x9884;&#x89C8;Sink&#x3002;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token keyword">private</span> <span class="token class-name">VideoTrack</span> <span class="token function">createVideoTrack</span><span class="token punctuation">(</span><span class="token class-name">VideoCapturer</span> capturer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x89C6;&#x9891;&#x6E90;&#x7EB9;&#x7406;&#x6570;&#x636E;&#x6E32;&#x67D3;&#x5B9E;&#x4F8B;&#xFF0C;&#x7ECF;&#x8FC7;&#x8BE5;&#x5B9E;&#x4F8B;&#x7EB9;&#x7406;&#x5904;&#x7406;&#x540E;&#x7684;&#x6570;&#x636E;&#x901A;&#x8FC7; CapturerObserver &#x56DE;&#x8C03;&#x51FA;&#x6765;&#x7528;&#x4E8E;&#x7F16;&#x7801;&#x6216;&#x9884;&#x89C8;(Camera2)</span>
    surfaceTextureHelper <span class="token operator">=</span>
        <span class="token class-name">SurfaceTextureHelper</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;CaptureThread&quot;</span><span class="token punctuation">,</span> rootEglBase<span class="token punctuation">.</span><span class="token function">getEglBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// &#x521B;&#x5EFA; VideoSource</span>
    videoSource <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createVideoSource</span><span class="token punctuation">(</span>capturer<span class="token punctuation">.</span><span class="token function">isScreencast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521D;&#x59CB;&#x5316;&#x53CA;&#x542F;&#x52A8;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#xFF0C;&#x6444;&#x50CF;&#x5934;&#x7684;&#x8BDD;&#xFF0C;&#x8C03;&#x7528; CameraCapturer.initialize() &#x63A5;&#x53E3;&#x521D;&#x59CB;&#x5316;&#xFF0C;CapturerObserver &#x4E3A; VideoSource &#x521B;&#x5EFA;</span>
    capturer<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>surfaceTextureHelper<span class="token punctuation">,</span> appContext<span class="token punctuation">,</span> videoSource<span class="token punctuation">.</span><span class="token function">getCapturerObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    capturer<span class="token punctuation">.</span><span class="token function">startCapture</span><span class="token punctuation">(</span>videoWidth<span class="token punctuation">,</span> videoHeight<span class="token punctuation">,</span> videoFps<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; VideoTrack</span>
    localVideoTrack <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createVideoTrack</span><span class="token punctuation">(</span>VIDEO_TRACK_ID<span class="token punctuation">,</span> videoSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x4F7F;&#x80FD;&#x89C6;&#x9891;</span>
    localVideoTrack<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span>renderVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x8BBE;&#x7F6E;&#x9884;&#x89C8; Sink</span>
    localVideoTrack<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>localRender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> localVideoTrack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/SurfaceTextureHelper.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SurfaceTextureHelper</span> <span class="token function">create</span><span class="token punctuation">(</span>
      <span class="token keyword">final</span> <span class="token class-name">String</span> threadName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">EglBase<span class="token punctuation">.</span>Context</span> sharedContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>threadName<span class="token punctuation">,</span> sharedContext<span class="token punctuation">,</span> <span class="token comment">/* alignTimestamps= */</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">YuvConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*frameRefMonitor=*/</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">SurfaceTextureHelper</span><span class="token punctuation">(</span><span class="token class-name">Context</span> sharedContext<span class="token punctuation">,</span> <span class="token class-name">Handler</span> handler<span class="token punctuation">,</span> <span class="token keyword">boolean</span> alignTimestamps<span class="token punctuation">,</span>
      <span class="token class-name">YuvConverter</span> yuvConverter<span class="token punctuation">,</span> <span class="token class-name">FrameRefMonitor</span> frameRefMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;SurfaceTextureHelper must be created on the handler thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timestampAligner <span class="token operator">=</span> alignTimestamps <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">TimestampAligner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>yuvConverter <span class="token operator">=</span> yuvConverter<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>frameRefMonitor <span class="token operator">=</span> frameRefMonitor<span class="token punctuation">;</span>

    eglBase <span class="token operator">=</span> <span class="token class-name">EglBase</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sharedContext<span class="token punctuation">,</span> <span class="token class-name">EglBase</span><span class="token punctuation">.</span>CONFIG_PIXEL_BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Both these statements have been observed to fail on rare occasions, see BUG=webrtc:5682.</span>
        eglBase<span class="token punctuation">.</span><span class="token function">createDummyPbufferSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eglBase<span class="token punctuation">.</span><span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Clean up before rethrowing the exception.</span>
        eglBase<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    oesTextureId <span class="token operator">=</span> <span class="token class-name">GlUtil</span><span class="token punctuation">.</span><span class="token function">generateTexture</span><span class="token punctuation">(</span><span class="token class-name">GLES11Ext</span><span class="token punctuation">.</span>GL_TEXTURE_EXTERNAL_OES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    surfaceTexture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SurfaceTexture</span><span class="token punctuation">(</span>oesTextureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setOnFrameAvailableListener</span><span class="token punctuation">(</span>surfaceTexture<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">SurfaceTexture</span> st<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        hasPendingTexture <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">tryDeliverTextureFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="14-%E6%B7%BB%E5%8A%A0-videotrack">1.4 &#x6DFB;&#x52A0; VideoTrack</h3>

<p>&#x6DFB;&#x52A0;&#x89C6;&#x9891; VideoTrack &#x5230; PeerConnection&#x3002;<br>
&#x5728;&#x6B64;&#x6D41;&#x7A0B;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;RtpSender &#x53CA; RtpReceiver &#x548C;&#x6536;&#x53D1;&#x5668; RtpTransceiver&#x3002;</p>
<p>&#x7B80;&#x8981;&#x4EE3;&#x7801;&#x6D41;&#x7A0B;&#xFF1A;<br>
peerConnection.addTrack(createVideoTrack(videoCapturer), mediaStreamLabels);</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/PeerConnection.java</span>
<span class="token keyword">public</span> <span class="token class-name">RtpSender</span> <span class="token function">addTrack</span><span class="token punctuation">(</span><span class="token class-name">MediaStreamTrack</span> track<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">addTrack</span><span class="token punctuation">(</span>track<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">RtpSender</span> <span class="token function">addTrack</span><span class="token punctuation">(</span><span class="token class-name">MediaStreamTrack</span> track<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> streamIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>track <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> streamIds <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;No MediaStreamTrack specified in addTrack.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// JNI &#x8C03;&#x7528;</span>
    <span class="token class-name">RtpSender</span> newSender <span class="token operator">=</span> <span class="token function">nativeAddTrack</span><span class="token punctuation">(</span>track<span class="token punctuation">.</span><span class="token function">getNativeMediaStreamTrack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> streamIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newSender <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;C++ addTrack failed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    senders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newSender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> newSender<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/RtpSender.java</span>
<span class="token comment">// &#x4ECE; C++ &#x5C42;&#x6784;&#x9020;</span>
<span class="token annotation punctuation">@CalledByNative</span>
<span class="token keyword">public</span> <span class="token class-name">RtpSender</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeRtpSender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeRtpSender <span class="token operator">=</span> nativeRtpSender<span class="token punctuation">;</span>
    <span class="token keyword">long</span> nativeTrack <span class="token operator">=</span> <span class="token function">nativeGetTrack</span><span class="token punctuation">(</span>nativeRtpSender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Java &#x5C42;&#x6700;&#x7EC8;&#x4FDD;&#x5B58; VideoTrack &#x6216; AudioTrack &#x7684;&#x5730;&#x65B9;</span>
    cachedTrack <span class="token operator">=</span> <span class="token class-name">MediaStreamTrack</span><span class="token punctuation">.</span><span class="token function">createMediaStreamTrack</span><span class="token punctuation">(</span>nativeTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> nativeDtmfSender <span class="token operator">=</span> <span class="token function">nativeGetDtmfSender</span><span class="token punctuation">(</span>nativeRtpSender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dtmfSender <span class="token operator">=</span> <span class="token punctuation">(</span>nativeDtmfSender <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">DtmfSender</span><span class="token punctuation">(</span>nativeDtmfSender<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>C++ &#x5C42;&#x8C03;&#x7528;</p>
<pre data-role="codeBlock" data-info="C++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnection_jni.h</span>
JNI_GENERATOR_EXPORT jobject <span class="token function">Java_org_webrtc_PeerConnection_nativeAddTrack</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jobject jcaller<span class="token punctuation">,</span>
    jlong track<span class="token punctuation">,</span>
    jobject streamIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">JNI_PeerConnection_AddTrack</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jcaller<span class="token punctuation">)</span><span class="token punctuation">,</span> track<span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> streamIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection.cc</span>
<span class="token keyword">static</span> ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">JNI_PeerConnection_AddTrack</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_pc<span class="token punctuation">,</span>
    <span class="token keyword">const</span> jlong native_track<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_stream_labels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x5728;&#x6B64;&#x8F6C;&#x5165;&#x5E73;&#x53F0;&#x7EDF;&#x4E00;&#x8C03;&#x7528;&#x63A5;&#x53E3;</span>
    RTCErrorOr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpSenderInterface<span class="token operator">&gt;&gt;</span> result <span class="token operator">=</span>
        <span class="token function">ExtractNativePC</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_pc<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">AddTrack</span><span class="token punctuation">(</span>
            <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>MediaStreamTrackInterface<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_track<span class="token punctuation">)</span><span class="token punctuation">,</span>
            JavaListToNativeVector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token punctuation">,</span> jstring<span class="token operator">&gt;</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_stream_labels<span class="token punctuation">,</span>
                                                        <span class="token operator">&amp;</span>JavaToNativeString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>LS_ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to add track: &quot;</span> <span class="token operator">&lt;&lt;</span> result<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x521B;&#x5EFA; Java &#x5C42; RtpSender</span>
        <span class="token keyword">return</span> <span class="token function">NativeToJavaRtpSender</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">MoveValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/peer_connection.cc</span>
RTCErrorOr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpSenderInterface<span class="token operator">&gt;&gt;</span> <span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">AddTrack</span><span class="token punctuation">(</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>MediaStreamTrackInterface<span class="token operator">&gt;</span> track<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">&gt;</span><span class="token operator">&amp;</span> stream_ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">/* &#x5982;&#x679C;&#x662F; UnifiedPlan&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;&#x6536;&#x53D1;&#x5668; Transceiver&#xFF0C;&#x5305;&#x62EC;&#x53D1;&#x9001;&#x548C;&#x63A5;&#x6536;&#x3002;
     * &#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x4E0D;&#x7528;&#x7BA1;&#x662F;&#x5426;&#x5DF2;&#x521B;&#x5EFA;&#x8FDC;&#x7AEF;&#x6D41;&#xFF0C;&#x63D0;&#x524D;&#x5C06;&#x8FDC;&#x7AEF;&#x6E32;&#x67D3;&#x7684;sink &#x6DFB;&#x52A0;&#x5230;&#x6536;&#x53D1;&#x5668;&#x91CC;&#x9762;&#x7684;&#x63A5;&#x6536; Track&#xFF08;Android &#x662F;&#x8FD9;&#x6837;&#x505A;&#x7684;&#xFF09; */</span>
    <span class="token keyword">auto</span> sender_or_error <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token function">IsUnifiedPlan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">AddTrackUnifiedPlan</span><span class="token punctuation">(</span>track<span class="token punctuation">,</span> stream_ids<span class="token punctuation">)</span>
                        <span class="token operator">:</span> <span class="token function">AddTrackPlanB</span><span class="token punctuation">(</span>track<span class="token punctuation">,</span> stream_ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sender_or_error<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">UpdateNegotiationNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stats_<span class="token operator">-&gt;</span><span class="token function">AddTrack</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sender_or_error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Unified Plan &#x6A21;&#x5F0F;&#x521B;&#x5EFA; RtpSender&#xFF0C;&#x82E5;&#x65E0;&#x6536;&#x53D1;&#x5668;&#x5219;&#x521B;&#x5EFA;&#x6536;&#x53D1;&#x5668; Transeiver&#x53CA; VideoRtpReceiver */</span>
RTCErrorOr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpSenderInterface<span class="token operator">&gt;&gt;</span>
<span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">AddTrackUnifiedPlan</span><span class="token punctuation">(</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>MediaStreamTrackInterface<span class="token operator">&gt;</span> track<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">&gt;</span><span class="token operator">&amp;</span> stream_ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* &#x67E5;&#x627E;&#x672A;&#x8BBE;&#x7F6E; Track &#x4E14;&#x6536;&#x53D1;&#x5668; MediaType &#x4E0E; track &#x76F8;&#x540C;&#xFF0C;&#x5E76;&#x4E14;&#x4E0D;&#x5904;&#x4E8E;&#x53D1;&#x9001;&#x6A21;&#x5F0F;(sendonly,sendrecv)&#x53CA;&#x672A;stop &#x7684;&#x6536;&#x53D1;&#x5668; */</span>
  <span class="token keyword">auto</span> transceiver <span class="token operator">=</span> <span class="token function">FindFirstTransceiverForAddedTrack</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>transceiver<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// &#x5DF2;&#x5B58;&#x5728;&#x6536;&#x53D1;&#x5668;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x4E0D;&#x5B58;&#x5728;&#x6536;&#x53D1;&#x5668; */</span>
    cricket<span class="token operator">::</span>MediaType media_type <span class="token operator">=</span>
        <span class="token punctuation">(</span>track<span class="token operator">-&gt;</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MediaStreamTrackInterface<span class="token operator">::</span>kAudioKind
             <span class="token operator">?</span> cricket<span class="token operator">::</span>MEDIA_TYPE_AUDIO
             <span class="token operator">:</span> cricket<span class="token operator">::</span>MEDIA_TYPE_VIDEO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>LS_INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Adding &quot;</span> <span class="token operator">&lt;&lt;</span> cricket<span class="token operator">::</span><span class="token function">MediaTypeToString</span><span class="token punctuation">(</span>media_type<span class="token punctuation">)</span>
                     <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; transceiver in response to a call to AddTrack.&quot;</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>string sender_id <span class="token operator">=</span> track<span class="token operator">-&gt;</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Avoid creating a sender with an existing ID by generating a random ID.</span>
    <span class="token comment">// This can happen if this is the second time AddTrack has created a sender</span>
    <span class="token comment">// for this track.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FindSenderById</span><span class="token punctuation">(</span>sender_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sender_id <span class="token operator">=</span> rtc<span class="token operator">::</span><span class="token function">CreateRandomUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* &#x521B;&#x5EFA; RtpSender, &#x97F3;&#x9891;&#x4E3A; AudioRtpSender&#xFF0C;&#x89C6;&#x9891;&#x4E3A; VideoRtpSender&#xFF0C;&#x8BBE;&#x7F6E; Track&#xFF0C;&#x5728;&#x8C03;&#x7528; RtpSender::SetSend() &#x65F6;&#x4F1A;&#x5C06;&#x7F16;&#x7801;&#x7684;Sink(&#x89C6;&#x9891;&#x4E3A;VideoStreamEncoder) &#x6DFB;&#x52A0;&#x5230; track &#x5185;&#xFF0C;&#x6700;&#x7EC8;&#x4E5F;&#x662F;&#x6DFB;&#x52A0;&#x5230;&#x5BF9;&#x5E94;&#x7684; VideoSource/AudioSource &#x91CC;&#x9762; */</span>
    <span class="token keyword">auto</span> sender <span class="token operator">=</span> <span class="token function">CreateSender</span><span class="token punctuation">(</span>media_type<span class="token punctuation">,</span> sender_id<span class="token punctuation">,</span> track<span class="token punctuation">,</span> stream_ids<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x521B;&#x5EFA; RtpReceiver, &#x97F3;&#x9891;&#x4E3A; AudioRtpReceiver&#xFF0C;&#x89C6;&#x9891;&#x4E3A; VideoRtpReceiver&#xFF0C;receiver_id &#x4E3A;&#x968F;&#x673A;&#x4EA7;&#x751F; */</span>
    <span class="token keyword">auto</span> receiver <span class="token operator">=</span> <span class="token function">CreateReceiver</span><span class="token punctuation">(</span>media_type<span class="token punctuation">,</span> rtc<span class="token operator">::</span><span class="token function">CreateRandomUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x6536;&#x53D1;&#x5668; Transceiver */</span>
    transceiver <span class="token operator">=</span> <span class="token function">CreateAndAddTransceiver</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x6807;&#x8BB0;&#x6536;&#x53D1;&#x5668;&#x521B;&#x5EFA;&#x539F;&#x56E0; */</span>
    transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_created_by_addtrack</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x8BBE;&#x7F6E;&#x6536;&#x53D1;&#x5668;&#x6536;&#x53D1;&#x6A21;&#x5F0F; */</span>
    transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_direction</span><span class="token punctuation">(</span>RtpTransceiverDirection<span class="token operator">::</span>kSendRecv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> transceiver<span class="token operator">-&gt;</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* &#x521B;&#x5EFA; RtpSender */</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpSenderProxyWithInternal<span class="token operator">&lt;</span>RtpSenderInternal<span class="token operator">&gt;&gt;</span>
<span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">CreateSender</span><span class="token punctuation">(</span>
    cricket<span class="token operator">::</span>MediaType media_type<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> id<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>MediaStreamTrackInterface<span class="token operator">&gt;</span> track<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">&gt;</span><span class="token operator">&amp;</span> stream_ids<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>RtpEncodingParameters<span class="token operator">&gt;</span><span class="token operator">&amp;</span> send_encodings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">RTC_DCHECK_RUN_ON</span><span class="token punctuation">(</span><span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpSenderProxyWithInternal<span class="token operator">&lt;</span>RtpSenderInternal<span class="token operator">&gt;&gt;</span> sender<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>media_type <span class="token operator">==</span> cricket<span class="token operator">::</span>MEDIA_TYPE_AUDIO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891; AudioRtpSender */</span>
    sender <span class="token operator">=</span> <span class="token class-name">RtpSenderProxyWithInternal</span><span class="token operator">&lt;</span>RtpSenderInternal<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>
        <span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">AudioRtpSender</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> stats_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NoteUsageEvent</span><span class="token punctuation">(</span>UsageEvent<span class="token operator">::</span>AUDIO_ADDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x89C6;&#x9891; VideoRtpSender */</span>
    sender <span class="token operator">=</span> <span class="token class-name">RtpSenderProxyWithInternal</span><span class="token operator">&lt;</span>RtpSenderInternal<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>
        <span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">VideoRtpSender</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NoteUsageEvent</span><span class="token punctuation">(</span>UsageEvent<span class="token operator">::</span>VIDEO_ADDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* &#x8BBE;&#x7F6E; VideoTrack &#x6216; AudioTrack&#xFF0C;&#x5728;&#x6B64;&#x6682;&#x65F6;&#x4E0D;&#x4F1A;&#x5C06; Encoder Sink &#x6DFB;&#x52A0;&#x5230; track&#xFF0C;&#x56E0;&#x4E3A;&#x8FD8;&#x4E0D;&#x5B58;&#x5728; ssrc */</span>
  <span class="token keyword">bool</span> set_track_succeeded <span class="token operator">=</span> sender<span class="token operator">-&gt;</span><span class="token function">SetTrack</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">return</span> sender<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* &#x521B;&#x5EFA; RtpReceiver */</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpReceiverProxyWithInternal<span class="token operator">&lt;</span>RtpReceiverInternal<span class="token operator">&gt;&gt;</span>
<span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">CreateReceiver</span><span class="token punctuation">(</span>cricket<span class="token operator">::</span>MediaType media_type<span class="token punctuation">,</span>
                               <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> receiver_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpReceiverProxyWithInternal<span class="token operator">&lt;</span>RtpReceiverInternal<span class="token operator">&gt;&gt;</span>
      receiver<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>media_type <span class="token operator">==</span> cricket<span class="token operator">::</span>MEDIA_TYPE_AUDIO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891; AudioRtpReceiver */</span>
    receiver <span class="token operator">=</span> <span class="token class-name">RtpReceiverProxyWithInternal</span><span class="token operator">&lt;</span>RtpReceiverInternal<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>
        <span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token function">AudioRtpReceiver</span><span class="token punctuation">(</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> receiver_id<span class="token punctuation">,</span>
                                                 std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NoteUsageEvent</span><span class="token punctuation">(</span>UsageEvent<span class="token operator">::</span>AUDIO_ADDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891; VideoRtpReceiver */</span>
    receiver <span class="token operator">=</span> <span class="token class-name">RtpReceiverProxyWithInternal</span><span class="token operator">&lt;</span>RtpReceiverInternal<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>
        <span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token function">VideoRtpReceiver</span><span class="token punctuation">(</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> receiver_id<span class="token punctuation">,</span>
                                                 std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NoteUsageEvent</span><span class="token punctuation">(</span>UsageEvent<span class="token operator">::</span>VIDEO_ADDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> receiver<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* &#x521B;&#x5EFA;&#x6536;&#x53D1;&#x5668; */</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpTransceiverProxyWithInternal<span class="token operator">&lt;</span>RtpTransceiver<span class="token operator">&gt;&gt;</span>
<span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">CreateAndAddTransceiver</span><span class="token punctuation">(</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpSenderProxyWithInternal<span class="token operator">&lt;</span>RtpSenderInternal<span class="token operator">&gt;&gt;</span> sender<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpReceiverProxyWithInternal<span class="token operator">&lt;</span>RtpReceiverInternal<span class="token operator">&gt;&gt;</span>
        receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Ensure that the new sender does not have an ID that is already in use by</span>
  <span class="token comment">// another sender.</span>
  <span class="token comment">// Allow receiver IDs to conflict since those come from remote SDP (which</span>
  <span class="token comment">// could be invalid, but should not cause a crash).</span>
  <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FindSenderById</span><span class="token punctuation">(</span>sender<span class="token operator">-&gt;</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> transceiver <span class="token operator">=</span> <span class="token class-name">RtpTransceiverProxyWithInternal</span><span class="token operator">&lt;</span>RtpTransceiver<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>
      <span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token function">RtpTransceiver</span><span class="token punctuation">(</span>
          sender<span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> <span class="token function">channel_manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          sender<span class="token operator">-&gt;</span><span class="token function">media_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> cricket<span class="token operator">::</span>MEDIA_TYPE_AUDIO
              <span class="token operator">?</span> <span class="token function">channel_manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetSupportedAudioRtpHeaderExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token operator">:</span> <span class="token function">channel_manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetSupportedVideoRtpHeaderExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* &#x4FDD;&#x5B58;&#x6536;&#x53D1;&#x5668; */</span>
  transceivers_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>transceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* &#x4FE1;&#x53F7;&#x8FDE;&#x63A5; */</span>
  transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>SignalNegotiationNeeded<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>PeerConnection<span class="token operator">::</span>OnNegotiationNeeded<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> transceiver<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/rtp_sender.cc</span>
<span class="token comment">// Native &#x5C42;&#x521B;&#x5EFA; Java &#x5C42; RtpSender &#x5B9E;&#x4F8B;</span>
ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">NativeToJavaRtpSender</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpSenderInterface<span class="token operator">&gt;</span> sender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sender<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token comment">// Sender is now owned by the Java object, and will be freed from</span>
    <span class="token comment">// RtpSender.dispose(), called by PeerConnection.dispose() or getSenders().</span>
    <span class="token keyword">return</span> <span class="token function">Java_RtpSender_Constructor</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/RtpSender_jni.h</span>
<span class="token keyword">static</span> base<span class="token operator">::</span>android<span class="token operator">::</span>ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">Java_RtpSender_Constructor</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jlong
    nativeRtpSender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_RtpSender_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_RtpSender_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_RtpSender_Constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    jobject ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">NewObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeRtpSender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> base<span class="token operator">::</span>android<span class="token operator">::</span>ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="2-%E9%9F%B3%E9%A2%91%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9D%97audiodevicemodule">2 &#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757;(AudioDeviceModule)</h2>

<p>&#x5916;&#x90E8;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x4EC5;&#x652F;&#x6301; java &#x5C42;&#x7EA7;&#xFF0C;&#x4E0D;&#x652F;&#x6301; OpenSLES. &#x501F;&#x7531; JavaAudioDeviceModule &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x548C;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x5B9E;&#x4F8B;&#xFF0C;&#x5E76;&#x901A;&#x8FC7; Jni &#x521B;&#x5EFA; native C++ &#x5C42; AudioDeviceModule &#x5BF9;&#x8C61;&#x3002;</p>
<h3 class="mume-header" id="21-%E5%88%9B%E5%BB%BA-javaaudiodevicemodule">2.1 &#x521B;&#x5EFA; JavaAudioDeviceModule</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token class-name">AudioDeviceModule</span> <span class="token function">createJavaAudioDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x91C7;&#x6837;&#x9891;&#x7387;&#x5728; Builder &#x6784;&#x9020;&#x65F6;&#x4ECE; WebRtcAudioManager &#x83B7;&#x53D6;&#x8BBE;&#x7F6E; */</span>
    <span class="token keyword">return</span> <span class="token class-name">JavaAudioDeviceModule</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span>
        <span class="token comment">/* &#x97F3;&#x9891;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x56DE;&#x8C03;&#xFF0C;&#x7528;&#x4E8E;&#x4FDD;&#x5B58;&#x5230;&#x6587;&#x4EF6; */</span>
        <span class="token punctuation">.</span><span class="token function">setSamplesReadyCallback</span><span class="token punctuation">(</span>saveRecordedAudioToFile<span class="token punctuation">)</span>
        <span class="token comment">/* &#x662F;&#x5426;&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x56DE;&#x58F0;&#x6D88;&#x9664;&#xFF0C;&#x9700;&#x8BBE;&#x5907;&#x652F;&#x6301; */</span>
        <span class="token punctuation">.</span><span class="token function">setUseHardwareAcousticEchoCanceler</span><span class="token punctuation">(</span><span class="token operator">!</span>peerConnectionParameters<span class="token punctuation">.</span>disableBuiltInAEC<span class="token punctuation">)</span>
        <span class="token comment">/* &#x662F;&#x5426;&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x566A;&#x58F0;&#x6291;&#x5236;&#xFF0C;&#x9700;&#x8BBE;&#x5907;&#x652F;&#x6301; */</span>
        <span class="token punctuation">.</span><span class="token function">setUseHardwareNoiseSuppressor</span><span class="token punctuation">(</span><span class="token operator">!</span>peerConnectionParameters<span class="token punctuation">.</span>disableBuiltInNS<span class="token punctuation">)</span>
        <span class="token comment">/* &#x8BBE;&#x7F6E;&#x9519;&#x8BEF;&#x56DE;&#x8C03;&#x53CA;&#x72B6;&#x6001;&#x56DE;&#x8C03; */</span>
        <span class="token punctuation">.</span><span class="token function">setAudioRecordErrorCallback</span><span class="token punctuation">(</span>audioRecordErrorCallback<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAudioTrackErrorCallback</span><span class="token punctuation">(</span>audioTrackErrorCallback<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAudioRecordStateCallback</span><span class="token punctuation">(</span>audioRecordStateCallback<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAudioTrackStateCallback</span><span class="token punctuation">(</span>audioTrackStateCallback<span class="token punctuation">)</span>
        <span class="token comment">/* &#x6784;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757; */</span>
        <span class="token punctuation">.</span><span class="token function">createAudioDeviceModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/JavaAudioDeviceModule.java</span>
<span class="token comment">// JavaAudioDeviceModule.Builder</span>
<span class="token keyword">public</span> <span class="token class-name">AudioDeviceModule</span> <span class="token function">createAudioDeviceModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x5B9E;&#x4F8B; sdk/android/src/java/org/webrtc/audio/WebRtcAudioRecord.java */</span>
    <span class="token keyword">final</span> <span class="token class-name">WebRtcAudioRecord</span> audioInput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebRtcAudioRecord</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioSource<span class="token punctuation">,</span>
        audioFormat<span class="token punctuation">,</span> audioRecordErrorCallback<span class="token punctuation">,</span> audioRecordStateCallback<span class="token punctuation">,</span> samplesReadyCallback<span class="token punctuation">,</span>
        useHardwareAcousticEchoCanceler<span class="token punctuation">,</span> useHardwareNoiseSuppressor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x5B9E;&#x4F8B; sdk/android/src/java/org/webrtc/audio/WebRtcAudioTrack.java */</span>
    <span class="token keyword">final</span> <span class="token class-name">WebRtcAudioTrack</span> audioOutput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebRtcAudioTrack</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioTrackErrorCallback<span class="token punctuation">,</span> audioTrackStateCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757; */</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JavaAudioDeviceModule</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioInput<span class="token punctuation">,</span> audioOutput<span class="token punctuation">,</span>
        inputSampleRate<span class="token punctuation">,</span> outputSampleRate<span class="token punctuation">,</span> useStereoInput<span class="token punctuation">,</span> useStereoOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// JavaAudioDeviceModule &#x662F; AudioDeviceModule &#x63A5;&#x53E3;&#x7684;&#x6D3E;&#x751F;&#x7C7B;</span>
<span class="token keyword">private</span> <span class="token class-name">JavaAudioDeviceModule</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">AudioManager</span> audioManager<span class="token punctuation">,</span>
      <span class="token class-name">WebRtcAudioRecord</span> audioInput<span class="token punctuation">,</span> <span class="token class-name">WebRtcAudioTrack</span> audioOutput<span class="token punctuation">,</span> <span class="token keyword">int</span> inputSampleRate<span class="token punctuation">,</span>
      <span class="token keyword">int</span> outputSampleRate<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useStereoInput<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useStereoOutput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioManager <span class="token operator">=</span> audioManager<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioInput <span class="token operator">=</span> audioInput<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioOutput <span class="token operator">=</span> audioOutput<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inputSampleRate <span class="token operator">=</span> inputSampleRate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outputSampleRate <span class="token operator">=</span> outputSampleRate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>useStereoInput <span class="token operator">=</span> useStereoInput<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>useStereoOutput <span class="token operator">=</span> useStereoOutput<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907; Native &#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x521B;&#x5EFA; PeerConnectionFactory &#x65F6;&#x8C03;&#x7528; */</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getNativeAudioDeviceModulePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>nativeLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeAudioDeviceModule <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nativeAudioDeviceModule <span class="token operator">=</span> <span class="token function">nativeCreateAudioDeviceModule</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioInput<span class="token punctuation">,</span>
                audioOutput<span class="token punctuation">,</span> inputSampleRate<span class="token punctuation">,</span> outputSampleRate<span class="token punctuation">,</span> useStereoInput<span class="token punctuation">,</span> useStereoOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> nativeAudioDeviceModule<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="22-%E5%88%9B%E5%BB%BA-native-%E5%B1%82-audiodevicemodule">2.2 &#x521B;&#x5EFA; Native &#x5C42; AudioDeviceModule</h3>

<p>&#x901A;&#x8FC7;JNI &#x8C03;&#x7528;&#x521B;&#x5EFA; AudioDeviceModule</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_java_audio_jni/JavaAudioDeviceModule_jni.h</span>
<span class="token comment">// &#x6B64;&#x6587;&#x4EF6;&#x4E3A;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;&#x4E2D;&#x52A8;&#x6001;&#x751F;&#x6210;</span>
JNI_GENERATOR_EXPORT jlong
    <span class="token function">Java_org_webrtc_audio_JavaAudioDeviceModule_nativeCreateAudioDeviceModule</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jobject context<span class="token punctuation">,</span>
    jobject audioManager<span class="token punctuation">,</span>
    jobject audioInput<span class="token punctuation">,</span>
    jobject audioOutput<span class="token punctuation">,</span>
    jint inputSampleRate<span class="token punctuation">,</span>
    jint outputSampleRate<span class="token punctuation">,</span>
    jboolean useStereoInput<span class="token punctuation">,</span>
    jboolean useStereoOutput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_JavaAudioDeviceModule_CreateAudioDeviceModule</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
        <span class="token comment">/* Java &#x5C42; Context &#x5F15;&#x7528; */</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token comment">/* Java &#x5C42; AudioManager &#x5F15;&#x7528;*/</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audioManager<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token comment">/* Java &#x5C42; WebRtcAudioRecord &#x5F15;&#x7528; */</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audioInput<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* Java &#x5C42; WebRtcAudioTrack &#x5F15;&#x7528; */</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audioOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        inputSampleRate<span class="token punctuation">,</span> outputSampleRate<span class="token punctuation">,</span>
        useStereoInput<span class="token punctuation">,</span> useStereoOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/audio_device/java_audio_device_module.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_JavaAudioDeviceModule_CreateAudioDeviceModule</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_audio_manager<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_webrtc_audio_record<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_webrtc_audio_track<span class="token punctuation">,</span>
    <span class="token keyword">int</span> input_sample_rate<span class="token punctuation">,</span>
    <span class="token keyword">int</span> output_sample_rate<span class="token punctuation">,</span>
    jboolean j_use_stereo_input<span class="token punctuation">,</span>
    jboolean j_use_stereo_output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AudioParameters input_parameters<span class="token punctuation">;</span>
    AudioParameters output_parameters<span class="token punctuation">;</span>
    <span class="token comment">/* &#x901A;&#x8FC7; AudioManager &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x53CA;&#x64AD;&#x653E;&#x7684;&#x76F8;&#x5173;&#x53C2;&#x6570; */</span>
    <span class="token function">GetAudioParameters</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_context<span class="token punctuation">,</span> j_audio_manager<span class="token punctuation">,</span> input_sample_rate<span class="token punctuation">,</span>
                        output_sample_rate<span class="token punctuation">,</span> j_use_stereo_input<span class="token punctuation">,</span>
                        j_use_stereo_output<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_parameters<span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>output_parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x91C7;&#x96C6; AudioRecordJni &#x5BF9;&#x8C61; */</span>
    <span class="token keyword">auto</span> audio_input <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>AudioRecordJni<span class="token operator">&gt;</span><span class="token punctuation">(</span>
        env<span class="token punctuation">,</span> input_parameters<span class="token punctuation">,</span> kHighLatencyModeDelayEstimateInMilliseconds<span class="token punctuation">,</span>
        j_webrtc_audio_record<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x64AD;&#x653E; AudioTrackJni &#x5BF9;&#x8C61; */</span>
    <span class="token keyword">auto</span> audio_output <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>AudioTrackJni<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> output_parameters<span class="token punctuation">,</span>
                                                        j_webrtc_audio_track<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token function">CreateAudioDeviceModuleFromInputAndOutput</span><span class="token punctuation">(</span>
                                <span class="token comment">// AudioDeviceModule::AudioLayer</span>
                                AudioDeviceModule<span class="token operator">::</span>kAndroidJavaAudio<span class="token punctuation">,</span>
                                <span class="token comment">// &#x662F;&#x5426;&#x53CC;&#x58F0;&#x9053;</span>
                                j_use_stereo_input<span class="token punctuation">,</span> j_use_stereo_output<span class="token punctuation">,</span>
                                <span class="token comment">// &#x64AD;&#x653E;&#x5EF6;&#x65F6;&#x4F30;&#x8BA1;&#xFF0C;150ms</span>
                                kHighLatencyModeDelayEstimateInMilliseconds<span class="token punctuation">,</span>
                                <span class="token comment">// &#x97F3;&#x9891;&#x91C7;&#x96C6;&#x53CA;&#x64AD;&#x653E;&#x5BF9;&#x8C61;</span>
                                std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_input<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_output<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/audio_device/audio_device_module.cc</span>
<span class="token comment">// &#x521B;&#x5EFA; AudioDeviceModule(modules/audio_device/include/audio_device.h)&#xFF0C;</span>
<span class="token comment">// AndroidAudioDeviceModule &#x7EE7;&#x627F;&#x4E8E;&#x8BE5;&#x7C7B;.</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioDeviceModule<span class="token operator">&gt;</span> <span class="token function">CreateAudioDeviceModuleFromInputAndOutput</span><span class="token punctuation">(</span>
    AudioDeviceModule<span class="token operator">::</span>AudioLayer audio_layer<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> is_stereo_playout_supported<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> is_stereo_record_supported<span class="token punctuation">,</span>
    <span class="token keyword">uint16_t</span> playout_delay_ms<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioInput<span class="token operator">&gt;</span> audio_input<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioOutput<span class="token operator">&gt;</span> audio_output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> __FUNCTION__<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>AndroidAudioDeviceModule<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      audio_layer<span class="token punctuation">,</span> is_stereo_playout_supported<span class="token punctuation">,</span> is_stereo_record_supported<span class="token punctuation">,</span>
      playout_delay_ms<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_input<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">AndroidAudioDeviceModule</span><span class="token punctuation">(</span>AudioDeviceModule<span class="token operator">::</span>AudioLayer audio_layer<span class="token punctuation">,</span>
                           <span class="token keyword">bool</span> is_stereo_playout_supported<span class="token punctuation">,</span>
                           <span class="token keyword">bool</span> is_stereo_record_supported<span class="token punctuation">,</span>
                           <span class="token keyword">uint16_t</span> playout_delay_ms<span class="token punctuation">,</span>
                           std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioInput<span class="token operator">&gt;</span> audio_input<span class="token punctuation">,</span>
                           std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioOutput<span class="token operator">&gt;</span> audio_output<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">audio_layer_</span><span class="token punctuation">(</span>audio_layer<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">is_stereo_playout_supported_</span><span class="token punctuation">(</span>is_stereo_playout_supported<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">is_stereo_record_supported_</span><span class="token punctuation">(</span>is_stereo_record_supported<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">playout_delay_ms_</span><span class="token punctuation">(</span>playout_delay_ms<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">task_queue_factory_</span><span class="token punctuation">(</span><span class="token function">CreateDefaultTaskQueueFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">input_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">output_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">initialized_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>input_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>output_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> __FUNCTION__<span class="token punctuation">;</span>
    thread_checker_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="23-native-%E8%8E%B7%E5%8F%96%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86%E6%92%AD%E6%94%BE%E5%8F%82%E6%95%B0">2.3 Native &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x64AD;&#x653E;&#x53C2;&#x6570;</h3>

<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// sdk/android/src/jni/audio_device/audio_device_module.cc</span>
<span class="token keyword">void</span> <span class="token function">GetAudioParameters</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_context<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_audio_manager<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> input_sample_rate<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> output_sample_rate<span class="token punctuation">,</span>
                        <span class="token keyword">bool</span> use_stereo_input<span class="token punctuation">,</span>
                        <span class="token keyword">bool</span> use_stereo_output<span class="token punctuation">,</span>
                        AudioParameters<span class="token operator">*</span> input_parameters<span class="token punctuation">,</span>
                        AudioParameters<span class="token operator">*</span> output_parameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> output_channels <span class="token operator">=</span> use_stereo_output <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> input_channels <span class="token operator">=</span> use_stereo_input <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t output_buffer_size <span class="token operator">=</span> <span class="token function">Java_WebRtcAudioManager_getOutputBufferSize</span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span> j_context<span class="token punctuation">,</span> j_audio_manager<span class="token punctuation">,</span> output_sample_rate<span class="token punctuation">,</span> output_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t input_buffer_size <span class="token operator">=</span> <span class="token function">Java_WebRtcAudioManager_getInputBufferSize</span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span> j_context<span class="token punctuation">,</span> j_audio_manager<span class="token punctuation">,</span> input_sample_rate<span class="token punctuation">,</span> input_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
  output_parameters<span class="token operator">-&gt;</span><span class="token function">reset</span><span class="token punctuation">(</span>output_sample_rate<span class="token punctuation">,</span>
                           <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>output_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>output_buffer_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  input_parameters<span class="token operator">-&gt;</span><span class="token function">reset</span><span class="token punctuation">(</span>input_sample_rate<span class="token punctuation">,</span>
                          <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>input_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>input_buffer_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>input_parameters<span class="token operator">-&gt;</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>output_parameters<span class="token operator">-&gt;</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_audio_device_module_base_jni/WebRTCAudioManager_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; sdk/android/src/java/org/webrt/audio/WebRtcAudioManager.java &#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;</span>
<span class="token comment">// &#x83B7;&#x53D6; AudioTrack &#x7684; getMinBufferSize</span>
<span class="token keyword">static</span> jint <span class="token function">Java_WebRtcAudioManager_getOutputBufferSize</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> audioManager<span class="token punctuation">,</span>
    JniIntWrapper sampleRate<span class="token punctuation">,</span>
    JniIntWrapper numberOfOutputChannels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_STATIC<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;getOutputBufferSize&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(Landroid/content/Context;Landroid/media/AudioManager;II)I&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioManager_getOutputBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; sdk/android/src/java/org/webrt/audio/WebRtcAudioManager.java &#x7684; getOutputBufferSize() &#x65B9;&#x6CD5; */</span>
    jint ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">CallStaticIntMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> audioManager<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">as_jint</span><span class="token punctuation">(</span>sampleRate<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">as_jint</span><span class="token punctuation">(</span>numberOfOutputChannels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x83B7;&#x53D6; AudioRecord &#x7684; getMinBufferSize</span>
<span class="token keyword">static</span> jint <span class="token function">Java_WebRtcAudioManager_getInputBufferSize</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> audioManager<span class="token punctuation">,</span>
    JniIntWrapper sampleRate<span class="token punctuation">,</span>
    JniIntWrapper numberOfInputChannels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_STATIC<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;getInputBufferSize&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(Landroid/content/Context;Landroid/media/AudioManager;II)I&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioManager_getInputBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; sdk/android/src/java/org/webrt/audio/WebRtcAudioManager.java &#x7684; getInputBufferSize() &#x65B9;&#x6CD5; */</span>
    jint ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">CallStaticIntMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> audioManager<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">as_jint</span><span class="token punctuation">(</span>sampleRate<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">as_jint</span><span class="token punctuation">(</span>numberOfInputChannels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="24-%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86-audiorecordjni">2.4 &#x97F3;&#x9891;&#x91C7;&#x96C6; AudioRecordJni</h3>

<p>Native &#x5C42;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x6784;&#x5EFA;&#x65F6;&#x7ED1;&#x5B9A; Java &#x5C42;&#x7684; WebRtcAudioRecord &#x5B9E;&#x4F8B;&#xFF0C;&#x4EE5;&#x5B9E;&#x73B0;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x542F;&#x52A8;&#x53CA;&#x8BFB;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x7F16;&#x7801;&#x53D1;&#x9001;&#x3002;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token class-name">AudioRecordJni</span><span class="token operator">::</span><span class="token function">AudioRecordJni</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                               <span class="token keyword">const</span> AudioParameters<span class="token operator">&amp;</span> audio_parameters<span class="token punctuation">,</span>
                               <span class="token keyword">int</span> total_delay_ms<span class="token punctuation">,</span>
                               <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_audio_record<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">j_audio_record_</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_audio_record<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &#x4FDD;&#x5B58; Java &#x5C42;&#x97F3;&#x9891;&#x91C7;&#x96C6; WebRtcAudioRecord &#x5B9E;&#x4F8B;&#x5F15;&#x7528;</span>
      <span class="token function">audio_parameters_</span><span class="token punctuation">(</span>audio_parameters<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">total_delay_ms_</span><span class="token punctuation">(</span>total_delay_ms<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_address_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_capacity_in_bytes_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">frames_per_buffer_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">initialized_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">recording_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">audio_device_buffer_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;ctor&quot;</span><span class="token punctuation">;</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>audio_parameters_<span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; Java&#x5C42;WebRtcAudioRecord&#x7684;setNativeAudioRecord &#x65B9;&#x6CD5;&#x8BBE;&#x7F6E; Native &#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x542F;&#x52A8;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x548C;&#x5C06;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x56DE;&#x8C03;C++&#x65F6;&#x4F7F;&#x7528; */</span>
    <span class="token function">Java_WebRtcAudioRecord_setNativeAudioRecord</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_audio_record_<span class="token punctuation">,</span>
                                                jni<span class="token operator">::</span><span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Detach from this thread since construction is allowed to happen on a</span>
    <span class="token comment">// different thread.</span>
    thread_checker_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread_checker_java_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_java_audio_device_module_native_jni/WebRtcAudioRecord_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; org/webrtc/audio/WebRtcAudioRecord.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Java_WebRtcAudioRecord_setNativeAudioRecord</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> obj<span class="token punctuation">,</span> jlong nativeAudioRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioRecord_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">org_webrtc_audio_WebRtcAudioRecord_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
  call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          env<span class="token punctuation">,</span>
          clazz<span class="token punctuation">,</span>
          <span class="token string">&quot;setNativeAudioRecord&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
          <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioRecord_setNativeAudioRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

     env<span class="token operator">-&gt;</span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeAudioRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Java &#x5C42;&#x8C03;&#x7528;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/src/java/org/webrtc/audio/WebRtcAudioRecord.java</span>
<span class="token annotation punctuation">@CalledByNative</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNativeAudioRecord</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeAudioRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAudioRecord <span class="token operator">=</span> nativeAudioRecord<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="25-%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE-audiotrackjni">2.5 &#x97F3;&#x9891;&#x64AD;&#x653E; AudioTrackJni</h3>

<p>Native &#x5C42;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x6784;&#x5EFA;&#x65F6;&#x7ED1;&#x5B9A;&#x5230; Java &#x5C42;&#x7684; WebRtcAudioTrack &#x5B9E;&#x4F8B;&#xFF0C;&#x5B9E;&#x73B0;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x521D;&#x59CB;&#x5316;&#x53CA;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x3002;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token class-name">AudioTrackJni</span><span class="token operator">::</span><span class="token function">AudioTrackJni</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> AudioParameters<span class="token operator">&amp;</span> audio_parameters<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_webrtc_audio_track<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">j_audio_track_</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_webrtc_audio_track<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &#x4FDD;&#x5B58; Java &#x5C42;&#x97F3;&#x9891;&#x91C7;&#x96C6; WebRtcAudioTrack &#x5B9E;&#x4F8B;&#x5F15;&#x7528;</span>
      <span class="token function">audio_parameters_</span><span class="token punctuation">(</span>audio_parameters<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_address_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_capacity_in_bytes_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">frames_per_buffer_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">initialized_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">playing_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">audio_device_buffer_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;ctor&quot;</span><span class="token punctuation">;</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>audio_parameters_<span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; Java&#x5C42; WebRtcAudioTrack &#x7684; setNativeAudioTrac &#x65B9;&#x6CD5;&#x8BBE;&#x7F6E; Native &#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x542F;&#x52A8;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x548C;&#x4ECE;C++&#x5C42;&#x83B7;&#x53D6;&#x64AD;&#x653E;&#x6570;&#x636E;&#x65F6;&#x4F7F;&#x7528; */</span>
    <span class="token function">Java_WebRtcAudioTrack_setNativeAudioTrack</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_audio_track_<span class="token punctuation">,</span>
                                                jni<span class="token operator">::</span><span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Detach from this thread since construction is allowed to happen on a</span>
    <span class="token comment">// different thread.</span>
    thread_checker_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread_checker_java_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_java_audio_device_module_native_jni/WebRtcAudioTrack_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; org/webrtc/audio/WebRtcAudioTrack.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Java_WebRtcAudioTrack_setNativeAudioTrack</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> obj<span class="token punctuation">,</span> jlong nativeAudioTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioTrack_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">org_webrtc_audio_WebRtcAudioTrack_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
  call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          env<span class="token punctuation">,</span>
          clazz<span class="token punctuation">,</span>
          <span class="token string">&quot;setNativeAudioTrack&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
          <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioTrack_setNativeAudioTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>

     env<span class="token operator">-&gt;</span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeAudioTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Java &#x5C42;&#x8C03;&#x7528;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/src/java/org/webrtc/audio/WebRtcAudioTrack.java</span>
<span class="token annotation punctuation">@CalledByNative</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNativeAudioTrack</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeAudioTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAudioTrack <span class="token operator">=</span> nativeAudioTrack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="3-%E8%A7%86%E9%A2%91%E5%9B%BE%E5%83%8F%E9%87%87%E9%9B%86%E6%A8%A1%E5%9D%97videocapturer">3 &#x89C6;&#x9891;&#x56FE;&#x50CF;&#x91C7;&#x96C6;&#x6A21;&#x5757;(VideoCapturer)</h2>

<p>&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90;&#x5206;&#x4E3A;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#xFF0C;&#x5C4F;&#x5E55;&#x5171;&#x4EAB;&#x53CA;&#x6444;&#x50CF;&#x5934;&#xFF0C;&#x8FD9;&#x51E0;&#x7C7B;&#x89C6;&#x9891;&#x6E90;&#x7EDF;&#x4E00;&#x7EE7;&#x627F;&#x4E86; VideoCapturer &#x7C7B;&#x3002;&#x5176;&#x4E2D;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#x6E90;&#x7684;&#x901A;&#x8FC7; CameraEnumerator&#x3001;CameraSession&#x3001;CameraCapturer &#x8FDE;&#x63A5;&#x4E0D;&#x540C; Camera API&#xFF0C; &#x5176;&#x4E2D; Camera1Enumerator&#x3001;Camera1Session&#xFF0C; Camera1Capturer &#x8FDE;&#x63A5; Camera V1 Api(&#x5373;Android 5&#x4E4B;&#x524D;&#x7684;&#x6444;&#x50CF;&#x5934;&#x63A5;&#x53E3;) &#xFF1B;&#x800C; Camera2Enumerator&#x3001;Camera2Session&#xFF0C; Camera2Capturer &#x8FDE;&#x63A5; Camera V2 &#x63A5;&#x53E3;&#x3002;&#x8FD9;&#x4E24;&#x5957;&#x63A5;&#x53E3;&#x5C01;&#x88C5;&#x4E86;&#x65B0;&#x65E7; Camera Api&#x7684;&#x5DEE;&#x5F02;&#x6027;&#xFF0C;&#x4F7F;&#x5916;&#x90E8;&#x8C03;&#x7528;&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#x3002;</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="1025px" preserveAspectRatio="none" style="width:2613px;height:1025px;" version="1.1" viewBox="0 0 2613 1025" width="2613px" zoomAndPan="magnify"><defs><filter height="300%" id="f1nnqmvf33jkaz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[6a70cc93280952e553d5079bb37818cf]
cluster CameraSession--><polygon fill="#FFFFFF" filter="url(#f1nnqmvf33jkaz)" points="1804,635,1919,635,1926,657.4883,2596,657.4883,2596,839,1804,839,1804,635" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="1804" x2="1926" y1="657.4883" y2="657.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="1808" y="650.5352">CameraSession</text><!--MD5=[e5ab114b80e753b114854575653dd8f1]
class CameraSession.CreateSessionCallback--><rect codeline="117" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="CameraSession.CreateSessionCallback" style="stroke:#A80036;stroke-width:1.5;" width="304" x="2268" y="709.5"/><ellipse cx="2351.25" cy="725.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2347.6777,721.7651 L2347.6777,719.6069 L2355.0571,719.6069 L2355.0571,721.7651 L2352.5918,721.7651 L2352.5918,729.8418 L2355.0571,729.8418 L2355.0571,732 L2347.6777,732 L2347.6777,729.8418 L2350.1431,729.8418 L2350.1431,721.7651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="129" x="2371.75" y="730.0352">CreateSessionCallback</text><line style="stroke:#A80036;stroke-width:1.5;" x1="2269" x2="2571" y1="741.5" y2="741.5"/><ellipse cx="2279" cy="752.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="202" x="2288" y="756.1348">void onDone(CameraSession session)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="2269" x2="2571" y1="762.4551" y2="762.4551"/><ellipse cx="2279" cy="773.4551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="278" x="2288" y="777.0898">void onFailure(FailureType failureType, String error)</text><!--MD5=[3636f3d29bbd8a3b807fc9bf24b084e1]
class CameraSession.Events--><rect codeline="123" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="136.7754" id="CameraSession.Events" style="stroke:#A80036;stroke-width:1.5;" width="386" x="1847" y="678"/><ellipse cx="2017.25" cy="694" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2013.6777,690.2651 L2013.6777,688.1069 L2021.0571,688.1069 L2021.0571,690.2651 L2018.5918,690.2651 L2018.5918,698.3418 L2021.0571,698.3418 L2021.0571,700.5 L2013.6777,700.5 L2013.6777,698.3418 L2016.1431,698.3418 L2016.1431,690.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="37" x="2037.75" y="698.5352">Events</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1848" x2="2232" y1="710" y2="710"/><ellipse cx="1858" cy="721" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="135" x="1867" y="724.6348">void onCameraOpening()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1848" x2="2232" y1="730.9551" y2="730.9551"/><ellipse cx="1858" cy="741.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="312" x="1867" y="745.5898">void onCameraError(CameraSession session, String error)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1848" x2="2232" y1="751.9102" y2="751.9102"/><ellipse cx="1858" cy="762.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="288" x="1867" y="766.5449">void onCameraDisconnected(CameraSession session)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1848" x2="2232" y1="772.8652" y2="772.8652"/><ellipse cx="1858" cy="783.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="252" x="1867" y="787.5">void onCameraClosed(CameraSession session)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1848" x2="2232" y1="793.8203" y2="793.8203"/><ellipse cx="1858" cy="804.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="360" x="1867" y="808.4551">void onFrameCaptured(CameraSession session, VideoFrame frame)</text><!--MD5=[4c84326b91249774fba9d49891354c9b]
class CapturerObserver--><rect codeline="2" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="94.8652" id="CapturerObserver" style="stroke:#A80036;stroke-width:1.5;" width="254" x="7" y="699"/><ellipse cx="77.75" cy="715" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M74.1777,711.2651 L74.1777,709.1069 L81.5571,709.1069 L81.5571,711.2651 L79.0918,711.2651 L79.0918,719.3418 L81.5571,719.3418 L81.5571,721.5 L74.1777,721.5 L74.1777,719.3418 L76.6431,719.3418 L76.6431,711.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="104" x="98.25" y="719.5352">CapturerObserver</text><line style="stroke:#A80036;stroke-width:1.5;" x1="8" x2="260" y1="731" y2="731"/><ellipse cx="18" cy="742" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="223" x="27" y="745.6348">void onCapturerStarted(boolean success)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="260" y1="751.9551" y2="751.9551"/><ellipse cx="18" cy="762.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="140" x="27" y="766.5898">void onCapturerStopped()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="260" y1="772.9102" y2="772.9102"/><ellipse cx="18" cy="783.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="228" x="27" y="787.5449">void onFrameCaptured(VideoFrame frame)</text><!--MD5=[d1851ec3eb8f60324b913a0e219678d1]
class VideoCapturer--><rect codeline="10" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="157.7305" id="VideoCapturer" style="stroke:#A80036;stroke-width:1.5;" width="383" x="1322.5" y="7"/><ellipse cx="1467.75" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1464.1777,19.2651 L1464.1777,17.1069 L1471.5571,17.1069 L1471.5571,19.2651 L1469.0918,19.2651 L1469.0918,27.3418 L1471.5571,27.3418 L1471.5571,29.5 L1464.1777,29.5 L1464.1777,27.3418 L1466.6431,27.3418 L1466.6431,19.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="84" x="1488.25" y="27.5352">VideoCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1323.5" x2="1704.5" y1="39" y2="39"/><ellipse cx="1333.5" cy="50" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="357" x="1342.5" y="53.6348">void initialize(SurfaceTextureHelper , Context , CapturerObserver )</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="59.9551" y2="59.9551"/><ellipse cx="1333.5" cy="70.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="280" x="1342.5" y="74.5898">void startCapture(int width, int height, int framerate)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="80.9102" y2="80.9102"/><ellipse cx="1333.5" cy="91.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="101" x="1342.5" y="95.5449">void stopCapture()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="101.8652" y2="101.8652"/><ellipse cx="1333.5" cy="112.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="332" x="1342.5" y="116.5">void changeCaptureFormat(int width, int height, int framerate)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="122.8203" y2="122.8203"/><ellipse cx="1333.5" cy="133.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="76" x="1342.5" y="137.4551">void dispose()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="143.7754" y2="143.7754"/><ellipse cx="1333.5" cy="154.7754" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="121" x="1342.5" y="158.4102">boolean isScreencast()</text><!--MD5=[e3b91f50f7e38913945d788d24b04423]
class CameraVideoCapturer--><rect codeline="24" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="CameraVideoCapturer" style="stroke:#A80036;stroke-width:1.5;" width="362" x="1033" y="225"/><ellipse cx="1145.25" cy="241" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1141.6777,237.2651 L1141.6777,235.1069 L1149.0571,235.1069 L1149.0571,237.2651 L1146.5918,237.2651 L1146.5918,245.3418 L1149.0571,245.3418 L1149.0571,247.5 L1141.6777,247.5 L1141.6777,245.3418 L1144.1431,245.3418 L1144.1431,237.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="129" x="1165.75" y="245.5352">CameraVideoCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1034" x2="1394" y1="257" y2="257"/><ellipse cx="1044" cy="268" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="229" x="1053" y="271.6348">void switchCamera(CameraSwitchHandler )</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1034" x2="1394" y1="277.9551" y2="277.9551"/><ellipse cx="1044" cy="288.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="336" x="1053" y="292.5898">void switchCamera(CameraSwitchHandler, String cameraName)</text><!--MD5=[d06c03ccfbdce18b1281f2fd6fb25f4d]
class CameraCapturer--><rect codeline="30" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="250.5059" id="CameraCapturer" style="stroke:#A80036;stroke-width:1.5;" width="354" x="1037" y="363"/><ellipse cx="1161.75" cy="379" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1161.8633,374.5981 L1160.7095,379.6699 L1163.0254,379.6699 Z M1160.3691,372.3569 L1163.3657,372.3569 L1166.7109,384.75 L1164.2622,384.75 L1163.4985,381.687 L1160.2197,381.687 L1159.4727,384.75 L1157.0239,384.75 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="96" x="1182.25" y="383.5352">CameraCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1038" x2="1390" y1="395" y2="395"/><polygon fill="#FFFF44" points="1048,401,1052,405,1048,409,1044,405" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="149" x="1057" y="409.6348">void createCameraSession()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="415.9551" y2="415.9551"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="423.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="209" x="1057" y="430.5898">void createSessionInternal(int delayMs)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="436.9102" y2="436.9102"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="444.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="150" x="1057" y="451.5449">void switchCameraInternal()</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="474.8203"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="209" x="1057" y="481.4551">CameraEnumerator cameraEnumerator</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1038" x2="1202.5" y1="464.3428" y2="464.3428"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="1202.5" y="468">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1225.5" x2="1390" y1="464.3428" y2="464.3428"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="487.7754" y2="487.7754"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="495.7754"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="328" x="1057" y="502.4102">CameraSession.CreateSessionCallback createSessionCallback</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="508.7305" y2="508.7305"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="516.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="280" x="1057" y="523.3652">CameraSession.Events cameraSessionEventsHandler</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="529.6855" y2="529.6855"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="537.6855"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="197" x="1057" y="544.3203">CapturerObserver capturerObserver</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="550.6406" y2="550.6406"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="558.6406"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="166" x="1057" y="565.2754">CameraSession currentSession</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="571.5957" y2="571.5957"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="579.5957"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="231" x="1057" y="586.2305">CameraSwitchHandler switchEventsHandler</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="592.5508" y2="592.5508"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="600.5508"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="179" x="1057" y="607.1855">CameraStatistics cameraStatistics</text><!--MD5=[f29480f3f6be8cdc6b3952e942fd3cfa]
class CameraEnumerator--><rect codeline="135" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="136.7754" id="CameraEnumerator" style="stroke:#A80036;stroke-width:1.5;" width="585" x="296.5" y="678"/><ellipse cx="528.75" cy="694" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M525.1777,690.2651 L525.1777,688.1069 L532.5571,688.1069 L532.5571,690.2651 L530.0918,690.2651 L530.0918,698.3418 L532.5571,698.3418 L532.5571,700.5 L525.1777,700.5 L525.1777,698.3418 L527.6431,698.3418 L527.6431,690.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="112" x="549.25" y="698.5352">CameraEnumerator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="297.5" x2="880.5" y1="710" y2="710"/><ellipse cx="307.5" cy="721" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="139" x="316.5" y="724.6348">String[] getDeviceNames()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="730.9551" y2="730.9551"/><ellipse cx="307.5" cy="741.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="226" x="316.5" y="745.5898">boolean isFrontFacing(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="751.9102" y2="751.9102"/><ellipse cx="307.5" cy="762.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="221" x="316.5" y="766.5449">boolean isBackFacing(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="772.8652" y2="772.8652"/><ellipse cx="307.5" cy="783.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="345" x="316.5" y="787.5">List&lt;CaptureFormat&gt; getSupportedFormats(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="793.8203" y2="793.8203"/><ellipse cx="307.5" cy="804.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="559" x="316.5" y="808.4551">CameraVideoCapturer createCapturer(String deviceName, CameraVideoCapturer.CameraEventsHandler )</text><!--MD5=[aa426e197ea1e471f3259685cb0cadc0]
class ScreenCapturerAndroid--><rect codeline="57" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="48" id="ScreenCapturerAndroid" style="stroke:#A80036;stroke-width:1.5;" width="167" x="1430.5" y="238"/><ellipse cx="1445.5" cy="254" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1447.9731,260.1431 Q1447.3921,260.4419 1446.7529,260.5913 Q1446.1138,260.7407 1445.4082,260.7407 Q1442.9014,260.7407 1441.5815,259.0889 Q1440.2617,257.437 1440.2617,254.3159 Q1440.2617,251.1865 1441.5815,249.5347 Q1442.9014,247.8828 1445.4082,247.8828 Q1446.1138,247.8828 1446.7612,248.0322 Q1447.4087,248.1816 1447.9731,248.4805 L1447.9731,251.2031 Q1447.3423,250.6221 1446.7488,250.3523 Q1446.1553,250.0825 1445.5244,250.0825 Q1444.1797,250.0825 1443.4949,251.1492 Q1442.8101,252.2158 1442.8101,254.3159 Q1442.8101,256.4077 1443.4949,257.4744 Q1444.1797,258.541 1445.5244,258.541 Q1446.1553,258.541 1446.7488,258.2712 Q1447.3423,258.0015 1447.9731,257.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="135" x="1459.5" y="258.5352">ScreenCapturerAndroid</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1431.5" x2="1596.5" y1="270" y2="270"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1431.5" x2="1596.5" y1="278" y2="278"/><!--MD5=[1759e3376b35249d894d8171cd4e7b48]
class FileVideoCapturer--><rect codeline="61" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="48" id="FileVideoCapturer" style="stroke:#A80036;stroke-width:1.5;" width="135" x="1632.5" y="238"/><ellipse cx="1647.5" cy="254" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1649.9731,260.1431 Q1649.3921,260.4419 1648.7529,260.5913 Q1648.1138,260.7407 1647.4082,260.7407 Q1644.9014,260.7407 1643.5815,259.0889 Q1642.2617,257.437 1642.2617,254.3159 Q1642.2617,251.1865 1643.5815,249.5347 Q1644.9014,247.8828 1647.4082,247.8828 Q1648.1138,247.8828 1648.7612,248.0322 Q1649.4087,248.1816 1649.9731,248.4805 L1649.9731,251.2031 Q1649.3423,250.6221 1648.7488,250.3523 Q1648.1553,250.0825 1647.5244,250.0825 Q1646.1797,250.0825 1645.4949,251.1492 Q1644.8101,252.2158 1644.8101,254.3159 Q1644.8101,256.4077 1645.4949,257.4744 Q1646.1797,258.541 1647.5244,258.541 Q1648.1553,258.541 1648.7488,258.2712 Q1649.3423,258.0015 1649.9731,257.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="103" x="1661.5" y="258.5352">FileVideoCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1633.5" x2="1766.5" y1="270" y2="270"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1633.5" x2="1766.5" y1="278" y2="278"/><!--MD5=[ccbd96572bb1b16b486fad2dde01e6f2]
class Camera1Capturer--><rect codeline="71" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="Camera1Capturer" style="stroke:#A80036;stroke-width:1.5;" width="175" x="916.5" y="709.5"/><ellipse cx="949.05" cy="725.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M951.5231,731.6431 Q950.9421,731.9419 950.3029,732.0913 Q949.6638,732.2407 948.9582,732.2407 Q946.4514,732.2407 945.1315,730.5889 Q943.8117,728.937 943.8117,725.8159 Q943.8117,722.6865 945.1315,721.0347 Q946.4514,719.3828 948.9582,719.3828 Q949.6638,719.3828 950.3112,719.5322 Q950.9587,719.6816 951.5231,719.9805 L951.5231,722.7031 Q950.8923,722.1221 950.2988,721.8523 Q949.7053,721.5825 949.0744,721.5825 Q947.7297,721.5825 947.0449,722.6492 Q946.3601,723.7158 946.3601,725.8159 Q946.3601,727.9077 947.0449,728.9744 Q947.7297,730.041 949.0744,730.041 Q949.7053,730.041 950.2988,729.7712 Q950.8923,729.5015 951.5231,728.9204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="104" x="966.95" y="730.0352">Camera1Capturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="917.5" x2="1090.5" y1="741.5" y2="741.5"/><ellipse cx="927.5" cy="752.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="104" x="936.5" y="756.1348">Camera1Capturer()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="917.5" x2="1090.5" y1="762.4551" y2="762.4551"/><polygon fill="#FFFF44" points="927.5,768.4551,931.5,772.4551,927.5,776.4551,923.5,772.4551" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="149" x="936.5" y="777.0898">void createCameraSession()</text><!--MD5=[09734e39e1aaab92cdb1f05f164bd2ac]
class Camera2Capturer--><rect codeline="77" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="Camera2Capturer" style="stroke:#A80036;stroke-width:1.5;" width="175" x="1126.5" y="709.5"/><ellipse cx="1159.05" cy="725.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1161.5231,731.6431 Q1160.9421,731.9419 1160.3029,732.0913 Q1159.6638,732.2407 1158.9582,732.2407 Q1156.4514,732.2407 1155.1315,730.5889 Q1153.8117,728.937 1153.8117,725.8159 Q1153.8117,722.6865 1155.1315,721.0347 Q1156.4514,719.3828 1158.9582,719.3828 Q1159.6638,719.3828 1160.3112,719.5322 Q1160.9587,719.6816 1161.5231,719.9805 L1161.5231,722.7031 Q1160.8923,722.1221 1160.2988,721.8523 Q1159.7053,721.5825 1159.0744,721.5825 Q1157.7297,721.5825 1157.0449,722.6492 Q1156.3601,723.7158 1156.3601,725.8159 Q1156.3601,727.9077 1157.0449,728.9744 Q1157.7297,730.041 1159.0744,730.041 Q1159.7053,730.041 1160.2988,729.7712 Q1160.8923,729.5015 1161.5231,728.9204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="104" x="1176.95" y="730.0352">Camera2Capturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1127.5" x2="1300.5" y1="741.5" y2="741.5"/><ellipse cx="1137.5" cy="752.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="104" x="1146.5" y="756.1348">Camera2Capturer()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1127.5" x2="1300.5" y1="762.4551" y2="762.4551"/><polygon fill="#FFFF44" points="1137.5,768.4551,1141.5,772.4551,1137.5,776.4551,1133.5,772.4551" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="149" x="1146.5" y="777.0898">void createCameraSession()</text><!--MD5=[19d1df133ca1013884d79ec64d03160b]
class CameraSession--><rect codeline="86" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="107.8203" id="CameraSession" style="stroke:#A80036;stroke-width:1.5;" width="440" x="1337" y="692.5"/><ellipse cx="1509.25" cy="708.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1505.6777,704.7651 L1505.6777,702.6069 L1513.0571,702.6069 L1513.0571,704.7651 L1510.5918,704.7651 L1510.5918,712.8418 L1513.0571,712.8418 L1513.0571,715 L1505.6777,715 L1505.6777,712.8418 L1508.1431,712.8418 L1508.1431,704.7651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="87" x="1529.75" y="713.0352">CameraSession</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1338" x2="1776" y1="724.5" y2="724.5"/><ellipse cx="1348" cy="735.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="58" x="1357" y="739.1348">void stop()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1338" x2="1776" y1="745.4551" y2="745.4551"/><ellipse cx="1348" cy="756.4551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="225" x="1357" y="760.0898">int getDeviceOrientation(Context context)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1338" x2="1776" y1="766.4102" y2="766.4102"/><ellipse cx="1348" cy="777.4102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="414" x="1357" y="781.0449">VideoFrame.TextureBuffer createTextureBufferWithModifiedTransformMatrix(</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="290" x="1357" y="794">TextureBufferImpl buffer, boolean mirror, int rotation)</text><!--MD5=[14ae07b67de67ef3ec59dfc7bd05aece]
class Camera1Session--><rect codeline="95" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="136.7754" id="Camera1Session" style="stroke:#A80036;stroke-width:1.5;" width="201" x="1347.5" y="875"/><ellipse cx="1396.25" cy="891" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1398.7231,897.1431 Q1398.1421,897.4419 1397.5029,897.5913 Q1396.8638,897.7407 1396.1582,897.7407 Q1393.6514,897.7407 1392.3315,896.0889 Q1391.0117,894.437 1391.0117,891.3159 Q1391.0117,888.1865 1392.3315,886.5347 Q1393.6514,884.8828 1396.1582,884.8828 Q1396.8638,884.8828 1397.5112,885.0322 Q1398.1587,885.1816 1398.7231,885.4805 L1398.7231,888.2031 Q1398.0923,887.6221 1397.4988,887.3523 Q1396.9053,887.0825 1396.2744,887.0825 Q1394.9297,887.0825 1394.2449,888.1492 Q1393.5601,889.2158 1393.5601,891.3159 Q1393.5601,893.4077 1394.2449,894.4744 Q1394.9297,895.541 1396.2744,895.541 Q1396.9053,895.541 1397.4988,895.2712 Q1398.0923,895.0015 1398.7231,894.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="95" x="1416.75" y="895.5352">Camera1Session</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1348.5" x2="1547.5" y1="907" y2="907"/><ellipse cx="1358.5" cy="918" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="67" x="1367.5" y="921.6348">void create()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1348.5" x2="1547.5" y1="927.9551" y2="927.9551"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1355.5" y="935.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="113" x="1367.5" y="942.5898">void startCapturing()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1348.5" x2="1547.5" y1="948.9102" y2="948.9102"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1355.5" y="956.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="162" x="1367.5" y="963.5449">void listenForTextureFrames()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1348.5" x2="1547.5" y1="969.8652" y2="969.8652"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1355.5" y="977.8652"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="175" x="1367.5" y="984.5">void listenForBytebufferFrames()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1348.5" x2="1547.5" y1="990.8203" y2="990.8203"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1355.5" y="998.8203"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="136" x="1367.5" y="1005.4551">int getFrameOrientation()</text><!--MD5=[01fec081d06c83f4541caf3f7cc36773]
class Camera2Session--><rect codeline="107" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="94.8652" id="Camera2Session" style="stroke:#A80036;stroke-width:1.5;" width="162" x="1584" y="896"/><ellipse cx="1614.75" cy="912" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1617.2231,918.1431 Q1616.6421,918.4419 1616.0029,918.5913 Q1615.3638,918.7407 1614.6582,918.7407 Q1612.1514,918.7407 1610.8315,917.0889 Q1609.5117,915.437 1609.5117,912.3159 Q1609.5117,909.1865 1610.8315,907.5347 Q1612.1514,905.8828 1614.6582,905.8828 Q1615.3638,905.8828 1616.0112,906.0322 Q1616.6587,906.1816 1617.2231,906.4805 L1617.2231,909.2031 Q1616.5923,908.6221 1615.9988,908.3523 Q1615.4053,908.0825 1614.7744,908.0825 Q1613.4297,908.0825 1612.7449,909.1492 Q1612.0601,910.2158 1612.0601,912.3159 Q1612.0601,914.4077 1612.7449,915.4744 Q1613.4297,916.541 1614.7744,916.541 Q1615.4053,916.541 1615.9988,916.2712 Q1616.5923,916.0015 1617.2231,915.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="95" x="1632.25" y="916.5352">Camera2Session</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1585" x2="1745" y1="928" y2="928"/><ellipse cx="1595" cy="939" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="67" x="1604" y="942.6348">void create()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1585" x2="1745" y1="948.9551" y2="948.9551"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1592" y="956.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="59" x="1604" y="963.5898">void start()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1585" x2="1745" y1="969.9102" y2="969.9102"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1592" y="977.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="136" x="1604" y="984.5449">int getFrameOrientation()</text><!--MD5=[d0ac0e6c7ffe0f9fe41145a86d5243f6]
class Camera1Enumerator--><rect codeline="147" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="94.8652" id="Camera1Enumerator" style="stroke:#A80036;stroke-width:1.5;" width="338" x="219" y="896"/><ellipse cx="323.75" cy="912" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M326.2231,918.1431 Q325.6421,918.4419 325.0029,918.5913 Q324.3638,918.7407 323.6582,918.7407 Q321.1514,918.7407 319.8315,917.0889 Q318.5117,915.437 318.5117,912.3159 Q318.5117,909.1865 319.8315,907.5347 Q321.1514,905.8828 323.6582,905.8828 Q324.3638,905.8828 325.0112,906.0322 Q325.6587,906.1816 326.2231,906.4805 L326.2231,909.2031 Q325.5923,908.6221 324.9988,908.3523 Q324.4053,908.0825 323.7744,908.0825 Q322.4297,908.0825 321.7449,909.1492 Q321.0601,910.2158 321.0601,912.3159 Q321.0601,914.4077 321.7449,915.4744 Q322.4297,916.541 323.7744,916.541 Q324.4053,916.541 324.9988,916.2712 Q325.5923,916.0015 326.2231,915.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="120" x="344.25" y="916.5352">Camera1Enumerator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="220" x2="556" y1="928" y2="928"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="227" y="936"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="199" x="239" y="942.6348">CameraInfo getCameraInfo(int index)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="220" x2="556" y1="948.9551" y2="948.9551"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="227" y="956.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="312" x="239" y="963.5898">List&lt;CaptureFormat&gt; getSupportedFormats(int cameraId)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="220" x2="556" y1="969.9102" y2="969.9102"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="227" y="977.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="172" x="239" y="984.5449">String getDeviceName(int index)</text><!--MD5=[48b3b187716a986d22b2634aa7919951]
class Camera2Enumerator--><rect codeline="155" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="Camera2Enumerator" style="stroke:#A80036;stroke-width:1.5;" width="397" x="592.5" y="906.5"/><ellipse cx="726.75" cy="922.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M729.2231,928.6431 Q728.6421,928.9419 728.0029,929.0913 Q727.3638,929.2407 726.6582,929.2407 Q724.1514,929.2407 722.8315,927.5889 Q721.5117,925.937 721.5117,922.8159 Q721.5117,919.6865 722.8315,918.0347 Q724.1514,916.3828 726.6582,916.3828 Q727.3638,916.3828 728.0112,916.5322 Q728.6587,916.6816 729.2231,916.9805 L729.2231,919.7031 Q728.5923,919.1221 727.9988,918.8523 Q727.4053,918.5825 726.7744,918.5825 Q725.4297,918.5825 724.7449,919.6492 Q724.0601,920.7158 724.0601,922.8159 Q724.0601,924.9077 724.7449,925.9744 Q725.4297,927.041 726.7744,927.041 Q727.4053,927.041 727.9988,926.7712 Q728.5923,926.5015 729.2231,925.9204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="120" x="747.25" y="927.0352">Camera2Enumerator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="593.5" x2="988.5" y1="938.5" y2="938.5"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="600.5" y="946.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="371" x="612.5" y="953.1348">CameraCharacteristics getCameraCharacteristics(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="593.5" x2="988.5" y1="959.4551" y2="959.4551"/><ellipse cx="603.5" cy="970.4551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="206" x="612.5" y="974.0898">boolean isSupported(Context context)</text><!--MD5=[a76226dc26b1373157892c246612775a]
reverse link CameraCapturer to CapturerObserver--><path codeline="51" d="M1022.88,536.03 C845.39,536.78 430.12,552.73 279,619 C238,636.98 200.2,670.8 173.47,698.94 " fill="none" id="CameraCapturer-backto-CapturerObserver" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1036,536,1029.9912,532.0132,1024,536.0264,1030.0088,540.0132,1036,536" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[8d16be48a47b929c2ce8b9a62009a270]
reverse link CameraCapturer to CameraEnumerator--><path codeline="52" d="M1022.76,476.29 C871.56,482.88 729.22,600.27 651.1,677.84 " fill="none" id="CameraCapturer-backto-CameraEnumerator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1036,476,1029.9135,472.1329,1024.0029,476.264,1030.0894,480.131,1036,476" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[a7eb497215feabb92724f152131991f3]
reverse link CameraCapturer to CameraSession.CreateSessionCallback--><path codeline="53" d="M1405.13,496.07 C1606.13,498.18 2076.74,546.88 2251,619 C2301.8,640.02 2351.09,679.84 2383.2,709.21 " fill="none" id="CameraCapturer-backto-CameraSession.CreateSessionCallback" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1392,496,1397.9824,500.0263,1403.9999,496.0527,1398.0175,492.0264,1392,496" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[a4c2fda8eb8258592542379c8c0e4447]
reverse link CameraCapturer to CameraSession.Events--><path codeline="54" d="M1405.05,516.03 C1600.07,517.03 1657.51,541.08 1843,619 C1879.54,634.35 1916.82,656.35 1948.98,677.72 " fill="none" id="CameraCapturer-backto-CameraSession.Events" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1392,516,1397.9912,520.0132,1404,516.0264,1398.0088,512.0132,1392,516" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[996e696b1041f98437ffb8a960da1c41]
reverse link CameraCapturer to CameraSession--><path codeline="55" d="M1405.35,556.92 C1470.65,565.96 1514.26,639.9 1537.34,692.46 " fill="none" id="CameraCapturer-backto-CameraSession" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1392,556,1397.7136,560.3994,1403.9721,556.8175,1398.2586,552.418,1392,556" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[0e5c36ed9415cc814f2ee6f1a4d4d3de]
reverse link VideoCapturer to CameraVideoCapturer--><path codeline="65" d="M1362.01,175.15 C1331.65,192.76 1301.4,210.31 1276.24,224.9 " fill="none" id="VideoCapturer-backto-CameraVideoCapturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1358.54,169.07,1379.36,165.09,1365.57,181.18,1358.54,169.07" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[f8c41590d8f2eb1f8ea3547becc6765a]
reverse link VideoCapturer to ScreenCapturerAndroid--><path codeline="66" d="M1514,185.24 C1514,204.87 1514,223.72 1514,237.71 " fill="none" id="VideoCapturer-backto-ScreenCapturerAndroid" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1507,185.09,1514,165.09,1521,185.09,1507,185.09" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[ba5a5a5aded9a8bf530f8f378f6be3f8]
reverse link VideoCapturer to FileVideoCapturer--><path codeline="67" d="M1612.4,179.05 C1635.72,200.87 1658.58,222.25 1675.1,237.71 " fill="none" id="VideoCapturer-backto-FileVideoCapturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1607.3,183.87,1597.48,165.09,1616.87,173.64,1607.3,183.87" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[40285a18b05116a2bb5bc3c9c80bb875]
reverse link CameraVideoCapturer to CameraCapturer--><path codeline="69" d="M1214,319.83 C1214,331.9 1214,345.1 1214,358.61 " fill="none" id="CameraVideoCapturer-backto-CameraCapturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1207,319.49,1214,299.49,1221,319.49,1207,319.49" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[79f5070d1b3e8ed456498fc0352b6661]
reverse link CameraCapturer to Camera1Capturer--><path codeline="83" d="M1100.1,626.75 C1075.31,657.38 1051.19,687.19 1033.31,709.28 " fill="none" id="CameraCapturer-backto-Camera1Capturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1094.67,622.33,1112.69,611.19,1105.55,631.14,1094.67,622.33" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[ccfa3e20f93efce94a8353912adc86d7]
reverse link CameraCapturer to Camera2Capturer--><path codeline="84" d="M1214,631.36 C1214,660.36 1214,688.3 1214,709.28 " fill="none" id="CameraCapturer-backto-Camera2Capturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1207,631.19,1214,611.19,1221,631.19,1207,631.19" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[b33991f621f5b0af78d08f8d2bba13d7]
reverse link CameraSession to Camera1Session--><path codeline="114" d="M1517.55,818.08 C1507.21,836.57 1496.09,856.46 1485.84,874.8 " fill="none" id="CameraSession-backto-Camera1Session" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1511.49,814.57,1527.36,800.53,1523.71,821.4,1511.49,814.57" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[f75d3d2b08c7bbd482af102eec66940b]
reverse link CameraSession to Camera2Session--><path codeline="115" d="M1596.21,818.29 C1610.5,844.1 1626.29,872.61 1639.13,895.8 " fill="none" id="CameraSession-backto-Camera2Session" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1589.94,821.41,1586.37,800.53,1602.18,814.63,1589.94,821.41" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[c6795812616f4a997f5cf1c0e50b3d3c]
reverse link CameraEnumerator to Camera1Enumerator--><path codeline="161" d="M504.86,829.13 C481.4,851.88 456.72,875.83 436.12,895.82 " fill="none" id="CameraEnumerator-backto-Camera1Enumerator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="500.04,824.06,519.26,815.15,509.78,834.1,500.04,824.06" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[455f21439928cf20c750eb6a7b86455e]
reverse link CameraEnumerator to Camera2Enumerator--><path codeline="162" d="M673.49,829.06 C701.44,856.04 731.12,884.69 753.66,906.45 " fill="none" id="CameraEnumerator-backto-Camera2Enumerator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="668.61,834.08,659.08,815.15,678.33,824.01,668.61,834.08" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[65d3e4d22b54be677a2d38f02652e935]
@startuml

interface CapturerObserver {
    + void onCapturerStarted(boolean success)
    ..
    + void onCapturerStopped()
    ..
    + void onFrameCaptured(VideoFrame frame)
}

interface VideoCapturer {
    + void initialize(SurfaceTextureHelper , Context , CapturerObserver )
    ..
    + void startCapture(int width, int height, int framerate)
    ..
    + void stopCapture()
    ..
    + void changeCaptureFormat(int width, int height, int framerate)
    ..
    + void dispose()
    ..
    + boolean isScreencast()
}

interface CameraVideoCapturer {
    + void switchCamera(CameraSwitchHandler )
    ..
    + void switchCamera(CameraSwitchHandler, String cameraName)
}

abstract class CameraCapturer {
    # {abstract} void createCameraSession()
    ..
    - void createSessionInternal(int delayMs)
    ..
    - void switchCameraInternal()
    - - field - -
    - {field} CameraEnumerator cameraEnumerator
    ..
    - {field} CameraSession.CreateSessionCallback createSessionCallback
    ..
    - {field} CameraSession.Events cameraSessionEventsHandler
    ..
    - {field} CapturerObserver capturerObserver
    ..
    - {field} CameraSession currentSession
    ..
    - {field} CameraSwitchHandler switchEventsHandler
    ..
    - {field} CameraStatistics cameraStatistics
}
CameraCapturer::capturerObserver *- - CapturerObserver
CameraCapturer::cameraEnumerator *- - CameraEnumerator
CameraCapturer::createSessionCallback *- - CameraSession.CreateSessionCallback
CameraCapturer::cameraSessionEventsHandler *- - CameraSession.Events
CameraCapturer::currentSession *- - CameraSession

class ScreenCapturerAndroid {

}

class FileVideoCapturer {

}

VideoCapturer <|- - CameraVideoCapturer
VideoCapturer <|- - ScreenCapturerAndroid
VideoCapturer <|- - FileVideoCapturer

CameraVideoCapturer <|- - CameraCapturer

class Camera1Capturer {
    + Camera1Capturer()
    ..
    # {method} void createCameraSession()
}

class Camera2Capturer {
    + Camera2Capturer()
    ..
    # {method} void createCameraSession()
}

CameraCapturer <|- - Camera1Capturer
CameraCapturer <|- - Camera2Capturer

interface CameraSession {
    + void stop()
    ..
    + {static} int getDeviceOrientation(Context context)
    ..
    + {static} VideoFrame.TextureBuffer createTextureBufferWithModifiedTransformMatrix(
      TextureBufferImpl buffer, boolean mirror, int rotation)
}

class Camera1Session {
    + {static} void create()
    ..
    - void startCapturing()
    ..
    - void listenForTextureFrames()
    ..
    - void listenForBytebufferFrames()
    ..
    - int getFrameOrientation()
}

class Camera2Session {
    + {static} void create()
    ..
    - void start()
    ..
    - int getFrameOrientation()
}
CameraSession <|- - Camera1Session
CameraSession <|- - Camera2Session

interface CameraSession.CreateSessionCallback {
    + void onDone(CameraSession session)
    ..
    + void onFailure(FailureType failureType, String error)
}

interface CameraSession.Events {
    + void onCameraOpening()
    ..
    + void onCameraError(CameraSession session, String error)
    ..
    + void onCameraDisconnected(CameraSession session)
    ..
    + void onCameraClosed(CameraSession session)
    ..
    + void onFrameCaptured(CameraSession session, VideoFrame frame)
}

interface CameraEnumerator {
    + String[] getDeviceNames()
    ..
    + boolean isFrontFacing(String deviceName)
    ..
    + boolean isBackFacing(String deviceName)
    ..
    + List<CaptureFormat> getSupportedFormats(String deviceName)
    ..
    + CameraVideoCapturer createCapturer(String deviceName, CameraVideoCapturer.CameraEventsHandler )
}

class Camera1Enumerator {
    - {static} CameraInfo getCameraInfo(int index)
    ..
    - {static} List<CaptureFormat> getSupportedFormats(int cameraId)
    ..
    - {static} String getDeviceName(int index)
}

class Camera2Enumerator {
    - {method} CameraCharacteristics getCameraCharacteristics(String deviceName)
    ..
    + {static} boolean isSupported(Context context)
}

CameraEnumerator <|- - Camera1Enumerator
CameraEnumerator <|- - Camera2Enumerator
@enduml

PlantUML version 1.2020.26(Tue Dec 22 01:45:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg></p><h3 class="mume-header" id="31-%E5%88%9B%E5%BB%BA%E6%91%84%E5%83%8F%E5%A4%B4%E9%87%87%E9%9B%86%E6%BA%90cameravideocapturer">3.1 &#x521B;&#x5EFA;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#x6E90;(CameraVideoCapturer)</h3>

<p>&#x521B;&#x5EFA;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90;&#xFF0C; Demo &#x7AEF;&#x8C03;&#x7528;&#x5165;&#x53E3;&#x3002;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// CallActivity.java</span>
<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">VideoCapturer</span> <span class="token function">createVideoCapturer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">VideoCapturer</span> videoCapturer<span class="token punctuation">;</span>
    <span class="token class-name">String</span> videoFileAsCamera <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>EXTRA_VIDEO_FILE_AS_CAMERA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x89C6;&#x9891;&#x6587;&#x4EF6;&#x4F5C;&#x4E3A;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90; */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>videoFileAsCamera <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            videoCapturer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileVideoCapturer</span><span class="token punctuation">(</span>videoFileAsCamera<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to open video file for emulated camera&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>screencaptureEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* &#x5C4F;&#x5E55;&#x5171;&#x4EAB; */</span>
        <span class="token keyword">return</span> <span class="token function">createScreenCapturer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useCamera2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Camera2 Api */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">captureToTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>camera2_texture_only_error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating capturer using camera2 API.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        videoCapturer <span class="token operator">=</span> <span class="token function">createCameraCapturer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Camera2Enumerator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Camera Api */</span>
        <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating capturer using camera1 API.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        videoCapturer <span class="token operator">=</span> <span class="token function">createCameraCapturer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">(</span><span class="token function">captureToTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>videoCapturer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to open camera&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> videoCapturer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x521B;&#x5EFA;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#x6E90;</span>
<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">VideoCapturer</span> <span class="token function">createCameraCapturer</span><span class="token punctuation">(</span><span class="token class-name">CameraEnumerator</span> enumerator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x83B7;&#x53D6;&#x8BBE;&#x5907;&#x6444;&#x50CF;&#x5934;&#x4FE1;&#x606F; */</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> deviceNames <span class="token operator">=</span> enumerator<span class="token punctuation">.</span><span class="token function">getDeviceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// First, try to find front facing camera</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Looking for front facing cameras.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x521B;&#x5EFA;&#x524D;&#x7F6E;&#x6444;&#x50CF;&#x5934;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> deviceName <span class="token operator">:</span> deviceNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enumerator<span class="token punctuation">.</span><span class="token function">isFrontFacing</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating front facing camera capturer.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">VideoCapturer</span> videoCapturer <span class="token operator">=</span> enumerator<span class="token punctuation">.</span><span class="token function">createCapturer</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">,</span> <span class="token comment">/* CameraEventsHandler */</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>videoCapturer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> videoCapturer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Front facing camera not found, try something else</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Looking for other cameras.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x82E5;&#x65E0;&#x524D;&#x7F6E;&#x6444;&#x50CF;&#x5934;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x540E;&#x7F6E;&#x6444;&#x50CF;&#x5934;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> deviceName <span class="token operator">:</span> deviceNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enumerator<span class="token punctuation">.</span><span class="token function">isFrontFacing</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating other camera capturer.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">VideoCapturer</span> videoCapturer <span class="token operator">=</span> enumerator<span class="token punctuation">.</span><span class="token function">createCapturer</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">,</span> <span class="token comment">/* CameraEventsHandler */</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>videoCapturer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> videoCapturer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="311-%E6%91%84%E5%83%8F%E5%A4%B4-camera1-%E9%87%87%E9%9B%86camera1capturer">3.1.1 &#x6444;&#x50CF;&#x5934; Camera1 &#x91C7;&#x96C6;(Camera1Capturer)</h4>

<ol>
<li>&#x521B;&#x5EFA; Camera1Enumerator&#xFF1B;</li>
<li>&#x901A;&#x8FC7; Camera1Enumerator &#x63A5;&#x53E3; createCapturer() &#x521B;&#x5EFA; Camera1Capturer</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera1Enumerator.java</span>
<span class="token keyword">public</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> captureToTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>captureToTexture <span class="token operator">=</span> captureToTexture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CameraVideoCapturer</span> <span class="token function">createCapturer</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> deviceName<span class="token punctuation">,</span> <span class="token class-name">CameraVideoCapturer<span class="token punctuation">.</span>CameraEventsHandler</span> eventsHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Camera1Capturer</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">,</span> eventsHandler<span class="token punctuation">,</span> captureToTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><ol start="3">
<li>Camera1Capturer &#x6784;&#x9020;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x7236;&#x7C7B; CameraCapturer &#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x4FDD;&#x5B58;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x7B49;&#x64CD;&#x4F5C;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera1Capturer.java</span>
<span class="token keyword">public</span> <span class="token class-name">Camera1Capturer</span><span class="token punctuation">(</span> <span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token class-name">CameraEventsHandler</span> eventsHandler<span class="token punctuation">,</span> <span class="token keyword">boolean</span> captureToTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x8C03;&#x7528;&#x7236;&#x7C7B;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x6CE8;&#x610F;&#x6B64;&#x5904;&#x91CD;&#x5EFA;&#x4E86; Camera1Enumerator  */</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>cameraName<span class="token punctuation">,</span> eventsHandler<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">(</span>captureToTexture<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>captureToTexture <span class="token operator">=</span> captureToTexture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/java/org/webrt/CameraCapturer.java</span>
<span class="token keyword">public</span> <span class="token class-name">CameraCapturer</span><span class="token punctuation">(</span><span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">CameraEventsHandler</span> eventsHandler<span class="token punctuation">,</span>
      <span class="token class-name">CameraEnumerator</span> cameraEnumerator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x6B64;&#x5904; eventsHandler &#x4E3A; null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventsHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventsHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CameraEventsHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraError</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraDisconnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraFreezed</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraOpening</span><span class="token punctuation">(</span><span class="token class-name">String</span> cameraName<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFirstFrameAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>eventsHandler <span class="token operator">=</span> eventsHandler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraEnumerator <span class="token operator">=</span> cameraEnumerator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraName <span class="token operator">=</span> cameraName<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> deviceNames <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>cameraEnumerator<span class="token punctuation">.</span><span class="token function">getDeviceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uiThreadHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="312-%E6%91%84%E5%83%8F%E5%A4%B4-camera2-%E9%87%87%E9%9B%86camera2capturer">3.1.2 &#x6444;&#x50CF;&#x5934; Camera2 &#x91C7;&#x96C6;(Camera2Capturer)</h4>

<ol>
<li>&#x521B;&#x5EFA; Camera2Enumerator&#xFF1B;</li>
<li>&#x901A;&#x8FC7; Camera2Enumerator &#x63A5;&#x53E3; createCapturer() &#x521B;&#x5EFA; Camera2Capturer</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera2Enumerator.java</span>
<span class="token keyword">public</span> <span class="token class-name">Camera2Enumerator</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token comment">/* &#x83B7;&#x53D6;&#x7CFB;&#x7EDF;&#x6444;&#x50CF;&#x5934;&#x7BA1;&#x7406;&#x670D;&#x52A1; */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CameraManager</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>CAMERA_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CameraVideoCapturer</span> <span class="token function">createCapturer</span><span class="token punctuation">(</span><span class="token class-name">String</span> deviceName<span class="token punctuation">,</span> <span class="token class-name">CameraVideoCapturer<span class="token punctuation">.</span>CameraEventsHandler</span> eventsHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Camera2Capturer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> deviceName<span class="token punctuation">,</span> eventsHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><ol start="3">
<li>Camera2Capturer &#x6784;&#x9020;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x7236;&#x7C7B; CameraCapturer &#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x4FDD;&#x5B58;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x7B49;&#x64CD;&#x4F5C;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera1Capturer.java</span>
<span class="token keyword">public</span> <span class="token class-name">Camera2Capturer</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token class-name">CameraEventsHandler</span> eventsHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x8C03;&#x7528;&#x7236;&#x7C7B;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x6CE8;&#x610F;&#x6B64;&#x5904;&#x65B0;&#x5EFA;&#x4E86; Camera2Enumerator  */</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>cameraName<span class="token punctuation">,</span> eventsHandler<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Camera2Enumerator</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token comment">/* &#x83B7;&#x53D6;&#x7CFB;&#x7EDF;&#x6444;&#x50CF;&#x5934;&#x7BA1;&#x7406;&#x670D;&#x52A1; */</span>
    cameraManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CameraManager</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>CAMERA_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/java/org/webrt/CameraCapturer.java</span>
<span class="token keyword">public</span> <span class="token class-name">CameraCapturer</span><span class="token punctuation">(</span><span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">CameraEventsHandler</span> eventsHandler<span class="token punctuation">,</span>
      <span class="token class-name">CameraEnumerator</span> cameraEnumerator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x6B64;&#x5904; eventsHandler &#x4E3A; null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventsHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventsHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CameraEventsHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraError</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraDisconnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraFreezed</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraOpening</span><span class="token punctuation">(</span><span class="token class-name">String</span> cameraName<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFirstFrameAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>eventsHandler <span class="token operator">=</span> eventsHandler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraEnumerator <span class="token operator">=</span> cameraEnumerator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraName <span class="token operator">=</span> cameraName<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> deviceNames <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>cameraEnumerator<span class="token punctuation">.</span><span class="token function">getDeviceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uiThreadHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="32-%E5%88%9B%E5%BB%BA-videosource">3.2 &#x521B;&#x5EFA; VideoSource</h3>

<ol>
<li>&#x521B;&#x5EFA; Java &#x5C42; VideoSource&#xFF0C;&#x7531; PeerConnectionClient.createVideoTrack() &#x5185;&#x8C03;&#x7528;&#x3002;</li>
</ol>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="670px" preserveAspectRatio="none" style="width:1228px;height:670px;" version="1.1" viewBox="0 0 1228 670" width="1228px" zoomAndPan="magnify"><defs><filter height="300%" id="f1uj030ph9c8hp" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[825a470c4f6fe58b64eee2fae4c3398f]
class MediaSource--><rect codeline="1" fill="#FEFECE" filter="url(#f1uj030ph9c8hp)" height="115.8203" id="MediaSource" style="stroke:#A80036;stroke-width:1.5;" width="198" x="549" y="7"/><ellipse cx="607.25" cy="23" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M609.7231,29.1431 Q609.1421,29.4419 608.5029,29.5913 Q607.8638,29.7407 607.1582,29.7407 Q604.6514,29.7407 603.3315,28.0889 Q602.0117,26.437 602.0117,23.3159 Q602.0117,20.1865 603.3315,18.5347 Q604.6514,16.8828 607.1582,16.8828 Q607.8638,16.8828 608.5112,17.0322 Q609.1587,17.1816 609.7231,17.4805 L609.7231,20.2031 Q609.0923,19.6221 608.4988,19.3523 Q607.9053,19.0825 607.2744,19.0825 Q605.9297,19.0825 605.2449,20.1492 Q604.5601,21.2158 604.5601,23.3159 Q604.5601,25.4077 605.2449,26.4744 Q605.9297,27.541 607.2744,27.541 Q607.9053,27.541 608.4988,27.2712 Q609.0923,27.0015 609.7231,26.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="73" x="627.75" y="27.5352">MediaSource</text><line style="stroke:#A80036;stroke-width:1.5;" x1="550" x2="746" y1="39" y2="39"/><ellipse cx="560" cy="50" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="172" x="569" y="53.6348">MediaSource(long nativeSource)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="550" x2="746" y1="59.9551" y2="59.9551"/><ellipse cx="560" cy="70.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="63" x="569" y="74.5898">State state()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="550" x2="746" y1="80.9102" y2="80.9102"/><ellipse cx="560" cy="91.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="76" x="569" y="95.5449">void dispose()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="550" x2="746" y1="101.8652" y2="101.8652"/><ellipse cx="560" cy="112.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="153" x="569" y="116.5">long getNativeMediaSource()</text><path d="M782,52.5 L782,61 L747.15,65 L782,69 L782,77.8105 A0,0 0 0 0 782,77.8105 L1086,77.8105 A0,0 0 0 0 1086,77.8105 L1086,62.5 L1076,52.5 L782,52.5 A0,0 0 0 0 782,52.5 " fill="#FBFB77" filter="url(#f1uj030ph9c8hp)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1076,52.5 L1076,62.5 L1086,62.5 L1076,52.5 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="788" y="70.0684">Java wrapper for a C++ MediaSourceInterface</text><!--MD5=[397927828c1a0cdf598938f40a262a32]
class NativeAndroidVideoTrackSource--><rect codeline="12" fill="#FEFECE" filter="url(#f1uj030ph9c8hp)" height="178.6855" id="NativeAndroidVideoTrackSource" style="stroke:#A80036;stroke-width:1.5;" width="436" x="431" y="478"/><ellipse cx="551.75" cy="494" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M554.2231,500.1431 Q553.6421,500.4419 553.0029,500.5913 Q552.3638,500.7407 551.6582,500.7407 Q549.1514,500.7407 547.8315,499.0889 Q546.5117,497.437 546.5117,494.3159 Q546.5117,491.1865 547.8315,489.5347 Q549.1514,487.8828 551.6582,487.8828 Q552.3638,487.8828 553.0112,488.0322 Q553.6587,488.1816 554.2231,488.4805 L554.2231,491.2031 Q553.5923,490.6221 552.9988,490.3523 Q552.4053,490.0825 551.7744,490.0825 Q550.4297,490.0825 549.7449,491.1492 Q549.0601,492.2158 549.0601,494.3159 Q549.0601,496.4077 549.7449,497.4744 Q550.4297,498.541 551.7744,498.541 Q552.4053,498.541 552.9988,498.2712 Q553.5923,498.0015 554.2231,497.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="186" x="572.25" y="498.5352">NativeAndroidVideoTrackSource</text><line style="stroke:#A80036;stroke-width:1.5;" x1="432" x2="866" y1="510" y2="510"/><ellipse cx="442" cy="521" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="382" x="451" y="524.6348">NativeAndroidVideoTrackSource(long nativeAndroidVideoTrackSource)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="432" x2="866" y1="530.9551" y2="530.9551"/><ellipse cx="442" cy="541.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="152" x="451" y="545.5898">void setState(boolean isLive)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="432" x2="866" y1="551.9102" y2="551.9102"/><ellipse cx="442" cy="562.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="410" x="451" y="566.5449">VideoProcessor.FrameAdaptationParameters adaptFrame(VideoFrame frame)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="432" x2="866" y1="572.8652" y2="572.8652"/><ellipse cx="442" cy="583.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="228" x="451" y="587.5">void onFrameCaptured(VideoFrame frame)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="432" x2="866" y1="593.8203" y2="593.8203"/><ellipse cx="442" cy="604.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="149" x="451" y="608.4551">void adaptOutputFormat(...)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="432" x2="866" y1="614.7754" y2="614.7754"/><ellipse cx="442" cy="625.7754" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="230" x="451" y="629.4102">void setIsScreencast(boolean isScreencast)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="432" x2="866" y1="635.7305" y2="635.7305"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="439" y="643.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="158" x="451" y="650.3652">void nativeSetIsScreencast(...)</text><path d="M6,555 L6,580.3105 A0,0 0 0 0 6,580.3105 L396,580.3105 A0,0 0 0 0 396,580.3105 L396,573 L430.7,567.5 L396,565 L396,565 L386,555 L6,555 A0,0 0 0 0 6,555 " fill="#FBFB77" filter="url(#f1uj030ph9c8hp)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M386,555 L386,565 L396,565 L386,555 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="12" y="572.5684">a simple layer that only handles the JNI wrapping of a C++</text><!--MD5=[9ff00f92b72c1751a52e1ef1709c84f0]
class VideoSource--><rect codeline="29" fill="#FEFECE" filter="url(#f1uj030ph9c8hp)" height="229.5508" id="VideoSource" style="stroke:#A80036;stroke-width:1.5;" width="407" x="444.5" y="187"/><ellipse cx="608.25" cy="203" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M610.7231,209.1431 Q610.1421,209.4419 609.5029,209.5913 Q608.8638,209.7407 608.1582,209.7407 Q605.6514,209.7407 604.3315,208.0889 Q603.0117,206.437 603.0117,203.3159 Q603.0117,200.1865 604.3315,198.5347 Q605.6514,196.8828 608.1582,196.8828 Q608.8638,196.8828 609.5112,197.0322 Q610.1587,197.1816 610.7231,197.4805 L610.7231,200.2031 Q610.0923,199.6221 609.4988,199.3523 Q608.9053,199.0825 608.2744,199.0825 Q606.9297,199.0825 606.2449,200.1492 Q605.5601,201.2158 605.5601,203.3159 Q605.5601,205.4077 606.2449,206.4744 Q606.9297,207.541 608.2744,207.541 Q608.9053,207.541 609.4988,207.2712 Q610.0923,207.0015 610.7231,206.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="71" x="628.75" y="207.5352">VideoSource</text><line style="stroke:#A80036;stroke-width:1.5;" x1="445.5" x2="850.5" y1="219" y2="219"/><ellipse cx="455.5" cy="230" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="171" x="464.5" y="233.6348">VideoSource(long nativeSource)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="445.5" x2="850.5" y1="239.9551" y2="239.9551"/><ellipse cx="455.5" cy="250.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="283" x="464.5" y="254.5898">void adaptOutputFormat(int width, int height, int fps)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="445.5" x2="850.5" y1="260.9102" y2="260.9102"/><ellipse cx="455.5" cy="271.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="230" x="464.5" y="275.5449">void setIsScreencast(boolean isScreencast)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="445.5" x2="850.5" y1="281.8652" y2="281.8652"/><ellipse cx="455.5" cy="292.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="381" x="464.5" y="296.5">void setVideoProcessor(@Nullable VideoProcessor newVideoProcessor)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="445.5" x2="850.5" y1="302.8203" y2="302.8203"/><ellipse cx="455.5" cy="313.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="224" x="464.5" y="317.4551">CapturerObserver getCapturerObserver()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="445.5" x2="850.5" y1="323.7754" y2="323.7754"/><ellipse cx="455.5" cy="334.7754" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="182" x="464.5" y="338.4102">long getNativeVideoTrackSource()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="445.5" x2="850.5" y1="344.7305" y2="344.7305"/><ellipse cx="455.5" cy="355.7305" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="76" x="464.5" y="359.3652">void dispose()</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="452.5" y="382.6406"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="350" x="464.5" y="389.2754">NativeAndroidVideoTrackSource nativeAndroidVideoTrackSource</text><line style="stroke:#A80036;stroke-width:1.0;" x1="445.5" x2="636.5" y1="372.1631" y2="372.1631"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="636.5" y="375.8203">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="659.5" x2="850.5" y1="372.1631" y2="372.1631"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="445.5" x2="850.5" y1="395.5957" y2="395.5957"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="452.5" y="403.5957"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="197" x="464.5" y="410.2305">CapturerObserver capturerObserver</text><path d="M894.5,288 L894.5,296.5 L859.69,300.5 L894.5,304.5 L894.5,313.3105 A0,0 0 0 0 894.5,313.3105 L1219.5,313.3105 A0,0 0 0 0 1219.5,313.3105 L1219.5,298 L1209.5,288 L894.5,288 A0,0 0 0 0 894.5,288 " fill="#FBFB77" filter="url(#f1uj030ph9c8hp)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1209.5,288 L1209.5,298 L1219.5,298 L1209.5,288 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="900.5" y="305.5684">Java wrapper of native AndroidVideoTrackSource</text><!--MD5=[d05ca32d10c56dfcefd32f010351a428]
reverse link MediaSource to VideoSource--><path codeline="50" d="M648,143.52 C648,156.09 648,169.36 648,182.62 " fill="none" id="MediaSource-backto-VideoSource" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="641,143.12,648,123.12,655,143.12,641,143.12" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[99cce3f31c4494696e86ec83cf989c12]
reverse link VideoSource to NativeAndroidVideoTrackSource--><path codeline="51" d="M860.89,395.07 C859.94,401.98 855.69,411 852,418 C840.2,440.41 823.33,460.29 804.29,477.63 " fill="none" id="VideoSource-backto-NativeAndroidVideoTrackSource" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="853,384.5,853.3826,391.7009,860.1768,394.1174,859.7942,386.9164,853,384.5" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[c0c1b774ce28b48c06fdbb54b5e17619]
@startuml
class MediaSource {
    + MediaSource(long nativeSource)
    ..
    + State state()
    ..
    + void dispose()
    ..
    + long getNativeMediaSource()
}
note right of MediaSource: Java wrapper for a C++ MediaSourceInterface

class NativeAndroidVideoTrackSource {
    + NativeAndroidVideoTrackSource(long nativeAndroidVideoTrackSource)
    ..
    + void setState(boolean isLive)
    ..
    + VideoProcessor.FrameAdaptationParameters adaptFrame(VideoFrame frame)
    ..
    + void onFrameCaptured(VideoFrame frame)
    ..
    + void adaptOutputFormat(...)
    ..
    + void setIsScreencast(boolean isScreencast)
    ..
    - void nativeSetIsScreencast(...)
}
note left of NativeAndroidVideoTrackSource: a simple layer that only handles the JNI wrapping of a C++

class VideoSource {
    + VideoSource(long nativeSource)
    ..
    + void adaptOutputFormat(int width, int height, int fps)
    ..
    + void setIsScreencast(boolean isScreencast)
    ..
    + void setVideoProcessor(@Nullable VideoProcessor newVideoProcessor)
    ..
    + CapturerObserver getCapturerObserver()
    ..
    + long getNativeVideoTrackSource()
    ..
    + void dispose()
    - -field- -
    - {field} NativeAndroidVideoTrackSource nativeAndroidVideoTrackSource
    ..
    - {field} CapturerObserver capturerObserver
}
note right of VideoSource: Java wrapper of native AndroidVideoTrackSource

MediaSource <|- - VideoSource
VideoSource::nativeAndroidVideoTrackSource *- - NativeAndroidVideoTrackSource
@enduml

PlantUML version 1.2020.26(Tue Dec 22 01:45:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg></p><center> Java &#x5C42; VideoSource &#x7C7B;&#x56FE; </center>
<p>&#x7B80;&#x8981;&#x4EE3;&#x7801;&#x6D41;&#x7A0B;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/PeerConnectionFactory.java</span>
<span class="token keyword">public</span> <span class="token class-name">VideoSource</span> <span class="token function">createVideoSource</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isScreencast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createVideoSource</span><span class="token punctuation">(</span>isScreencast<span class="token punctuation">,</span> <span class="token comment">/* alignTimestamps= */</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">VideoSource</span> <span class="token function">createVideoSource</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isScreencast<span class="token punctuation">,</span> <span class="token keyword">boolean</span> alignTimestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkPeerConnectionFactoryExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x9700;&#x5148;&#x521B;&#x5EFA; Native &#x5C42; VideoSource&#xFF0C;&#x8FDB;&#x884C;&#x7ED1;&#x5B9A;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">VideoSource</span><span class="token punctuation">(</span><span class="token function">nativeCreateVideoSource</span><span class="token punctuation">(</span>nativeFactory<span class="token punctuation">,</span> isScreencast<span class="token punctuation">,</span> alignTimestamps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/VideoSource.java</span>
<span class="token keyword">public</span> <span class="token class-name">VideoSource</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x8C03;&#x7528;&#x7236;&#x7C7B; MediaSource &#x6784;&#x9020;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>nativeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x521B;&#x5EFA; AndroidVideoTrackSource &#x7684; java &#x5C42;&#x6620;&#x5C04;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAndroidVideoTrackSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeAndroidVideoTrackSource</span><span class="token punctuation">(</span>nativeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// // sdk/android/src/java/org/webrtc/NativeAndroidVideoTrackSource.java</span>
<span class="token keyword">public</span> <span class="token class-name">NativeAndroidVideoTrackSource</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeAndroidVideoTrackSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAndroidVideoTrackSource <span class="token operator">=</span> nativeAndroidVideoTrackSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/MediaSource.java</span>
<span class="token keyword">public</span> <span class="token class-name">MediaSource</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    refCountDelegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefCountDelegate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">JniCommon</span><span class="token punctuation">.</span><span class="token function">nativeReleaseRef</span><span class="token punctuation">(</span>nativeSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeSource <span class="token operator">=</span> nativeSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><ol start="2">
<li>&#x521B;&#x5EFA; VideoSource &#x5BF9;&#x5E94; C++ &#x5C42; AndroidVideoTrackSource&#x3002;</li>
</ol>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="1008px" preserveAspectRatio="none" style="width:753px;height:1008px;" version="1.1" viewBox="0 0 753 1008" width="753px" zoomAndPan="magnify"><defs><filter height="300%" id="f17ubmhuvv31fq" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[f09b074c911cbd46f8902695b08e6b0a]
class RefCountInterface--><rect codeline="1" fill="#FEFECE" filter="url(#f17ubmhuvv31fq)" height="73.9102" id="RefCountInterface" style="stroke:#A80036;stroke-width:1.5;" width="200" x="7" y="7"/><ellipse cx="51.75" cy="23" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M51.8633,18.5981 L50.7095,23.6699 L53.0254,23.6699 Z M50.3691,16.3569 L53.3657,16.3569 L56.7109,28.75 L54.2622,28.75 L53.4985,25.687 L50.2197,25.687 L49.4727,28.75 L47.0239,28.75 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="102" x="72.25" y="27.5352">RefCountInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="8" x2="206" y1="39" y2="39"/><ellipse cx="18" cy="50" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="73" x="27" y="53.6348">void AddRef()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="206" y1="59.9551" y2="59.9551"/><ellipse cx="18" cy="70.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="174" x="27" y="74.5898">RefCountReleaseStatus Release()</text><!--MD5=[01c0a374e0ca965dd1eeca3f6175e91c]
class NotifierInterface--><rect codeline="7" fill="#FEFECE" filter="url(#f17ubmhuvv31fq)" height="73.9102" id="NotifierInterface" style="stroke:#A80036;stroke-width:1.5;" width="320" x="242" y="7"/><ellipse cx="351.75" cy="23" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M351.8633,18.5981 L350.7095,23.6699 L353.0254,23.6699 Z M350.3691,16.3569 L353.3657,16.3569 L356.7109,28.75 L354.2622,28.75 L353.4985,25.687 L350.2197,25.687 L349.4727,28.75 L347.0239,28.75 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="92" x="372.25" y="27.5352">NotifierInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="243" x2="561" y1="39" y2="39"/><ellipse cx="253" cy="50" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="281" x="262" y="53.6348">void RegisterObserver(ObserverInterface* observer)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="243" x2="561" y1="59.9551" y2="59.9551"/><ellipse cx="253" cy="70.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="294" x="262" y="74.5898">void UnregisterObserver(ObserverInterface* observer)</text><!--MD5=[29617029bd9857469f98034951e19503]
class MediaSourceInterface--><rect codeline="13" fill="#FEFECE" filter="url(#f17ubmhuvv31fq)" height="73.9102" id="MediaSourceInterface" style="stroke:#A80036;stroke-width:1.5;" width="155" x="176.5" y="150.5"/><ellipse cx="191.5" cy="166.5" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M191.6133,162.0981 L190.4595,167.1699 L192.7754,167.1699 Z M190.1191,159.8569 L193.1157,159.8569 L196.4609,172.25 L194.0122,172.25 L193.2485,169.187 L189.9697,169.187 L189.2227,172.25 L186.7739,172.25 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="123" x="205.5" y="171.0352">MediaSourceInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="177.5" x2="330.5" y1="182.5" y2="182.5"/><line style="stroke:#A80036;stroke-width:1.5;" x1="177.5" x2="330.5" y1="190.5" y2="190.5"/><ellipse cx="187.5" cy="201.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="100" x="196.5" y="205.1348">SourceState state()</text><ellipse cx="187.5" cy="214.4551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="73" x="196.5" y="218.0898">bool remote()</text><!--MD5=[b938fa271f0b869b5d94b8c15d06f4a6]
class VideoSourceInterface--><rect codeline="21" fill="#FEFECE" filter="url(#f17ubmhuvv31fq)" height="93.1309" id="VideoSourceInterface" style="stroke:#A80036;stroke-width:1.5;" width="372" x="367" y="141"/><ellipse cx="488.25" cy="160.1328" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M488.3633,155.731 L487.2095,160.8027 L489.5254,160.8027 Z M486.8691,153.4897 L489.8657,153.4897 L493.2109,165.8828 L490.7622,165.8828 L489.9985,162.8198 L486.7197,162.8198 L485.9727,165.8828 L483.5239,165.8828 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="81" x="528.75" y="157.6016">&#xAB;VideoFrame&#xBB;</text><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="121" x="508.75" y="171.7344">VideoSourceInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="368" x2="738" y1="179.2656" y2="179.2656"/><ellipse cx="378" cy="190.2656" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="346" x="387" y="193.9004">void AddOrUpdateSink(VideoSinkInterface&lt;VideoFrameT&gt;* sink,</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="163" x="387" y="206.8555">const VideoSinkWants&amp; wants)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="368" x2="738" y1="213.1758" y2="213.1758"/><ellipse cx="378" cy="224.1758" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="315" x="387" y="227.8105">void RemoveSink(VideoSinkInterface&lt;VideoFrameT&gt;* sink)</text><!--MD5=[678244807185033dd954902073fd0036]
class VideoTrackSourceInterface--><rect codeline="28" fill="#FEFECE" filter="url(#f17ubmhuvv31fq)" height="183.6406" id="VideoTrackSourceInterface" style="stroke:#A80036;stroke-width:1.5;" width="337" x="234.5" y="294"/><ellipse cx="321.75" cy="310" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M321.8633,305.5981 L320.7095,310.6699 L323.0254,310.6699 Z M320.3691,303.3569 L323.3657,303.3569 L326.7109,315.75 L324.2622,315.75 L323.4985,312.687 L320.2197,312.687 L319.4727,315.75 L317.0239,315.75 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="154" x="342.25" y="314.5352">VideoTrackSourceInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="235.5" x2="570.5" y1="326" y2="326"/><ellipse cx="245.5" cy="337" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="108" x="254.5" y="340.6348">bool is_screencast()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="235.5" x2="570.5" y1="346.9551" y2="346.9551"/><ellipse cx="245.5" cy="357.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="126" x="254.5" y="361.5898">bool needs_denoising()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="235.5" x2="570.5" y1="367.9102" y2="367.9102"/><ellipse cx="245.5" cy="378.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="168" x="254.5" y="382.5449">bool SupportsEncodedOutput()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="235.5" x2="570.5" y1="388.8652" y2="388.8652"/><ellipse cx="245.5" cy="399.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="134" x="254.5" y="403.5">void GenerateKeyFrame()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="235.5" x2="570.5" y1="409.8203" y2="409.8203"/><ellipse cx="245.5" cy="420.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="120" x="254.5" y="424.4551">void AddEncodedSink(</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="311" x="254.5" y="437.4102">rtc::VideoSinkInterface&lt;RecordableEncodedFrame&gt;* sink)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="235.5" x2="570.5" y1="443.7305" y2="443.7305"/><ellipse cx="245.5" cy="454.7305" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="140" x="254.5" y="458.3652">void RemoveEncodedSink(</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="311" x="254.5" y="471.3203">rtc::VideoSinkInterface&lt;RecordableEncodedFrame&gt;* sink)</text><!--MD5=[de182b76367d5d2a64f0286e069abe67]
class AdaptedVideoTrackSource--><rect codeline="47" fill="#FEFECE" filter="url(#f17ubmhuvv31fq)" height="187.6406" id="AdaptedVideoTrackSource" style="stroke:#A80036;stroke-width:1.5;" width="298" x="254" y="538"/><ellipse cx="321.75" cy="554" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M324.2231,560.1431 Q323.6421,560.4419 323.0029,560.5913 Q322.3638,560.7407 321.6582,560.7407 Q319.1514,560.7407 317.8315,559.0889 Q316.5117,557.437 316.5117,554.3159 Q316.5117,551.1865 317.8315,549.5347 Q319.1514,547.8828 321.6582,547.8828 Q322.3638,547.8828 323.0112,548.0322 Q323.6587,548.1816 324.2231,548.4805 L324.2231,551.2031 Q323.5923,550.6221 322.9988,550.3523 Q322.4053,550.0825 321.7744,550.0825 Q320.4297,550.0825 319.7449,551.1492 Q319.0601,552.2158 319.0601,554.3159 Q319.0601,556.4077 319.7449,557.4744 Q320.4297,558.541 321.7744,558.541 Q322.4053,558.541 322.9988,558.2712 Q323.5923,558.0015 324.2231,557.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="154" x="342.25" y="558.5352">AdaptedVideoTrackSource</text><line style="stroke:#A80036;stroke-width:1.5;" x1="255" x2="551" y1="570" y2="570"/><polygon fill="#FFFF44" points="265,576,269,580,265,584,261,580" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="272" x="274" y="584.6348">AdaptedVideoTrackSource(int required_alignment)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="255" x2="551" y1="590.9551" y2="590.9551"/><polygon fill="#FFFF44" points="265,596.9551,269,600.9551,265,604.9551,261,600.9551" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="263" x="274" y="605.5898">void OnFrame(const webrtc::VideoFrame&amp; frame)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="255" x2="551" y1="611.9102" y2="611.9102"/><polygon fill="#FFFF44" points="265,617.9102,269,621.9102,265,625.9102,261,621.9102" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="109" x="274" y="626.5449">bool AdaptFrame(...)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="255" x2="551" y1="632.8652" y2="632.8652"/><polygon fill="#FFFF44" points="265,638.8652,269,642.8652,265,646.8652,261,642.8652" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="113" x="274" y="647.5">bool apply_rotation()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="255" x2="551" y1="653.8203" y2="653.8203"/><polygon fill="#FFFF44" points="265,659.8203,269,663.8203,265,667.8203,261,663.8203" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="207" x="274" y="668.4551">cricket::VideoAdapter* video_adapter()</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="262" y="691.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="200" x="274" y="698.3652">cricket::VideoAdapter video_adapter_</text><line style="stroke:#A80036;stroke-width:1.0;" x1="255" x2="391.5" y1="681.2529" y2="681.2529"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="391.5" y="684.9102">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="414.5" x2="551" y1="681.2529" y2="681.2529"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="255" x2="551" y1="704.6855" y2="704.6855"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="262" y="712.6855"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="168" x="274" y="719.3203">VideoBroadcaster broadcaster_</text><!--MD5=[8b7074493888052699ed7127bfec4874]
class AndroidVideoTrackSource--><rect codeline="64" fill="#FEFECE" filter="url(#f17ubmhuvv31fq)" height="208.5957" id="AndroidVideoTrackSource" style="stroke:#A80036;stroke-width:1.5;" width="340" x="233" y="786"/><ellipse cx="323.75" cy="802" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M326.2231,808.1431 Q325.6421,808.4419 325.0029,808.5913 Q324.3638,808.7407 323.6582,808.7407 Q321.1514,808.7407 319.8315,807.0889 Q318.5117,805.437 318.5117,802.3159 Q318.5117,799.1865 319.8315,797.5347 Q321.1514,795.8828 323.6582,795.8828 Q324.3638,795.8828 325.0112,796.0322 Q325.6587,796.1816 326.2231,796.4805 L326.2231,799.2031 Q325.5923,798.6221 324.9988,798.3523 Q324.4053,798.0825 323.7744,798.0825 Q322.4297,798.0825 321.7449,799.1492 Q321.0601,800.2158 321.0601,802.3159 Q321.0601,804.4077 321.7449,805.4744 Q322.4297,806.541 323.7744,806.541 Q324.4053,806.541 324.9988,806.2712 Q325.5923,806.0015 326.2231,805.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="150" x="344.25" y="806.5352">AndroidVideoTrackSource</text><line style="stroke:#A80036;stroke-width:1.5;" x1="234" x2="572" y1="818" y2="818"/><ellipse cx="244" cy="829" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="168" x="253" y="832.6348">void SetState(SourceState state)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="234" x2="572" y1="838.9551" y2="838.9551"/><ellipse cx="244" cy="849.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="244" x="253" y="853.5898">ScopedJavaLocalRef&lt;jobject&gt; AdaptFrame(...)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="234" x2="572" y1="859.9102" y2="859.9102"/><ellipse cx="244" cy="870.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="142" x="253" y="874.5449">void OnFrameCaptured(...)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="234" x2="572" y1="880.8652" y2="880.8652"/><ellipse cx="244" cy="891.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="314" x="253" y="895.5">void SetIsScreencast(JNIEnv* env, jboolean j_is_screencast)</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="241" y="918.7754"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="175" x="253" y="925.4102">std::atomic&lt;SourceState&gt; state_</text><line style="stroke:#A80036;stroke-width:1.0;" x1="234" x2="391.5" y1="908.2979" y2="908.2979"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="391.5" y="911.9551">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="414.5" x2="572" y1="908.2979" y2="908.2979"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="234" x2="572" y1="931.7305" y2="931.7305"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="241" y="939.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="183" x="253" y="946.3652">std::atomic&lt;bool&gt; is_screencast_</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="234" x2="572" y1="952.6855" y2="952.6855"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="241" y="960.6855"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="227" x="253" y="967.3203">rtc::TimestampAligner timestamp_aligner_</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="234" x2="572" y1="973.6406" y2="973.6406"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="241" y="981.6406"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="127" x="253" y="988.2754">bool align_timestamps_</text><!--MD5=[0679a97b568289550c4081713cb02b65]
reverse link NotifierInterface to MediaSourceInterface--><path codeline="18" d="M349.8,94.91 C330.62,113.24 309.31,133.62 291.66,150.49 " fill="none" id="NotifierInterface-backto-MediaSourceInterface" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="344.98,89.83,364.27,81.07,354.65,99.95,344.98,89.83" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[5a153841ca8a57224d0847dab40fb0fb]
reverse link RefCountInterface to MediaSourceInterface--><path codeline="19" d="M159.13,95.18 C178.1,113.44 199.15,133.7 216.59,150.49 " fill="none" id="RefCountInterface-backto-MediaSourceInterface" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="154.03,99.99,144.47,81.07,163.74,89.9,154.03,99.99" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[7862f141ce08ce636cee3448cb099c88]
reverse link MediaSourceInterface to VideoTrackSourceInterface--><path codeline="44" d="M293.6,240.72 C306.03,257.12 320.14,275.73 334,294 " fill="none" id="MediaSourceInterface-backto-VideoTrackSourceInterface" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="287.84,244.71,281.33,224.54,298.99,236.25,287.84,244.71" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[8414994905215c1eb9f980ca0604f096]
reverse link VideoSourceInterface to VideoTrackSourceInterface--><path codeline="45" d="M505.87,250.24 C495.35,264.02 483.97,278.92 472.76,293.62 " fill="none" id="VideoSourceInterface-backto-VideoTrackSourceInterface" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="500.51,245.73,518.21,234.07,511.64,254.22,500.51,245.73" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[448b7439b96d458fbb907c4662517f21]
reverse link VideoTrackSourceInterface to AdaptedVideoTrackSource--><path codeline="62" d="M403,498.61 C403,511.74 403,525.03 403,537.87 " fill="none" id="VideoTrackSourceInterface-backto-AdaptedVideoTrackSource" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="396,498.2,403,478.2,410,498.2,396,498.2" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[bcd3338fa0acfeb7d671d2afb241a7b6]
reverse link AdaptedVideoTrackSource to AndroidVideoTrackSource--><path codeline="81" d="M403,746.6 C403,759.65 403,772.92 403,785.83 " fill="none" id="AdaptedVideoTrackSource-backto-AndroidVideoTrackSource" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="396,746.33,403,726.33,410,746.33,396,746.33" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[1c936da1a13ede31c42c3d10f3d91105]
@startuml
abstract class RefCountInterface {
    + {abstract} void AddRef()
    ..
    + {abstract} RefCountReleaseStatus Release()
}

abstract class NotifierInterface {
    + {abstract} void RegisterObserver(ObserverInterface* observer)
    ..
    + {abstract} void UnregisterObserver(ObserverInterface* observer)
}

abstract class MediaSourceInterface {
    + {abstract} SourceState state()
    + {abstract} bool remote()
}

NotifierInterface <|- - MediaSourceInterface
RefCountInterface <|- - MediaSourceInterface

abstract class VideoSourceInterface <<VideoFrame>> {
    + {abstract} void AddOrUpdateSink(VideoSinkInterface<VideoFrameT>* sink, 
    const VideoSinkWants& wants)
    ..
    + {abstract} void RemoveSink(VideoSinkInterface<VideoFrameT>* sink)
}

abstract class VideoTrackSourceInterface {
    + {abstract} bool is_screencast()
    ..
    + {abstract} bool needs_denoising()
    ..
    + {abstract} bool SupportsEncodedOutput()
    ..
    + {abstract} void GenerateKeyFrame()
    ..
    + {abstract} void AddEncodedSink(
      rtc::VideoSinkInterface<RecordableEncodedFrame>* sink)
    ..
    + {abstract} void RemoveEncodedSink(
      rtc::VideoSinkInterface<RecordableEncodedFrame>* sink)
}

MediaSourceInterface <|- - VideoTrackSourceInterface
VideoSourceInterface <|- - VideoTrackSourceInterface

class AdaptedVideoTrackSource {
    # AdaptedVideoTrackSource(int required_alignment)
    ..
    # void OnFrame(const webrtc::VideoFrame& frame)
    ..
    # bool AdaptFrame(...)
    ..
    # bool apply_rotation()
    ..
    # cricket::VideoAdapter* video_adapter()
    - -field- -
    - {field} cricket::VideoAdapter video_adapter_
    ..
    - {field} VideoBroadcaster broadcaster_
}
VideoTrackSourceInterface <|- - AdaptedVideoTrackSource

class AndroidVideoTrackSource {
    + void SetState(SourceState state)
    ..
    + ScopedJavaLocalRef<jobject> AdaptFrame(...)
    ..
    + void OnFrameCaptured(...)
    ..
    + void SetIsScreencast(JNIEnv* env, jboolean j_is_screencast)
    - -field- -
    - {field} std::atomic<SourceState> state_
    ..
    - {field} std::atomic<bool> is_screencast_
    ..
    - {field} rtc::TimestampAligner timestamp_aligner_
    ..
    - {field} bool align_timestamps_
}
AdaptedVideoTrackSource <|- - AndroidVideoTrackSource

@enduml

PlantUML version 1.2020.26(Tue Dec 22 01:45:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg></p><center> C++ &#x5C42; VideoSource &#x7C7B;&#x56FE; </center>
<p>&#x7B80;&#x8981;&#x4EE3;&#x7801;&#x6D41;&#x7A0B;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnectionFactory_jni.h</span>
JNI_GENERATOR_EXPORT jlong <span class="token function">Java_org_webrtc_PeerConnectionFactory_nativeCreateVideoSource</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jlong factory<span class="token punctuation">,</span>
    jboolean is_screencast<span class="token punctuation">,</span>
    jboolean alignTimestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_PeerConnectionFactory_CreateVideoSource</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> is_screencast<span class="token punctuation">,</span> alignTimestamps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection_factory.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_PeerConnectionFactory_CreateVideoSource</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    jlong native_factory<span class="token punctuation">,</span>
    jboolean is_screencast<span class="token punctuation">,</span>
    jboolean align_timestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  OwnedFactoryAndThreads<span class="token operator">*</span> factory <span class="token operator">=</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>OwnedFactoryAndThreads<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token function">CreateVideoSource</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> factory<span class="token operator">-&gt;</span><span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            factory<span class="token operator">-&gt;</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            is_screencast<span class="token punctuation">,</span> align_timestamps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/video.cc</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">CreateVideoSource</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                        rtc<span class="token operator">::</span>Thread<span class="token operator">*</span> signaling_thread<span class="token punctuation">,</span>
                        rtc<span class="token operator">::</span>Thread<span class="token operator">*</span> worker_thread<span class="token punctuation">,</span>
                        jboolean is_screencast<span class="token punctuation">,</span>
                        jboolean align_timestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AndroidVideoTrackSource<span class="token operator">&gt;</span> <span class="token function">source</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>AndroidVideoTrackSource<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            signaling_thread<span class="token punctuation">,</span> env<span class="token punctuation">,</span> is_screencast<span class="token punctuation">,</span> align_timestamps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> source<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/android_video_track_source.cc</span>
<span class="token comment">// AndroidVideoTrackSource &#x7EE7;&#x627F;&#x4E8E; AdaptedVideoTrackSource, AdaptedVideoTrackSource &#x53C8;&#x7EE7;&#x627F;&#x4E8E; VideoTrackSourceInterface</span>
<span class="token comment">// AdaptedVideoTrackSource &#x5B9E;&#x73B0;&#x4E86;&#x5BF9;&#x89C6;&#x9891;&#x88C1;&#x526A;&#xFF0C;&#x89D2;&#x5EA6;&#x65CB;&#x8F6C;&#xFF0C;&#x4E22;&#x5E27;&#x7B49;&#x5904;&#x7406;</span>
<span class="token class-name">AndroidVideoTrackSource</span><span class="token operator">::</span><span class="token function">AndroidVideoTrackSource</span><span class="token punctuation">(</span>rtc<span class="token operator">::</span>Thread<span class="token operator">*</span> signaling_thread<span class="token punctuation">,</span>
                                                 JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
                                                 <span class="token keyword">bool</span> is_screencast<span class="token punctuation">,</span>
                                                 <span class="token keyword">bool</span> align_timestamps<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">AdaptedVideoTrackSource</span><span class="token punctuation">(</span>kRequiredResolutionAlignment<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">signaling_thread_</span><span class="token punctuation">(</span>signaling_thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">is_screencast_</span><span class="token punctuation">(</span>is_screencast<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">align_timestamps_</span><span class="token punctuation">(</span>align_timestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>LS_INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;AndroidVideoTrackSource ctor&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="33-%E6%91%84%E5%83%8F%E5%A4%B4%E9%87%87%E9%9B%86%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8F%8A%E5%90%AF%E5%8A%A8">3.3 &#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#x521D;&#x59CB;&#x5316;&#x53CA;&#x542F;&#x52A8;</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/src/java/org/webrtc/CameraCapturer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">SurfaceTextureHelper</span> surfaceTextureHelper<span class="token punctuation">,</span> <span class="token class-name">Context</span> applicationContext<span class="token punctuation">,</span>
      <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>webrtc<span class="token punctuation">.</span></span>CapturerObserver</span> capturerObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span>
    <span class="token comment">// capturerObserver &#x89C6;&#x9891;&#x6570;&#x636E;&#x56DE;&#x8C03;&#x63A5;&#x53E3;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>capturerObserver <span class="token operator">=</span> capturerObserver<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>surfaceHelper <span class="token operator">=</span> surfaceTextureHelper<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraThreadHandler <span class="token operator">=</span> surfaceTextureHelper<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startCapture</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> framerate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;startCapture: &quot;</span> <span class="token operator">+</span> width <span class="token operator">+</span> <span class="token string">&quot;x&quot;</span> <span class="token operator">+</span> height <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> framerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;CameraCapturer must be initialized before calling startCapture.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stateLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionOpening <span class="token operator">||</span> currentSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Session already open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>framerate <span class="token operator">=</span> framerate<span class="token punctuation">;</span>

        sessionOpening <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// &#x6444;&#x50CF;&#x5934;&#x542F;&#x52A8;&#x5C1D;&#x8BD5;&#x6B21;&#x6570;</span>
        openAttemptsRemaining <span class="token operator">=</span> MAX_OPEN_CAMERA_ATTEMPTS<span class="token punctuation">;</span>
        <span class="token function">createSessionInternal</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createSessionInternal</span><span class="token punctuation">(</span><span class="token keyword">int</span> delayMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x542F;&#x52A8;&#x6444;&#x50CF;&#x5934;&#x542F;&#x52A8;&#x8D85;&#x65F6;&#x5B9A;&#x65F6;&#x5668;&#xFF0C;&#x4EE5;&#x4FBF;&#x91CD;&#x542F;&#x6444;&#x50CF;&#x5934;</span>
    uiThreadHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>openCameraTimeoutRunnable<span class="token punctuation">,</span> delayMs <span class="token operator">+</span> OPEN_CAMERA_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cameraThreadHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// &#x8C03;&#x7528;&#x5B50;&#x7C7B; Camera1Capturer &#x6216; Camera2Capturer &#x7684; createCameraSession() &#x5B9E;&#x73B0;</span>
            <span class="token function">createCameraSession</span><span class="token punctuation">(</span>createSessionCallback<span class="token punctuation">,</span> cameraSessionEventsHandler<span class="token punctuation">,</span> applicationContext<span class="token punctuation">,</span>
                surfaceHelper<span class="token punctuation">,</span> cameraName<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> framerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delayMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="331-%E5%90%AF%E5%8A%A8-camera1-%E9%87%87%E9%9B%86">3.3.1 &#x542F;&#x52A8; Camera1 &#x91C7;&#x96C6;</h4>

<p>&#x5728;&#x8C03;&#x7528; CameraCapturer &#x7684; startCapture() &#x65F6;&#x542F;&#x52A8;&#xFF0C;&#x5148;&#x521B;&#x5EFA; Camera1Session&#xFF0C;&#x5E76;&#x5728; Camera1Session &#x5185;&#x542F;&#x52A8;&#x6444;&#x50CF;&#x5934;&#x3002;</p>
<ol>
<li>&#x521B;&#x5EFA; Camera1Session&#xFF0C;&#x5E76;&#x6253;&#x5F00;&#x6444;&#x50CF;&#x5934;&#xFF0C;&#x8BBE;&#x7F6E;&#x6444;&#x50CF;&#x5934;&#x53C2;&#x6570;&#x3002;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera1Capturer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">createCameraSession</span><span class="token punctuation">(</span><span class="token class-name">CameraSession<span class="token punctuation">.</span>CreateSessionCallback</span> createSessionCallback<span class="token punctuation">,</span>
    <span class="token class-name">CameraSession<span class="token punctuation">.</span>Events</span> events<span class="token punctuation">,</span> <span class="token class-name">Context</span> applicationContext<span class="token punctuation">,</span>
    <span class="token class-name">SurfaceTextureHelper</span> surfaceTextureHelper<span class="token punctuation">,</span> <span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span>
    <span class="token keyword">int</span> framerate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x521B;&#x5EFA; Camera1Session &#x5E76;&#x542F;&#x52A8;&#x6444;&#x50CF;&#x5934;</span>
    <span class="token class-name">Camera1Session</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>createSessionCallback<span class="token punctuation">,</span> events<span class="token punctuation">,</span> captureToTexture<span class="token punctuation">,</span> applicationContext<span class="token punctuation">,</span>
        surfaceTextureHelper<span class="token punctuation">,</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">.</span><span class="token function">getCameraIndex</span><span class="token punctuation">(</span>cameraName<span class="token punctuation">)</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
        framerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/java/org/webrtc/Camera1Session.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">CreateSessionCallback</span> callback<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Events</span> events<span class="token punctuation">,</span>
      <span class="token keyword">final</span> <span class="token keyword">boolean</span> captureToTexture<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Context</span> applicationContext<span class="token punctuation">,</span>
      <span class="token keyword">final</span> <span class="token class-name">SurfaceTextureHelper</span> surfaceTextureHelper<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> cameraId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> framerate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> constructionTimeNs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Open camera &quot;</span> <span class="token operator">+</span> cameraId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x72B6;&#x6001;&#x4E0A;&#x62A5;</span>
    events<span class="token punctuation">.</span><span class="token function">onCameraOpening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera</span> camera<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x6253;&#x5F00;&#x6444;&#x50CF;&#x5934;</span>
        camera <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>cameraId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x6444;&#x50CF;&#x5934;&#x6253;&#x5F00;&#x5931;&#x8D25;&#xFF0C;&#x56DE;&#x8C03;&#x89E6;&#x53D1;&#x91CD;&#x542F;</span>
        callback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">FailureType</span><span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>camera <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x6444;&#x50CF;&#x5934;&#x6253;&#x5F00;&#x5931;&#x8D25;&#xFF0C;&#x56DE;&#x8C03;&#x89E6;&#x53D1;&#x91CD;&#x542F;</span>
        callback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">FailureType</span><span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>
            <span class="token string">&quot;android.hardware.Camera.open returned null for camera id = &quot;</span> <span class="token operator">+</span> cameraId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x8BBE;&#x7F6E;&#x6444;&#x50CF;&#x5934;&#x9884;&#x89C8;</span>
        camera<span class="token punctuation">.</span><span class="token function">setPreviewTexture</span><span class="token punctuation">(</span>surfaceTextureHelper<span class="token punctuation">.</span><span class="token function">getSurfaceTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        camera<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// &#x6444;&#x50CF;&#x5934;&#x9884;&#x89C8;&#x8BBE;&#x7F6E;&#x5931;&#x8D25;&#xFF0C;&#x56DE;&#x8C03;&#x89E6;&#x53D1;&#x91CD;&#x542F;</span>
        callback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">FailureType</span><span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x6444;&#x50CF;&#x5934; &#x53C2;&#x6570;&#x8BBE;&#x7F6E;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// &#x82E5;&#x4EE5;&#x975E;&#x7EB9;&#x7406;&#x65B9;&#x5F0F;&#x6355;&#x6349;&#xFF0C;&#x5219;&#x901A;&#x8FC7; Camera.PreviewCallback &#x56DE;&#x8C03;&#x91C7;&#x96C6;&#x6570;&#x636E;&#xFF0C;&#x9700;&#x8BBE;&#x7F6E;&#x7F13;&#x51B2;&#x533A;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>captureToTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> frameSize <span class="token operator">=</span> captureFormat<span class="token punctuation">.</span><span class="token function">frameSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUMBER_OF_CAPTURE_BUFFERS<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span>frameSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            camera<span class="token punctuation">.</span><span class="token function">addCallbackBuffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Calculate orientation manually and send it as CVO insted.</span>
    camera<span class="token punctuation">.</span><span class="token function">setDisplayOrientation</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token comment">/* degrees */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    callback<span class="token punctuation">.</span><span class="token function">onDone</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Camera1Session</span><span class="token punctuation">(</span>events<span class="token punctuation">,</span> captureToTexture<span class="token punctuation">,</span> applicationContext<span class="token punctuation">,</span>
        surfaceTextureHelper<span class="token punctuation">,</span> cameraId<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> info<span class="token punctuation">,</span> captureFormat<span class="token punctuation">,</span> constructionTimeNs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Camera1Session</span><span class="token punctuation">(</span><span class="token class-name">Events</span> events<span class="token punctuation">,</span> <span class="token keyword">boolean</span> captureToTexture<span class="token punctuation">,</span> <span class="token class-name">Context</span> applicationContext<span class="token punctuation">,</span>
      <span class="token class-name">SurfaceTextureHelper</span> surfaceTextureHelper<span class="token punctuation">,</span> <span class="token keyword">int</span> cameraId<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera</span> camera<span class="token punctuation">,</span>
      <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera<span class="token punctuation">.</span>CameraInfo</span> info<span class="token punctuation">,</span> <span class="token class-name">CaptureFormat</span> captureFormat<span class="token punctuation">,</span>
      <span class="token keyword">long</span> constructionTimeNs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Create new camera1 session on camera &quot;</span> <span class="token operator">+</span> cameraId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraThreadHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>events <span class="token operator">=</span> events<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>captureToTexture <span class="token operator">=</span> captureToTexture<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>surfaceTextureHelper <span class="token operator">=</span> surfaceTextureHelper<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraId <span class="token operator">=</span> cameraId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>camera <span class="token operator">=</span> camera<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>captureFormat <span class="token operator">=</span> captureFormat<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>constructionTimeNs <span class="token operator">=</span> constructionTimeNs<span class="token punctuation">;</span>

    <span class="token comment">// &#x8BBE;&#x7F6E;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x8F93;&#x51FA;&#x5206;&#x8FA8;&#x7387;</span>
    surfaceTextureHelper<span class="token punctuation">.</span><span class="token function">setTextureSize</span><span class="token punctuation">(</span>captureFormat<span class="token punctuation">.</span>width<span class="token punctuation">,</span> captureFormat<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x5F00;&#x59CB;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;</span>
    <span class="token function">startCapturing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><ol start="2">
<li>&#x542F;&#x52A8;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#xFF0C;&#x8BBE;&#x7F6E;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x56DE;&#x8C03;&#x3002;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/src/java/org/webrtc/Camera1Session.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startCapturing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Start capturing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkIsOnCameraThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    state <span class="token operator">=</span> <span class="token class-name">SessionState</span><span class="token punctuation">.</span>RUNNING<span class="token punctuation">;</span>

    camera<span class="token punctuation">.</span><span class="token function">setErrorCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera<span class="token punctuation">.</span>ErrorCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">int</span> error<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera</span> camera<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> errorMessage<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera</span><span class="token punctuation">.</span>CAMERA_ERROR_SERVER_DIED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                errorMessage <span class="token operator">=</span> <span class="token string">&quot;Camera server died!&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                errorMessage <span class="token operator">=</span> <span class="token string">&quot;Camera error: &quot;</span> <span class="token operator">+</span> error<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">stopInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera</span><span class="token punctuation">.</span>CAMERA_ERROR_EVICTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                events<span class="token punctuation">.</span><span class="token function">onCameraDisconnected</span><span class="token punctuation">(</span><span class="token class-name">Camera1Session</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                events<span class="token punctuation">.</span><span class="token function">onCameraError</span><span class="token punctuation">(</span><span class="token class-name">Camera1Session</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x8BBE;&#x7F6E;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x76D1;&#x542C;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>captureToTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">listenForTextureFrames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">listenForBytebufferFrames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x6B63;&#x5F0F;&#x542F;&#x52A8;&#x6444;&#x50CF;&#x5934;</span>
        camera<span class="token punctuation">.</span><span class="token function">startPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stopInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        events<span class="token punctuation">.</span><span class="token function">onCameraError</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="332-%E5%90%AF%E5%8A%A8-camera2-%E9%87%87%E9%9B%86">3.3.2 &#x542F;&#x52A8; Camera2 &#x91C7;&#x96C6;</h4>

<p>&#x5728;&#x8C03;&#x7528; CameraCapturer &#x7684; startCapture() &#x65F6;&#x542F;&#x52A8;&#xFF0C;&#x5148;&#x521B;&#x5EFA; Camera2Session&#xFF0C;&#x5E76;&#x5728; Camera2Session &#x5185;&#x542F;&#x52A8;&#x6444;&#x50CF;&#x5934;&#x3002;</p>
<ol>
<li>&#x521B;&#x5EFA; Camera2Session</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera2Capturer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">createCameraSession</span><span class="token punctuation">(</span><span class="token class-name">CameraSession<span class="token punctuation">.</span>CreateSessionCallback</span> createSessionCallback<span class="token punctuation">,</span>
      <span class="token class-name">CameraSession<span class="token punctuation">.</span>Events</span> events<span class="token punctuation">,</span> <span class="token class-name">Context</span> applicationContext<span class="token punctuation">,</span>
      <span class="token class-name">SurfaceTextureHelper</span> surfaceTextureHelper<span class="token punctuation">,</span> <span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      <span class="token keyword">int</span> framerate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Camera2Session</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>createSessionCallback<span class="token punctuation">,</span> events<span class="token punctuation">,</span> applicationContext<span class="token punctuation">,</span> cameraManager<span class="token punctuation">,</span>
        surfaceTextureHelper<span class="token punctuation">,</span> cameraName<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> framerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/java/org/webrtc/Camera2Session.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">CreateSessionCallback</span> callback<span class="token punctuation">,</span> <span class="token class-name">Events</span> events<span class="token punctuation">,</span>
      <span class="token class-name">Context</span> applicationContext<span class="token punctuation">,</span> <span class="token class-name">CameraManager</span> cameraManager<span class="token punctuation">,</span>
      <span class="token class-name">SurfaceTextureHelper</span> surfaceTextureHelper<span class="token punctuation">,</span> <span class="token class-name">String</span> cameraId<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      <span class="token keyword">int</span> framerate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Camera2Session</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> events<span class="token punctuation">,</span> applicationContext<span class="token punctuation">,</span> cameraManager<span class="token punctuation">,</span> surfaceTextureHelper<span class="token punctuation">,</span>
        cameraId<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> framerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Camera2Session</span><span class="token punctuation">(</span><span class="token class-name">CreateSessionCallback</span> callback<span class="token punctuation">,</span> <span class="token class-name">Events</span> events<span class="token punctuation">,</span> <span class="token class-name">Context</span> applicationContext<span class="token punctuation">,</span>
      <span class="token class-name">CameraManager</span> cameraManager<span class="token punctuation">,</span> <span class="token class-name">SurfaceTextureHelper</span> surfaceTextureHelper<span class="token punctuation">,</span> <span class="token class-name">String</span> cameraId<span class="token punctuation">,</span>
      <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> framerate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Create new camera2 session on camera &quot;</span> <span class="token operator">+</span> cameraId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    constructionTimeNs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraThreadHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>events <span class="token operator">=</span> events<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraManager <span class="token operator">=</span> cameraManager<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>surfaceTextureHelper <span class="token operator">=</span> surfaceTextureHelper<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraId <span class="token operator">=</span> cameraId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>framerate <span class="token operator">=</span> framerate<span class="token punctuation">;</span>

    <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><ol start="2">
<li>&#x6253;&#x5F00;&#x6444;&#x50CF;&#x5934;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkIsOnCameraThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        cameraCharacteristics <span class="token operator">=</span> cameraManager<span class="token punctuation">.</span><span class="token function">getCameraCharacteristics</span><span class="token punctuation">(</span>cameraId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">CameraAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;getCameraCharacteristics(): &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cameraOrientation <span class="token operator">=</span> cameraCharacteristics<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">CameraCharacteristics</span><span class="token punctuation">.</span>SENSOR_ORIENTATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    isCameraFrontFacing <span class="token operator">=</span> cameraCharacteristics<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">CameraCharacteristics</span><span class="token punctuation">.</span>LENS_FACING<span class="token punctuation">)</span>
        <span class="token operator">==</span> <span class="token class-name">CameraMetadata</span><span class="token punctuation">.</span>LENS_FACING_FRONT<span class="token punctuation">;</span>

    <span class="token function">findCaptureFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">openCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">openCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkIsOnCameraThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Opening camera &quot;</span> <span class="token operator">+</span> cameraId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    events<span class="token punctuation">.</span><span class="token function">onCameraOpening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x8BBE;&#x7F6E;&#x6444;&#x50CF;&#x5934;&#x72B6;&#x6001;&#x56DE;&#x8C03;&#xFF0C;&#x6253;&#x5F00;&#x6444;&#x50CF;&#x5934;</span>
        cameraManager<span class="token punctuation">.</span><span class="token function">openCamera</span><span class="token punctuation">(</span>cameraId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CameraStateCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cameraThreadHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CameraAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to open camera: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="34-%E5%88%9B%E5%BB%BA-videotrack">3.4 &#x521B;&#x5EFA; VideoTrack</h3>

<p>&#x8C03;&#x7528;&#x5165;&#x53E3;&#x4E3A; PeerConnectionClient.createVideoTrack()&#xFF0C; &#x8BE6;&#x89C1; <a href="#13-%E5%88%9B%E5%BB%BA-videotrack">1.3 &#x521B;&#x5EFA; VideoTrack</a>&#x3002;<br>
&#x5728;&#x521B;&#x5EFA; VideoSource &#x53CA;&#x6253;&#x5F00;&#x6444;&#x50CF;&#x5934;&#x4E4B;&#x540E;&#xFF0C;&#x8C03;&#x7528; PeerConnectionFactory.createVideoTrack()&#x3002;</p>
<h4 class="mume-header" id="341-%E5%88%9B%E5%BB%BA-videotrack">3.4.1 &#x521B;&#x5EFA; VideoTrack</h4>

<p>localVideoTrack = factory.createVideoTrack(VIDEO_TRACK_ID, videoSource);</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="396px" preserveAspectRatio="none" style="width:829px;height:396px;" version="1.1" viewBox="0 0 829 396" width="829px" zoomAndPan="magnify"><defs><filter height="300%" id="f14drsf1fjk6va" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[a672ae9fac79242bca3f687b5a335114]
class MediaStreamTrack--><rect codeline="2" fill="#FEFECE" filter="url(#f14drsf1fjk6va)" height="136.7754" id="MediaStreamTrack" style="stroke:#A80036;stroke-width:1.5;" width="221" x="21" y="7"/><ellipse cx="73.25" cy="23" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M75.7231,29.1431 Q75.1421,29.4419 74.5029,29.5913 Q73.8638,29.7407 73.1582,29.7407 Q70.6514,29.7407 69.3315,28.0889 Q68.0117,26.437 68.0117,23.3159 Q68.0117,20.1865 69.3315,18.5347 Q70.6514,16.8828 73.1582,16.8828 Q73.8638,16.8828 74.5112,17.0322 Q75.1587,17.1816 75.7231,17.4805 L75.7231,20.2031 Q75.0923,19.6221 74.4988,19.3523 Q73.9053,19.0825 73.2744,19.0825 Q71.9297,19.0825 71.2449,20.1492 Q70.5601,21.2158 70.5601,23.3159 Q70.5601,25.4077 71.2449,26.4744 Q71.9297,27.541 73.2744,27.541 Q73.9053,27.541 74.4988,27.2712 Q75.0923,27.0015 75.7231,26.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="108" x="93.75" y="27.5352">MediaStreamTrack</text><line style="stroke:#A80036;stroke-width:1.5;" x1="22" x2="241" y1="39" y2="39"/><ellipse cx="32" cy="50" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="195" x="41" y="53.6348">MediaStreamTrack(long nativeTrack)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="22" x2="241" y1="59.9551" y2="59.9551"/><ellipse cx="32" cy="70.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="193" x="41" y="74.5898">boolean setEnabled(boolean enable)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="22" x2="241" y1="80.9102" y2="80.9102"/><ellipse cx="32" cy="91.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="76" x="41" y="95.5449">void dispose()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="22" x2="241" y1="101.8652" y2="101.8652"/><ellipse cx="32" cy="112.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="183" x="41" y="116.5">long getNativeMediaStreamTrack()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="22" x2="241" y1="122.8203" y2="122.8203"/><ellipse cx="32" cy="133.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="66" x="41" y="137.4551">String kind()</text><path d="M277.5,63 L277.5,71.5 L242.29,75.5 L277.5,79.5 L277.5,88.3105 A0,0 0 0 0 277.5,88.3105 L617.5,88.3105 A0,0 0 0 0 617.5,88.3105 L617.5,73 L607.5,63 L277.5,63 A0,0 0 0 0 277.5,63 " fill="#FBFB77" filter="url(#f14drsf1fjk6va)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M607.5,63 L607.5,73 L617.5,73 L607.5,63 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="283.5" y="80.5684">Java wrapper for a C++ MediaStreamTrackInterface</text><!--MD5=[624725d07d18954dc286a411c06d7419]
class VideoTrack--><rect codeline="16" fill="#FEFECE" filter="url(#f14drsf1fjk6va)" height="178.6855" id="VideoTrack" style="stroke:#A80036;stroke-width:1.5;" width="249" x="7" y="204"/><ellipse cx="94.25" cy="220" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M96.7231,226.1431 Q96.1421,226.4419 95.5029,226.5913 Q94.8638,226.7407 94.1582,226.7407 Q91.6514,226.7407 90.3315,225.0889 Q89.0117,223.437 89.0117,220.3159 Q89.0117,217.1865 90.3315,215.5347 Q91.6514,213.8828 94.1582,213.8828 Q94.8638,213.8828 95.5112,214.0322 Q96.1587,214.1816 96.7231,214.4805 L96.7231,217.2031 Q96.0923,216.6221 95.4988,216.3523 Q94.9053,216.0825 94.2744,216.0825 Q92.9297,216.0825 92.2449,217.1492 Q91.5601,218.2158 91.5601,220.3159 Q91.5601,222.4077 92.2449,223.4744 Q92.9297,224.541 94.2744,224.541 Q94.9053,224.541 95.4988,224.2712 Q96.0923,224.0015 96.7231,223.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="66" x="114.75" y="224.5352">VideoTrack</text><line style="stroke:#A80036;stroke-width:1.5;" x1="8" x2="255" y1="236" y2="236"/><ellipse cx="18" cy="247" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="157" x="27" y="250.6348">VideoTrack(long nativeTrack)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="255" y1="256.9551" y2="256.9551"/><ellipse cx="18" cy="267.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="153" x="27" y="271.5898">void addSink(VideoSink sink)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="255" y1="277.9102" y2="277.9102"/><ellipse cx="18" cy="288.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="173" x="27" y="292.5449">void removeSink(VideoSink sink)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="255" y1="298.8652" y2="298.8652"/><ellipse cx="18" cy="309.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="145" x="27" y="313.5">long getNativeVideoTrack()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="255" y1="319.8203" y2="319.8203"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="15" y="327.8203"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="193" x="27" y="334.4551">long nativeWrapSink(VideoSink sink)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="255" y1="340.7754" y2="340.7754"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="15" y="348.7754"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="160" x="27" y="355.4102">void nativeFreeSink(long sink)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="255" y1="361.7305" y2="361.7305"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="15" y="369.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="223" x="27" y="376.3652">IdentityHashMap&lt;VideoSink, Long&gt; sinks</text><path d="M291.5,281 L291.5,289.5 L256.08,293.5 L291.5,297.5 L291.5,306.3105 A0,0 0 0 0 291.5,306.3105 L533.5,306.3105 A0,0 0 0 0 533.5,306.3105 L533.5,291 L523.5,281 L291.5,281 A0,0 0 0 0 291.5,281 " fill="#FBFB77" filter="url(#f14drsf1fjk6va)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M523.5,281 L523.5,291 L533.5,291 L523.5,281 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="297.5" y="298.5684">Java version of VideoTrackInterface</text><path d="M653,63 L653,88.3105 L820,88.3105 L820,73 L810,63 L653,63 " fill="#FBFB77" filter="url(#f14drsf1fjk6va)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M810,63 L810,73 L820,73 L810,63 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="659" y="80.5684">Java &#x5C42; VideoTrack &#x7C7B;&#x56FE;</text><!--MD5=[1822c88301af4e154c8d0f782aae6fb9]
reverse link MediaStreamTrack to VideoTrack--><path codeline="33" d="M131.5,164.34 C131.5,177.41 131.5,190.89 131.5,203.97 " fill="none" id="MediaStreamTrack-backto-VideoTrack" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="124.5,164.25,131.5,144.25,138.5,164.25,124.5,164.25" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[b91125004d615430a4d92325904924b2]
@startuml

class MediaStreamTrack {
    + MediaStreamTrack(long nativeTrack)
    ..
    + boolean setEnabled(boolean enable)
    ..
    + void dispose()
    ..
    + long getNativeMediaStreamTrack()
    ..
    + String kind()
}

note right of MediaStreamTrack : Java wrapper for a C++ MediaStreamTrackInterface

class VideoTrack {
    + VideoTrack(long nativeTrack)
    ..
    + void addSink(VideoSink sink)
    ..
    + void removeSink(VideoSink sink)
    ..
    + long getNativeVideoTrack()
    ..
    - long nativeWrapSink(VideoSink sink)
    ..
    - void nativeFreeSink(long sink)
    ..
    - {field} IdentityHashMap<VideoSink, Long> sinks
}
note right of VideoTrack: Java version of VideoTrackInterface

MediaStreamTrack <|- - VideoTrack

note "Java  VideoTrack " as N1
@enduml

PlantUML version 1.2020.26(Tue Dec 22 01:45:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg></p><center>Java &#x5C42; VideoTrack &#x7C7B;&#x56FE;</center>
<p>&#x521B;&#x5EFA;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/PeerConnectionFactory.java</span>
<span class="token comment">// id: &quot;ARDAMSv0&quot;</span>
<span class="token keyword">public</span> <span class="token class-name">VideoTrack</span> <span class="token function">createVideoTrack</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">VideoSource</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkPeerConnectionFactoryExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">VideoTrack</span><span class="token punctuation">(</span>
        <span class="token function">nativeCreateVideoTrack</span><span class="token punctuation">(</span>nativeFactory<span class="token punctuation">,</span> id<span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">getNativeVideoTrackSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">/* Native VideoSource &#x6307;&#x9488;&#x5730;&#x5740; */</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/VideoTrack.java</span>
<span class="token keyword">public</span> <span class="token class-name">VideoTrack</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x8C03;&#x7528;&#x7236;&#x7C7B; MediaStreamTrack &#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x4FDD;&#x5B58; native &#x6307;&#x9488;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>nativeTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>&#x521B;&#x5EFA; Native &#x5C42; VideoTrack&#x3002;</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="1172px" preserveAspectRatio="none" style="width:849px;height:1172px;" version="1.1" viewBox="0 0 849 1172" width="849px" zoomAndPan="magnify"><defs><filter height="300%" id="f11ett8m8q7ldr" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[f09b074c911cbd46f8902695b08e6b0a]
class RefCountInterface--><rect codeline="1" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="73.9102" id="RefCountInterface" style="stroke:#A80036;stroke-width:1.5;" width="200" x="7" y="7"/><ellipse cx="51.75" cy="23" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M51.8633,18.5981 L50.7095,23.6699 L53.0254,23.6699 Z M50.3691,16.3569 L53.3657,16.3569 L56.7109,28.75 L54.2622,28.75 L53.4985,25.687 L50.2197,25.687 L49.4727,28.75 L47.0239,28.75 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="102" x="72.25" y="27.5352">RefCountInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="8" x2="206" y1="39" y2="39"/><ellipse cx="18" cy="50" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="73" x="27" y="53.6348">void AddRef()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="206" y1="59.9551" y2="59.9551"/><ellipse cx="18" cy="70.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="174" x="27" y="74.5898">RefCountReleaseStatus Release()</text><!--MD5=[01c0a374e0ca965dd1eeca3f6175e91c]
class NotifierInterface--><rect codeline="7" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="73.9102" id="NotifierInterface" style="stroke:#A80036;stroke-width:1.5;" width="320" x="242" y="7"/><ellipse cx="351.75" cy="23" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M351.8633,18.5981 L350.7095,23.6699 L353.0254,23.6699 Z M350.3691,16.3569 L353.3657,16.3569 L356.7109,28.75 L354.2622,28.75 L353.4985,25.687 L350.2197,25.687 L349.4727,28.75 L347.0239,28.75 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="92" x="372.25" y="27.5352">NotifierInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="243" x2="561" y1="39" y2="39"/><ellipse cx="253" cy="50" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="281" x="262" y="53.6348">void RegisterObserver(ObserverInterface* observer)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="243" x2="561" y1="59.9551" y2="59.9551"/><ellipse cx="253" cy="70.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="294" x="262" y="74.5898">void UnregisterObserver(ObserverInterface* observer)</text><!--MD5=[dfabf0a64290ba1c2105ee3103a164d5]
class ObserverInterface--><rect codeline="13" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="60.9551" id="ObserverInterface" style="stroke:#A80036;stroke-width:1.5;" width="135" x="428.5" y="718.5"/><ellipse cx="443.5" cy="734.5" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M443.6133,730.0981 L442.4595,735.1699 L444.7754,735.1699 Z M442.1191,727.8569 L445.1157,727.8569 L448.4609,740.25 L446.0122,740.25 L445.2485,737.187 L441.9697,737.187 L441.2227,740.25 L438.7739,740.25 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="103" x="457.5" y="739.0352">ObserverInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="429.5" x2="562.5" y1="750.5" y2="750.5"/><line style="stroke:#A80036;stroke-width:1.5;" x1="429.5" x2="562.5" y1="758.5" y2="758.5"/><ellipse cx="439.5" cy="769.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="98" x="448.5" y="773.1348">void OnChanged()</text><!--MD5=[cdba1842027a29aa7c4c028465e70e99]
class MediaStreamTrackInterface--><rect codeline="17" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="115.8203" id="MediaStreamTrackInterface" style="stroke:#A80036;stroke-width:1.5;" width="190" x="159" y="141"/><ellipse cx="174" cy="157" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M174.1133,152.5981 L172.9595,157.6699 L175.2754,157.6699 Z M172.6191,150.3569 L175.6157,150.3569 L178.9609,162.75 L176.5122,162.75 L175.7485,159.687 L172.4697,159.687 L171.7227,162.75 L169.2739,162.75 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="158" x="188" y="161.5352">MediaStreamTrackInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="160" x2="348" y1="173" y2="173"/><ellipse cx="170" cy="184" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="89" x="179" y="187.6348">std::string kind()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="160" x2="348" y1="193.9551" y2="193.9551"/><ellipse cx="170" cy="204.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="161" x="179" y="208.5898">bool set_enabled(bool enable)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="160" x2="348" y1="214.9102" y2="214.9102"/><ellipse cx="170" cy="225.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="77" x="179" y="229.5449">bool enabled()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="160" x2="348" y1="235.8652" y2="235.8652"/><ellipse cx="170" cy="246.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="93" x="179" y="250.5">TrackState state()</text><!--MD5=[b938fa271f0b869b5d94b8c15d06f4a6]
class VideoSourceInterface--><rect codeline="30" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="93.1309" id="VideoSourceInterface" style="stroke:#A80036;stroke-width:1.5;" width="372" x="408" y="152.5"/><ellipse cx="529.25" cy="171.6328" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M529.3633,167.231 L528.2095,172.3027 L530.5254,172.3027 Z M527.8691,164.9897 L530.8657,164.9897 L534.2109,177.3828 L531.7622,177.3828 L530.9985,174.3198 L527.7197,174.3198 L526.9727,177.3828 L524.5239,177.3828 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="81" x="569.75" y="169.1016">&#xAB;VideoFrame&#xBB;</text><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="121" x="549.75" y="183.2344">VideoSourceInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="409" x2="779" y1="190.7656" y2="190.7656"/><ellipse cx="419" cy="201.7656" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="346" x="428" y="205.4004">void AddOrUpdateSink(VideoSinkInterface&lt;VideoFrameT&gt;* sink,</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="163" x="428" y="218.3555">const VideoSinkWants&amp; wants)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="409" x2="779" y1="224.6758" y2="224.6758"/><ellipse cx="419" cy="235.6758" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="315" x="428" y="239.3105">void RemoveSink(VideoSinkInterface&lt;VideoFrameT&gt;* sink)</text><!--MD5=[cac854fbcca87e45cfe4d524d1f84242]
class VideoTrackInterface--><rect codeline="37" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="94.8652" id="VideoTrackInterface" style="stroke:#A80036;stroke-width:1.5;" width="241" x="133.5" y="317"/><ellipse cx="191.75" cy="333" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M194.2231,339.1431 Q193.6421,339.4419 193.0029,339.5913 Q192.3638,339.7407 191.6582,339.7407 Q189.1514,339.7407 187.8315,338.0889 Q186.5117,336.437 186.5117,333.3159 Q186.5117,330.1865 187.8315,328.5347 Q189.1514,326.8828 191.6582,326.8828 Q192.3638,326.8828 193.0112,327.0322 Q193.6587,327.1816 194.2231,327.4805 L194.2231,330.2031 Q193.5923,329.6221 192.9988,329.3523 Q192.4053,329.0825 191.7744,329.0825 Q190.4297,329.0825 189.7449,330.1492 Q189.0601,331.2158 189.0601,333.3159 Q189.0601,335.4077 189.7449,336.4744 Q190.4297,337.541 191.7744,337.541 Q192.4053,337.541 192.9988,337.2712 Q193.5923,337.0015 194.2231,336.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="116" x="212.25" y="337.5352">VideoTrackInterface</text><line style="stroke:#A80036;stroke-width:1.5;" x1="134.5" x2="373.5" y1="349" y2="349"/><ellipse cx="144.5" cy="360" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="215" x="153.5" y="363.6348">VideoTrackSourceInterface* GetSource()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="134.5" x2="373.5" y1="369.9551" y2="369.9551"/><ellipse cx="144.5" cy="380.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="213" x="153.5" y="384.5898">void set_content_hint(ContentHint hint)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="134.5" x2="373.5" y1="390.9102" y2="390.9102"/><ellipse cx="144.5" cy="401.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="144" x="153.5" y="405.5449">ContentHint content_hint()</text><!--MD5=[bc5b29fb3d887e13be4d600333f8a461]
class Notifier--><rect codeline="48" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="131.041" id="Notifier" style="stroke:#A80036;stroke-width:1.5;" width="320" x="46" y="472"/><ellipse cx="139.75" cy="491.1328" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M142.2231,497.2759 Q141.6421,497.5747 141.0029,497.7241 Q140.3638,497.8735 139.6582,497.8735 Q137.1514,497.8735 135.8315,496.2217 Q134.5117,494.5698 134.5117,491.4487 Q134.5117,488.3193 135.8315,486.6675 Q137.1514,485.0156 139.6582,485.0156 Q140.3638,485.0156 141.0112,485.165 Q141.6587,485.3145 142.2231,485.6133 L142.2231,488.3359 Q141.5923,487.7549 140.9988,487.4851 Q140.4053,487.2153 139.7744,487.2153 Q138.4297,487.2153 137.7449,488.282 Q137.0601,489.3486 137.0601,491.4487 Q137.0601,493.5405 137.7449,494.6072 Q138.4297,495.6738 139.7744,495.6738 Q140.4053,495.6738 140.9988,495.4041 Q141.5923,495.1343 142.2231,494.5532 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="128" x="158.25" y="488.6016">&#xAB;VideoTrackInterface&#xBB;</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="42" x="201.25" y="502.7344">Notifier</text><line style="stroke:#A80036;stroke-width:1.5;" x1="47" x2="365" y1="510.2656" y2="510.2656"/><ellipse cx="57" cy="521.2656" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="281" x="66" y="524.9004">void RegisterObserver(ObserverInterface* observer)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="47" x2="365" y1="531.2207" y2="531.2207"/><ellipse cx="57" cy="542.2207" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="294" x="66" y="545.8555">void UnregisterObserver(ObserverInterface* observer)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="47" x2="365" y1="552.1758" y2="552.1758"/><ellipse cx="57" cy="563.1758" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="118" x="66" y="566.8105">void FireOnChanged()</text><polygon fill="none" points="57,588.0859,61,592.0859,57,596.0859,53,592.0859" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="222" x="66" y="596.7207">std::list&lt;ObserverInterface*&gt; observers_</text><line style="stroke:#A80036;stroke-width:1.0;" x1="47" x2="194.5" y1="579.6084" y2="579.6084"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="194.5" y="583.2656">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="217.5" x2="365" y1="579.6084" y2="579.6084"/><!--MD5=[a672ae9fac79242bca3f687b5a335114]
class MediaStreamTrack--><rect codeline="58" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="171.6406" id="MediaStreamTrack" style="stroke:#A80036;stroke-width:1.5;" width="372" x="21" y="663"/><ellipse cx="148.75" cy="679" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M151.2231,685.1431 Q150.6421,685.4419 150.0029,685.5913 Q149.3638,685.7407 148.6582,685.7407 Q146.1514,685.7407 144.8315,684.0889 Q143.5117,682.437 143.5117,679.3159 Q143.5117,676.1865 144.8315,674.5347 Q146.1514,672.8828 148.6582,672.8828 Q149.3638,672.8828 150.0112,673.0322 Q150.6587,673.1816 151.2231,673.4805 L151.2231,676.2031 Q150.5923,675.6221 149.9988,675.3523 Q149.4053,675.0825 148.7744,675.0825 Q147.4297,675.0825 146.7449,676.1492 Q146.0601,677.2158 146.0601,679.3159 Q146.0601,681.4077 146.7449,682.4744 Q147.4297,683.541 148.7744,683.541 Q149.4053,683.541 149.9988,683.2712 Q150.5923,683.0015 151.2231,682.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="108" x="169.25" y="683.5352">MediaStreamTrack</text><line style="stroke:#A80036;stroke-width:1.5;" x1="22" x2="392" y1="695" y2="695"/><ellipse cx="32" cy="706" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="244" x="41" y="709.6348">MediaStreamTrackInterface::TrackState state()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="22" x2="392" y1="715.9551" y2="715.9551"/><ellipse cx="32" cy="726.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="77" x="41" y="730.5898">bool enabled()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="22" x2="392" y1="736.9102" y2="736.9102"/><ellipse cx="32" cy="747.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="161" x="41" y="751.5449">bool set_enabled(bool enable)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="22" x2="392" y1="757.8652" y2="757.8652"/><polygon fill="#FFFF44" points="32,763.8652,36,767.8652,32,771.8652,28,767.8652" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="346" x="41" y="772.5">bool set_state(MediaStreamTrackInterface::TrackState new_state)</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="29" y="795.7754"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="75" x="41" y="802.4102">bool enabled_</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="29" y="808.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="77" x="41" y="815.3652">std::string id_;</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="29" y="821.6855"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="242" x="41" y="828.3203">MediaStreamTrackInterface::TrackState state_</text><line style="stroke:#A80036;stroke-width:1.0;" x1="22" x2="195.5" y1="785.2979" y2="785.2979"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="195.5" y="788.9551">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="218.5" x2="392" y1="785.2979" y2="785.2979"/><!--MD5=[974f90801eb1d681aea5b35a8b965827]
class VideoSourceBase--><rect codeline="74" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="82.8652" id="VideoSourceBase" style="stroke:#A80036;stroke-width:1.5;" width="434" x="401" y="496"/><ellipse cx="564.75" cy="512" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M567.2231,518.1431 Q566.6421,518.4419 566.0029,518.5913 Q565.3638,518.7407 564.6582,518.7407 Q562.1514,518.7407 560.8315,517.0889 Q559.5117,515.437 559.5117,512.3159 Q559.5117,509.1865 560.8315,507.5347 Q562.1514,505.8828 564.6582,505.8828 Q565.3638,505.8828 566.0112,506.0322 Q566.6587,506.1816 567.2231,506.4805 L567.2231,509.2031 Q566.5923,508.6221 565.9988,508.3523 Q565.4053,508.0825 564.7744,508.0825 Q563.4297,508.0825 562.7449,509.1492 Q562.0601,510.2158 562.0601,512.3159 Q562.0601,514.4077 562.7449,515.4744 Q563.4297,516.541 564.7744,516.541 Q565.4053,516.541 565.9988,516.2712 Q566.5923,516.0015 567.2231,515.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="98" x="585.25" y="516.5352">VideoSourceBase</text><line style="stroke:#A80036;stroke-width:1.5;" x1="402" x2="834" y1="528" y2="528"/><polygon fill="#FFFF44" points="412,534,416,538,412,542,408,538" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="408" x="421" y="542.6348">SinkPair* FindSinkPair(const VideoSinkInterface&lt;webrtc::VideoFrame&gt;* sink)</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="409" y="565.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="154" x="421" y="572.5449">std::vector&lt;SinkPair&gt; sinks_</text><line style="stroke:#A80036;stroke-width:1.0;" x1="402" x2="606.5" y1="555.4326" y2="555.4326"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="606.5" y="559.0898">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="629.5" x2="834" y1="555.4326" y2="555.4326"/><!--MD5=[624725d07d18954dc286a411c06d7419]
class VideoTrack--><rect codeline="81" fill="#FEFECE" filter="url(#f11ett8m8q7ldr)" height="263.4609" id="VideoTrack" style="stroke:#A80036;stroke-width:1.5;" width="386" x="303" y="895"/><ellipse cx="458.75" cy="911" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M461.2231,917.1431 Q460.6421,917.4419 460.0029,917.5913 Q459.3638,917.7407 458.6582,917.7407 Q456.1514,917.7407 454.8315,916.0889 Q453.5117,914.437 453.5117,911.3159 Q453.5117,908.1865 454.8315,906.5347 Q456.1514,904.8828 458.6582,904.8828 Q459.3638,904.8828 460.0112,905.0322 Q460.6587,905.1816 461.2231,905.4805 L461.2231,908.2031 Q460.5923,907.6221 459.9988,907.3523 Q459.4053,907.0825 458.7744,907.0825 Q457.4297,907.0825 456.7449,908.1492 Q456.0601,909.2158 456.0601,911.3159 Q456.0601,913.4077 456.7449,914.4744 Q457.4297,915.541 458.7744,915.541 Q459.4053,915.541 459.9988,915.2712 Q460.5923,915.0015 461.2231,914.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="66" x="479.25" y="915.5352">VideoTrack</text><line style="stroke:#A80036;stroke-width:1.5;" x1="304" x2="688" y1="927" y2="927"/><ellipse cx="314" cy="938" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="262" x="323" y="941.6348">static rtc::scoped_refptr&lt;VideoTrack&gt; Create(...)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="304" x2="688" y1="947.9551" y2="947.9551"/><ellipse cx="314" cy="958.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="360" x="323" y="962.5898">void AddOrUpdateSink(rtc::VideoSinkInterface&lt;VideoFrame&gt;* sink,</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="184" x="323" y="975.5449">const rtc::VideoSinkWants&amp; wants)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="304" x2="688" y1="981.8652" y2="981.8652"/><ellipse cx="314" cy="992.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="329" x="323" y="996.5">void RemoveSink(rtc::VideoSinkInterface&lt;VideoFrame&gt;* sink)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="304" x2="688" y1="1002.8203" y2="1002.8203"/><ellipse cx="314" cy="1013.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="215" x="323" y="1017.4551">VideoTrackSourceInterface* GetSource()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="304" x2="688" y1="1023.7754" y2="1023.7754"/><ellipse cx="314" cy="1034.7754" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="144" x="323" y="1038.4102">ContentHint content_hint()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="304" x2="688" y1="1044.7305" y2="1044.7305"/><ellipse cx="314" cy="1055.7305" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="213" x="323" y="1059.3652">void set_content_hint(ContentHint hint)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="304" x2="688" y1="1065.6855" y2="1065.6855"/><ellipse cx="314" cy="1076.6855" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="161" x="323" y="1080.3203">bool set_enabled(bool enable)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="304" x2="688" y1="1086.6406" y2="1086.6406"/><ellipse cx="314" cy="1097.6406" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="89" x="323" y="1101.2754">std::string kind()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="304" x2="688" y1="1107.5957" y2="1107.5957"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="311" y="1115.5957"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="72" x="323" y="1122.2305">OnChanged()</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="340" x="309" y="1152.1406">rtc::scoped_refptr&lt;VideoTrackSourceInterface&gt; video_source_</text><line style="stroke:#A80036;stroke-width:1.0;" x1="304" x2="484.5" y1="1135.0283" y2="1135.0283"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="484.5" y="1138.6855">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="507.5" x2="688" y1="1135.0283" y2="1135.0283"/><!--MD5=[600cc02bbda4167ac5f51999ba21c42d]
reverse link RefCountInterface to MediaStreamTrackInterface--><path codeline="27" d="M155.71,95.7 C169.59,110.14 184.79,125.97 199.01,140.77 " fill="none" id="RefCountInterface-backto-MediaStreamTrackInterface" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="150.65,100.53,141.84,81.26,160.74,90.83,150.65,100.53" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[95e5074e4ea58f41949fd4aeb3c4d9b5]
reverse link NotifierInterface to MediaStreamTrackInterface--><path codeline="28" d="M352.95,95.7 C338.99,110.14 323.68,125.97 309.36,140.77 " fill="none" id="NotifierInterface-backto-MediaStreamTrackInterface" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="347.99,90.77,366.93,81.26,358.05,100.5,347.99,90.77" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[396a86581661d700386a483fb9fa7c5f]
reverse link MediaStreamTrackInterface to VideoTrackInterface--><path codeline="45" d="M254,277.37 C254,290.87 254,304.53 254,316.88 " fill="none" id="MediaStreamTrackInterface-backto-VideoTrackInterface" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="247,277.18,254,257.18,261,277.18,247,277.18" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[865369a157f62a64de51409104ee4db0]
reverse link VideoSourceInterface to VideoTrackInterface--><path codeline="46" d="M481.25,254.22 C439.05,274.51 391.51,297.38 350.86,316.92 " fill="none" id="VideoSourceInterface-backto-VideoTrackInterface" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="478.23,247.9,499.29,245.54,484.3,260.52,478.23,247.9" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[e4febc087ea2f332049a7e2b3b3e07ec]
reverse link VideoTrackInterface to Notifier--><path codeline="71" d="M235.44,431.62 C231.73,444.84 227.84,458.71 224.14,471.88 " fill="none" id="VideoTrackInterface-backto-Notifier" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="228.74,429.59,240.88,412.23,242.22,433.37,228.74,429.59" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[fcf1fbc7d190b8cf9abb6e3667fbd895]
reverse link Notifier to MediaStreamTrack--><path codeline="72" d="M206.4,623.14 C206.47,636.21 206.53,649.73 206.59,662.82 " fill="none" id="Notifier-backto-MediaStreamTrack" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="199.4,623.1,206.31,603.07,213.4,623.03,199.4,623.1" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[d606722f6d48fe06f43c6ba532a3e1ab]
reverse link VideoSourceInterface to VideoSourceBase--><path codeline="79" d="M598.71,266.1 C603.59,334.41 611.04,438.85 615.1,495.87 " fill="none" id="VideoSourceInterface-backto-VideoSourceBase" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="591.7,266.18,597.26,245.73,605.67,265.18,591.7,266.18" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[1822c88301af4e154c8d0f782aae6fb9]
reverse link MediaStreamTrack to VideoTrack--><path codeline="103" d="M311.11,849.25 C326.64,864.05 342.84,879.5 358.92,894.83 " fill="none" id="MediaStreamTrack-backto-VideoTrack" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="306.11,854.15,296.46,835.28,315.77,844.02,306.11,854.15" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[9947272d59d1b88e2f4cfb374db17f5e]
reverse link VideoSourceBase to VideoTrack--><path codeline="104" d="M615.65,599.35 C612.1,660.03 603.2,755.39 581,835 C575.48,854.8 568.23,875.18 560.29,894.91 " fill="none" id="VideoSourceBase-backto-VideoTrack" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="608.68,598.65,616.72,579.04,622.66,599.38,608.68,598.65" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[c3d3b64afc17b4da88f67d2b75caef2d]
reverse link ObserverInterface to VideoTrack--><path codeline="105" d="M496,799.86 C496,826.66 496,861.07 496,894.91 " fill="none" id="ObserverInterface-backto-VideoTrack" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="489,799.75,496,779.75,503,799.75,489,799.75" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[617c747bc67a10b1857c39705984c5c0]
@startuml
abstract class RefCountInterface {
    + {abstract} void AddRef()
    ..
    + {abstract} RefCountReleaseStatus Release()
}

abstract class NotifierInterface {
    + {abstract} void RegisterObserver(ObserverInterface* observer)
    ..
    + {abstract} void UnregisterObserver(ObserverInterface* observer)
}

abstract class ObserverInterface {
    + {abstract} void OnChanged()
}

abstract class MediaStreamTrackInterface {
    + {abstract} std::string kind()
    ..
    + {abstract} bool set_enabled(bool enable)
    ..
    + {abstract} bool enabled()
    ..
    + {abstract} TrackState state()
}

RefCountInterface <|- - MediaStreamTrackInterface
NotifierInterface <|- - MediaStreamTrackInterface

abstract class VideoSourceInterface<<VideoFrame>> {
    + {abstract} void AddOrUpdateSink(VideoSinkInterface<VideoFrameT>* sink,
    const VideoSinkWants& wants)
    ..
    + {abstract} void RemoveSink(VideoSinkInterface<VideoFrameT>* sink)
}

class VideoTrackInterface {
    + VideoTrackSourceInterface* GetSource()
    ..
    + void set_content_hint(ContentHint hint)
    ..
    + ContentHint content_hint()
}

MediaStreamTrackInterface <|- - VideoTrackInterface
VideoSourceInterface <|- - VideoTrackInterface

class Notifier <<VideoTrackInterface>> {
    + void RegisterObserver(ObserverInterface* observer)
    ..
    + void UnregisterObserver(ObserverInterface* observer)
    ..
    + void FireOnChanged()
    - - field - -
    # {field} std::list<ObserverInterface*> observers_
}

class MediaStreamTrack {
    + MediaStreamTrackInterface::TrackState state()
    ..
    + bool enabled()
    ..
    + bool set_enabled(bool enable)
    ..
    # bool set_state(MediaStreamTrackInterface::TrackState new_state)
    - -field- -
    - {field} bool enabled_
    - {field} std::string id_;
    - {field} MediaStreamTrackInterface::TrackState state_
}
VideoTrackInterface <|- - Notifier
Notifier <|- - MediaStreamTrack

class VideoSourceBase {
    # SinkPair* FindSinkPair(const VideoSinkInterface<webrtc::VideoFrame>* sink)
    - -field- -
    - {field} std::vector<SinkPair> sinks_
}
VideoSourceInterface <|- - VideoSourceBase

class VideoTrack {
    + {static} static rtc::scoped_refptr<VideoTrack> Create(...)
    ..
    + void AddOrUpdateSink(rtc::VideoSinkInterface<VideoFrame>* sink,
                       const rtc::VideoSinkWants& wants)
    ..
    + void RemoveSink(rtc::VideoSinkInterface<VideoFrame>* sink)
    ..
    + VideoTrackSourceInterface* GetSource()
    ..
    + ContentHint content_hint()
    ..
    + void set_content_hint(ContentHint hint)
    ..
    + bool set_enabled(bool enable)
    ..
    + std::string kind()
    ..
    - OnChanged()
    - -field- -
    rtc::scoped_refptr<VideoTrackSourceInterface> video_source_
}
MediaStreamTrack <|- - VideoTrack
VideoSourceBase <|- - VideoTrack
ObserverInterface <|- - VideoTrack
@enduml

PlantUML version 1.2020.26(Tue Dec 22 01:45:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg></p><center>C++ &#x5C42; VideoTrack &#x7C7B;&#x56FE;</center>
<p>&#x521B;&#x5EFA;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnectionFactory_jni.h</span>
JNI_GENERATOR_EXPORT jlong <span class="token function">Java_org_webrtc_PeerConnectionFactory_nativeCreateVideoTrack</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jlong factory<span class="token punctuation">,</span>
    jstring id<span class="token punctuation">,</span>
    jlong nativeVideoSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">JNI_PeerConnectionFactory_CreateVideoTrack</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> factory<span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jstring<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span> nativeVideoSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection_factory.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_PeerConnectionFactory_CreateVideoTrack</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    jlong native_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jstring<span class="token operator">&gt;</span><span class="token operator">&amp;</span> id<span class="token punctuation">,</span>
    jlong native_source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>VideoTrackInterface<span class="token operator">&gt;</span> track <span class="token operator">=</span>
        <span class="token function">PeerConnectionFactoryFromJava</span><span class="token punctuation">(</span>native_factory<span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">CreateVideoTrack</span><span class="token punctuation">(</span>
                <span class="token function">JavaToStdString</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>VideoTrackSourceInterface<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span>track<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/peer_connection_factory.cc</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>VideoTrackInterface<span class="token operator">&gt;</span> <span class="token class-name">PeerConnectionFactory</span><span class="token operator">::</span><span class="token function">CreateVideoTrack</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> id<span class="token punctuation">,</span>
    VideoTrackSourceInterface<span class="token operator">*</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>signaling_thread_<span class="token operator">-&gt;</span><span class="token function">IsCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>VideoTrackInterface<span class="token operator">&gt;</span> <span class="token function">track</span><span class="token punctuation">(</span>
      <span class="token class-name">VideoTrack</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> source<span class="token punctuation">,</span> worker_thread_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">VideoTrackProxy</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>signaling_thread_<span class="token punctuation">,</span> worker_thread_<span class="token punctuation">,</span> track<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/video_track.cc</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>VideoTrack<span class="token operator">&gt;</span> <span class="token class-name">VideoTrack</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> id<span class="token punctuation">,</span>
    VideoTrackSourceInterface<span class="token operator">*</span> source<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>Thread<span class="token operator">*</span> worker_thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x6784;&#x9020; VideoTrack</span>
    rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>VideoTrack<span class="token operator">&gt;</span><span class="token operator">*</span> track <span class="token operator">=</span>
        <span class="token keyword">new</span> rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>VideoTrack<span class="token operator">&gt;</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> source<span class="token punctuation">,</span> worker_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> track<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">VideoTrack</span><span class="token operator">::</span><span class="token function">VideoTrack</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> label<span class="token punctuation">,</span>
                       VideoTrackSourceInterface<span class="token operator">*</span> video_source<span class="token punctuation">,</span>
                       rtc<span class="token operator">::</span>Thread<span class="token operator">*</span> worker_thread<span class="token punctuation">)</span>
    <span class="token operator">:</span> MediaStreamTrack<span class="token operator">&lt;</span>VideoTrackInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">worker_thread_</span><span class="token punctuation">(</span>worker_thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// &#x4FDD;&#x5B58; VideoSource&#xFF0C;&#x5728; set_enabled() &#x7684;&#x65F6;&#x5019;&#x6DFB;&#x52A0; sink&#x3002;</span>
      <span class="token function">video_source_</span><span class="token punctuation">(</span>video_source<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">content_hint_</span><span class="token punctuation">(</span>ContentHint<span class="token operator">::</span>kNone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// &#x6CE8;&#x518C; VideoSource &#x89C2;&#x5BDF;&#x8005;</span>
    video_source_<span class="token operator">-&gt;</span><span class="token function">RegisterObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// api/notifier.h</span>
<span class="token comment">// AndroidVideoTrackSource &#x7EE7;&#x627F;&#x4E8E; AdaptedVideoTrackSource&#xFF0C;</span>
<span class="token comment">// AdaptedVideoTraceSource &#x7EE7;&#x627F;&#x4E8E; webrtc::Notifier&lt;webrtc::VideoTrackSourceInterface&gt;</span>
<span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">RegisterObserver</span><span class="token punctuation">(</span>ObserverInterface<span class="token operator">*</span> observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>observer <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    observers_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="342-%E4%BD%BF%E8%83%BD-videotrack">3.4.2 &#x4F7F;&#x80FD; VideoTrack</h4>

<p>localVideoTrack.setEnabled(renderVideo);</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/MediaStreamTrack.java</span>
<span class="token comment">// VideoTrack &#x662F; MediaStreamTrack &#x7684;&#x6269;&#x5C55;&#x7C7B;&#xFF0C;setEnabled() &#x7684;&#x5B9E;&#x73B0;&#x4F4D;&#x4E8E; MediaStreamTrack</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkMediaStreamTrackExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x8C03;&#x7528; Native &#x5C42; VideoTrack &#x51FD;&#x6570;</span>
    <span class="token keyword">return</span> <span class="token function">nativeSetEnabled</span><span class="token punctuation">(</span>nativeTrack<span class="token punctuation">,</span> enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>&#x8F6C;&#x5165; Native &#x5C42;&#x8C03;&#x7528;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/MediaStreamTrack_jni.h</span>
JNI_GENERATOR_EXPORT jboolean <span class="token function">Java_org_webrtc_MediaStreamTrack_nativeSetEnabled</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jlong track<span class="token punctuation">,</span>
    jboolean enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_MediaStreamTrack_SetEnabled</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> track<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/media_stream_track.cc</span>
<span class="token keyword">static</span> jboolean <span class="token function">JNI_MediaStreamTrack_SetEnabled</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
                                                jlong j_p<span class="token punctuation">,</span>
                                                jboolean enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>MediaStreamTrackInterface<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>j_p<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_enabled</span><span class="token punctuation">(</span>enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/video_track.cc</span>
<span class="token keyword">bool</span> <span class="token class-name">VideoTrack</span><span class="token operator">::</span><span class="token function">set_enabled</span><span class="token punctuation">(</span><span class="token keyword">bool</span> enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>signaling_thread_checker_<span class="token punctuation">.</span><span class="token function">IsCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker_thread_<span class="token operator">-&gt;</span>Invoke<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>RTC_FROM_HERE<span class="token punctuation">,</span> <span class="token punctuation">[</span>enable<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>worker_thread_<span class="token operator">-&gt;</span><span class="token function">IsCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> sink_pair <span class="token operator">:</span> <span class="token function">sink_pairs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rtc<span class="token operator">::</span>VideoSinkWants modified_wants <span class="token operator">=</span> sink_pair<span class="token punctuation">.</span>wants<span class="token punctuation">;</span>
            modified_wants<span class="token punctuation">.</span>black_frames <span class="token operator">=</span> <span class="token operator">!</span>enable<span class="token punctuation">;</span>
            video_source_<span class="token operator">-&gt;</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>sink_pair<span class="token punctuation">.</span>sink<span class="token punctuation">,</span> modified_wants<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x8C03;&#x7528;&#x57FA;&#x7C7B;&#x51FD;&#x6570;</span>
    <span class="token keyword">return</span> <span class="token class-name">MediaStreamTrack</span><span class="token operator">&lt;</span>VideoTrackInterface<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">set_enabled</span><span class="token punctuation">(</span>enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/media_stream_track.h</span>
<span class="token keyword">bool</span> <span class="token function">set_enabled</span><span class="token punctuation">(</span><span class="token keyword">bool</span> enable<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
    <span class="token keyword">bool</span> fire_on_change <span class="token operator">=</span> <span class="token punctuation">(</span>enable <span class="token operator">!=</span> enabled_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x4FDD;&#x5B58;&#x4F7F;&#x80FD;&#x72B6;&#x6001;</span>
    enabled_ <span class="token operator">=</span> enable<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fire_on_change<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x6B64;&#x5904; T &#x4E3A; VideoTrackInterface</span>
        <span class="token class-name">Notifier</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">FireOnChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fire_on_change<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="343-%E6%B7%BB%E5%8A%A0%E6%B8%B2%E6%9F%93-sink">3.4.3 &#x6DFB;&#x52A0;&#x6E32;&#x67D3; Sink</h4>

<p>&#x6DFB;&#x52A0;&#x9884;&#x89C8;&#x7684; VideoSink &#x5230; VideoTrack&#x3002;</p>
<p>localVideoTrack.addSink(localRender);</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/VideoTrack.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSink</span><span class="token punctuation">(</span><span class="token class-name">VideoSink</span> sink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sink <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;The VideoSink is not allowed to be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// We allow calling addSink() with the same sink multiple times. This is similar to the C++</span>
    <span class="token comment">// VideoTrack::AddOrUpdateSink().</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sinks<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Java &#x5C42; VideoSink &#x4E0E; Native &#x5C42; VideoSink &#x7684;&#x6620;&#x5C04; */</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> nativeSink <span class="token operator">=</span> <span class="token function">nativeWrapSink</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* &#x4FDD;&#x5B58;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF0C;&#x5728; &#x5220;&#x9664;Sink&#x65F6;&#xFF0C;&#x91CA;&#x653E; Native &#x5C42;&#x7684; VideoSink */</span>
        sinks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> nativeSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">nativeAddSink</span><span class="token punctuation">(</span><span class="token function">getNativeMediaStreamTrack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nativeSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><ol>
<li>&#x6620;&#x5C04; Java &#x5C42; VideoSink &#x5230; Native &#x5C42; VideoSink&#xFF08;VideoSinkWrapper&#xFF09;&#x3002;</li>
</ol>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_video_jni/VideoTrack_jni.h</span>
JNI_GENERATOR_EXPORT jlong <span class="token function">Java_org_webrtc_VideoTrack_nativeWrapSink</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jobject sink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">JNI_VideoTrack_WrapSink</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> sink<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/video_track.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_VideoTrack_WrapSink</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
                                     <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> sink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">VideoSinkWrapper</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> sink<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/video_sink.cc</span>
<span class="token comment">// &#x4FDD;&#x5B58; Java &#x5C42; VideoSink &#x5B9E;&#x4F8B;&#xFF0C;&#x540E;&#x7EED;&#x89C6;&#x9891;&#x5E27;&#x901A;&#x8FC7;&#x8BE5;&#x5B9E;&#x4F8B;&#x56DE;&#x8C03;&#x7ED9; Java &#x5C42;&#x3002;</span>
<span class="token comment">// VideoSinkWrapper &#x7236;&#x7C7B;&#x662F; rtc::VideoSinkInterface&lt;VideoFrame&gt;&#xFF0C;&#x91CD;&#x5199;&#x4E86; OnFrame(VideoFrame)</span>
<span class="token class-name">VideoSinkWrapper</span><span class="token operator">::</span><span class="token function">VideoSinkWrapper</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span> <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_sink<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">j_sink_</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_sink<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre><ol start="2">
<li>&#x6DFB;&#x52A0; VideoSink &#x5230; VideoTrack &#x4E0A;</li>
</ol>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_video_jni/VideoTrack_jni.h</span>
JNI_GENERATOR_EXPORT <span class="token keyword">void</span> <span class="token function">Java_org_webrtc_VideoTrack_nativeAddSink</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jlong track<span class="token punctuation">,</span>
    jlong nativeSink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">JNI_VideoTrack_AddSink</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> track<span class="token punctuation">,</span> nativeSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/video_track.cc</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">JNI_VideoTrack_AddSink</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
                                   jlong j_native_track<span class="token punctuation">,</span>
                                   jlong j_native_sink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>VideoTrackInterface<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>j_native_track<span class="token punctuation">)</span>
        <span class="token operator">-&gt;</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>
            <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>rtc<span class="token operator">::</span>VideoSinkInterface<span class="token operator">&lt;</span>VideoFrame<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>j_native_sink<span class="token punctuation">)</span><span class="token punctuation">,</span>
            rtc<span class="token operator">::</span><span class="token function">VideoSinkWants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/video_track.cc</span>
<span class="token keyword">void</span> <span class="token class-name">VideoTrack</span><span class="token operator">::</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>rtc<span class="token operator">::</span>VideoSinkInterface<span class="token operator">&lt;</span>VideoFrame<span class="token operator">&gt;</span><span class="token operator">*</span> sink<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> rtc<span class="token operator">::</span>VideoSinkWants<span class="token operator">&amp;</span> wants<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>worker_thread_<span class="token operator">-&gt;</span><span class="token function">IsCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x57FA;&#x7C7B;&#x4FDD;&#x5B58; Sink */</span>
    <span class="token class-name">VideoSourceBase</span><span class="token operator">::</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> wants<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rtc<span class="token operator">::</span>VideoSinkWants modified_wants <span class="token operator">=</span> wants<span class="token punctuation">;</span>

    <span class="token comment">// &#x662F;&#x5426;&#x5DF2;&#x4F7F;&#x80FD; VideoTrack&#xFF0C;&#x672A;&#x4F7F;&#x80FD;&#x7684;&#x8BDD;&#x7528;&#x9ED1;&#x5C4F;&#x5E27;&#x4EE3;&#x66FF;&#xFF0C;&#x56E0;&#x4E4B;&#x524D;&#x5DF2;&#x8BBE;&#x7F6E; enable&#xFF0C;&#x6240;&#x4EE5;&#x6B64;&#x5904; black_frames &#x4E3A;false</span>
    modified_wants<span class="token punctuation">.</span>black_frames <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// VideoSource &#x6DFB;&#x52A0;&#x56DE;&#x8C03; Sink&#xFF0C;&#x5373;&#x8C03;&#x7528; AdaptedVideoTrackSource::AddOrUpdateSink(&#xFF09;</span>
    video_source_<span class="token operator">-&gt;</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> modified_wants<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// media/base/video_source_base.cc</span>
<span class="token keyword">void</span> <span class="token class-name">VideoSourceBase</span><span class="token operator">::</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>
    VideoSinkInterface<span class="token operator">&lt;</span>webrtc<span class="token operator">::</span>VideoFrame<span class="token operator">&gt;</span><span class="token operator">*</span> sink<span class="token punctuation">,</span>
    <span class="token keyword">const</span> VideoSinkWants<span class="token operator">&amp;</span> wants<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>sink <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    SinkPair<span class="token operator">*</span> sink_pair <span class="token operator">=</span> <span class="token function">FindSinkPair</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sink_pair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sinks_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">SinkPair</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> wants<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        sink_pair<span class="token operator">-&gt;</span>wants <span class="token operator">=</span> wants<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x6DFB;&#x52A0; VideoSink &#x5230; VideoSource</span>
<span class="token comment">// AndroidVideoTrackSource &#x7EE7;&#x627F;&#x4E8E; AdaptedVideoTrackSource,</span>
<span class="token keyword">void</span> <span class="token class-name">AdaptedVideoTrackSource</span><span class="token operator">::</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>
    rtc<span class="token operator">::</span>VideoSinkInterface<span class="token operator">&lt;</span>webrtc<span class="token operator">::</span>VideoFrame<span class="token operator">&gt;</span><span class="token operator">*</span> sink<span class="token punctuation">,</span>
    <span class="token keyword">const</span> rtc<span class="token operator">::</span>VideoSinkWants<span class="token operator">&amp;</span> wants<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    broadcaster_<span class="token punctuation">.</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> wants<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OnSinkWantsChanged</span><span class="token punctuation">(</span>broadcaster_<span class="token punctuation">.</span><span class="token function">wants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="344-%E6%B7%BB%E5%8A%A0%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81-sink">3.4.4 &#x6DFB;&#x52A0;&#x89C6;&#x9891;&#x7F16;&#x7801; Sink</h4>

<ol>
<li>&#x521B;&#x5EFA;&#x672C;&#x5730; Offer Sdp&#xFF1B;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// CallActivity.java</span>
peerConnectionClient<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><ol start="2">
<li>&#x8BBE;&#x7F6E;&#x672C;&#x5730; Offer Sdp&#xFF0C;&#x4F1A;&#x9010;&#x6B65;&#x521B;&#x5EFA; VideoMediaChannel, VideoSendStream, &#x6DFB;&#x52A0; VideoStreamEncoder &#x5230; VideoSource;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token comment">// &#x8BBE;&#x7F6E;&#x672C;&#x5730; Offer Sdp &#x662F;&#x5728;&#x521B;&#x5EFA; Offer &#x6210;&#x529F;&#x7684;&#x56DE;&#x8C03;&#x91CC;&#x9762;:</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SDPObserver</span> <span class="token keyword">implements</span> <span class="token class-name">SdpObserver</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreateSuccess</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SessionDescription</span> origSdp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>localSdp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Multiple SDP create.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">String</span> sdpDescription <span class="token operator">=</span> origSdp<span class="token punctuation">.</span>description<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>preferIsac<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sdpDescription <span class="token operator">=</span> <span class="token function">preferCodec</span><span class="token punctuation">(</span>sdpDescription<span class="token punctuation">,</span> AUDIO_CODEC_ISAC<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVideoCallEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sdpDescription <span class="token operator">=</span>
            <span class="token function">preferCodec</span><span class="token punctuation">(</span>sdpDescription<span class="token punctuation">,</span> <span class="token function">getSdpVideoCodecName</span><span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">final</span> <span class="token class-name">SessionDescription</span> sdp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionDescription</span><span class="token punctuation">(</span>origSdp<span class="token punctuation">.</span>type<span class="token punctuation">,</span> sdpDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
      localSdp <span class="token operator">=</span> sdp<span class="token punctuation">;</span>
      executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnection <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Set local SDP from &quot;</span> <span class="token operator">+</span> sdp<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* &#x8BBE;&#x7F6E; Offer Sdp */</span>
          peerConnection<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>sdpObserver<span class="token punctuation">,</span> sdp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// PeerConnection.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token class-name">SdpObserver</span> observer<span class="token punctuation">,</span> <span class="token class-name">SessionDescription</span> sdp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x8C03;&#x7528; Native &#x51FD;&#x6570; */</span>
    <span class="token function">nativeSetLocalDescription</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> sdp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Native &#x5C42;&#x8C03;&#x7528;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnection_jni.h</span>
JNI_GENERATOR_EXPORT <span class="token keyword">void</span> <span class="token function">Java_org_webrtc_PeerConnection_nativeSetLocalDescription</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jobject jcaller<span class="token punctuation">,</span>
    jobject observer<span class="token punctuation">,</span>
    jobject sdp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_PeerConnection_SetLocalDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
      jcaller<span class="token punctuation">)</span><span class="token punctuation">,</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> observer<span class="token punctuation">)</span><span class="token punctuation">,</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> sdp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection.cc</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">JNI_PeerConnection_SetLocalDescription</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_pc<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_observer<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_sdp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>SetSdpObserverJni<span class="token operator">&gt;</span> <span class="token function">observer</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>SetSdpObserverJni<span class="token operator">&gt;</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_observer<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ExtractNativePC</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_pc<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetLocalDescription</span><span class="token punctuation">(</span>
      observer<span class="token punctuation">,</span> <span class="token function">JavaToNativeSessionDescription</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_sdp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/peer_connection.cc</span>
<span class="token keyword">void</span> <span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">SetLocalDescription</span><span class="token punctuation">(</span>
    SetSessionDescriptionObserver<span class="token operator">*</span> observer<span class="token punctuation">,</span>
    SessionDescriptionInterface<span class="token operator">*</span> desc_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">RTC_DCHECK_RUN_ON</span><span class="token punctuation">(</span><span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Chain this operation. If asynchronous operations are pending on the chain,</span>
  <span class="token comment">// this operation will be queued to be invoked, otherwise the contents of the</span>
  <span class="token comment">// lambda will execute immediately.</span>
  <span class="token comment">/* &#x5982;&#x4E0A;&#x9762;&#x6CE8;&#x91CA;&#x6240;&#x8FF0;&#xFF0C;operations_chain_ &#x5176;&#x5B9E;&#x662F;&#x4E00;&#x4E2A;&#x534A;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;&#xFF0C;&#x5185;&#x90E8;&#x662F;&#x4E00;&#x4E2A;&#x5148;&#x8FDB;&#x5148;&#x51FA;&#x7684;&#x961F;&#x5217;&#xFF0C;&#x7F13;&#x5B58;&#x7740;&#x8981;&#x6267;&#x884C;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;
   * &#x4F46;&#x5982;&#x679C;&#x63D2;&#x5165;&#x4EFB;&#x52A1;&#x65F6;&#x521A;&#x597D;&#x662F;&#x7B2C;&#x4E00;&#x4E2A;&#xFF0C;&#x5219;&#x7ACB;&#x5373;&#x6267;&#x884C;&#xFF0C;&#x5426;&#x5219;&#xFF0C;&#x53EA;&#x505A;&#x63D2;&#x5165;&#x64CD;&#x4F5C;&#x5C31;&#x8FD4;&#x56DE;&#xFF0C;&#x8BE5;&#x6B21;&#x63D2;&#x5165;&#x7684;&#x4EFB;&#x52A1;&#x7B49;&#x5F85;&#x524D;&#x9762;&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x540E;&#x81EA;&#x52A8;&#x8C03;&#x7528;&#x6267;&#x884C;&#x3002;
   */</span>
  operations_chain_<span class="token operator">-&gt;</span><span class="token function">ChainOperation</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span>this_weak_ptr <span class="token operator">=</span> weak_ptr_factory_<span class="token punctuation">.</span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       observer_refptr <span class="token operator">=</span>
           rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>SetSessionDescriptionObserver<span class="token operator">&gt;</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">,</span>
       desc <span class="token operator">=</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>SessionDescriptionInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>desc_ptr<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
          std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> operations_chain_callback<span class="token punctuation">)</span> <span class="token keyword">mutable</span> <span class="token punctuation">{</span>
        <span class="token comment">// Abort early if |this_weak_ptr| is no longer valid.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>this_weak_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// For consistency with DoSetLocalDescription(), we DO NOT inform the</span>
          <span class="token comment">// |observer_refptr| that the operation failed in this case.</span>
          <span class="token comment">// TODO(hbos): If/when we process SLD messages in ~PeerConnection,</span>
          <span class="token comment">// the consistent thing would be to inform the observer here.</span>
          <span class="token comment">// &#x901A;&#x77E5; operations_chain_&#xFF0C;&#x5F53;&#x524D;&#x4EFB;&#x52A1;&#x5DF2;&#x7ECF;&#x6267;&#x884C;&#x5B8C;&#x6210;&#xFF0C;operations_chain_ &#x4F1A;&#x4ECE;&#x961F;&#x5217;&#x4E2D;&#x5220;&#x9664;&#x8BE5;&#x4EFB;&#x52A1;&#xFF0C;&#x5E76;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;</span>
          <span class="token function">operations_chain_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* &#x8BBE;&#x7F6E; Offer Sdp, &#x6B64;&#x64CD;&#x4F5C;&#x5F53;&#x524D;&#x4E3A;&#x540C;&#x6B65;&#x6267;&#x884C;&#xFF0C;&#x56E0;&#x4E3A; operations_chain_ &#x5185;&#x8FD8;&#x6CA1;&#x6709;&#x5176;&#x4ED6;&#x4EFB;&#x52A1; */</span>
        this_weak_ptr<span class="token operator">-&gt;</span><span class="token function">DoSetLocalDescription</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                             std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>observer_refptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// DoSetLocalDescription() is currently implemented as a synchronous</span>
        <span class="token comment">// operation but where the |observer|&apos;s callbacks are invoked</span>
        <span class="token comment">// asynchronously in a post to OnMessage().</span>
        <span class="token comment">// For backwards-compatability reasons, we declare the operation as</span>
        <span class="token comment">// completed here (rather than in OnMessage()). This ensures that</span>
        <span class="token comment">// subsequent offer/answer operations can start immediately (without</span>
        <span class="token comment">// waiting for OnMessage()).</span>
        <span class="token function">operations_chain_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">DoSetLocalDescription</span><span class="token punctuation">(</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>SessionDescriptionInterface<span class="token operator">&gt;</span> desc<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>SetSessionDescriptionObserver<span class="token operator">&gt;</span> observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token comment">/* &#x4E00;&#x5806;&#x6821;&#x9A8C;&#xFF0C;&#x5FFD;&#x7565; */</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// Grab the description type before moving ownership to ApplyLocalDescription,</span>
  <span class="token comment">// which may destroy it before returning.</span>
  <span class="token keyword">const</span> SdpType type <span class="token operator">=</span> desc<span class="token operator">-&gt;</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  error <span class="token operator">=</span> <span class="token function">ApplyLocalDescription</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// |desc| may be destroyed at this point.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Local Sdp &#x8BBE;&#x7F6E;&#x5931;&#x8D25;&#xFF0C;&#x53D1;&#x9001; MSG_SET_SESSIONDESCRIPTION_FAILED &#x6D88;&#x606F;&#xFF0C;&#x518D;&#x901A;&#x8FC7; observer &#x56DE;&#x8C03;&#x4E0A;&#x5C42; */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Local Sdp &#x8BBE;&#x7F6E;&#x6210;&#x529F;&#xFF0C;&#x53D1;&#x9001; MSG_SET_SESSIONDESCRIPTION_SUCCESS &#x6D88;&#x606F;&#xFF0C;&#x518D;&#x901A;&#x8FC7; observer &#x56DE;&#x8C03;&#x4E0A;&#x5C42; */</span>
  <span class="token function">PostSetSessionDescriptionSuccess</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// MaybeStartGathering needs to be called after posting</span>
  <span class="token comment">// MSG_SET_SESSIONDESCRIPTION_SUCCESS, so that we don&apos;t signal any candidates</span>
  <span class="token comment">// before signaling that SetLocalDescription completed.</span>
  <span class="token comment">/* &#x5F00;&#x59CB; ICE &#x5730;&#x5740;&#x6536;&#x96C6; */</span>
  transport_controller_<span class="token operator">-&gt;</span><span class="token function">MaybeStartGathering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

RTCError <span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">ApplyLocalDescription</span><span class="token punctuation">(</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>SessionDescriptionInterface<span class="token operator">&gt;</span> desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">/* &#x6839;&#x636E;&#x662F;&#x5426;&#x5DF2;&#x5B58;&#x5728; remote sdp &#x5224;&#x65AD;&#x662F;&#x5426;&#x53D1;&#x8D77;&#x65B9; */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_caller_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">remote_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Remote description was applied first, so this PC is the callee.</span>
      is_caller_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Local description is applied first, so this PC is the caller.</span>
      is_caller_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">/* Android RTC demo &#x4F7F;&#x7528;&#x7684;&#x662F; Unified Plan */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsUnifiedPlan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 1. &#x521B;&#x5EFA; MediaChannel, &#x66F4;&#x65B0;&#x5230;&#x6536;&#x53D1;&#x5668; */</span>
    RTCError error <span class="token operator">=</span> <span class="token function">UpdateTransceiversAndDataChannels</span><span class="token punctuation">(</span>
        cricket<span class="token operator">::</span>CS_LOCAL<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">local_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> old_local_description<span class="token punctuation">,</span>
        <span class="token function">remote_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Media channels will be created only when offer is set. These may use new</span>
    <span class="token comment">// transports just created by PushdownTransportDescription.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> SdpType<span class="token operator">::</span>kOffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO(bugs.webrtc.org/4676) - Handle CreateChannel failure, as new local</span>
      <span class="token comment">// description is applied. Restore back to old description.</span>
      RTCError error <span class="token operator">=</span> <span class="token function">CreateChannels</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token function">local_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Remove unused channels if MediaContentDescription is rejected.</span>
    <span class="token function">RemoveUnusedChannels</span><span class="token punctuation">(</span><span class="token function">local_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* 2. &#x521B;&#x5EFA; VideoSendStream &#x6216; AudioSendStream */</span>
  error <span class="token operator">=</span> <span class="token function">UpdateSessionState</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> cricket<span class="token operator">::</span>CS_LOCAL<span class="token punctuation">,</span>
                             <span class="token function">local_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsUnifiedPlan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> transceiver <span class="token operator">:</span> transceivers_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ContentInfo<span class="token operator">*</span> content <span class="token operator">=</span>
          <span class="token function">FindMediaSectionForTransceiver</span><span class="token punctuation">(</span>transceiver<span class="token punctuation">,</span> <span class="token function">local_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      cricket<span class="token operator">::</span>ChannelInterface<span class="token operator">*</span> channel <span class="token operator">=</span> transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token operator">-&gt;</span>rejected <span class="token operator">||</span> <span class="token operator">!</span>channel <span class="token operator">||</span> channel<span class="token operator">-&gt;</span><span class="token function">local_streams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 0 is a special value meaning &quot;this sender has no associated send</span>
        <span class="token comment">// stream&quot;. Need to call this so the sender won&apos;t attempt to configure</span>
        <span class="token comment">// a no longer existing stream and run into DCHECKs in the lower</span>
        <span class="token comment">// layers.</span>
        transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">sender_internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetSsrc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Get the StreamParams from the channel which could generate SSRCs.</span>
        <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>StreamParams<span class="token operator">&gt;</span><span class="token operator">&amp;</span> streams <span class="token operator">=</span> channel<span class="token operator">-&gt;</span><span class="token function">local_streams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">sender_internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_stream_ids</span><span class="token punctuation">(</span>
            streams<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">stream_ids</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* 3. &#x8BBE;&#x7F6E; RtpSender &#x7684; ssrc, &#x540C;&#x65F6;&#x89E6;&#x53D1;&#x6DFB;&#x52A0; VideoStreamEncoder &#x5230; VideoSource */</span>
        transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">sender_internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetSsrc</span><span class="token punctuation">(</span>
            streams<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">first_ssrc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Plan B semantics.</span>

    <span class="token comment">// Update state and SSRC of local MediaStreams and DataChannels based on the</span>
    <span class="token comment">// local session description.</span>
    <span class="token keyword">const</span> cricket<span class="token operator">::</span>ContentInfo<span class="token operator">*</span> audio_content <span class="token operator">=</span>
        <span class="token function">GetFirstAudioContent</span><span class="token punctuation">(</span><span class="token function">local_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>audio_content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>audio_content<span class="token operator">-&gt;</span>rejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">RemoveSenders</span><span class="token punctuation">(</span>cricket<span class="token operator">::</span>MEDIA_TYPE_AUDIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> cricket<span class="token operator">::</span>AudioContentDescription<span class="token operator">*</span> audio_desc <span class="token operator">=</span>
            audio_content<span class="token operator">-&gt;</span><span class="token function">media_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">as_audio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">UpdateLocalSenders</span><span class="token punctuation">(</span>audio_desc<span class="token operator">-&gt;</span><span class="token function">streams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> audio_desc<span class="token operator">-&gt;</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> cricket<span class="token operator">::</span>ContentInfo<span class="token operator">*</span> video_content <span class="token operator">=</span>
        <span class="token function">GetFirstVideoContent</span><span class="token punctuation">(</span><span class="token function">local_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>video_content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>video_content<span class="token operator">-&gt;</span>rejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">RemoveSenders</span><span class="token punctuation">(</span>cricket<span class="token operator">::</span>MEDIA_TYPE_VIDEO<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> cricket<span class="token operator">::</span>VideoContentDescription<span class="token operator">*</span> video_desc <span class="token operator">=</span>
            video_content<span class="token operator">-&gt;</span><span class="token function">media_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">as_video</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">UpdateLocalSenders</span><span class="token punctuation">(</span>video_desc<span class="token operator">-&gt;</span><span class="token function">streams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> video_desc<span class="token operator">-&gt;</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">return</span> <span class="token class-name">RTCError</span><span class="token operator">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**********************************************************/</span>
<span class="token comment">/* 1. &#x521B;&#x5EFA; MediaChannel, &#x66F4;&#x65B0;&#x5230;&#x6536;&#x53D1;&#x5668;, &#x9650;&#x4E8E; Unified Plan &#x6A21;&#x5F0F; */</span>
RTCError <span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">UpdateTransceiversAndDataChannels</span><span class="token punctuation">(</span>
    cricket<span class="token operator">::</span>ContentSource source<span class="token punctuation">,</span>
    <span class="token keyword">const</span> SessionDescriptionInterface<span class="token operator">&amp;</span> new_session<span class="token punctuation">,</span>
    <span class="token keyword">const</span> SessionDescriptionInterface<span class="token operator">*</span> old_local_description<span class="token punctuation">,</span>
    <span class="token keyword">const</span> SessionDescriptionInterface<span class="token operator">*</span> old_remote_description<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">const</span> ContentInfos<span class="token operator">&amp;</span> new_contents <span class="token operator">=</span> new_session<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> new_contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cricket<span class="token operator">::</span>ContentInfo<span class="token operator">&amp;</span> new_content <span class="token operator">=</span> new_contents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    cricket<span class="token operator">::</span>MediaType media_type <span class="token operator">=</span> new_content<span class="token punctuation">.</span><span class="token function">media_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mid_generator_<span class="token punctuation">.</span><span class="token function">AddKnownId</span><span class="token punctuation">(</span>new_content<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>media_type <span class="token operator">==</span> cricket<span class="token operator">::</span>MEDIA_TYPE_AUDIO <span class="token operator">||</span>
        media_type <span class="token operator">==</span> cricket<span class="token operator">::</span>MEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

      <span class="token comment">/* sdp &#x4E0E; &#x6536;&#x53D1;&#x5668; Transceiver &#x8FDB;&#x884C;&#x5173;&#x8054;(&#x901A;&#x8FC7; mline_index)&#xFF0C;&#x66F4;&#x65B0; Transceiver &#x7684; mid&#xFF0C;&#x8FD4;&#x56DE; Transceiver. */</span>
      <span class="token keyword">auto</span> transceiver_or_error <span class="token operator">=</span>
          <span class="token function">AssociateTransceiver</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> new_session<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> new_content<span class="token punctuation">,</span>
                               old_local_content<span class="token punctuation">,</span> old_remote_content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transceiver_or_error<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> transceiver_or_error<span class="token punctuation">.</span><span class="token function">MoveError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">auto</span> transceiver <span class="token operator">=</span> transceiver_or_error<span class="token punctuation">.</span><span class="token function">MoveValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      RTCError error <span class="token operator">=</span>
          <span class="token function">UpdateTransceiverChannel</span><span class="token punctuation">(</span>transceiver<span class="token punctuation">,</span> new_content<span class="token punctuation">,</span> bundle_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>media_type <span class="token operator">==</span> cricket<span class="token operator">::</span>MEDIA_TYPE_DATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">LOG_AND_RETURN_ERROR</span><span class="token punctuation">(</span>RTCErrorType<span class="token operator">::</span>INTERNAL_ERROR<span class="token punctuation">,</span>
                           <span class="token string">&quot;Unknown section type.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token class-name">RTCError</span><span class="token operator">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* &#x521B;&#x5EFA;&#x53CA;&#x5173;&#x8054; MediaChannel */</span>
RTCError <span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">UpdateTransceiverChannel</span><span class="token punctuation">(</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>RtpTransceiverProxyWithInternal<span class="token operator">&lt;</span>RtpTransceiver<span class="token operator">&gt;&gt;</span>
        transceiver<span class="token punctuation">,</span>
    <span class="token keyword">const</span> cricket<span class="token operator">::</span>ContentInfo<span class="token operator">&amp;</span> content<span class="token punctuation">,</span>
    <span class="token keyword">const</span> cricket<span class="token operator">::</span>ContentGroup<span class="token operator">*</span> bundle_group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span><span class="token function">IsUnifiedPlan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>transceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  cricket<span class="token operator">::</span>ChannelInterface<span class="token operator">*</span> channel <span class="token operator">=</span> transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span>rejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetChannel</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DestroyChannelInterface</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>transceiver<span class="token operator">-&gt;</span><span class="token function">media_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> cricket<span class="token operator">::</span>MEDIA_TYPE_AUDIO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891; Channel */</span>
        channel <span class="token operator">=</span> <span class="token function">CreateVoiceChannel</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x89C6;&#x9891; Channel */</span>
        channel <span class="token operator">=</span> <span class="token function">CreateVideoChannel</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_AND_RETURN_ERROR</span><span class="token punctuation">(</span>
            RTCErrorType<span class="token operator">::</span>INTERNAL_ERROR<span class="token punctuation">,</span>
            <span class="token string">&quot;Failed to create channel for mid=&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/* &#x8BBE;&#x7F6E; Channel &#x5230;&#x6536;&#x53D1;&#x5668;&#x5185;&#xFF0C;&#x5E76;&#x5C06; MediaChannel &#x8BBE;&#x7F6E;&#x5230;&#x6536;&#x53D1;&#x5668;&#x5185;&#x7684;&#x6BCF;&#x4E2A; RtpSender &#x548C; RtpReceiver */</span>
      transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token class-name">RTCError</span><span class="token operator">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* &#x521B;&#x5EFA; VideoChannel&#xFF0C;&#x4FDD;&#x5B58;&#x7740; MediaChannel */</span>
cricket<span class="token operator">::</span>VideoChannel<span class="token operator">*</span> <span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">CreateVideoChannel</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* Rtp/Rtcp &#x6570;&#x636E;&#x5305;&#x53D1;&#x9001;&#x63A5;&#x53E3; */</span>
  RtpTransportInternal<span class="token operator">*</span> rtp_transport <span class="token operator">=</span> <span class="token function">GetRtpTransport</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* rtp &#x5305;&#x6700;&#x5927;&#x5305;&#x957F;&#x914D;&#x7F6E; */</span>
  MediaTransportConfig media_transport_config <span class="token operator">=</span>
      transport_controller_<span class="token operator">-&gt;</span><span class="token function">GetMediaTransportConfig</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* &#x521B;&#x5EFA;&#x89C6;&#x9891; VideoChannel */</span>
  cricket<span class="token operator">::</span>VideoChannel<span class="token operator">*</span> video_channel <span class="token operator">=</span> <span class="token function">channel_manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">CreateVideoChannel</span><span class="token punctuation">(</span>
      call_ptr_<span class="token punctuation">,</span> configuration_<span class="token punctuation">.</span>media_config<span class="token punctuation">,</span> rtp_transport<span class="token punctuation">,</span>
      media_transport_config<span class="token punctuation">,</span> <span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mid<span class="token punctuation">,</span> <span class="token function">SrtpRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">GetCryptoOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ssrc_generator_<span class="token punctuation">,</span> video_options_<span class="token punctuation">,</span>
      video_bitrate_allocator_factory_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>video_channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  video_channel<span class="token operator">-&gt;</span>SignalDtlsSrtpSetupFailure<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>PeerConnection<span class="token operator">::</span>OnDtlsSrtpSetupFailure<span class="token punctuation">)</span><span class="token punctuation">;</span>
  video_channel<span class="token operator">-&gt;</span>SignalSentPacket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                                          <span class="token operator">&amp;</span>PeerConnection<span class="token operator">::</span>OnSentPacket_w<span class="token punctuation">)</span><span class="token punctuation">;</span>
  video_channel<span class="token operator">-&gt;</span><span class="token function">SetRtpTransport</span><span class="token punctuation">(</span>rtp_transport<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> video_channel<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/channel_manager.cc</span>
<span class="token comment">// &#x521B;&#x5EFA; VideoMediaChannel, &#x57FA;&#x7C7B;&#x662F; MediaChannel</span>
VideoChannel<span class="token operator">*</span> <span class="token class-name">ChannelManager</span><span class="token operator">::</span><span class="token function">CreateVideoChannel</span><span class="token punctuation">(</span>
    webrtc<span class="token operator">::</span>Call<span class="token operator">*</span> call<span class="token punctuation">,</span>
    <span class="token keyword">const</span> cricket<span class="token operator">::</span>MediaConfig<span class="token operator">&amp;</span> media_config<span class="token punctuation">,</span>
    webrtc<span class="token operator">::</span>RtpTransportInternal<span class="token operator">*</span> rtp_transport<span class="token punctuation">,</span>
    <span class="token keyword">const</span> webrtc<span class="token operator">::</span>MediaTransportConfig<span class="token operator">&amp;</span> media_transport_config<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>Thread<span class="token operator">*</span> signaling_thread<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> content_name<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> srtp_required<span class="token punctuation">,</span>
    <span class="token keyword">const</span> webrtc<span class="token operator">::</span>CryptoOptions<span class="token operator">&amp;</span> crypto_options<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>UniqueRandomIdGenerator<span class="token operator">*</span> ssrc_generator<span class="token punctuation">,</span>
    <span class="token keyword">const</span> VideoOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
    webrtc<span class="token operator">::</span>VideoBitrateAllocatorFactory<span class="token operator">*</span> video_bitrate_allocator_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">/* &#x901A;&#x8FC7; WebRtcVideoEngine &#x521B;&#x5EFA; WebRtcVideoChannel, &#x57FA;&#x7C7B;&#x662F; VideoMediaChannel */</span>
  VideoMediaChannel<span class="token operator">*</span> media_channel <span class="token operator">=</span> media_engine_<span class="token operator">-&gt;</span><span class="token function">video</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateMediaChannel</span><span class="token punctuation">(</span>
      call<span class="token punctuation">,</span> media_config<span class="token punctuation">,</span> options<span class="token punctuation">,</span> crypto_options<span class="token punctuation">,</span>
      video_bitrate_allocator_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>media_channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* &#x521B;&#x5EFA; VideoChannel&#xFF0C;&#x4FDD;&#x5B58; media_channel &#x5230; VideoChannel &#x7684;&#x57FA;&#x7C7B; BaseChannel &#x4E2D; */</span>
  <span class="token keyword">auto</span> video_channel <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>VideoChannel<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      worker_thread_<span class="token punctuation">,</span> network_thread_<span class="token punctuation">,</span> signaling_thread<span class="token punctuation">,</span>
      absl<span class="token operator">::</span><span class="token function">WrapUnique</span><span class="token punctuation">(</span>media_channel<span class="token punctuation">)</span><span class="token punctuation">,</span> content_name<span class="token punctuation">,</span> srtp_required<span class="token punctuation">,</span>
      crypto_options<span class="token punctuation">,</span> ssrc_generator<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* &#x521D;&#x59CB;&#x5316; VideoChannel&#xFF0C;&#x5B9E;&#x9645;&#x662F;&#x8C03;&#x7528;&#x57FA;&#x7C7B; BaseChannel::Init_w()&#xFF0C; &#x8BBE;&#x7F6E; media_channel &#x7684; Rtp &#x53D1;&#x9001;&#x63A5;&#x53E3; */</span>
  video_channel<span class="token operator">-&gt;</span><span class="token function">Init_w</span><span class="token punctuation">(</span>rtp_transport<span class="token punctuation">,</span> media_transport_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">BaseChannel</span><span class="token operator">::</span><span class="token function">Init_w</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">WebRtcVideoChannel</span><span class="token operator">::</span><span class="token function">SetInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">MediaChannel</span><span class="token operator">::</span><span class="token function">SetInterface</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> media_transport_config<span class="token punctuation">)</span>

  <span class="token comment">/* &#x4FDD;&#x5B58; VideoChannel */</span>
  VideoChannel<span class="token operator">*</span> video_channel_ptr <span class="token operator">=</span> video_channel<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  video_channels_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>video_channel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> video_channel_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* &#x8BBE;&#x7F6E; Channel */</span>
<span class="token keyword">void</span> <span class="token class-name">RtpTransceiver</span><span class="token operator">::</span><span class="token function">SetChannel</span><span class="token punctuation">(</span>cricket<span class="token operator">::</span>ChannelInterface<span class="token operator">*</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Cannot set a non-null channel on a stopped transceiver.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stopped_ <span class="token operator">&amp;&amp;</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  channel_ <span class="token operator">=</span> channel<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>channel_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    channel_<span class="token operator">-&gt;</span><span class="token function">SignalFirstPacketReceived</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>RtpTransceiver<span class="token operator">::</span>OnFirstPacketReceived<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> sender <span class="token operator">:</span> senders_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sender<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetMediaChannel</span><span class="token punctuation">(</span>channel_ <span class="token operator">?</span> channel_<span class="token operator">-&gt;</span><span class="token function">media_channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                 <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> receiver <span class="token operator">:</span> receivers_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>channel_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      receiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    receiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetMediaChannel</span><span class="token punctuation">(</span>channel_ <span class="token operator">?</span> channel_<span class="token operator">-&gt;</span><span class="token function">media_channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                   <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*********************************************/</span>
<span class="token comment">/* 2. &#x521B;&#x5EFA; VideoSendStream &#x6216; AudioSendStream */</span>

RTCError <span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">UpdateSessionState</span><span class="token punctuation">(</span>
    SdpType type<span class="token punctuation">,</span>
    cricket<span class="token operator">::</span>ContentSource source<span class="token punctuation">,</span>
    <span class="token keyword">const</span> cricket<span class="token operator">::</span>SessionDescription<span class="token operator">*</span> description<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// Update internal objects according to the session description&apos;s media</span>
  <span class="token comment">// descriptions.</span>
  RTCError error <span class="token operator">=</span> <span class="token function">PushdownMediaDescription</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token class-name">RTCError</span><span class="token operator">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

RTCError <span class="token class-name">PeerConnection</span><span class="token operator">::</span><span class="token function">PushdownMediaDescription</span><span class="token punctuation">(</span>
    SdpType type<span class="token punctuation">,</span>
    cricket<span class="token operator">::</span>ContentSource source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> SessionDescriptionInterface<span class="token operator">*</span> sdesc <span class="token operator">=</span>
      <span class="token punctuation">(</span>source <span class="token operator">==</span> cricket<span class="token operator">::</span>CS_LOCAL <span class="token operator">?</span> <span class="token function">local_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                   <span class="token operator">:</span> <span class="token function">remote_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>sdesc<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Push down the new SDP media section for each audio/video transceiver.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> transceiver <span class="token operator">:</span> transceivers_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ContentInfo<span class="token operator">*</span> content_info <span class="token operator">=</span>
        <span class="token function">FindMediaSectionForTransceiver</span><span class="token punctuation">(</span>transceiver<span class="token punctuation">,</span> sdesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cricket<span class="token operator">::</span>ChannelInterface<span class="token operator">*</span> channel <span class="token operator">=</span> transceiver<span class="token operator">-&gt;</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    std<span class="token operator">::</span>string error<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> success <span class="token operator">=</span> <span class="token punctuation">(</span>source <span class="token operator">==</span> cricket<span class="token operator">::</span>CS_LOCAL<span class="token punctuation">)</span>
                       <span class="token operator">?</span> channel<span class="token operator">-&gt;</span><span class="token function">SetLocalContent</span><span class="token punctuation">(</span>content_desc<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span>
                       <span class="token operator">:</span> channel<span class="token operator">-&gt;</span><span class="token function">SetRemoteContent</span><span class="token punctuation">(</span>content_desc<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG_AND_RETURN_ERROR</span><span class="token punctuation">(</span>RTCErrorType<span class="token operator">::</span>INVALID_PARAMETER<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">return</span> <span class="token class-name">RTCError</span><span class="token operator">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">VideoChannel</span><span class="token operator">::</span><span class="token function">SetLocalContent_w</span><span class="token punctuation">(</span><span class="token keyword">const</span> MediaContentDescription<span class="token operator">*</span> content<span class="token punctuation">,</span>
                                     SdpType type<span class="token punctuation">,</span>
                                     std<span class="token operator">::</span>string<span class="token operator">*</span> error_desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">media_channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetRecvParameters</span><span class="token punctuation">(</span>recv_params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SafeSetError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to set local video description recv parameters.&quot;</span><span class="token punctuation">,</span>
                 error_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  last_recv_params_ <span class="token operator">=</span> recv_params<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>needs_send_params_update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">media_channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetSendParameters</span><span class="token punctuation">(</span>send_params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">SafeSetError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to set send parameters.&quot;</span><span class="token punctuation">,</span> error_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    last_send_params_ <span class="token operator">=</span> send_params<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// TODO(pthatcher): Move local streams into VideoSendParameters, and</span>
  <span class="token comment">// only give it to the media channel once we have a remote</span>
  <span class="token comment">// description too (without a remote description, we won&apos;t be able</span>
  <span class="token comment">// to send them anyway).</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">UpdateLocalStreams_w</span><span class="token punctuation">(</span>video<span class="token operator">-&gt;</span><span class="token function">streams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> error_desc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SafeSetError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to set local video description streams.&quot;</span><span class="token punctuation">,</span> error_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">set_local_content_direction</span><span class="token punctuation">(</span>content<span class="token operator">-&gt;</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">UpdateMediaSendRecvState_w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">BaseChannel</span><span class="token operator">::</span><span class="token function">UpdateLocalStreams_w</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>StreamParams<span class="token operator">&gt;</span><span class="token operator">&amp;</span> streams<span class="token punctuation">,</span>
                                       SdpType type<span class="token punctuation">,</span>
                                       std<span class="token operator">::</span>string<span class="token operator">*</span> error_desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// In the case of RIDs (where SSRCs are not negotiated), this method will</span>
  <span class="token comment">// generate an SSRC for each layer in StreamParams. That representation will</span>
  <span class="token comment">// be stored internally in |local_streams_|.</span>
  <span class="token comment">// In subsequent offers, the same stream can appear in |streams| again</span>
  <span class="token comment">// (without the SSRCs), so it should be looked up using RIDs (if available)</span>
  <span class="token comment">// and then by primary SSRC.</span>
  <span class="token comment">// In both scenarios, it is safe to assume that the media channel will be</span>
  <span class="token comment">// created with a StreamParams object with SSRCs. However, it is not safe to</span>
  <span class="token comment">// assume that |local_streams_| will always have SSRCs as there are scenarios</span>
  <span class="token comment">// in which niether SSRCs or RIDs are negotiated.</span>

  <span class="token comment">// Check for streams that have been removed.</span>
  <span class="token keyword">bool</span> ret <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// Check for new streams.</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>StreamParams<span class="token operator">&gt;</span> all_streams<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> StreamParams<span class="token operator">&amp;</span> stream <span class="token operator">:</span> streams<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    StreamParams<span class="token operator">*</span> existing <span class="token operator">=</span> <span class="token function">GetStream</span><span class="token punctuation">(</span>local_streams_<span class="token punctuation">,</span> <span class="token function">StreamFinder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Parameters cannot change for an existing stream.</span>
      all_streams<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">*</span>existing<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    all_streams<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    StreamParams<span class="token operator">&amp;</span> new_stream <span class="token operator">=</span> all_streams<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// At this point we use the legacy simulcast group in StreamParams to</span>
    <span class="token comment">// indicate that we want multiple layers to the media channel.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_stream<span class="token punctuation">.</span><span class="token function">has_ssrcs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO(bugs.webrtc.org/10250): Indicate if flex is desired here.</span>
      new_stream<span class="token punctuation">.</span><span class="token function">GenerateSsrcs</span><span class="token punctuation">(</span>new_stream<span class="token punctuation">.</span><span class="token function">rids</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/* rtx = */</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                               <span class="token comment">/* flex_fec = */</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ssrc_generator_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* &#x521B;&#x5EFA; VideoSendStream */</span>
    <span class="token function">media_channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">AddSendStream</span><span class="token punctuation">(</span>new_stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">WebRtcVideoChannel</span><span class="token operator">::</span><span class="token function">AddSendStream</span><span class="token punctuation">(</span><span class="token keyword">const</span> StreamParams<span class="token operator">&amp;</span> sp<span class="token punctuation">)</span> <span class="token comment">// webrtc_video_engine.cc</span>
      <span class="token operator">--</span><span class="token operator">&gt;</span> WebRtcVideoChannel<span class="token operator">::</span><span class="token class-name">WebRtcVideoSendStream</span><span class="token operator">::</span><span class="token function">WebRtcVideoSendStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">--</span><span class="token operator">&gt;</span> WebRtcVideoChannel<span class="token operator">::</span><span class="token class-name">WebRtcVideoSendStream</span><span class="token operator">::</span><span class="token function">SetCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">--</span><span class="token operator">&gt;</span> WebRtcVideoChannel<span class="token operator">::</span><span class="token class-name">WebRtcVideoSendStream</span><span class="token operator">::</span><span class="token function">RecreateWebRtcStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">--</span><span class="token operator">&gt;</span> webrtc<span class="token operator">::</span>VideoSendStream<span class="token operator">*</span> <span class="token class-name">Call</span><span class="token operator">::</span><span class="token function">CreateVideoSendStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// call/call.cc</span>
              <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">VideoSendStream</span><span class="token operator">::</span><span class="token function">VideoSendStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// video/video_send_stream.cc</span>
                <span class="token operator">--</span><span class="token operator">&gt;</span> video_stream_encoder_ <span class="token operator">=</span> <span class="token function">CreateVideoStreamEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  local_streams_ <span class="token operator">=</span> all_streams<span class="token punctuation">;</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**************************************************************************/</span>
<span class="token comment">/* 3. &#x8BBE;&#x7F6E; RtpSender &#x7684; ssrc, &#x540C;&#x65F6;&#x89E6;&#x53D1;&#x6DFB;&#x52A0; VideoStreamEncoder &#x5230; VideoSource */</span>
<span class="token comment">// pc/rtp_sender.cc</span>

<span class="token keyword">void</span> <span class="token class-name">RtpSenderBase</span><span class="token operator">::</span><span class="token function">SetSsrc</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> ssrc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">TRACE_EVENT0</span><span class="token punctuation">(</span><span class="token string">&quot;webrtc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RtpSenderBase::SetSsrc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stopped_ <span class="token operator">||</span> ssrc <span class="token operator">==</span> ssrc_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// If we are already sending with a particular SSRC, stop sending.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">can_send_track</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ClearSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RemoveTrackFromStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ssrc_ <span class="token operator">=</span> ssrc<span class="token punctuation">;</span>
  <span class="token comment">// can_send_track() &#x5224;&#x65AD; track_ &#x53CA; ssrc_ &#x662F;&#x5426;&#x5B58;&#x5728;&#x3002;&#x6B64;&#x65F6;&#x5DF2;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x3002;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">can_send_track</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x8C03;&#x7528;&#x5B50;&#x7C7B;&#x7684; SetSend()</span>
    <span class="token function">SetSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AddTrackToStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>


<span class="token comment">// </span>
<span class="token keyword">void</span> <span class="token class-name">VideoRtpSender</span><span class="token operator">::</span><span class="token function">SetSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  cricket<span class="token operator">::</span>VideoOptions options<span class="token punctuation">;</span>
  <span class="token comment">/* &#x83B7;&#x53D6; VideoSource&#xFF0C;&#x8BE5;&#x521B;&#x5EFA;&#x8BE6;&#x89C1; */</span>
  VideoTrackSourceInterface<span class="token operator">*</span> source <span class="token operator">=</span> <span class="token function">video_track</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span>is_screencast <span class="token operator">=</span> source<span class="token operator">-&gt;</span><span class="token function">is_screencast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>video_noise_reduction <span class="token operator">=</span> source<span class="token operator">-&gt;</span><span class="token function">needs_denoising</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  options<span class="token punctuation">.</span>content_hint <span class="token operator">=</span> cached_track_content_hint_<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cached_track_content_hint_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> VideoTrackInterface<span class="token operator">::</span>ContentHint<span class="token operator">::</span>kNone<span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> VideoTrackInterface<span class="token operator">::</span>ContentHint<span class="token operator">::</span>kFluid<span class="token operator">:</span>
      options<span class="token punctuation">.</span>is_screencast <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> VideoTrackInterface<span class="token operator">::</span>ContentHint<span class="token operator">::</span>kDetailed<span class="token operator">:</span>
    <span class="token keyword">case</span> VideoTrackInterface<span class="token operator">::</span>ContentHint<span class="token operator">::</span>kText<span class="token operator">:</span>
      options<span class="token punctuation">.</span>is_screencast <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* &#x8BBE;&#x7F6E; VideoSource, &#x5C06; VideoStreamEncoder &#x4F5C;&#x4E3A; VideoSink &#x6DFB;&#x52A0;&#x5230; VideoSource */</span>
  <span class="token keyword">bool</span> success <span class="token operator">=</span> worker_thread_<span class="token operator">-&gt;</span>Invoke<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>RTC_FROM_HERE<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">video_media_channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetVideoSend</span><span class="token punctuation">(</span>ssrc_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>options<span class="token punctuation">,</span> <span class="token function">video_track</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// media/engine/webrt_video_engine.cc</span>
<span class="token keyword">bool</span> <span class="token class-name">WebRtcVideoChannel</span><span class="token operator">::</span><span class="token function">SetVideoSend</span><span class="token punctuation">(</span>
    <span class="token keyword">uint32_t</span> ssrc<span class="token punctuation">,</span>
    <span class="token keyword">const</span> VideoOptions<span class="token operator">*</span> options<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>VideoSourceInterface<span class="token operator">&lt;</span>webrtc<span class="token operator">::</span>VideoFrame<span class="token operator">&gt;</span><span class="token operator">*</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// &#x67E5;&#x627E; VideoSendStream</span>
  <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> kv <span class="token operator">=</span> send_streams_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>ssrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>kv <span class="token operator">==</span> send_streams_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Allow unknown ssrc only if source is null.</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>source <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>LS_ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;No sending stream on ssrc &quot;</span> <span class="token operator">&lt;&lt;</span> ssrc<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> kv<span class="token operator">-&gt;</span>second<span class="token operator">-&gt;</span><span class="token function">SetVideoSend</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> WebRtcVideoChannel<span class="token operator">::</span><span class="token class-name">WebRtcVideoSendStream</span><span class="token operator">::</span><span class="token function">SetVideoSend</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> VideoOptions<span class="token operator">*</span> options<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>VideoSourceInterface<span class="token operator">&lt;</span>webrtc<span class="token operator">::</span>VideoFrame<span class="token operator">&gt;</span><span class="token operator">*</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">/* WebRtcVideoSendStream &#x521B;&#x5EFA;&#x65F6; source_ &#x4E3A;&#x7A7A;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x521B;&#x5EFA;&#x65F6;&#x548C;&#x8FD9;&#x91CC;&#x90FD;&#x4E0D;&#x4F1A;&#x8C03;&#x7528; SetSource */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source_ <span class="token operator">&amp;&amp;</span> stream_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stream_<span class="token operator">-&gt;</span><span class="token function">SetSource</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> webrtc<span class="token operator">::</span>DegradationPreference<span class="token operator">::</span>DISABLED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Switch to the new source.</span>
  source_ <span class="token operator">=</span> source<span class="token punctuation">;</span>
  <span class="token comment">/* source_ &#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x53CA;VideoSendStream &#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#xFF0C;&#x8C03;&#x7528; SetSource() */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">&amp;&amp;</span> stream_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x6B64;&#x5904;&#x53C2;&#x6570; this &#x4E3A; WebRtcVideoSendStream&#xFF0C;&#x5373;&#x540E;&#x9762;&#x6D41;&#x7A0B;&#x6DFB;&#x52A0; Sink &#x7684; source</span>
    stream_<span class="token operator">-&gt;</span><span class="token function">SetSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">GetDegradationPreference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">VideoSendStream</span><span class="token operator">::</span><span class="token function">SetSource</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> degradation_preference<span class="token punctuation">)</span> <span class="token comment">// video/video_send_stream.cc</span>
      <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">VideoStreamEncoder</span><span class="token operator">::</span><span class="token function">SetSource</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> degradation_preference<span class="token punctuation">)</span> <span class="token comment">// video/video_stream_encoder.cc</span>
        <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">VideoSourceSinkController</span><span class="token operator">::</span><span class="token function">SetSource</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> degradation_preference<span class="token punctuation">)</span> <span class="token comment">// video/video_source_sink_controller.cc</span>
              <span class="token comment">// &#x6B64;&#x5904; sink_ &#x4E3A; VideoStreamEncoder&#xFF0C; &#x662F; VideoSourceSinkController &#x5728; VideoStreamEncoder &#x521B;&#x5EFA;&#x65F6;&#x4F20;&#x5165;</span>
          <span class="token operator">--</span><span class="token operator">&gt;</span> source<span class="token operator">-&gt;</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>sink_<span class="token punctuation">,</span> wants<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">--</span><span class="token operator">&gt;</span> WebRtcVideoChannel<span class="token operator">::</span><span class="token class-name">WebRtcVideoSendStream</span><span class="token operator">::</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> wants<span class="token punctuation">)</span> <span class="token comment">// media/engine/webrt_video_engine.cc</span>
              <span class="token operator">--</span><span class="token operator">&gt;</span> encoder_sink_ <span class="token operator">=</span> sink<span class="token punctuation">;</span> <span class="token comment">// &#x4FDD;&#x5B58; sink</span>
                  <span class="token comment">// &#x6B64;&#x5904; source_ &#x5B9E;&#x4E3A; VideoTrack&#xFF0C;&#x540E;&#x7EED;&#x6D41;&#x7A0B;&#x4E0E;&#x6DFB;&#x52A0;&#x89C6;&#x9891;&#x9884;&#x89C8; sink &#x57FA;&#x672C;&#x4E00;&#x81F4;&#x3002;&#x53EF;&#x56DE;&#x770B;&#x4E0A;&#x4E00;&#x8282; &#x300A;3.4.3&#x300B;&#x3002;</span>
              <span class="token operator">--</span><span class="token operator">&gt;</span> source_<span class="token operator">-&gt;</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>encoder_sink_<span class="token punctuation">,</span> wants<span class="token punctuation">)</span>
                <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">VideoTrack</span><span class="token operator">::</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> wants<span class="token punctuation">)</span>
                  <span class="token operator">--</span><span class="token operator">&gt;</span> video_source_<span class="token operator">-&gt;</span><span class="token function">AddOrUpdateSink</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> modified_wants<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</pre><h3 class="mume-header" id="35-%E6%91%84%E5%83%8F%E5%A4%B4%E8%A7%86%E9%A2%91%E6%95%B0%E6%8D%AE%E6%B5%81">3.5 &#x6444;&#x50CF;&#x5934;&#x89C6;&#x9891;&#x6570;&#x636E;&#x6D41;</h3>

<pre data-role="codeBlock" data-info class="language-"><code>(Camera2 &#x6216; Camera1 &#x4F7F;&#x80FD; captureToTexture) (SurfaceTextureHelper.java) SurfaceTextureHelper.listener.onFrame() --&gt;
Camera1Session/Camera2Session --&gt; (CameraCapturer.java) CameraSession.Events.onFrameCaptured() 
--&gt; (VideoSource.java) CapturerObserver.onFrameCaptured()
--&gt; (NativeAndroidVideoTrackSource.java) NativeAndroidVideoTrackSource.onFrameCaptured() 
--&gt; (android_video_track_source.cc) AndroidVideoTrackSource.onFrameCaptured()
--&gt; (adapted_video_track_source.cc) AdaptedVideoTrackSource::OnFrame() --&gt; broadcaster_.OnFrame(frame)
// &#x5206;&#x652F;1&#xFF1A;&#x89C6;&#x9891;&#x9884;&#x89C8;
--&gt; (sdk/android/src/jni/video_sink.cc) VideoSinkWrapper::::OnFrame(VideoFrame)
--&gt; (gen/sdk/android/generated_video_jni/VideoSink_jni.h) Java_VideoSink_onFrame(VideoFrame) // &#x6620;&#x5C04;&#x5230; Java &#x5C42; VideoFrame
--&gt; (CallActivity.java) ProxyVideoSink::onFrame() --&gt; target.onFrame(VideoFrame)
--&gt; (SurfaceViewRenderer.java) SurfaceViewRenderer::onFrame(VideoFrame)

// &#x5206;&#x652F;2&#xFF1A;&#x89C6;&#x9891;&#x7F16;&#x7801;
--&gt; (video/video_stream_encoder.cc) VideoStreamEncoder::OnFrame(VideoFrame)
</code></pre>
      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>