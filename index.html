
<!DOCTYPE html>
<html>
  <head>
    <title>no title</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    .markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}/**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}.emoji {
  height: 0.8em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}
    /* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

    </style>
    
  </head>
  <body for="html-export">
    <div class="mume markdown-preview">
    <html><head></head><body><div><h2 class="mume-header" id="1-peerconnection-%E5%88%9B%E5%BB%BA">1 PeerConnection &#x521B;&#x5EFA;</h2>

<p>&#x97F3;&#x89C6;&#x9891;&#x4E92;&#x901A;&#x9700;&#x8981;&#x5148;&#x521B;&#x5EFA; PeerConnection&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x521B;&#x5EFA;&#x53CA;&#x4EA4;&#x6362; Sdp&#xFF0C;&#x4EE5;&#x5B8C;&#x6210;&#x901A;&#x8BDD;&#x5EFA;&#x7ACB;&#x3002;</p>
<h3 class="mume-header" id="11-peerconnectionfactory-%E5%88%9B%E5%BB%BA">1.1 PeerConnectionFactory &#x521B;&#x5EFA;</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// CallActivity.java</span>
<span class="token class-name">CallActivity</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create peer connection client.</span>
    <span class="token comment">// &#x521B;&#x5EFA; peer connection client, &#x5E76;&#x8C03;&#x7528; PeerConnectionFactory.initialize() &#x52A0;&#x8F7D;&#x52A8;&#x6001;&#x5E93;&#x53CA;&#x4E0A;&#x4E0B;&#x6587;&#x73AF;&#x5883;&#x7B49;.</span>
    peerConnectionClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnectionClient</span><span class="token punctuation">(</span>
        <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> eglBase<span class="token punctuation">,</span> peerConnectionParameters<span class="token punctuation">,</span> <span class="token class-name">CallActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnectionFactory */</span>
    <span class="token class-name">PeerConnectionFactory<span class="token punctuation">.</span>Options</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnectionFactory<span class="token punctuation">.</span>Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PeerConnectionClient</span><span class="token punctuation">.</span><span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    
    <span class="token comment">/* &#x5F00;&#x59CB;&#x901A;&#x8BDD;&#x5EFA;&#x7ACB; */</span>
    <span class="token function">startCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span><span class="token class-name">PeerConnectionFactory<span class="token punctuation">.</span>Options</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;PeerConnectionFactory has already been constructed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">createPeerConnectionFactoryInternal</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">createPeerConnectionFactoryInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757; */</span>
    <span class="token keyword">final</span> <span class="token class-name">AudioDeviceModule</span> adm <span class="token operator">=</span> <span class="token function">createJavaAudioDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x89C6;&#x9891;&#x7F16;&#x7801;&#x662F;&#x5426;&#x4F7F;&#x80FD; H264 high level profile */</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> enableH264HighProfile <span class="token operator">=</span>
        VIDEO_CODEC_H264_HIGH<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCodec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">VideoEncoderFactory</span> encoderFactory<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">VideoDecoderFactory</span> decoderFactory<span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA;&#x89C6;&#x9891;&#x7F16;&#x89E3;&#x7801;&#x5DE5;&#x5382;, &#x8F6F;&#x7F16;&#x6216;&#x786C;&#x7F16; */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCodecHwAcceleration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      encoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultVideoEncoderFactory</span><span class="token punctuation">(</span>
          rootEglBase<span class="token punctuation">.</span><span class="token function">getEglBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* enableIntelVp8Encoder */</span><span class="token punctuation">,</span> enableH264HighProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      decoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultVideoDecoderFactory</span><span class="token punctuation">(</span>rootEglBase<span class="token punctuation">.</span><span class="token function">getEglBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      encoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftwareVideoEncoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      decoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftwareVideoDecoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* &#x6784;&#x5EFA; PeerConnectionFactory */</span>
    factory <span class="token operator">=</span> <span class="token class-name">PeerConnectionFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setAudioDeviceModule</span><span class="token punctuation">(</span>adm<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setVideoEncoderFactory</span><span class="token punctuation">(</span>encoderFactory<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setVideoDecoderFactory</span><span class="token punctuation">(</span>decoderFactory<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    adm<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/PeerConnectionFactory.java</span>
<span class="token comment">// PeerConnectionFactory.Builder</span>
<span class="token keyword">public</span> <span class="token class-name">PeerConnectionFactory</span> <span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x901A;&#x8FC7; Jni &#x521B;&#x5EFA; Native &#x5C42; PeerConnectionFactory &#x5BF9;&#x8C61;</span>
    <span class="token keyword">return</span> <span class="token function">nativeCreatePeerConnectionFactory</span><span class="token punctuation">(</span><span class="token class-name">ContextUtils</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span>
        <span class="token comment">/* &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x8BBE;&#x5907; Native C++&#x6307;&#x9488; */</span>
        audioDeviceModule<span class="token punctuation">.</span><span class="token function">getNativeAudioDeviceModulePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x7F16;&#x7801;&#x5DE5;&#x5382;&#x7C7B; Native C++ &#x6307;&#x9488; */</span>
        audioEncoderFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeAudioEncoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x89E3;&#x7801;&#x5DE5;&#x5382;&#x7C7B; Native C++ &#x6307;&#x9488; */</span>
        audioDecoderFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeAudioDecoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token comment">/* &#x89C6;&#x9891;&#x7F16;&#x7801;&#x5668;&#x5DE5;&#x5382;&#x7C7B;&#x5BF9;&#x8C61; */</span>
        videoEncoderFactory<span class="token punctuation">,</span>
        <span class="token comment">/* &#x89C6;&#x9891;&#x89E3;&#x7801;&#x5668;&#x5DE5;&#x5382;&#x7C7B;&#x5BF9;&#x8C61; */</span>
        videoDecoderFactory<span class="token punctuation">,</span>
        <span class="token comment">/* &#x97F3;&#x9891;&#x589E;&#x5F3A;&#x5904;&#x7406;&#xFF0C;&#x6B64;&#x5904;&#x4E3A; null */</span>
        audioProcessingFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> audioProcessingFactory<span class="token punctuation">.</span><span class="token function">createNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* fec &#x63A7;&#x5236;&#x5668;&#xFF0C;&#x6B64;&#x5904;&#x4E3A; null */</span>
        fecControllerFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> fecControllerFactoryFactory<span class="token punctuation">.</span><span class="token function">createNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        networkControllerFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token number">0</span>
            <span class="token operator">:</span> networkControllerFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeNetworkControllerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        networkStatePredictorFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token number">0</span>
            <span class="token operator">:</span> networkStatePredictorFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeNetworkStatePredictorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        mediaTransportFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token number">0</span>
            <span class="token operator">:</span> mediaTransportFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeMediaTransportFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        neteqFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> neteqFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeNetEqFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnection_factory_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; sdk/android/api/org/webrtc/PeerConnectionFactory.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x52A8;&#x6001;&#x751F;&#x6210;</span>
<span class="token comment">/* &#x521B;&#x5EFA; Native &#x5C42; PeerConnectionFactory &#x5BF9;&#x8C61; */</span>
JNI_GENERATOR_EXPORT jobject
    <span class="token function">Java_org_webrtc_PeerConnectionFactory_nativeCreatePeerConnectionFactory</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jobject context<span class="token punctuation">,</span>
    jobject options<span class="token punctuation">,</span>
    jlong nativeAudioDeviceModule<span class="token punctuation">,</span>
    jlong audioEncoderFactory<span class="token punctuation">,</span>
    jlong audioDecoderFactory<span class="token punctuation">,</span>
    jobject encoderFactory<span class="token punctuation">,</span>
    jobject decoderFactory<span class="token punctuation">,</span>
    jlong nativeAudioProcessor<span class="token punctuation">,</span>
    jlong nativeFecControllerFactory<span class="token punctuation">,</span>
    jlong nativeNetworkControllerFactory<span class="token punctuation">,</span>
    jlong nativeNetworkStatePredictorFactory<span class="token punctuation">,</span>
    jlong mediaTransportFactory<span class="token punctuation">,</span>
    jlong neteqFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">JNI_PeerConnectionFactory_CreatePeerConnectionFactory</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        nativeAudioDeviceModule<span class="token punctuation">,</span> 
        audioEncoderFactory<span class="token punctuation">,</span> audioDecoderFactory<span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> encoderFactory<span class="token punctuation">)</span><span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> decoderFactory<span class="token punctuation">)</span><span class="token punctuation">,</span>
        nativeAudioProcessor<span class="token punctuation">,</span>
        nativeFecControllerFactory<span class="token punctuation">,</span> nativeNetworkControllerFactory<span class="token punctuation">,</span>
        nativeNetworkStatePredictorFactory<span class="token punctuation">,</span> mediaTransportFactory<span class="token punctuation">,</span> neteqFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection_factory.cc</span>
<span class="token keyword">static</span> ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span>
<span class="token function">JNI_PeerConnectionFactory_CreatePeerConnectionFactory</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jcontext<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> joptions<span class="token punctuation">,</span>
    jlong native_audio_device_module<span class="token punctuation">,</span>
    jlong native_audio_encoder_factory<span class="token punctuation">,</span>
    jlong native_audio_decoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jencoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jdecoder_factory<span class="token punctuation">,</span>
    jlong native_audio_processor<span class="token punctuation">,</span>
    jlong native_fec_controller_factory<span class="token punctuation">,</span>
    jlong native_network_controller_factory<span class="token punctuation">,</span>
    jlong native_network_state_predictor_factory<span class="token punctuation">,</span>
    jlong native_media_transport_factory<span class="token punctuation">,</span>
    jlong native_neteq_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioProcessing<span class="token operator">&gt;</span> audio_processor <span class="token operator">=</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>AudioProcessing<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">CreatePeerConnectionFactoryForJava</span><span class="token punctuation">(</span>
      jni<span class="token punctuation">,</span> jcontext<span class="token punctuation">,</span> joptions<span class="token punctuation">,</span>
      <span class="token comment">// Native &#x97F3;&#x9891;&#x8BBE;&#x5907;&#x5BF9;&#x8C61;</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>AudioDeviceModule<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_device_module<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfRefPtr<span class="token operator">&lt;</span>AudioEncoderFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_encoder_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfRefPtr<span class="token operator">&lt;</span>AudioDecoderFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_decoder_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jencoder_factory<span class="token punctuation">,</span> jdecoder_factory<span class="token punctuation">,</span>
      <span class="token comment">// &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x589E;&#x5F3A;&#x5904;&#x7406;&#x5BF9;&#x8C61;</span>
      audio_processor <span class="token operator">?</span> audio_processor <span class="token operator">:</span> <span class="token function">CreateAudioProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>FecControllerFactoryInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_fec_controller_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>NetworkControllerFactoryInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_network_controller_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>NetworkStatePredictorFactoryInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_network_state_predictor_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>MediaTransportFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_media_transport_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>NetEqFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>native_neteq_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Following parameters are optional:</span>
<span class="token comment">// |audio_device_module|, |jencoder_factory|, |jdecoder_factory|,</span>
<span class="token comment">// |audio_processor|, |media_transport_factory|, |fec_controller_factory|,</span>
<span class="token comment">// |network_state_predictor_factory|, |neteq_factory|.</span>
ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">CreatePeerConnectionFactoryForJava</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jcontext<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> joptions<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioDeviceModule<span class="token operator">&gt;</span> audio_device_module<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioEncoderFactory<span class="token operator">&gt;</span> audio_encoder_factory<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioDecoderFactory<span class="token operator">&gt;</span> audio_decoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jencoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jdecoder_factory<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioProcessing<span class="token operator">&gt;</span> audio_processor<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>FecControllerFactoryInterface<span class="token operator">&gt;</span> fec_controller_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NetworkControllerFactoryInterface<span class="token operator">&gt;</span>
        network_controller_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NetworkStatePredictorFactoryInterface<span class="token operator">&gt;</span>
        network_state_predictor_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>MediaTransportFactory<span class="token operator">&gt;</span> media_transport_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NetEqFactory<span class="token operator">&gt;</span> neteq_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// talk/ assumes pretty widely that the current Thread is ThreadManager&apos;d, but</span>
    <span class="token comment">// ThreadManager only WrapCurrentThread()s the thread where it is first</span>
    <span class="token comment">// created.  Since the semantics around when auto-wrapping happens in</span>
    <span class="token comment">// webrtc/rtc_base/ are convoluted, we simply wrap here to avoid having to</span>
    <span class="token comment">// think about ramifications of auto-wrapping there.</span>
    rtc<span class="token operator">::</span><span class="token class-name">ThreadManager</span><span class="token operator">::</span><span class="token function">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">WrapCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; network &#x7EBF;&#x7A0B;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> network_thread <span class="token operator">=</span>
        rtc<span class="token operator">::</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">CreateWithSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    network_thread<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span><span class="token string">&quot;network_thread&quot;</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>network_thread<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to start thread&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; worker &#x7EBF;&#x7A0B;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> worker_thread <span class="token operator">=</span> rtc<span class="token operator">::</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker_thread<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span><span class="token string">&quot;worker_thread&quot;</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>worker_thread<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to start thread&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; signaling &#x7EBF;&#x7A0B;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> signaling_thread <span class="token operator">=</span> rtc<span class="token operator">::</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    signaling_thread<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span><span class="token string">&quot;signaling_thread&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>signaling_thread<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to start thread&quot;</span><span class="token punctuation">;</span>

    rtc<span class="token operator">::</span>NetworkMonitorFactory<span class="token operator">*</span> network_monitor_factory <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> absl<span class="token operator">::</span>optional<span class="token operator">&lt;</span>PeerConnectionFactoryInterface<span class="token operator">::</span>Options<span class="token operator">&gt;</span> options <span class="token operator">=</span>
        <span class="token function">JavaToNativePeerConnectionFactoryOptions</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> joptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Do not create network_monitor_factory only if the options are</span>
    <span class="token comment">// provided and disable_network_monitor therein is set to true.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token operator">-&gt;</span>disable_network_monitor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        network_monitor_factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">AndroidNetworkMonitorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rtc<span class="token operator">::</span><span class="token class-name">NetworkMonitorFactory</span><span class="token operator">::</span><span class="token function">SetFactory</span><span class="token punctuation">(</span>network_monitor_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    PeerConnectionFactoryDependencies dependencies<span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>network_thread <span class="token operator">=</span> network_thread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>worker_thread <span class="token operator">=</span> worker_thread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>signaling_thread <span class="token operator">=</span> signaling_thread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>task_queue_factory <span class="token operator">=</span> <span class="token function">CreateDefaultTaskQueueFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>call_factory <span class="token operator">=</span> <span class="token function">CreateCallFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>event_log_factory <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>RtcEventLogFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>
        dependencies<span class="token punctuation">.</span>task_queue_factory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>fec_controller_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>fec_controller_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>network_controller_factory <span class="token operator">=</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_controller_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>network_state_predictor_factory <span class="token operator">=</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_state_predictor_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>media_transport_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>media_transport_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>neteq_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>neteq_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cricket<span class="token operator">::</span>MediaEngineDependencies media_dependencies<span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>task_queue_factory <span class="token operator">=</span> dependencies<span class="token punctuation">.</span>task_queue_factory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x5916;&#x90E8;&#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;</span>
    media_dependencies<span class="token punctuation">.</span>adm <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_device_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>audio_encoder_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_encoder_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>audio_decoder_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_decoder_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>audio_processing <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>video_encoder_factory <span class="token operator">=</span>
        absl<span class="token operator">::</span><span class="token function">WrapUnique</span><span class="token punctuation">(</span><span class="token function">CreateVideoEncoderFactory</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> jencoder_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>video_decoder_factory <span class="token operator">=</span>
        absl<span class="token operator">::</span><span class="token function">WrapUnique</span><span class="token punctuation">(</span><span class="token function">CreateVideoDecoderFactory</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> jdecoder_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x521B;&#x5EFA; MediaEngine</span>
    dependencies<span class="token punctuation">.</span>media_engine <span class="token operator">=</span>
        cricket<span class="token operator">::</span><span class="token function">CreateMediaEngine</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>media_dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; PeerConnectionFactory&#xFF0C;&#x6B64;&#x8C03;&#x7528;&#x4E0E;&#x5176;&#x4ED6;&#x5E73;&#x53F0;&#x76F8;&#x540C;</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>PeerConnectionFactoryInterface<span class="token operator">&gt;</span> factory <span class="token operator">=</span>
        <span class="token function">CreateModularPeerConnectionFactory</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to create the peer connection factory; &quot;</span>
                            <span class="token string">&quot;WebRTC/libjingle init likely failed on this device&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO(honghaiz): Maybe put the options as the argument of</span>
    <span class="token comment">// CreatePeerConnectionFactory.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        factory<span class="token operator">-&gt;</span><span class="token function">SetOptions</span><span class="token punctuation">(</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">NativeToScopedJavaPeerConnectionFactory</span><span class="token punctuation">(</span>
        jni<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>worker_thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>signaling_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> network_monitor_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">NativeToScopedJavaPeerConnectionFactory</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>webrtc<span class="token operator">::</span>PeerConnectionFactoryInterface<span class="token operator">&gt;</span> pcf<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> network_thread<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> worker_thread<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> signaling_thread<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>NetworkMonitorFactory<span class="token operator">*</span> network_monitor_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// OwnedFactoryAndThreads &#x4FDD;&#x5B58;&#x7EF4;&#x62A4; Native Factory &#x5BF9;&#x8C61;</span>
    OwnedFactoryAndThreads<span class="token operator">*</span> owned_factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">OwnedFactoryAndThreads</span><span class="token punctuation">(</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>worker_thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>signaling_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> network_monitor_factory<span class="token punctuation">,</span> pcf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; Java &#x5C42;&#x7684; PeerConnectionFactory &#x5B9E;&#x4F8B;</span>
    ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> j_pcf <span class="token operator">=</span> <span class="token function">Java_PeerConnectionFactory_Constructor</span><span class="token punctuation">(</span>
        env<span class="token punctuation">,</span> <span class="token function">NativeToJavaPointer</span><span class="token punctuation">(</span>owned_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x56DE;&#x8C03; PeerConnectionFactory.onNetworkThreadReady()</span>
    <span class="token function">PostJavaCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> owned_factory<span class="token operator">-&gt;</span><span class="token function">network_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTC_FROM_HERE<span class="token punctuation">,</span> j_pcf<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>Java_PeerConnectionFactory_onNetworkThreadReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x56DE;&#x8C03; PeerConnectionFactory.onWorkerThreadReady()</span>
    <span class="token function">PostJavaCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> owned_factory<span class="token operator">-&gt;</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTC_FROM_HERE<span class="token punctuation">,</span> j_pcf<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>Java_PeerConnectionFactory_onWorkerThreadReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x56DE;&#x8C03; PeerConnectionFactory.onSignalingThreadReady()</span>
    <span class="token function">PostJavaCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> owned_factory<span class="token operator">-&gt;</span><span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTC_FROM_HERE<span class="token punctuation">,</span> j_pcf<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>Java_PeerConnectionFactory_onSignalingThreadReady<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> j_pcf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> base<span class="token operator">::</span>android<span class="token operator">::</span>ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">Java_PeerConnectionFactory_Constructor</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span>
    env<span class="token punctuation">,</span> jlong nativeFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_PeerConnectionFactory_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_PeerConnectionFactory_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_PeerConnectionFactory_Constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x6784;&#x9020; Java &#x5C42; PeerConnectionFactory &#x5B9E;&#x4F8B;</span>
    jobject ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">NewObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> base<span class="token operator">::</span>android<span class="token operator">::</span>ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="12-%E5%88%9B%E5%BB%BA-peerconnection">1.2 &#x521B;&#x5EFA; PeerConnection</h3>

<ol>
<li>&#x8FDE;&#x63A5;&#x4E0A;&#x623F;&#x95F4;&#x670D;&#x52A1;&#x5668;&#xFF1B;</li>
<li>&#x82E5;&#x4F7F;&#x80FD;&#x89C6;&#x9891;&#xFF0C;&#x5219;&#x5148;&#x521B;&#x5EFA;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90;&#xFF1B;</li>
<li>&#x521B;&#x5EFA; PeerConnection&#xFF1B;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// CallActivity.java</span>
<span class="token comment">/* &#x4FE1;&#x4EE4;&#x5C42;&#x8FDE;&#x63A5;&#x623F;&#x95F4;&#x670D;&#x52A1;&#x5668;&#x6210;&#x529F;, &#x521B;&#x5EFA; PeerConnection, &#x82E5;&#x662F;&#x4E3B;&#x53EB;&#x7AEF;&#x5219;&#x521B;&#x5EFA; offer sdp&#xFF0C;&#x82E5;&#x662F;&#x88AB;&#x53EB;&#x7AEF;&#x5219;&#x9700;&#x8BBE;&#x7F6E;&#x8FDC;&#x7AEF; Sdp &#x53CA;&#x521B;&#x5EFA;&#x672C;&#x7AEF; Sdp */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onConnectedToRoomInternal</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SignalingParameters</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> delta <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> callStartedTimeMs<span class="token punctuation">;</span>

    signalingParameters <span class="token operator">=</span> params<span class="token punctuation">;</span>
    <span class="token function">logAndToast</span><span class="token punctuation">(</span><span class="token string">&quot;Creating peer connection, delay=&quot;</span> <span class="token operator">+</span> delta <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x5B9E;&#x4F8B;&#xFF0C;&#x53EF;&#x4E3A;&#xFF1A;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x3001;&#x5C4F;&#x5E55;&#x5171;&#x4EAB;&#x3001;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6; */</span>
    <span class="token class-name">VideoCapturer</span> videoCapturer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCallEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        videoCapturer <span class="token operator">=</span> <span class="token function">createVideoCapturer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnection */</span>
    peerConnectionClient<span class="token punctuation">.</span><span class="token function">createPeerConnection</span><span class="token punctuation">(</span>
        localProxyVideoSink<span class="token punctuation">,</span> remoteSinks<span class="token punctuation">,</span> videoCapturer<span class="token punctuation">,</span> signalingParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>signalingParameters<span class="token punctuation">.</span>initiator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logAndToast</span><span class="token punctuation">(</span><span class="token string">&quot;Creating OFFER...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Create offer. Offer SDP will be sent to answering client in</span>
        <span class="token comment">// PeerConnectionEvents.onLocalDescription event.</span>
        peerConnectionClient<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>offerSdp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            peerConnectionClient<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>offerSdp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">logAndToast</span><span class="token punctuation">(</span><span class="token string">&quot;Creating ANSWER...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Create answer. Answer SDP will be sent to offering client in</span>
            <span class="token comment">// PeerConnectionEvents.onLocalDescription event.</span>
            peerConnectionClient<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>iceCandidates <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Add remote ICE candidates from room.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IceCandidate</span> iceCandidate <span class="token operator">:</span> params<span class="token punctuation">.</span>iceCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                peerConnectionClient<span class="token punctuation">.</span><span class="token function">addRemoteIceCandidate</span><span class="token punctuation">(</span>iceCandidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">VideoSink</span> localRender<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">VideoSink</span> remoteSink<span class="token punctuation">,</span>
      <span class="token keyword">final</span> <span class="token class-name">VideoCapturer</span> videoCapturer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SignalingParameters</span> signalingParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCallEnabled <span class="token operator">&amp;&amp;</span> videoCapturer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Video call enabled but no video capturer provided.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">createPeerConnection</span><span class="token punctuation">(</span>
        localRender<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>remoteSink<span class="token punctuation">)</span><span class="token punctuation">,</span> videoCapturer<span class="token punctuation">,</span> signalingParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">VideoSink</span> localRender<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VideoSink</span><span class="token punctuation">&gt;</span></span> remoteSinks<span class="token punctuation">,</span>
      <span class="token keyword">final</span> <span class="token class-name">VideoCapturer</span> videoCapturer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SignalingParameters</span> signalingParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating peer connection without initializing factory.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x672C;&#x5730;&#x9884;&#x89C8;&#x7684; sink</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>localRender <span class="token operator">=</span> localRender<span class="token punctuation">;</span>
    <span class="token comment">// &#x8FDC;&#x7AEF;&#x6E32;&#x67D3;&#x7684; sink</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>remoteSinks <span class="token operator">=</span> remoteSinks<span class="token punctuation">;</span>
    <span class="token comment">// &#x89C6;&#x9891;&#x6E90;&#x5B9E;&#x4F8B;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>videoCapturer <span class="token operator">=</span> videoCapturer<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>signalingParameters <span class="token operator">=</span> signalingParameters<span class="token punctuation">;</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">createMediaConstraintsInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">createPeerConnectionInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">maybeCreateAndStartRtcEventLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create peer connection: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createPeerConnectionInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> isError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Peerconnection factory is not created&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Create peer connection.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    queuedRemoteCandidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">PeerConnection<span class="token punctuation">.</span>RTCConfiguration</span> rtcConfig <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>RTCConfiguration</span><span class="token punctuation">(</span>signalingParameters<span class="token punctuation">.</span>iceServers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TCP candidates are only useful when connecting to a server that supports</span>
    <span class="token comment">// ICE-TCP.</span>
    rtcConfig<span class="token punctuation">.</span>tcpCandidatePolicy <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>TcpCandidatePolicy</span><span class="token punctuation">.</span>DISABLED<span class="token punctuation">;</span>
    rtcConfig<span class="token punctuation">.</span>bundlePolicy <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>BundlePolicy</span><span class="token punctuation">.</span>MAXBUNDLE<span class="token punctuation">;</span>
    rtcConfig<span class="token punctuation">.</span>rtcpMuxPolicy <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>RtcpMuxPolicy</span><span class="token punctuation">.</span>REQUIRE<span class="token punctuation">;</span>
    rtcConfig<span class="token punctuation">.</span>continualGatheringPolicy <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>ContinualGatheringPolicy</span><span class="token punctuation">.</span>GATHER_CONTINUALLY<span class="token punctuation">;</span>
    <span class="token comment">// Use ECDSA encryption.</span>
    rtcConfig<span class="token punctuation">.</span>keyType <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>KeyType</span><span class="token punctuation">.</span>ECDSA<span class="token punctuation">;</span>
    <span class="token comment">// Enable DTLS for normal calls and disable for loopback calls.</span>
    rtcConfig<span class="token punctuation">.</span>enableDtlsSrtp <span class="token operator">=</span> <span class="token operator">!</span>peerConnectionParameters<span class="token punctuation">.</span>loopback<span class="token punctuation">;</span>
    rtcConfig<span class="token punctuation">.</span>sdpSemantics <span class="token operator">=</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>SdpSemantics</span><span class="token punctuation">.</span>UNIFIED_PLAN<span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnection */</span>
    peerConnection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createPeerConnection</span><span class="token punctuation">(</span>rtcConfig<span class="token punctuation">,</span> pcObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataChannelEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* create data channel */</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    isInitiator <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// Set INFO libjingle logging.</span>
    <span class="token comment">// NOTE: this _must_ happen while |factory| is alive!</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">enableLogToDebugOutput</span><span class="token punctuation">(</span><span class="token class-name">Logging<span class="token punctuation">.</span>Severity</span><span class="token punctuation">.</span>LS_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mediaStreamLabels <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">&quot;ARDAMS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVideoCallEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x5E76;&#x6DFB;&#x52A0;&#x89C6;&#x9891;&#x6E90;&#x5230; PeerConnection, &#x521B;&#x5EFA; VideoTrack &#x65F6;&#x5C06;&#x542F;&#x52A8;&#x89C6;&#x9891;&#x6E90;&#x91C7;&#x96C6; */</span>
        peerConnection<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span><span class="token function">createVideoTrack</span><span class="token punctuation">(</span>videoCapturer<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaStreamLabels<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// We can add the renderers right away because we don&apos;t need to wait for an</span>
        <span class="token comment">// answer to get the remote track.</span>
        remoteVideoTrack <span class="token operator">=</span> <span class="token function">getRemoteVideoTrack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        remoteVideoTrack<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span>renderVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">VideoSink</span> remoteSink <span class="token operator">:</span> remoteSinks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            remoteVideoTrack<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>remoteSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    peerConnection<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span><span class="token function">createAudioTrack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mediaStreamLabels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVideoCallEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">findVideoSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Peer connection created.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/PeerConnectionFactory.java</span>
<span class="token keyword">public</span> <span class="token class-name">PeerConnection</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span>
      <span class="token class-name">PeerConnection<span class="token punctuation">.</span>RTCConfiguration</span> rtcConfig<span class="token punctuation">,</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>Observer</span> observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span>rtcConfig<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* constraints */</span><span class="token punctuation">,</span> observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">PeerConnection</span> <span class="token function">createPeerConnectionInternal</span><span class="token punctuation">(</span><span class="token class-name">PeerConnection<span class="token punctuation">.</span>RTCConfiguration</span> rtcConfig<span class="token punctuation">,</span>
      <span class="token class-name">MediaConstraints</span> constraints<span class="token comment">/* null */</span><span class="token punctuation">,</span> <span class="token class-name">PeerConnection<span class="token punctuation">.</span>Observer</span> observer<span class="token punctuation">,</span>
      <span class="token class-name">SSLCertificateVerifier</span> sslCertificateVerifier<span class="token comment">/* null */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkPeerConnectionFactoryExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x521B;&#x5EFA; PeerConnection.Observer &#x7684; Native &#x5C42;&#x5173;&#x8054;&#x5BF9;&#x8C61;</span>
    <span class="token keyword">long</span> nativeObserver <span class="token operator">=</span> <span class="token class-name">PeerConnection</span><span class="token punctuation">.</span><span class="token function">createNativePeerConnectionObserver</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeObserver <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> nativePeerConnection <span class="token operator">=</span> <span class="token function">nativeCreatePeerConnection</span><span class="token punctuation">(</span>
        nativeFactory<span class="token punctuation">,</span> rtcConfig<span class="token punctuation">,</span> constraints<span class="token punctuation">,</span> nativeObserver<span class="token punctuation">,</span> sslCertificateVerifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nativePeerConnection <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnection</span><span class="token punctuation">(</span>nativePeerConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/PeerConnection.java</span>
<span class="token class-name">PeerConnection</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativePeerConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativePeerConnection <span class="token operator">=</span> nativePeerConnection<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>&#x7ED1;&#x5B9A; Java &#x5C42; PeerConnection Observer &#x5BF9;&#x8C61;&#xFF0C;&#x540E;&#x7EED;&#x901A;&#x8FC7;&#x8BE5; Observer &#x5C06; Native &#x5C42;&#x4E8B;&#x4EF6;&#x56DE;&#x8C03;&#x5230; Java &#x5C42;&#x3002;<br>
&#x5176;&#x4E2D;&#xFF0C;PeerConnectionObserverJni &#x4E3A;Android&#x7AEF; PeerConnectionObserver &#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x3002;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnection_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; PeerConnection.java &#x751F;&#x6210;</span>
JNI_GENERATOR_EXPORT jlong <span class="token function">Java_org_webrtc_PeerConnection_nativeCreatePeerConnectionObserver</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jobject observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_PeerConnection_CreatePeerConnectionObserver</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> observer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_PeerConnection_CreatePeerConnectionObserver</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">PeerConnectionObserverJni</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_observer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">PeerConnectionObserverJni</span><span class="token operator">::</span><span class="token function">PeerConnectionObserverJni</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_observer<span class="token punctuation">)</span>
    <span class="token comment">// &#x521B;&#x5EFA; Observer Object &#x7684; global &#x5F15;&#x7528;</span>
    <span class="token operator">:</span> <span class="token function">j_observer_global_</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> j_observer<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre><p>&#x521B;&#x5EFA; Native &#x5C42; PeerConnection &#x5BF9;&#x8C61;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnection_factory_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; sdk/android/api/org/webrtc/PeerConnectionFactory.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x52A8;&#x6001;&#x751F;&#x6210;</span>
<span class="token comment">/* &#x521B;&#x5EFA; Native &#x5C42; PeerConnection &#x5BF9;&#x8C61; */</span>
JNI_GENERATOR_EXPORT jlong <span class="token function">Java_org_webrtc_PeerConnectionFactory_nativeCreatePeerConnection</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jlong factory<span class="token punctuation">,</span>
    jobject rtcConfig<span class="token punctuation">,</span>
    jobject constraints<span class="token punctuation">,</span> <span class="token comment">// null</span>
    jlong nativeObserver<span class="token punctuation">,</span>
    jobject sslCertificateVerifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_PeerConnectionFactory_CreatePeerConnection</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> factory<span class="token punctuation">,</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> rtcConfig<span class="token punctuation">)</span><span class="token punctuation">,</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> constraints<span class="token punctuation">)</span><span class="token punctuation">,</span> nativeObserver<span class="token punctuation">,</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> sslCertificateVerifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection_factory.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_PeerConnectionFactory_CreatePeerConnection</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    jlong factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_rtc_config<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_constraints<span class="token punctuation">,</span> <span class="token comment">/* null */</span>
    jlong observer_p<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_sslCertificateVerifier <span class="token comment">/* null */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* PeerConnectionObserver */</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>PeerConnectionObserver<span class="token operator">&gt;</span> <span class="token function">observer</span><span class="token punctuation">(</span>
        <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>PeerConnectionObserver<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>observer_p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// RTCConfiguration &#x62F7;&#x8D1D;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// rtc::RTCCertificate &#x751F;&#x6210;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// MediaConstraints &#x62F7;&#x8D1D;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    PeerConnectionDependencies <span class="token function">peer_connection_dependencies</span><span class="token punctuation">(</span>observer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// SSLCertificateVerifierWrapper &#x521B;&#x5EFA;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnection&#xFF0C;&#x8BE5;&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x4E0E;&#x5404;&#x5E73;&#x53F0;&#x4E00;&#x81F4; */</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>PeerConnectionInterface<span class="token operator">&gt;</span> pc <span class="token operator">=</span>
        <span class="token function">PeerConnectionFactoryFromJava</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">CreatePeerConnection</span><span class="token punctuation">(</span>
            rtc_config<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>peer_connection_dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pc<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8FD4;&#x56DE; PeerConnection &#x5C01;&#x88C5;&#x5BF9;&#x8C61; */</span>
    <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token function">OwnedPeerConnection</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>constraints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// pc/peer_connection_factory.cc</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>PeerConnectionInterface<span class="token operator">&gt;</span>
<span class="token class-name">PeerConnectionFactory</span><span class="token operator">::</span><span class="token function">CreatePeerConnection</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> PeerConnectionInterface<span class="token operator">::</span>RTCConfiguration<span class="token operator">&amp;</span> configuration<span class="token punctuation">,</span>
    PeerConnectionDependencies dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// &#x521B;&#x5EFA; PeerConnection</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>PeerConnection<span class="token operator">&gt;</span> <span class="token function">pc</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>PeerConnection<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>event_log<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ActionsBeforeInitializeForTesting</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// PeerConnection &#x521D;&#x59CB;&#x5316;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pc<span class="token operator">-&gt;</span><span class="token function">Initialize</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">PeerConnectionProxy</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="13-%E5%88%9B%E5%BB%BA-videotrack">1.3 &#x521B;&#x5EFA; VideoTrack</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token keyword">private</span> <span class="token class-name">VideoTrack</span> <span class="token function">createVideoTrack</span><span class="token punctuation">(</span><span class="token class-name">VideoCapturer</span> capturer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x89C6;&#x9891;&#x6E90;&#x7EB9;&#x7406;&#x6570;&#x636E;&#x6E32;&#x67D3;&#x5B9E;&#x4F8B;&#xFF0C;&#x7ECF;&#x8FC7;&#x8BE5;&#x5B9E;&#x4F8B;&#x7EB9;&#x7406;&#x5904;&#x7406;&#x540E;&#x7684;&#x6570;&#x636E;&#x901A;&#x8FC7; CapturerObserver &#x56DE;&#x8C03;&#x51FA;&#x6765;&#x7528;&#x4E8E;&#x7F16;&#x7801;&#x6216;&#x9884;&#x89C8;(Camera2)</span>
    surfaceTextureHelper <span class="token operator">=</span>
        <span class="token class-name">SurfaceTextureHelper</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;CaptureThread&quot;</span><span class="token punctuation">,</span> rootEglBase<span class="token punctuation">.</span><span class="token function">getEglBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// &#x521B;&#x5EFA; VideoSource</span>
    videoSource <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createVideoSource</span><span class="token punctuation">(</span>capturer<span class="token punctuation">.</span><span class="token function">isScreencast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521D;&#x59CB;&#x5316;&#x53CA;&#x542F;&#x52A8;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#xFF0C;&#x6444;&#x50CF;&#x5934;&#x7684;&#x8BDD;&#xFF0C;&#x8C03;&#x7528; CameraCapturer.initialize() &#x63A5;&#x53E3;&#x521D;&#x59CB;&#x5316;&#xFF0C;CapturerObserver &#x4E3A; VideoSource &#x521B;&#x5EFA;</span>
    capturer<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>surfaceTextureHelper<span class="token punctuation">,</span> appContext<span class="token punctuation">,</span> videoSource<span class="token punctuation">.</span><span class="token function">getCapturerObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    capturer<span class="token punctuation">.</span><span class="token function">startCapture</span><span class="token punctuation">(</span>videoWidth<span class="token punctuation">,</span> videoHeight<span class="token punctuation">,</span> videoFps<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; VideoTrack</span>
    localVideoTrack <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createVideoTrack</span><span class="token punctuation">(</span>VIDEO_TRACK_ID<span class="token punctuation">,</span> videoSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x4F7F;&#x80FD;&#x89C6;&#x9891;</span>
    localVideoTrack<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span>renderVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x8BBE;&#x7F6E;&#x9884;&#x89C8; Sink</span>
    localVideoTrack<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>localRender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> localVideoTrack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/SurfaceTextureHelper.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SurfaceTextureHelper</span> <span class="token function">create</span><span class="token punctuation">(</span>
      <span class="token keyword">final</span> <span class="token class-name">String</span> threadName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">EglBase<span class="token punctuation">.</span>Context</span> sharedContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>threadName<span class="token punctuation">,</span> sharedContext<span class="token punctuation">,</span> <span class="token comment">/* alignTimestamps= */</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">YuvConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*frameRefMonitor=*/</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">SurfaceTextureHelper</span><span class="token punctuation">(</span><span class="token class-name">Context</span> sharedContext<span class="token punctuation">,</span> <span class="token class-name">Handler</span> handler<span class="token punctuation">,</span> <span class="token keyword">boolean</span> alignTimestamps<span class="token punctuation">,</span>
      <span class="token class-name">YuvConverter</span> yuvConverter<span class="token punctuation">,</span> <span class="token class-name">FrameRefMonitor</span> frameRefMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;SurfaceTextureHelper must be created on the handler thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timestampAligner <span class="token operator">=</span> alignTimestamps <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">TimestampAligner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>yuvConverter <span class="token operator">=</span> yuvConverter<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>frameRefMonitor <span class="token operator">=</span> frameRefMonitor<span class="token punctuation">;</span>

    eglBase <span class="token operator">=</span> <span class="token class-name">EglBase</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sharedContext<span class="token punctuation">,</span> <span class="token class-name">EglBase</span><span class="token punctuation">.</span>CONFIG_PIXEL_BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Both these statements have been observed to fail on rare occasions, see BUG=webrtc:5682.</span>
        eglBase<span class="token punctuation">.</span><span class="token function">createDummyPbufferSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eglBase<span class="token punctuation">.</span><span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Clean up before rethrowing the exception.</span>
        eglBase<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    oesTextureId <span class="token operator">=</span> <span class="token class-name">GlUtil</span><span class="token punctuation">.</span><span class="token function">generateTexture</span><span class="token punctuation">(</span><span class="token class-name">GLES11Ext</span><span class="token punctuation">.</span>GL_TEXTURE_EXTERNAL_OES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    surfaceTexture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SurfaceTexture</span><span class="token punctuation">(</span>oesTextureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setOnFrameAvailableListener</span><span class="token punctuation">(</span>surfaceTexture<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">SurfaceTexture</span> st<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        hasPendingTexture <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">tryDeliverTextureFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="2-%E9%9F%B3%E9%A2%91%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9D%97audiodevicemodule">2 &#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757;(AudioDeviceModule)</h2>

<p>&#x5916;&#x90E8;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x4EC5;&#x652F;&#x6301; java &#x5C42;&#x7EA7;&#xFF0C;&#x4E0D;&#x652F;&#x6301; OpenSLES. &#x501F;&#x7531; JavaAudioDeviceModule &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x548C;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x5B9E;&#x4F8B;&#xFF0C;&#x5E76;&#x901A;&#x8FC7; Jni &#x521B;&#x5EFA; native C++ &#x5C42; AudioDeviceModule &#x5BF9;&#x8C61;&#x3002;</p>
<h3 class="mume-header" id="21-%E5%88%9B%E5%BB%BA-javaaudiodevicemodule">2.1 &#x521B;&#x5EFA; JavaAudioDeviceModule</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token class-name">AudioDeviceModule</span> <span class="token function">createJavaAudioDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x91C7;&#x6837;&#x9891;&#x7387;&#x5728; Builder &#x6784;&#x9020;&#x65F6;&#x4ECE; WebRtcAudioManager &#x83B7;&#x53D6;&#x8BBE;&#x7F6E; */</span>
    <span class="token keyword">return</span> <span class="token class-name">JavaAudioDeviceModule</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span>
        <span class="token comment">/* &#x97F3;&#x9891;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x56DE;&#x8C03;&#xFF0C;&#x7528;&#x4E8E;&#x4FDD;&#x5B58;&#x5230;&#x6587;&#x4EF6; */</span>
        <span class="token punctuation">.</span><span class="token function">setSamplesReadyCallback</span><span class="token punctuation">(</span>saveRecordedAudioToFile<span class="token punctuation">)</span>
        <span class="token comment">/* &#x662F;&#x5426;&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x56DE;&#x58F0;&#x6D88;&#x9664;&#xFF0C;&#x9700;&#x8BBE;&#x5907;&#x652F;&#x6301; */</span>
        <span class="token punctuation">.</span><span class="token function">setUseHardwareAcousticEchoCanceler</span><span class="token punctuation">(</span><span class="token operator">!</span>peerConnectionParameters<span class="token punctuation">.</span>disableBuiltInAEC<span class="token punctuation">)</span>
        <span class="token comment">/* &#x662F;&#x5426;&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x566A;&#x58F0;&#x6291;&#x5236;&#xFF0C;&#x9700;&#x8BBE;&#x5907;&#x652F;&#x6301; */</span>
        <span class="token punctuation">.</span><span class="token function">setUseHardwareNoiseSuppressor</span><span class="token punctuation">(</span><span class="token operator">!</span>peerConnectionParameters<span class="token punctuation">.</span>disableBuiltInNS<span class="token punctuation">)</span>
        <span class="token comment">/* &#x8BBE;&#x7F6E;&#x9519;&#x8BEF;&#x56DE;&#x8C03;&#x53CA;&#x72B6;&#x6001;&#x56DE;&#x8C03; */</span>
        <span class="token punctuation">.</span><span class="token function">setAudioRecordErrorCallback</span><span class="token punctuation">(</span>audioRecordErrorCallback<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAudioTrackErrorCallback</span><span class="token punctuation">(</span>audioTrackErrorCallback<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAudioRecordStateCallback</span><span class="token punctuation">(</span>audioRecordStateCallback<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAudioTrackStateCallback</span><span class="token punctuation">(</span>audioTrackStateCallback<span class="token punctuation">)</span>
        <span class="token comment">/* &#x6784;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757; */</span>
        <span class="token punctuation">.</span><span class="token function">createAudioDeviceModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/JavaAudioDeviceModule.java</span>
<span class="token comment">// JavaAudioDeviceModule.Builder</span>
<span class="token keyword">public</span> <span class="token class-name">AudioDeviceModule</span> <span class="token function">createAudioDeviceModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x5B9E;&#x4F8B; sdk/android/src/java/org/webrtc/audio/WebRtcAudioRecord.java */</span>
    <span class="token keyword">final</span> <span class="token class-name">WebRtcAudioRecord</span> audioInput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebRtcAudioRecord</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioSource<span class="token punctuation">,</span>
        audioFormat<span class="token punctuation">,</span> audioRecordErrorCallback<span class="token punctuation">,</span> audioRecordStateCallback<span class="token punctuation">,</span> samplesReadyCallback<span class="token punctuation">,</span>
        useHardwareAcousticEchoCanceler<span class="token punctuation">,</span> useHardwareNoiseSuppressor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x5B9E;&#x4F8B; sdk/android/src/java/org/webrtc/audio/WebRtcAudioTrack.java */</span>
    <span class="token keyword">final</span> <span class="token class-name">WebRtcAudioTrack</span> audioOutput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebRtcAudioTrack</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioTrackErrorCallback<span class="token punctuation">,</span> audioTrackStateCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757; */</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JavaAudioDeviceModule</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioInput<span class="token punctuation">,</span> audioOutput<span class="token punctuation">,</span>
        inputSampleRate<span class="token punctuation">,</span> outputSampleRate<span class="token punctuation">,</span> useStereoInput<span class="token punctuation">,</span> useStereoOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// JavaAudioDeviceModule &#x662F; AudioDeviceModule &#x63A5;&#x53E3;&#x7684;&#x6D3E;&#x751F;&#x7C7B;</span>
<span class="token keyword">private</span> <span class="token class-name">JavaAudioDeviceModule</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">AudioManager</span> audioManager<span class="token punctuation">,</span>
      <span class="token class-name">WebRtcAudioRecord</span> audioInput<span class="token punctuation">,</span> <span class="token class-name">WebRtcAudioTrack</span> audioOutput<span class="token punctuation">,</span> <span class="token keyword">int</span> inputSampleRate<span class="token punctuation">,</span>
      <span class="token keyword">int</span> outputSampleRate<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useStereoInput<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useStereoOutput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioManager <span class="token operator">=</span> audioManager<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioInput <span class="token operator">=</span> audioInput<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioOutput <span class="token operator">=</span> audioOutput<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inputSampleRate <span class="token operator">=</span> inputSampleRate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outputSampleRate <span class="token operator">=</span> outputSampleRate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>useStereoInput <span class="token operator">=</span> useStereoInput<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>useStereoOutput <span class="token operator">=</span> useStereoOutput<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907; Native &#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x521B;&#x5EFA; PeerConnectionFactory &#x65F6;&#x8C03;&#x7528; */</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getNativeAudioDeviceModulePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>nativeLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeAudioDeviceModule <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nativeAudioDeviceModule <span class="token operator">=</span> <span class="token function">nativeCreateAudioDeviceModule</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioInput<span class="token punctuation">,</span>
                audioOutput<span class="token punctuation">,</span> inputSampleRate<span class="token punctuation">,</span> outputSampleRate<span class="token punctuation">,</span> useStereoInput<span class="token punctuation">,</span> useStereoOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> nativeAudioDeviceModule<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="22-%E5%88%9B%E5%BB%BA-native-%E5%B1%82-audiodevicemodule">2.2 &#x521B;&#x5EFA; Native &#x5C42; AudioDeviceModule</h3>

<p>&#x901A;&#x8FC7;JNI &#x8C03;&#x7528;&#x521B;&#x5EFA; AudioDeviceModule</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_java_audio_jni/JavaAudioDeviceModule_jni.h</span>
<span class="token comment">// &#x6B64;&#x6587;&#x4EF6;&#x4E3A;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;&#x4E2D;&#x52A8;&#x6001;&#x751F;&#x6210;</span>
JNI_GENERATOR_EXPORT jlong
    <span class="token function">Java_org_webrtc_audio_JavaAudioDeviceModule_nativeCreateAudioDeviceModule</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jobject context<span class="token punctuation">,</span>
    jobject audioManager<span class="token punctuation">,</span>
    jobject audioInput<span class="token punctuation">,</span>
    jobject audioOutput<span class="token punctuation">,</span>
    jint inputSampleRate<span class="token punctuation">,</span>
    jint outputSampleRate<span class="token punctuation">,</span>
    jboolean useStereoInput<span class="token punctuation">,</span>
    jboolean useStereoOutput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_JavaAudioDeviceModule_CreateAudioDeviceModule</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
        <span class="token comment">/* Java &#x5C42; Context &#x5F15;&#x7528; */</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token comment">/* Java &#x5C42; AudioManager &#x5F15;&#x7528;*/</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audioManager<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token comment">/* Java &#x5C42; WebRtcAudioRecord &#x5F15;&#x7528; */</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audioInput<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* Java &#x5C42; WebRtcAudioTrack &#x5F15;&#x7528; */</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audioOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        inputSampleRate<span class="token punctuation">,</span> outputSampleRate<span class="token punctuation">,</span>
        useStereoInput<span class="token punctuation">,</span> useStereoOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/audio_device/java_audio_device_module.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_JavaAudioDeviceModule_CreateAudioDeviceModule</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_audio_manager<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_webrtc_audio_record<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_webrtc_audio_track<span class="token punctuation">,</span>
    <span class="token keyword">int</span> input_sample_rate<span class="token punctuation">,</span>
    <span class="token keyword">int</span> output_sample_rate<span class="token punctuation">,</span>
    jboolean j_use_stereo_input<span class="token punctuation">,</span>
    jboolean j_use_stereo_output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AudioParameters input_parameters<span class="token punctuation">;</span>
    AudioParameters output_parameters<span class="token punctuation">;</span>
    <span class="token comment">/* &#x901A;&#x8FC7; AudioManager &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x53CA;&#x64AD;&#x653E;&#x7684;&#x76F8;&#x5173;&#x53C2;&#x6570; */</span>
    <span class="token function">GetAudioParameters</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_context<span class="token punctuation">,</span> j_audio_manager<span class="token punctuation">,</span> input_sample_rate<span class="token punctuation">,</span>
                        output_sample_rate<span class="token punctuation">,</span> j_use_stereo_input<span class="token punctuation">,</span>
                        j_use_stereo_output<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_parameters<span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>output_parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x91C7;&#x96C6; AudioRecordJni &#x5BF9;&#x8C61; */</span>
    <span class="token keyword">auto</span> audio_input <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>AudioRecordJni<span class="token operator">&gt;</span><span class="token punctuation">(</span>
        env<span class="token punctuation">,</span> input_parameters<span class="token punctuation">,</span> kHighLatencyModeDelayEstimateInMilliseconds<span class="token punctuation">,</span>
        j_webrtc_audio_record<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x64AD;&#x653E; AudioTrackJni &#x5BF9;&#x8C61; */</span>
    <span class="token keyword">auto</span> audio_output <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>AudioTrackJni<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> output_parameters<span class="token punctuation">,</span>
                                                        j_webrtc_audio_track<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token function">CreateAudioDeviceModuleFromInputAndOutput</span><span class="token punctuation">(</span>
                                <span class="token comment">// AudioDeviceModule::AudioLayer</span>
                                AudioDeviceModule<span class="token operator">::</span>kAndroidJavaAudio<span class="token punctuation">,</span>
                                <span class="token comment">// &#x662F;&#x5426;&#x53CC;&#x58F0;&#x9053;</span>
                                j_use_stereo_input<span class="token punctuation">,</span> j_use_stereo_output<span class="token punctuation">,</span>
                                <span class="token comment">// &#x64AD;&#x653E;&#x5EF6;&#x65F6;&#x4F30;&#x8BA1;&#xFF0C;150ms</span>
                                kHighLatencyModeDelayEstimateInMilliseconds<span class="token punctuation">,</span>
                                <span class="token comment">// &#x97F3;&#x9891;&#x91C7;&#x96C6;&#x53CA;&#x64AD;&#x653E;&#x5BF9;&#x8C61;</span>
                                std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_input<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_output<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/audio_device/audio_device_module.cc</span>
<span class="token comment">// &#x521B;&#x5EFA; AudioDeviceModule(modules/audio_device/include/audio_device.h)&#xFF0C;</span>
<span class="token comment">// AndroidAudioDeviceModule &#x7EE7;&#x627F;&#x4E8E;&#x8BE5;&#x7C7B;.</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioDeviceModule<span class="token operator">&gt;</span> <span class="token function">CreateAudioDeviceModuleFromInputAndOutput</span><span class="token punctuation">(</span>
    AudioDeviceModule<span class="token operator">::</span>AudioLayer audio_layer<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> is_stereo_playout_supported<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> is_stereo_record_supported<span class="token punctuation">,</span>
    <span class="token keyword">uint16_t</span> playout_delay_ms<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioInput<span class="token operator">&gt;</span> audio_input<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioOutput<span class="token operator">&gt;</span> audio_output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> __FUNCTION__<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>AndroidAudioDeviceModule<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      audio_layer<span class="token punctuation">,</span> is_stereo_playout_supported<span class="token punctuation">,</span> is_stereo_record_supported<span class="token punctuation">,</span>
      playout_delay_ms<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_input<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">AndroidAudioDeviceModule</span><span class="token punctuation">(</span>AudioDeviceModule<span class="token operator">::</span>AudioLayer audio_layer<span class="token punctuation">,</span>
                           <span class="token keyword">bool</span> is_stereo_playout_supported<span class="token punctuation">,</span>
                           <span class="token keyword">bool</span> is_stereo_record_supported<span class="token punctuation">,</span>
                           <span class="token keyword">uint16_t</span> playout_delay_ms<span class="token punctuation">,</span>
                           std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioInput<span class="token operator">&gt;</span> audio_input<span class="token punctuation">,</span>
                           std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioOutput<span class="token operator">&gt;</span> audio_output<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">audio_layer_</span><span class="token punctuation">(</span>audio_layer<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">is_stereo_playout_supported_</span><span class="token punctuation">(</span>is_stereo_playout_supported<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">is_stereo_record_supported_</span><span class="token punctuation">(</span>is_stereo_record_supported<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">playout_delay_ms_</span><span class="token punctuation">(</span>playout_delay_ms<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">task_queue_factory_</span><span class="token punctuation">(</span><span class="token function">CreateDefaultTaskQueueFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">input_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">output_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">initialized_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>input_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>output_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> __FUNCTION__<span class="token punctuation">;</span>
    thread_checker_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="23-native-%E8%8E%B7%E5%8F%96%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86%E6%92%AD%E6%94%BE%E5%8F%82%E6%95%B0">2.3 Native &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x64AD;&#x653E;&#x53C2;&#x6570;</h3>

<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// sdk/android/src/jni/audio_device/audio_device_module.cc</span>
<span class="token keyword">void</span> <span class="token function">GetAudioParameters</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_context<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_audio_manager<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> input_sample_rate<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> output_sample_rate<span class="token punctuation">,</span>
                        <span class="token keyword">bool</span> use_stereo_input<span class="token punctuation">,</span>
                        <span class="token keyword">bool</span> use_stereo_output<span class="token punctuation">,</span>
                        AudioParameters<span class="token operator">*</span> input_parameters<span class="token punctuation">,</span>
                        AudioParameters<span class="token operator">*</span> output_parameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> output_channels <span class="token operator">=</span> use_stereo_output <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> input_channels <span class="token operator">=</span> use_stereo_input <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t output_buffer_size <span class="token operator">=</span> <span class="token function">Java_WebRtcAudioManager_getOutputBufferSize</span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span> j_context<span class="token punctuation">,</span> j_audio_manager<span class="token punctuation">,</span> output_sample_rate<span class="token punctuation">,</span> output_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t input_buffer_size <span class="token operator">=</span> <span class="token function">Java_WebRtcAudioManager_getInputBufferSize</span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span> j_context<span class="token punctuation">,</span> j_audio_manager<span class="token punctuation">,</span> input_sample_rate<span class="token punctuation">,</span> input_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
  output_parameters<span class="token operator">-&gt;</span><span class="token function">reset</span><span class="token punctuation">(</span>output_sample_rate<span class="token punctuation">,</span>
                           <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>output_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>output_buffer_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  input_parameters<span class="token operator">-&gt;</span><span class="token function">reset</span><span class="token punctuation">(</span>input_sample_rate<span class="token punctuation">,</span>
                          <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>input_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>input_buffer_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>input_parameters<span class="token operator">-&gt;</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>output_parameters<span class="token operator">-&gt;</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_audio_device_module_base_jni/WebRTCAudioManager_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; sdk/android/src/java/org/webrt/audio/WebRtcAudioManager.java &#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;</span>
<span class="token comment">// &#x83B7;&#x53D6; AudioTrack &#x7684; getMinBufferSize</span>
<span class="token keyword">static</span> jint <span class="token function">Java_WebRtcAudioManager_getOutputBufferSize</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> audioManager<span class="token punctuation">,</span>
    JniIntWrapper sampleRate<span class="token punctuation">,</span>
    JniIntWrapper numberOfOutputChannels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_STATIC<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;getOutputBufferSize&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(Landroid/content/Context;Landroid/media/AudioManager;II)I&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioManager_getOutputBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; sdk/android/src/java/org/webrt/audio/WebRtcAudioManager.java &#x7684; getOutputBufferSize() &#x65B9;&#x6CD5; */</span>
    jint ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">CallStaticIntMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> audioManager<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">as_jint</span><span class="token punctuation">(</span>sampleRate<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">as_jint</span><span class="token punctuation">(</span>numberOfOutputChannels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x83B7;&#x53D6; AudioRecord &#x7684; getMinBufferSize</span>
<span class="token keyword">static</span> jint <span class="token function">Java_WebRtcAudioManager_getInputBufferSize</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> audioManager<span class="token punctuation">,</span>
    JniIntWrapper sampleRate<span class="token punctuation">,</span>
    JniIntWrapper numberOfInputChannels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_STATIC<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;getInputBufferSize&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(Landroid/content/Context;Landroid/media/AudioManager;II)I&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioManager_getInputBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; sdk/android/src/java/org/webrt/audio/WebRtcAudioManager.java &#x7684; getInputBufferSize() &#x65B9;&#x6CD5; */</span>
    jint ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">CallStaticIntMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> audioManager<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">as_jint</span><span class="token punctuation">(</span>sampleRate<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">as_jint</span><span class="token punctuation">(</span>numberOfInputChannels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="24-%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86-audiorecordjni">2.4 &#x97F3;&#x9891;&#x91C7;&#x96C6; AudioRecordJni</h3>

<p>Native &#x5C42;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x6784;&#x5EFA;&#x65F6;&#x7ED1;&#x5B9A; Java &#x5C42;&#x7684; WebRtcAudioRecord &#x5B9E;&#x4F8B;&#xFF0C;&#x4EE5;&#x5B9E;&#x73B0;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x542F;&#x52A8;&#x53CA;&#x8BFB;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x7F16;&#x7801;&#x53D1;&#x9001;&#x3002;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token class-name">AudioRecordJni</span><span class="token operator">::</span><span class="token function">AudioRecordJni</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                               <span class="token keyword">const</span> AudioParameters<span class="token operator">&amp;</span> audio_parameters<span class="token punctuation">,</span>
                               <span class="token keyword">int</span> total_delay_ms<span class="token punctuation">,</span>
                               <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_audio_record<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">j_audio_record_</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_audio_record<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &#x4FDD;&#x5B58; Java &#x5C42;&#x97F3;&#x9891;&#x91C7;&#x96C6; WebRtcAudioRecord &#x5B9E;&#x4F8B;&#x5F15;&#x7528;</span>
      <span class="token function">audio_parameters_</span><span class="token punctuation">(</span>audio_parameters<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">total_delay_ms_</span><span class="token punctuation">(</span>total_delay_ms<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_address_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_capacity_in_bytes_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">frames_per_buffer_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">initialized_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">recording_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">audio_device_buffer_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;ctor&quot;</span><span class="token punctuation">;</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>audio_parameters_<span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; Java&#x5C42;WebRtcAudioRecord&#x7684;setNativeAudioRecord &#x65B9;&#x6CD5;&#x8BBE;&#x7F6E; Native &#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x542F;&#x52A8;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x548C;&#x5C06;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x56DE;&#x8C03;C++&#x65F6;&#x4F7F;&#x7528; */</span>
    <span class="token function">Java_WebRtcAudioRecord_setNativeAudioRecord</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_audio_record_<span class="token punctuation">,</span>
                                                jni<span class="token operator">::</span><span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Detach from this thread since construction is allowed to happen on a</span>
    <span class="token comment">// different thread.</span>
    thread_checker_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread_checker_java_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_java_audio_device_module_native_jni/WebRtcAudioRecord_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; org/webrtc/audio/WebRtcAudioRecord.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Java_WebRtcAudioRecord_setNativeAudioRecord</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> obj<span class="token punctuation">,</span> jlong nativeAudioRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioRecord_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">org_webrtc_audio_WebRtcAudioRecord_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
  call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          env<span class="token punctuation">,</span>
          clazz<span class="token punctuation">,</span>
          <span class="token string">&quot;setNativeAudioRecord&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
          <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioRecord_setNativeAudioRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

     env<span class="token operator">-&gt;</span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeAudioRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Java &#x5C42;&#x8C03;&#x7528;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/src/java/org/webrtc/audio/WebRtcAudioRecord.java</span>
<span class="token annotation punctuation">@CalledByNative</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNativeAudioRecord</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeAudioRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAudioRecord <span class="token operator">=</span> nativeAudioRecord<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="25-%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE-audiotrackjni">2.5 &#x97F3;&#x9891;&#x64AD;&#x653E; AudioTrackJni</h3>

<p>Native &#x5C42;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x6784;&#x5EFA;&#x65F6;&#x7ED1;&#x5B9A;&#x5230; Java &#x5C42;&#x7684; WebRtcAudioTrack &#x5B9E;&#x4F8B;&#xFF0C;&#x5B9E;&#x73B0;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x521D;&#x59CB;&#x5316;&#x53CA;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x3002;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token class-name">AudioTrackJni</span><span class="token operator">::</span><span class="token function">AudioTrackJni</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> AudioParameters<span class="token operator">&amp;</span> audio_parameters<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_webrtc_audio_track<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">j_audio_track_</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_webrtc_audio_track<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &#x4FDD;&#x5B58; Java &#x5C42;&#x97F3;&#x9891;&#x91C7;&#x96C6; WebRtcAudioTrack &#x5B9E;&#x4F8B;&#x5F15;&#x7528;</span>
      <span class="token function">audio_parameters_</span><span class="token punctuation">(</span>audio_parameters<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_address_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_capacity_in_bytes_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">frames_per_buffer_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">initialized_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">playing_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">audio_device_buffer_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;ctor&quot;</span><span class="token punctuation">;</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>audio_parameters_<span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; Java&#x5C42; WebRtcAudioTrack &#x7684; setNativeAudioTrac &#x65B9;&#x6CD5;&#x8BBE;&#x7F6E; Native &#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x542F;&#x52A8;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x548C;&#x4ECE;C++&#x5C42;&#x83B7;&#x53D6;&#x64AD;&#x653E;&#x6570;&#x636E;&#x65F6;&#x4F7F;&#x7528; */</span>
    <span class="token function">Java_WebRtcAudioTrack_setNativeAudioTrack</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_audio_track_<span class="token punctuation">,</span>
                                                jni<span class="token operator">::</span><span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Detach from this thread since construction is allowed to happen on a</span>
    <span class="token comment">// different thread.</span>
    thread_checker_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread_checker_java_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_java_audio_device_module_native_jni/WebRtcAudioTrack_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; org/webrtc/audio/WebRtcAudioTrack.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Java_WebRtcAudioTrack_setNativeAudioTrack</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> obj<span class="token punctuation">,</span> jlong nativeAudioTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioTrack_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">org_webrtc_audio_WebRtcAudioTrack_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
  call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          env<span class="token punctuation">,</span>
          clazz<span class="token punctuation">,</span>
          <span class="token string">&quot;setNativeAudioTrack&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
          <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioTrack_setNativeAudioTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>

     env<span class="token operator">-&gt;</span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeAudioTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Java &#x5C42;&#x8C03;&#x7528;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/src/java/org/webrtc/audio/WebRtcAudioTrack.java</span>
<span class="token annotation punctuation">@CalledByNative</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNativeAudioTrack</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeAudioTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAudioTrack <span class="token operator">=</span> nativeAudioTrack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="3-%E8%A7%86%E9%A2%91%E5%9B%BE%E5%83%8F%E9%87%87%E9%9B%86%E6%A8%A1%E5%9D%97videocapturer">3 &#x89C6;&#x9891;&#x56FE;&#x50CF;&#x91C7;&#x96C6;&#x6A21;&#x5757;(VideoCapturer)</h2>

<p>&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90;&#x5206;&#x4E3A;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#xFF0C;&#x5C4F;&#x5E55;&#x5171;&#x4EAB;&#x53CA;&#x6444;&#x50CF;&#x5934;&#xFF0C;&#x8FD9;&#x51E0;&#x7C7B;&#x89C6;&#x9891;&#x6E90;&#x7EDF;&#x4E00;&#x7EE7;&#x627F;&#x4E86; VideoCapturer &#x7C7B;&#x3002;&#x5176;&#x4E2D;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#x6E90;&#x7684;&#x901A;&#x8FC7; CameraEnumerator&#x3001;CameraSession&#x3001;CameraCapturer &#x8FDE;&#x63A5;&#x4E0D;&#x540C; Camera API&#xFF0C; &#x5176;&#x4E2D; Camera1Enumerator&#x3001;Camera1Session&#xFF0C; Camera1Capturer &#x8FDE;&#x63A5; Camera V1 Api(&#x5373;Android 5&#x4E4B;&#x524D;&#x7684;&#x6444;&#x50CF;&#x5934;&#x63A5;&#x53E3;) &#xFF1B;&#x800C; Camera2Enumerator&#x3001;Camera2Session&#xFF0C; Camera2Capturer &#x8FDE;&#x63A5; Camera V2 &#x63A5;&#x53E3;&#x3002;&#x8FD9;&#x4E24;&#x5957;&#x63A5;&#x53E3;&#x5C01;&#x88C5;&#x4E86;&#x65B0;&#x65E7; Camera Api&#x7684;&#x5DEE;&#x5F02;&#x6027;&#xFF0C;&#x4F7F;&#x5916;&#x90E8;&#x8C03;&#x7528;&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#x3002;</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="1025px" preserveAspectRatio="none" style="width:2613px;height:1025px;" version="1.1" viewBox="0 0 2613 1025" width="2613px" zoomAndPan="magnify"><defs><filter height="300%" id="f1nnqmvf33jkaz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[6a70cc93280952e553d5079bb37818cf]
cluster CameraSession--><polygon fill="#FFFFFF" filter="url(#f1nnqmvf33jkaz)" points="1804,635,1919,635,1926,657.4883,2596,657.4883,2596,839,1804,839,1804,635" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="1804" x2="1926" y1="657.4883" y2="657.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="1808" y="650.5352">CameraSession</text><!--MD5=[e5ab114b80e753b114854575653dd8f1]
class CameraSession.CreateSessionCallback--><rect codeline="117" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="CameraSession.CreateSessionCallback" style="stroke:#A80036;stroke-width:1.5;" width="304" x="2268" y="709.5"/><ellipse cx="2351.25" cy="725.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2347.6777,721.7651 L2347.6777,719.6069 L2355.0571,719.6069 L2355.0571,721.7651 L2352.5918,721.7651 L2352.5918,729.8418 L2355.0571,729.8418 L2355.0571,732 L2347.6777,732 L2347.6777,729.8418 L2350.1431,729.8418 L2350.1431,721.7651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="129" x="2371.75" y="730.0352">CreateSessionCallback</text><line style="stroke:#A80036;stroke-width:1.5;" x1="2269" x2="2571" y1="741.5" y2="741.5"/><ellipse cx="2279" cy="752.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="202" x="2288" y="756.1348">void onDone(CameraSession session)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="2269" x2="2571" y1="762.4551" y2="762.4551"/><ellipse cx="2279" cy="773.4551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="278" x="2288" y="777.0898">void onFailure(FailureType failureType, String error)</text><!--MD5=[3636f3d29bbd8a3b807fc9bf24b084e1]
class CameraSession.Events--><rect codeline="123" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="136.7754" id="CameraSession.Events" style="stroke:#A80036;stroke-width:1.5;" width="386" x="1847" y="678"/><ellipse cx="2017.25" cy="694" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2013.6777,690.2651 L2013.6777,688.1069 L2021.0571,688.1069 L2021.0571,690.2651 L2018.5918,690.2651 L2018.5918,698.3418 L2021.0571,698.3418 L2021.0571,700.5 L2013.6777,700.5 L2013.6777,698.3418 L2016.1431,698.3418 L2016.1431,690.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="37" x="2037.75" y="698.5352">Events</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1848" x2="2232" y1="710" y2="710"/><ellipse cx="1858" cy="721" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="135" x="1867" y="724.6348">void onCameraOpening()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1848" x2="2232" y1="730.9551" y2="730.9551"/><ellipse cx="1858" cy="741.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="312" x="1867" y="745.5898">void onCameraError(CameraSession session, String error)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1848" x2="2232" y1="751.9102" y2="751.9102"/><ellipse cx="1858" cy="762.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="288" x="1867" y="766.5449">void onCameraDisconnected(CameraSession session)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1848" x2="2232" y1="772.8652" y2="772.8652"/><ellipse cx="1858" cy="783.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="252" x="1867" y="787.5">void onCameraClosed(CameraSession session)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1848" x2="2232" y1="793.8203" y2="793.8203"/><ellipse cx="1858" cy="804.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="360" x="1867" y="808.4551">void onFrameCaptured(CameraSession session, VideoFrame frame)</text><!--MD5=[4c84326b91249774fba9d49891354c9b]
class CapturerObserver--><rect codeline="2" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="94.8652" id="CapturerObserver" style="stroke:#A80036;stroke-width:1.5;" width="254" x="7" y="699"/><ellipse cx="77.75" cy="715" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M74.1777,711.2651 L74.1777,709.1069 L81.5571,709.1069 L81.5571,711.2651 L79.0918,711.2651 L79.0918,719.3418 L81.5571,719.3418 L81.5571,721.5 L74.1777,721.5 L74.1777,719.3418 L76.6431,719.3418 L76.6431,711.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="104" x="98.25" y="719.5352">CapturerObserver</text><line style="stroke:#A80036;stroke-width:1.5;" x1="8" x2="260" y1="731" y2="731"/><ellipse cx="18" cy="742" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="223" x="27" y="745.6348">void onCapturerStarted(boolean success)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="260" y1="751.9551" y2="751.9551"/><ellipse cx="18" cy="762.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="140" x="27" y="766.5898">void onCapturerStopped()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="260" y1="772.9102" y2="772.9102"/><ellipse cx="18" cy="783.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="228" x="27" y="787.5449">void onFrameCaptured(VideoFrame frame)</text><!--MD5=[d1851ec3eb8f60324b913a0e219678d1]
class VideoCapturer--><rect codeline="10" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="157.7305" id="VideoCapturer" style="stroke:#A80036;stroke-width:1.5;" width="383" x="1322.5" y="7"/><ellipse cx="1467.75" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1464.1777,19.2651 L1464.1777,17.1069 L1471.5571,17.1069 L1471.5571,19.2651 L1469.0918,19.2651 L1469.0918,27.3418 L1471.5571,27.3418 L1471.5571,29.5 L1464.1777,29.5 L1464.1777,27.3418 L1466.6431,27.3418 L1466.6431,19.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="84" x="1488.25" y="27.5352">VideoCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1323.5" x2="1704.5" y1="39" y2="39"/><ellipse cx="1333.5" cy="50" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="357" x="1342.5" y="53.6348">void initialize(SurfaceTextureHelper , Context , CapturerObserver )</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="59.9551" y2="59.9551"/><ellipse cx="1333.5" cy="70.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="280" x="1342.5" y="74.5898">void startCapture(int width, int height, int framerate)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="80.9102" y2="80.9102"/><ellipse cx="1333.5" cy="91.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="101" x="1342.5" y="95.5449">void stopCapture()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="101.8652" y2="101.8652"/><ellipse cx="1333.5" cy="112.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="332" x="1342.5" y="116.5">void changeCaptureFormat(int width, int height, int framerate)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="122.8203" y2="122.8203"/><ellipse cx="1333.5" cy="133.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="76" x="1342.5" y="137.4551">void dispose()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1323.5" x2="1704.5" y1="143.7754" y2="143.7754"/><ellipse cx="1333.5" cy="154.7754" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="121" x="1342.5" y="158.4102">boolean isScreencast()</text><!--MD5=[e3b91f50f7e38913945d788d24b04423]
class CameraVideoCapturer--><rect codeline="24" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="CameraVideoCapturer" style="stroke:#A80036;stroke-width:1.5;" width="362" x="1033" y="225"/><ellipse cx="1145.25" cy="241" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1141.6777,237.2651 L1141.6777,235.1069 L1149.0571,235.1069 L1149.0571,237.2651 L1146.5918,237.2651 L1146.5918,245.3418 L1149.0571,245.3418 L1149.0571,247.5 L1141.6777,247.5 L1141.6777,245.3418 L1144.1431,245.3418 L1144.1431,237.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="129" x="1165.75" y="245.5352">CameraVideoCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1034" x2="1394" y1="257" y2="257"/><ellipse cx="1044" cy="268" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="229" x="1053" y="271.6348">void switchCamera(CameraSwitchHandler )</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1034" x2="1394" y1="277.9551" y2="277.9551"/><ellipse cx="1044" cy="288.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="336" x="1053" y="292.5898">void switchCamera(CameraSwitchHandler, String cameraName)</text><!--MD5=[d06c03ccfbdce18b1281f2fd6fb25f4d]
class CameraCapturer--><rect codeline="30" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="250.5059" id="CameraCapturer" style="stroke:#A80036;stroke-width:1.5;" width="354" x="1037" y="363"/><ellipse cx="1161.75" cy="379" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1161.8633,374.5981 L1160.7095,379.6699 L1163.0254,379.6699 Z M1160.3691,372.3569 L1163.3657,372.3569 L1166.7109,384.75 L1164.2622,384.75 L1163.4985,381.687 L1160.2197,381.687 L1159.4727,384.75 L1157.0239,384.75 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="96" x="1182.25" y="383.5352">CameraCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1038" x2="1390" y1="395" y2="395"/><polygon fill="#FFFF44" points="1048,401,1052,405,1048,409,1044,405" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="149" x="1057" y="409.6348">void createCameraSession()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="415.9551" y2="415.9551"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="423.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="209" x="1057" y="430.5898">void createSessionInternal(int delayMs)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="436.9102" y2="436.9102"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="444.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="150" x="1057" y="451.5449">void switchCameraInternal()</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="474.8203"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="209" x="1057" y="481.4551">CameraEnumerator cameraEnumerator</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1038" x2="1202.5" y1="464.3428" y2="464.3428"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="1202.5" y="468">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1225.5" x2="1390" y1="464.3428" y2="464.3428"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="487.7754" y2="487.7754"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="495.7754"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="328" x="1057" y="502.4102">CameraSession.CreateSessionCallback createSessionCallback</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="508.7305" y2="508.7305"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="516.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="280" x="1057" y="523.3652">CameraSession.Events cameraSessionEventsHandler</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="529.6855" y2="529.6855"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="537.6855"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="197" x="1057" y="544.3203">CapturerObserver capturerObserver</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="550.6406" y2="550.6406"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="558.6406"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="166" x="1057" y="565.2754">CameraSession currentSession</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="571.5957" y2="571.5957"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="579.5957"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="231" x="1057" y="586.2305">CameraSwitchHandler switchEventsHandler</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1038" x2="1390" y1="592.5508" y2="592.5508"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1045" y="600.5508"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="179" x="1057" y="607.1855">CameraStatistics cameraStatistics</text><!--MD5=[f29480f3f6be8cdc6b3952e942fd3cfa]
class CameraEnumerator--><rect codeline="135" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="136.7754" id="CameraEnumerator" style="stroke:#A80036;stroke-width:1.5;" width="585" x="296.5" y="678"/><ellipse cx="528.75" cy="694" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M525.1777,690.2651 L525.1777,688.1069 L532.5571,688.1069 L532.5571,690.2651 L530.0918,690.2651 L530.0918,698.3418 L532.5571,698.3418 L532.5571,700.5 L525.1777,700.5 L525.1777,698.3418 L527.6431,698.3418 L527.6431,690.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="112" x="549.25" y="698.5352">CameraEnumerator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="297.5" x2="880.5" y1="710" y2="710"/><ellipse cx="307.5" cy="721" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="139" x="316.5" y="724.6348">String[] getDeviceNames()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="730.9551" y2="730.9551"/><ellipse cx="307.5" cy="741.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="226" x="316.5" y="745.5898">boolean isFrontFacing(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="751.9102" y2="751.9102"/><ellipse cx="307.5" cy="762.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="221" x="316.5" y="766.5449">boolean isBackFacing(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="772.8652" y2="772.8652"/><ellipse cx="307.5" cy="783.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="345" x="316.5" y="787.5">List&lt;CaptureFormat&gt; getSupportedFormats(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="793.8203" y2="793.8203"/><ellipse cx="307.5" cy="804.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="559" x="316.5" y="808.4551">CameraVideoCapturer createCapturer(String deviceName, CameraVideoCapturer.CameraEventsHandler )</text><!--MD5=[aa426e197ea1e471f3259685cb0cadc0]
class ScreenCapturerAndroid--><rect codeline="57" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="48" id="ScreenCapturerAndroid" style="stroke:#A80036;stroke-width:1.5;" width="167" x="1430.5" y="238"/><ellipse cx="1445.5" cy="254" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1447.9731,260.1431 Q1447.3921,260.4419 1446.7529,260.5913 Q1446.1138,260.7407 1445.4082,260.7407 Q1442.9014,260.7407 1441.5815,259.0889 Q1440.2617,257.437 1440.2617,254.3159 Q1440.2617,251.1865 1441.5815,249.5347 Q1442.9014,247.8828 1445.4082,247.8828 Q1446.1138,247.8828 1446.7612,248.0322 Q1447.4087,248.1816 1447.9731,248.4805 L1447.9731,251.2031 Q1447.3423,250.6221 1446.7488,250.3523 Q1446.1553,250.0825 1445.5244,250.0825 Q1444.1797,250.0825 1443.4949,251.1492 Q1442.8101,252.2158 1442.8101,254.3159 Q1442.8101,256.4077 1443.4949,257.4744 Q1444.1797,258.541 1445.5244,258.541 Q1446.1553,258.541 1446.7488,258.2712 Q1447.3423,258.0015 1447.9731,257.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="135" x="1459.5" y="258.5352">ScreenCapturerAndroid</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1431.5" x2="1596.5" y1="270" y2="270"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1431.5" x2="1596.5" y1="278" y2="278"/><!--MD5=[1759e3376b35249d894d8171cd4e7b48]
class FileVideoCapturer--><rect codeline="61" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="48" id="FileVideoCapturer" style="stroke:#A80036;stroke-width:1.5;" width="135" x="1632.5" y="238"/><ellipse cx="1647.5" cy="254" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1649.9731,260.1431 Q1649.3921,260.4419 1648.7529,260.5913 Q1648.1138,260.7407 1647.4082,260.7407 Q1644.9014,260.7407 1643.5815,259.0889 Q1642.2617,257.437 1642.2617,254.3159 Q1642.2617,251.1865 1643.5815,249.5347 Q1644.9014,247.8828 1647.4082,247.8828 Q1648.1138,247.8828 1648.7612,248.0322 Q1649.4087,248.1816 1649.9731,248.4805 L1649.9731,251.2031 Q1649.3423,250.6221 1648.7488,250.3523 Q1648.1553,250.0825 1647.5244,250.0825 Q1646.1797,250.0825 1645.4949,251.1492 Q1644.8101,252.2158 1644.8101,254.3159 Q1644.8101,256.4077 1645.4949,257.4744 Q1646.1797,258.541 1647.5244,258.541 Q1648.1553,258.541 1648.7488,258.2712 Q1649.3423,258.0015 1649.9731,257.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="103" x="1661.5" y="258.5352">FileVideoCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1633.5" x2="1766.5" y1="270" y2="270"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1633.5" x2="1766.5" y1="278" y2="278"/><!--MD5=[ccbd96572bb1b16b486fad2dde01e6f2]
class Camera1Capturer--><rect codeline="71" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="Camera1Capturer" style="stroke:#A80036;stroke-width:1.5;" width="175" x="916.5" y="709.5"/><ellipse cx="949.05" cy="725.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M951.5231,731.6431 Q950.9421,731.9419 950.3029,732.0913 Q949.6638,732.2407 948.9582,732.2407 Q946.4514,732.2407 945.1315,730.5889 Q943.8117,728.937 943.8117,725.8159 Q943.8117,722.6865 945.1315,721.0347 Q946.4514,719.3828 948.9582,719.3828 Q949.6638,719.3828 950.3112,719.5322 Q950.9587,719.6816 951.5231,719.9805 L951.5231,722.7031 Q950.8923,722.1221 950.2988,721.8523 Q949.7053,721.5825 949.0744,721.5825 Q947.7297,721.5825 947.0449,722.6492 Q946.3601,723.7158 946.3601,725.8159 Q946.3601,727.9077 947.0449,728.9744 Q947.7297,730.041 949.0744,730.041 Q949.7053,730.041 950.2988,729.7712 Q950.8923,729.5015 951.5231,728.9204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="104" x="966.95" y="730.0352">Camera1Capturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="917.5" x2="1090.5" y1="741.5" y2="741.5"/><ellipse cx="927.5" cy="752.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="104" x="936.5" y="756.1348">Camera1Capturer()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="917.5" x2="1090.5" y1="762.4551" y2="762.4551"/><polygon fill="#FFFF44" points="927.5,768.4551,931.5,772.4551,927.5,776.4551,923.5,772.4551" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="149" x="936.5" y="777.0898">void createCameraSession()</text><!--MD5=[09734e39e1aaab92cdb1f05f164bd2ac]
class Camera2Capturer--><rect codeline="77" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="Camera2Capturer" style="stroke:#A80036;stroke-width:1.5;" width="175" x="1126.5" y="709.5"/><ellipse cx="1159.05" cy="725.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1161.5231,731.6431 Q1160.9421,731.9419 1160.3029,732.0913 Q1159.6638,732.2407 1158.9582,732.2407 Q1156.4514,732.2407 1155.1315,730.5889 Q1153.8117,728.937 1153.8117,725.8159 Q1153.8117,722.6865 1155.1315,721.0347 Q1156.4514,719.3828 1158.9582,719.3828 Q1159.6638,719.3828 1160.3112,719.5322 Q1160.9587,719.6816 1161.5231,719.9805 L1161.5231,722.7031 Q1160.8923,722.1221 1160.2988,721.8523 Q1159.7053,721.5825 1159.0744,721.5825 Q1157.7297,721.5825 1157.0449,722.6492 Q1156.3601,723.7158 1156.3601,725.8159 Q1156.3601,727.9077 1157.0449,728.9744 Q1157.7297,730.041 1159.0744,730.041 Q1159.7053,730.041 1160.2988,729.7712 Q1160.8923,729.5015 1161.5231,728.9204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="104" x="1176.95" y="730.0352">Camera2Capturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1127.5" x2="1300.5" y1="741.5" y2="741.5"/><ellipse cx="1137.5" cy="752.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="104" x="1146.5" y="756.1348">Camera2Capturer()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1127.5" x2="1300.5" y1="762.4551" y2="762.4551"/><polygon fill="#FFFF44" points="1137.5,768.4551,1141.5,772.4551,1137.5,776.4551,1133.5,772.4551" style="stroke:#B38D22;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="149" x="1146.5" y="777.0898">void createCameraSession()</text><!--MD5=[19d1df133ca1013884d79ec64d03160b]
class CameraSession--><rect codeline="86" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="107.8203" id="CameraSession" style="stroke:#A80036;stroke-width:1.5;" width="440" x="1337" y="692.5"/><ellipse cx="1509.25" cy="708.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1505.6777,704.7651 L1505.6777,702.6069 L1513.0571,702.6069 L1513.0571,704.7651 L1510.5918,704.7651 L1510.5918,712.8418 L1513.0571,712.8418 L1513.0571,715 L1505.6777,715 L1505.6777,712.8418 L1508.1431,712.8418 L1508.1431,704.7651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="87" x="1529.75" y="713.0352">CameraSession</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1338" x2="1776" y1="724.5" y2="724.5"/><ellipse cx="1348" cy="735.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="58" x="1357" y="739.1348">void stop()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1338" x2="1776" y1="745.4551" y2="745.4551"/><ellipse cx="1348" cy="756.4551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="225" x="1357" y="760.0898">int getDeviceOrientation(Context context)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1338" x2="1776" y1="766.4102" y2="766.4102"/><ellipse cx="1348" cy="777.4102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="414" x="1357" y="781.0449">VideoFrame.TextureBuffer createTextureBufferWithModifiedTransformMatrix(</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="290" x="1357" y="794">TextureBufferImpl buffer, boolean mirror, int rotation)</text><!--MD5=[14ae07b67de67ef3ec59dfc7bd05aece]
class Camera1Session--><rect codeline="95" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="136.7754" id="Camera1Session" style="stroke:#A80036;stroke-width:1.5;" width="201" x="1347.5" y="875"/><ellipse cx="1396.25" cy="891" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1398.7231,897.1431 Q1398.1421,897.4419 1397.5029,897.5913 Q1396.8638,897.7407 1396.1582,897.7407 Q1393.6514,897.7407 1392.3315,896.0889 Q1391.0117,894.437 1391.0117,891.3159 Q1391.0117,888.1865 1392.3315,886.5347 Q1393.6514,884.8828 1396.1582,884.8828 Q1396.8638,884.8828 1397.5112,885.0322 Q1398.1587,885.1816 1398.7231,885.4805 L1398.7231,888.2031 Q1398.0923,887.6221 1397.4988,887.3523 Q1396.9053,887.0825 1396.2744,887.0825 Q1394.9297,887.0825 1394.2449,888.1492 Q1393.5601,889.2158 1393.5601,891.3159 Q1393.5601,893.4077 1394.2449,894.4744 Q1394.9297,895.541 1396.2744,895.541 Q1396.9053,895.541 1397.4988,895.2712 Q1398.0923,895.0015 1398.7231,894.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="95" x="1416.75" y="895.5352">Camera1Session</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1348.5" x2="1547.5" y1="907" y2="907"/><ellipse cx="1358.5" cy="918" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="67" x="1367.5" y="921.6348">void create()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1348.5" x2="1547.5" y1="927.9551" y2="927.9551"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1355.5" y="935.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="113" x="1367.5" y="942.5898">void startCapturing()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1348.5" x2="1547.5" y1="948.9102" y2="948.9102"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1355.5" y="956.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="162" x="1367.5" y="963.5449">void listenForTextureFrames()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1348.5" x2="1547.5" y1="969.8652" y2="969.8652"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1355.5" y="977.8652"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="175" x="1367.5" y="984.5">void listenForBytebufferFrames()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1348.5" x2="1547.5" y1="990.8203" y2="990.8203"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1355.5" y="998.8203"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="136" x="1367.5" y="1005.4551">int getFrameOrientation()</text><!--MD5=[01fec081d06c83f4541caf3f7cc36773]
class Camera2Session--><rect codeline="107" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="94.8652" id="Camera2Session" style="stroke:#A80036;stroke-width:1.5;" width="162" x="1584" y="896"/><ellipse cx="1614.75" cy="912" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1617.2231,918.1431 Q1616.6421,918.4419 1616.0029,918.5913 Q1615.3638,918.7407 1614.6582,918.7407 Q1612.1514,918.7407 1610.8315,917.0889 Q1609.5117,915.437 1609.5117,912.3159 Q1609.5117,909.1865 1610.8315,907.5347 Q1612.1514,905.8828 1614.6582,905.8828 Q1615.3638,905.8828 1616.0112,906.0322 Q1616.6587,906.1816 1617.2231,906.4805 L1617.2231,909.2031 Q1616.5923,908.6221 1615.9988,908.3523 Q1615.4053,908.0825 1614.7744,908.0825 Q1613.4297,908.0825 1612.7449,909.1492 Q1612.0601,910.2158 1612.0601,912.3159 Q1612.0601,914.4077 1612.7449,915.4744 Q1613.4297,916.541 1614.7744,916.541 Q1615.4053,916.541 1615.9988,916.2712 Q1616.5923,916.0015 1617.2231,915.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="95" x="1632.25" y="916.5352">Camera2Session</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1585" x2="1745" y1="928" y2="928"/><ellipse cx="1595" cy="939" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="67" x="1604" y="942.6348">void create()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1585" x2="1745" y1="948.9551" y2="948.9551"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1592" y="956.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="59" x="1604" y="963.5898">void start()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1585" x2="1745" y1="969.9102" y2="969.9102"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1592" y="977.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="136" x="1604" y="984.5449">int getFrameOrientation()</text><!--MD5=[d0ac0e6c7ffe0f9fe41145a86d5243f6]
class Camera1Enumerator--><rect codeline="147" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="94.8652" id="Camera1Enumerator" style="stroke:#A80036;stroke-width:1.5;" width="338" x="219" y="896"/><ellipse cx="323.75" cy="912" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M326.2231,918.1431 Q325.6421,918.4419 325.0029,918.5913 Q324.3638,918.7407 323.6582,918.7407 Q321.1514,918.7407 319.8315,917.0889 Q318.5117,915.437 318.5117,912.3159 Q318.5117,909.1865 319.8315,907.5347 Q321.1514,905.8828 323.6582,905.8828 Q324.3638,905.8828 325.0112,906.0322 Q325.6587,906.1816 326.2231,906.4805 L326.2231,909.2031 Q325.5923,908.6221 324.9988,908.3523 Q324.4053,908.0825 323.7744,908.0825 Q322.4297,908.0825 321.7449,909.1492 Q321.0601,910.2158 321.0601,912.3159 Q321.0601,914.4077 321.7449,915.4744 Q322.4297,916.541 323.7744,916.541 Q324.4053,916.541 324.9988,916.2712 Q325.5923,916.0015 326.2231,915.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="120" x="344.25" y="916.5352">Camera1Enumerator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="220" x2="556" y1="928" y2="928"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="227" y="936"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="199" x="239" y="942.6348">CameraInfo getCameraInfo(int index)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="220" x2="556" y1="948.9551" y2="948.9551"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="227" y="956.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="312" x="239" y="963.5898">List&lt;CaptureFormat&gt; getSupportedFormats(int cameraId)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="220" x2="556" y1="969.9102" y2="969.9102"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="227" y="977.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="172" x="239" y="984.5449">String getDeviceName(int index)</text><!--MD5=[48b3b187716a986d22b2634aa7919951]
class Camera2Enumerator--><rect codeline="155" fill="#FEFECE" filter="url(#f1nnqmvf33jkaz)" height="73.9102" id="Camera2Enumerator" style="stroke:#A80036;stroke-width:1.5;" width="397" x="592.5" y="906.5"/><ellipse cx="726.75" cy="922.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M729.2231,928.6431 Q728.6421,928.9419 728.0029,929.0913 Q727.3638,929.2407 726.6582,929.2407 Q724.1514,929.2407 722.8315,927.5889 Q721.5117,925.937 721.5117,922.8159 Q721.5117,919.6865 722.8315,918.0347 Q724.1514,916.3828 726.6582,916.3828 Q727.3638,916.3828 728.0112,916.5322 Q728.6587,916.6816 729.2231,916.9805 L729.2231,919.7031 Q728.5923,919.1221 727.9988,918.8523 Q727.4053,918.5825 726.7744,918.5825 Q725.4297,918.5825 724.7449,919.6492 Q724.0601,920.7158 724.0601,922.8159 Q724.0601,924.9077 724.7449,925.9744 Q725.4297,927.041 726.7744,927.041 Q727.4053,927.041 727.9988,926.7712 Q728.5923,926.5015 729.2231,925.9204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="120" x="747.25" y="927.0352">Camera2Enumerator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="593.5" x2="988.5" y1="938.5" y2="938.5"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="600.5" y="946.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="371" x="612.5" y="953.1348">CameraCharacteristics getCameraCharacteristics(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="593.5" x2="988.5" y1="959.4551" y2="959.4551"/><ellipse cx="603.5" cy="970.4551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="206" x="612.5" y="974.0898">boolean isSupported(Context context)</text><!--MD5=[a76226dc26b1373157892c246612775a]
reverse link CameraCapturer to CapturerObserver--><path codeline="51" d="M1022.88,536.03 C845.39,536.78 430.12,552.73 279,619 C238,636.98 200.2,670.8 173.47,698.94 " fill="none" id="CameraCapturer-backto-CapturerObserver" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1036,536,1029.9912,532.0132,1024,536.0264,1030.0088,540.0132,1036,536" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[8d16be48a47b929c2ce8b9a62009a270]
reverse link CameraCapturer to CameraEnumerator--><path codeline="52" d="M1022.76,476.29 C871.56,482.88 729.22,600.27 651.1,677.84 " fill="none" id="CameraCapturer-backto-CameraEnumerator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1036,476,1029.9135,472.1329,1024.0029,476.264,1030.0894,480.131,1036,476" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[a7eb497215feabb92724f152131991f3]
reverse link CameraCapturer to CameraSession.CreateSessionCallback--><path codeline="53" d="M1405.13,496.07 C1606.13,498.18 2076.74,546.88 2251,619 C2301.8,640.02 2351.09,679.84 2383.2,709.21 " fill="none" id="CameraCapturer-backto-CameraSession.CreateSessionCallback" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1392,496,1397.9824,500.0263,1403.9999,496.0527,1398.0175,492.0264,1392,496" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[a4c2fda8eb8258592542379c8c0e4447]
reverse link CameraCapturer to CameraSession.Events--><path codeline="54" d="M1405.05,516.03 C1600.07,517.03 1657.51,541.08 1843,619 C1879.54,634.35 1916.82,656.35 1948.98,677.72 " fill="none" id="CameraCapturer-backto-CameraSession.Events" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1392,516,1397.9912,520.0132,1404,516.0264,1398.0088,512.0132,1392,516" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[996e696b1041f98437ffb8a960da1c41]
reverse link CameraCapturer to CameraSession--><path codeline="55" d="M1405.35,556.92 C1470.65,565.96 1514.26,639.9 1537.34,692.46 " fill="none" id="CameraCapturer-backto-CameraSession" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1392,556,1397.7136,560.3994,1403.9721,556.8175,1398.2586,552.418,1392,556" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[0e5c36ed9415cc814f2ee6f1a4d4d3de]
reverse link VideoCapturer to CameraVideoCapturer--><path codeline="65" d="M1362.01,175.15 C1331.65,192.76 1301.4,210.31 1276.24,224.9 " fill="none" id="VideoCapturer-backto-CameraVideoCapturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1358.54,169.07,1379.36,165.09,1365.57,181.18,1358.54,169.07" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[f8c41590d8f2eb1f8ea3547becc6765a]
reverse link VideoCapturer to ScreenCapturerAndroid--><path codeline="66" d="M1514,185.24 C1514,204.87 1514,223.72 1514,237.71 " fill="none" id="VideoCapturer-backto-ScreenCapturerAndroid" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1507,185.09,1514,165.09,1521,185.09,1507,185.09" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[ba5a5a5aded9a8bf530f8f378f6be3f8]
reverse link VideoCapturer to FileVideoCapturer--><path codeline="67" d="M1612.4,179.05 C1635.72,200.87 1658.58,222.25 1675.1,237.71 " fill="none" id="VideoCapturer-backto-FileVideoCapturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1607.3,183.87,1597.48,165.09,1616.87,173.64,1607.3,183.87" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[40285a18b05116a2bb5bc3c9c80bb875]
reverse link CameraVideoCapturer to CameraCapturer--><path codeline="69" d="M1214,319.83 C1214,331.9 1214,345.1 1214,358.61 " fill="none" id="CameraVideoCapturer-backto-CameraCapturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1207,319.49,1214,299.49,1221,319.49,1207,319.49" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[79f5070d1b3e8ed456498fc0352b6661]
reverse link CameraCapturer to Camera1Capturer--><path codeline="83" d="M1100.1,626.75 C1075.31,657.38 1051.19,687.19 1033.31,709.28 " fill="none" id="CameraCapturer-backto-Camera1Capturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1094.67,622.33,1112.69,611.19,1105.55,631.14,1094.67,622.33" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[ccfa3e20f93efce94a8353912adc86d7]
reverse link CameraCapturer to Camera2Capturer--><path codeline="84" d="M1214,631.36 C1214,660.36 1214,688.3 1214,709.28 " fill="none" id="CameraCapturer-backto-Camera2Capturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1207,631.19,1214,611.19,1221,631.19,1207,631.19" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[b33991f621f5b0af78d08f8d2bba13d7]
reverse link CameraSession to Camera1Session--><path codeline="114" d="M1517.55,818.08 C1507.21,836.57 1496.09,856.46 1485.84,874.8 " fill="none" id="CameraSession-backto-Camera1Session" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1511.49,814.57,1527.36,800.53,1523.71,821.4,1511.49,814.57" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[f75d3d2b08c7bbd482af102eec66940b]
reverse link CameraSession to Camera2Session--><path codeline="115" d="M1596.21,818.29 C1610.5,844.1 1626.29,872.61 1639.13,895.8 " fill="none" id="CameraSession-backto-Camera2Session" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1589.94,821.41,1586.37,800.53,1602.18,814.63,1589.94,821.41" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[c6795812616f4a997f5cf1c0e50b3d3c]
reverse link CameraEnumerator to Camera1Enumerator--><path codeline="161" d="M504.86,829.13 C481.4,851.88 456.72,875.83 436.12,895.82 " fill="none" id="CameraEnumerator-backto-Camera1Enumerator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="500.04,824.06,519.26,815.15,509.78,834.1,500.04,824.06" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[455f21439928cf20c750eb6a7b86455e]
reverse link CameraEnumerator to Camera2Enumerator--><path codeline="162" d="M673.49,829.06 C701.44,856.04 731.12,884.69 753.66,906.45 " fill="none" id="CameraEnumerator-backto-Camera2Enumerator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="668.61,834.08,659.08,815.15,678.33,824.01,668.61,834.08" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[65d3e4d22b54be677a2d38f02652e935]
@startuml

interface CapturerObserver {
    + void onCapturerStarted(boolean success)
    ..
    + void onCapturerStopped()
    ..
    + void onFrameCaptured(VideoFrame frame)
}

interface VideoCapturer {
    + void initialize(SurfaceTextureHelper , Context , CapturerObserver )
    ..
    + void startCapture(int width, int height, int framerate)
    ..
    + void stopCapture()
    ..
    + void changeCaptureFormat(int width, int height, int framerate)
    ..
    + void dispose()
    ..
    + boolean isScreencast()
}

interface CameraVideoCapturer {
    + void switchCamera(CameraSwitchHandler )
    ..
    + void switchCamera(CameraSwitchHandler, String cameraName)
}

abstract class CameraCapturer {
    # {abstract} void createCameraSession()
    ..
    - void createSessionInternal(int delayMs)
    ..
    - void switchCameraInternal()
    - - field - -
    - {field} CameraEnumerator cameraEnumerator
    ..
    - {field} CameraSession.CreateSessionCallback createSessionCallback
    ..
    - {field} CameraSession.Events cameraSessionEventsHandler
    ..
    - {field} CapturerObserver capturerObserver
    ..
    - {field} CameraSession currentSession
    ..
    - {field} CameraSwitchHandler switchEventsHandler
    ..
    - {field} CameraStatistics cameraStatistics
}
CameraCapturer::capturerObserver *- - CapturerObserver
CameraCapturer::cameraEnumerator *- - CameraEnumerator
CameraCapturer::createSessionCallback *- - CameraSession.CreateSessionCallback
CameraCapturer::cameraSessionEventsHandler *- - CameraSession.Events
CameraCapturer::currentSession *- - CameraSession

class ScreenCapturerAndroid {

}

class FileVideoCapturer {

}

VideoCapturer <|- - CameraVideoCapturer
VideoCapturer <|- - ScreenCapturerAndroid
VideoCapturer <|- - FileVideoCapturer

CameraVideoCapturer <|- - CameraCapturer

class Camera1Capturer {
    + Camera1Capturer()
    ..
    # {method} void createCameraSession()
}

class Camera2Capturer {
    + Camera2Capturer()
    ..
    # {method} void createCameraSession()
}

CameraCapturer <|- - Camera1Capturer
CameraCapturer <|- - Camera2Capturer

interface CameraSession {
    + void stop()
    ..
    + {static} int getDeviceOrientation(Context context)
    ..
    + {static} VideoFrame.TextureBuffer createTextureBufferWithModifiedTransformMatrix(
      TextureBufferImpl buffer, boolean mirror, int rotation)
}

class Camera1Session {
    + {static} void create()
    ..
    - void startCapturing()
    ..
    - void listenForTextureFrames()
    ..
    - void listenForBytebufferFrames()
    ..
    - int getFrameOrientation()
}

class Camera2Session {
    + {static} void create()
    ..
    - void start()
    ..
    - int getFrameOrientation()
}
CameraSession <|- - Camera1Session
CameraSession <|- - Camera2Session

interface CameraSession.CreateSessionCallback {
    + void onDone(CameraSession session)
    ..
    + void onFailure(FailureType failureType, String error)
}

interface CameraSession.Events {
    + void onCameraOpening()
    ..
    + void onCameraError(CameraSession session, String error)
    ..
    + void onCameraDisconnected(CameraSession session)
    ..
    + void onCameraClosed(CameraSession session)
    ..
    + void onFrameCaptured(CameraSession session, VideoFrame frame)
}

interface CameraEnumerator {
    + String[] getDeviceNames()
    ..
    + boolean isFrontFacing(String deviceName)
    ..
    + boolean isBackFacing(String deviceName)
    ..
    + List<CaptureFormat> getSupportedFormats(String deviceName)
    ..
    + CameraVideoCapturer createCapturer(String deviceName, CameraVideoCapturer.CameraEventsHandler )
}

class Camera1Enumerator {
    - {static} CameraInfo getCameraInfo(int index)
    ..
    - {static} List<CaptureFormat> getSupportedFormats(int cameraId)
    ..
    - {static} String getDeviceName(int index)
}

class Camera2Enumerator {
    - {method} CameraCharacteristics getCameraCharacteristics(String deviceName)
    ..
    + {static} boolean isSupported(Context context)
}

CameraEnumerator <|- - Camera1Enumerator
CameraEnumerator <|- - Camera2Enumerator
@enduml

PlantUML version 1.2020.26(Tue Dec 22 01:45:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg></p><p>&#x521B;&#x5EFA;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// CallActivity.java</span>
<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">VideoCapturer</span> <span class="token function">createVideoCapturer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">VideoCapturer</span> videoCapturer<span class="token punctuation">;</span>
    <span class="token class-name">String</span> videoFileAsCamera <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>EXTRA_VIDEO_FILE_AS_CAMERA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x89C6;&#x9891;&#x6587;&#x4EF6;&#x4F5C;&#x4E3A;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90; */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>videoFileAsCamera <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            videoCapturer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileVideoCapturer</span><span class="token punctuation">(</span>videoFileAsCamera<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to open video file for emulated camera&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>screencaptureEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* &#x5C4F;&#x5E55;&#x5171;&#x4EAB; */</span>
        <span class="token keyword">return</span> <span class="token function">createScreenCapturer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useCamera2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Camera2 Api */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">captureToTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>camera2_texture_only_error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating capturer using camera2 API.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        videoCapturer <span class="token operator">=</span> <span class="token function">createCameraCapturer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Camera2Enumerator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Camera Api */</span>
        <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating capturer using camera1 API.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        videoCapturer <span class="token operator">=</span> <span class="token function">createCameraCapturer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">(</span><span class="token function">captureToTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>videoCapturer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to open camera&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> videoCapturer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x521B;&#x5EFA;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#x6E90;</span>
<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">VideoCapturer</span> <span class="token function">createCameraCapturer</span><span class="token punctuation">(</span><span class="token class-name">CameraEnumerator</span> enumerator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x83B7;&#x53D6;&#x8BBE;&#x5907;&#x6444;&#x50CF;&#x5934;&#x4FE1;&#x606F; */</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> deviceNames <span class="token operator">=</span> enumerator<span class="token punctuation">.</span><span class="token function">getDeviceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// First, try to find front facing camera</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Looking for front facing cameras.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x521B;&#x5EFA;&#x524D;&#x7F6E;&#x6444;&#x50CF;&#x5934;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> deviceName <span class="token operator">:</span> deviceNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enumerator<span class="token punctuation">.</span><span class="token function">isFrontFacing</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating front facing camera capturer.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">VideoCapturer</span> videoCapturer <span class="token operator">=</span> enumerator<span class="token punctuation">.</span><span class="token function">createCapturer</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">,</span> <span class="token comment">/* CameraEventsHandler */</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>videoCapturer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> videoCapturer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Front facing camera not found, try something else</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Looking for other cameras.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x82E5;&#x65E0;&#x524D;&#x7F6E;&#x6444;&#x50CF;&#x5934;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x540E;&#x7F6E;&#x6444;&#x50CF;&#x5934;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> deviceName <span class="token operator">:</span> deviceNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enumerator<span class="token punctuation">.</span><span class="token function">isFrontFacing</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating other camera capturer.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">VideoCapturer</span> videoCapturer <span class="token operator">=</span> enumerator<span class="token punctuation">.</span><span class="token function">createCapturer</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">,</span> <span class="token comment">/* CameraEventsHandler */</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>videoCapturer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> videoCapturer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="31-%E6%91%84%E5%83%8F%E5%A4%B4-camera1-%E9%87%87%E9%9B%86">3.1 &#x6444;&#x50CF;&#x5934; Camera1 &#x91C7;&#x96C6;</h3>

<h4 class="mume-header" id="311-%E5%88%9B%E5%BB%BA-cameracapturer">3.1.1 &#x521B;&#x5EFA; CameraCapturer</h4>

<ol>
<li>&#x521B;&#x5EFA; Camera1Enumerator&#xFF1B;</li>
<li>&#x901A;&#x8FC7; Camera1Enumerator &#x63A5;&#x53E3; createCapturer() &#x521B;&#x5EFA; Camera1Capturer</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera1Enumerator.java</span>
<span class="token keyword">public</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> captureToTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>captureToTexture <span class="token operator">=</span> captureToTexture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CameraVideoCapturer</span> <span class="token function">createCapturer</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> deviceName<span class="token punctuation">,</span> <span class="token class-name">CameraVideoCapturer<span class="token punctuation">.</span>CameraEventsHandler</span> eventsHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Camera1Capturer</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">,</span> eventsHandler<span class="token punctuation">,</span> captureToTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><ol start="3">
<li>Camera1Capturer &#x6784;&#x9020;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x7236;&#x7C7B; CameraCapturer &#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x4FDD;&#x5B58;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x7B49;&#x64CD;&#x4F5C;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera1Capturer.java</span>
<span class="token keyword">public</span> <span class="token class-name">Camera1Capturer</span><span class="token punctuation">(</span> <span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token class-name">CameraEventsHandler</span> eventsHandler<span class="token punctuation">,</span> <span class="token keyword">boolean</span> captureToTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x8C03;&#x7528;&#x7236;&#x7C7B;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x6CE8;&#x610F;&#x6B64;&#x5904;&#x91CD;&#x5EFA;&#x4E86; Camera1Enumerator  */</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>cameraName<span class="token punctuation">,</span> eventsHandler<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">(</span>captureToTexture<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>captureToTexture <span class="token operator">=</span> captureToTexture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/java/org/webrt/CameraCapturer.java</span>
<span class="token keyword">public</span> <span class="token class-name">CameraCapturer</span><span class="token punctuation">(</span><span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">CameraEventsHandler</span> eventsHandler<span class="token punctuation">,</span>
      <span class="token class-name">CameraEnumerator</span> cameraEnumerator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x6B64;&#x5904; eventsHandler &#x4E3A; null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventsHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventsHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CameraEventsHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraError</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraDisconnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraFreezed</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraOpening</span><span class="token punctuation">(</span><span class="token class-name">String</span> cameraName<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFirstFrameAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>eventsHandler <span class="token operator">=</span> eventsHandler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraEnumerator <span class="token operator">=</span> cameraEnumerator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraName <span class="token operator">=</span> cameraName<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> deviceNames <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>cameraEnumerator<span class="token punctuation">.</span><span class="token function">getDeviceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uiThreadHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="312-%E5%90%AF%E5%8A%A8-camera-%E9%87%87%E9%9B%86">3.1.2 &#x542F;&#x52A8; Camera &#x91C7;&#x96C6;</h4>

<p>&#x5728;&#x8C03;&#x7528; CameraCapturer &#x7684; startCapture() &#x65F6;&#x542F;&#x52A8;&#xFF0C;&#x5148;&#x521B;&#x5EFA; CameraSession&#xFF0C;&#x5E76;&#x5728; CameraSession &#x5185;&#x542F;&#x52A8;&#x6444;&#x50CF;&#x5934;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera1Capturer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">createCameraSession</span><span class="token punctuation">(</span><span class="token class-name">CameraSession<span class="token punctuation">.</span>CreateSessionCallback</span> createSessionCallback<span class="token punctuation">,</span>
    <span class="token class-name">CameraSession<span class="token punctuation">.</span>Events</span> events<span class="token punctuation">,</span> <span class="token class-name">Context</span> applicationContext<span class="token punctuation">,</span>
    <span class="token class-name">SurfaceTextureHelper</span> surfaceTextureHelper<span class="token punctuation">,</span> <span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span>
    <span class="token keyword">int</span> framerate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x521B;&#x5EFA; Camera1Session &#x5E76;&#x542F;&#x52A8;&#x6444;&#x50CF;&#x5934;</span>
    <span class="token class-name">Camera1Session</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>createSessionCallback<span class="token punctuation">,</span> events<span class="token punctuation">,</span> captureToTexture<span class="token punctuation">,</span> applicationContext<span class="token punctuation">,</span>
        surfaceTextureHelper<span class="token punctuation">,</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">.</span><span class="token function">getCameraIndex</span><span class="token punctuation">(</span>cameraName<span class="token punctuation">)</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
        framerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="32-%E6%91%84%E5%83%8F%E5%A4%B4-camera2-%E9%87%87%E9%9B%86">3.2 &#x6444;&#x50CF;&#x5934; Camera2 &#x91C7;&#x96C6;</h3>

<p>Camera2 &#x5FC5;&#x987B;&#x542F;&#x7528; Texture &#x624D;&#x80FD;&#x6E32;&#x67D3;&#x3002;</p>
<h4 class="mume-header" id="321-%E5%88%9B%E5%BB%BA-cameracapturer">3.2.1 &#x521B;&#x5EFA; CameraCapturer</h4>

<ol>
<li>&#x521B;&#x5EFA; Camera2Enumerator&#xFF1B;</li>
<li>&#x901A;&#x8FC7; Camera2Enumerator &#x63A5;&#x53E3; createCapturer() &#x521B;&#x5EFA; Camera2Capturer</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera2Enumerator.java</span>
<span class="token keyword">public</span> <span class="token class-name">Camera2Enumerator</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token comment">/* &#x83B7;&#x53D6;&#x7CFB;&#x7EDF;&#x6444;&#x50CF;&#x5934;&#x7BA1;&#x7406;&#x670D;&#x52A1; */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CameraManager</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>CAMERA_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CameraVideoCapturer</span> <span class="token function">createCapturer</span><span class="token punctuation">(</span><span class="token class-name">String</span> deviceName<span class="token punctuation">,</span> <span class="token class-name">CameraVideoCapturer<span class="token punctuation">.</span>CameraEventsHandler</span> eventsHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Camera2Capturer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> deviceName<span class="token punctuation">,</span> eventsHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><ol start="3">
<li>Camera2Capturer &#x6784;&#x9020;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x7236;&#x7C7B; CameraCapturer &#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x4FDD;&#x5B58;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x7B49;&#x64CD;&#x4F5C;</li>
</ol>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/Camera1Capturer.java</span>
<span class="token keyword">public</span> <span class="token class-name">Camera2Capturer</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token class-name">CameraEventsHandler</span> eventsHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x8C03;&#x7528;&#x7236;&#x7C7B;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x6CE8;&#x610F;&#x6B64;&#x5904;&#x65B0;&#x5EFA;&#x4E86; Camera2Enumerator  */</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>cameraName<span class="token punctuation">,</span> eventsHandler<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Camera2Enumerator</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token comment">/* &#x83B7;&#x53D6;&#x7CFB;&#x7EDF;&#x6444;&#x50CF;&#x5934;&#x7BA1;&#x7406;&#x670D;&#x52A1; */</span>
    cameraManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CameraManager</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>CAMERA_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/java/org/webrt/CameraCapturer.java</span>
<span class="token keyword">public</span> <span class="token class-name">CameraCapturer</span><span class="token punctuation">(</span><span class="token class-name">String</span> cameraName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">CameraEventsHandler</span> eventsHandler<span class="token punctuation">,</span>
      <span class="token class-name">CameraEnumerator</span> cameraEnumerator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x6B64;&#x5904; eventsHandler &#x4E3A; null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventsHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventsHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CameraEventsHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraError</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraDisconnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraFreezed</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraOpening</span><span class="token punctuation">(</span><span class="token class-name">String</span> cameraName<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFirstFrameAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCameraClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>eventsHandler <span class="token operator">=</span> eventsHandler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraEnumerator <span class="token operator">=</span> cameraEnumerator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraName <span class="token operator">=</span> cameraName<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> deviceNames <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>cameraEnumerator<span class="token punctuation">.</span><span class="token function">getDeviceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uiThreadHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="322-%E5%90%AF%E5%8A%A8-camera2-%E9%87%87%E9%9B%86">3.2.2 &#x542F;&#x52A8; Camera2 &#x91C7;&#x96C6;</h4>

<h3 class="mume-header" id="33-%E5%88%9B%E5%BB%BA-videosource">3.3 &#x521B;&#x5EFA; VideoSource</h3>

<p>&#x521B;&#x5EFA; Java &#x5C42; VideoSource</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/api/org/webrtc/PeerConnectionFactory.java</span>
<span class="token keyword">public</span> <span class="token class-name">VideoSource</span> <span class="token function">createVideoSource</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isScreencast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createVideoSource</span><span class="token punctuation">(</span>isScreencast<span class="token punctuation">,</span> <span class="token comment">/* alignTimestamps= */</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">VideoSource</span> <span class="token function">createVideoSource</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isScreencast<span class="token punctuation">,</span> <span class="token keyword">boolean</span> alignTimestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkPeerConnectionFactoryExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x9700;&#x5148;&#x521B;&#x5EFA; Native &#x5C42; VideoSource&#xFF0C;&#x8FDB;&#x884C;&#x7ED1;&#x5B9A;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">VideoSource</span><span class="token punctuation">(</span><span class="token function">nativeCreateVideoSource</span><span class="token punctuation">(</span>nativeFactory<span class="token punctuation">,</span> isScreencast<span class="token punctuation">,</span> alignTimestamps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/VideoSource.java</span>
<span class="token keyword">public</span> <span class="token class-name">VideoSource</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>nativeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAndroidVideoTrackSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeAndroidVideoTrackSource</span><span class="token punctuation">(</span>nativeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// // sdk/android/src/java/org/webrtc/NativeAndroidVideoTrackSource.java</span>
<span class="token keyword">public</span> <span class="token class-name">NativeAndroidVideoTrackSource</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeAndroidVideoTrackSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAndroidVideoTrackSource <span class="token operator">=</span> nativeAndroidVideoTrackSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/MediaSource.java</span>
<span class="token keyword">public</span> <span class="token class-name">MediaSource</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    refCountDelegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefCountDelegate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">JniCommon</span><span class="token punctuation">.</span><span class="token function">nativeReleaseRef</span><span class="token punctuation">(</span>nativeSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeSource <span class="token operator">=</span> nativeSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>&#x521B;&#x5EFA; Native &#x5C42; VideoSource</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnectionFactory_jni.h</span>
JNI_GENERATOR_EXPORT jlong <span class="token function">Java_org_webrtc_PeerConnectionFactory_nativeCreateVideoSource</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jlong factory<span class="token punctuation">,</span>
    jboolean is_screencast<span class="token punctuation">,</span>
    jboolean alignTimestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_PeerConnectionFactory_CreateVideoSource</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> is_screencast<span class="token punctuation">,</span> alignTimestamps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection_factory.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_PeerConnectionFactory_CreateVideoSource</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    jlong native_factory<span class="token punctuation">,</span>
    jboolean is_screencast<span class="token punctuation">,</span>
    jboolean align_timestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  OwnedFactoryAndThreads<span class="token operator">*</span> factory <span class="token operator">=</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>OwnedFactoryAndThreads<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token function">CreateVideoSource</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> factory<span class="token operator">-&gt;</span><span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            factory<span class="token operator">-&gt;</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            is_screencast<span class="token punctuation">,</span> align_timestamps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/video.cc</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">CreateVideoSource</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                        rtc<span class="token operator">::</span>Thread<span class="token operator">*</span> signaling_thread<span class="token punctuation">,</span>
                        rtc<span class="token operator">::</span>Thread<span class="token operator">*</span> worker_thread<span class="token punctuation">,</span>
                        jboolean is_screencast<span class="token punctuation">,</span>
                        jboolean align_timestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AndroidVideoTrackSource<span class="token operator">&gt;</span> <span class="token function">source</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>AndroidVideoTrackSource<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            signaling_thread<span class="token punctuation">,</span> env<span class="token punctuation">,</span> is_screencast<span class="token punctuation">,</span> align_timestamps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> source<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/android_video_track_source.cc</span>
<span class="token comment">// AndroidVideoTrackSource &#x7EE7;&#x627F;&#x4E8E; AdaptedVideoTrackSource, AdaptedVideoTrackSource &#x53C8;&#x7EE7;&#x627F;&#x4E8E; VideoTrackSourceInterface</span>
<span class="token comment">// AdaptedVideoTrackSource &#x5B9E;&#x73B0;&#x4E86;&#x5BF9;&#x89C6;&#x9891;&#x88C1;&#x526A;&#xFF0C;&#x89D2;&#x5EA6;&#x65CB;&#x8F6C;&#xFF0C;&#x4E22;&#x5E27;&#x7B49;&#x5904;&#x7406;</span>
<span class="token class-name">AndroidVideoTrackSource</span><span class="token operator">::</span><span class="token function">AndroidVideoTrackSource</span><span class="token punctuation">(</span>rtc<span class="token operator">::</span>Thread<span class="token operator">*</span> signaling_thread<span class="token punctuation">,</span>
                                                 JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
                                                 <span class="token keyword">bool</span> is_screencast<span class="token punctuation">,</span>
                                                 <span class="token keyword">bool</span> align_timestamps<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">AdaptedVideoTrackSource</span><span class="token punctuation">(</span>kRequiredResolutionAlignment<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">signaling_thread_</span><span class="token punctuation">(</span>signaling_thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">is_screencast_</span><span class="token punctuation">(</span>is_screencast<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">align_timestamps_</span><span class="token punctuation">(</span>align_timestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>LS_INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;AndroidVideoTrackSource ctor&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="34-%E6%91%84%E5%83%8F%E5%A4%B4%E9%87%87%E9%9B%86%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8F%8A%E5%90%AF%E5%8A%A8">3.4 &#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6;&#x521D;&#x59CB;&#x5316;&#x53CA;&#x542F;&#x52A8;</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/src/java/org/webrtc/CameraCapturer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">SurfaceTextureHelper</span> surfaceTextureHelper<span class="token punctuation">,</span> <span class="token class-name">Context</span> applicationContext<span class="token punctuation">,</span>
      <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>webrtc<span class="token punctuation">.</span></span>CapturerObserver</span> capturerObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span>
    <span class="token comment">// capturerObserver &#x89C6;&#x9891;&#x6570;&#x636E;&#x56DE;&#x8C03;&#x63A5;&#x53E3;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>capturerObserver <span class="token operator">=</span> capturerObserver<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>surfaceHelper <span class="token operator">=</span> surfaceTextureHelper<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraThreadHandler <span class="token operator">=</span> surfaceTextureHelper<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startCapture</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> framerate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;startCapture: &quot;</span> <span class="token operator">+</span> width <span class="token operator">+</span> <span class="token string">&quot;x&quot;</span> <span class="token operator">+</span> height <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> framerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;CameraCapturer must be initialized before calling startCapture.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stateLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionOpening <span class="token operator">||</span> currentSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Session already open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>framerate <span class="token operator">=</span> framerate<span class="token punctuation">;</span>

        sessionOpening <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// &#x6444;&#x50CF;&#x5934;&#x542F;&#x52A8;&#x5C1D;&#x8BD5;&#x6B21;&#x6570;</span>
        openAttemptsRemaining <span class="token operator">=</span> MAX_OPEN_CAMERA_ATTEMPTS<span class="token punctuation">;</span>
        <span class="token function">createSessionInternal</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createSessionInternal</span><span class="token punctuation">(</span><span class="token keyword">int</span> delayMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x542F;&#x52A8;&#x6444;&#x50CF;&#x5934;&#x542F;&#x52A8;&#x8D85;&#x65F6;&#x5B9A;&#x65F6;&#x5668;&#xFF0C;&#x4EE5;&#x4FBF;&#x91CD;&#x542F;&#x6444;&#x50CF;&#x5934;</span>
    uiThreadHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>openCameraTimeoutRunnable<span class="token punctuation">,</span> delayMs <span class="token operator">+</span> OPEN_CAMERA_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cameraThreadHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// &#x8C03;&#x7528;&#x5B50;&#x7C7B; Camera1Capturer &#x6216; Camera2Capturer &#x7684; createCameraSession() &#x5B9E;&#x73B0;</span>
            <span class="token function">createCameraSession</span><span class="token punctuation">(</span>createSessionCallback<span class="token punctuation">,</span> cameraSessionEventsHandler<span class="token punctuation">,</span> applicationContext<span class="token punctuation">,</span>
                surfaceHelper<span class="token punctuation">,</span> cameraName<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> framerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delayMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="35-%E6%91%84%E5%83%8F%E5%A4%B4%E8%A7%86%E9%A2%91%E6%95%B0%E6%8D%AE%E6%B5%81">3.5 &#x6444;&#x50CF;&#x5934;&#x89C6;&#x9891;&#x6570;&#x636E;&#x6D41;</h3>

<pre data-role="codeBlock" data-info class="language-"><code>Camera1Session/Camera2Session --&gt; (CameraCapturer.java) CameraSession.Events.onFrameCaptured() 
--&gt; (VideoSource.java) CapturerObserver.onFrameCaptured()
--&gt; (NativeAndroidVideoTrackSource.java) NativeAndroidVideoTrackSource.onFrameCaptured() 
--&gt; (android_video_track_source.cc) AndroidVideoTrackSource.onFrameCaptured()
--&gt; (adapted_video_track_source.cc) AdaptedVideoTrackSource::OnFrame()
--&gt; broadcaster_.OnFrame(frame)
</code></pre></div></body></html>
    </div>
  </body>
</html>
